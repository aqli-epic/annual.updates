---
title: "Factsheets 2023"
author: "Aarsh Batra, Nishka Sharma"
date: '2023-07-24'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# get packages, global variables and datasets
```{r load-lib-helper-files-data-global-var}

# read in the helper file
source("./appPublic/aqli.data.explorer.helper.script.R")

```

# This script contains code for graphs and some calculations that were not computed by the
# AQLI Data Explorer dashboard: https://aarsh.shinyapps.io/aqli-epic-data-explorer/.

#========================================================================================================


## India Factsheet 

```{r india_fs_2023}

#> Since [year], [x%] of the world's increase in pollution camer from [country]-----------------

country_select <- "India"

# Since 2013 all gadm2 places where pollution has increased - > average pm2.5 in 2013, 2021
 avg_pm2.5_global <- gadm2_aqli_2021 %>% 
  mutate(diff_pm2021_pm2013 = pm2021 - pm2013) %>%
  filter(diff_pm2021_pm2013 > 0) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2013_pop_weighted = pm2013*pop_weights, 
         pm2021_pop_weighted = pm2021*pop_weights) %>%
  summarise(avg_pm2.5_2013 = sum(pm2013_pop_weighted, na.rm = TRUE), 
            avg_pm2.5_2021 = sum(pm2021_pop_weighted, na.rm = TRUE))

 actual_diff_global <- avg_pm2.5_global$avg_pm2.5_2021 - avg_pm2.5_global$avg_pm2.5_2013
 
# Assuming that of the places (gadm2 regions) where pollution increased, if amongst those places, 
# all Indian gadm2 regions had the same pollution in 2021 as it had in 2013, how would the global
# average PM2.5 look in 2021.
 
avg_pm2.5_global_adjusted <- gadm2_aqli_2021 %>% 
  mutate(diff_pm2021_pm2013 = pm2021 - pm2013) %>%
  filter(diff_pm2021_pm2013 > 0) %>%
   mutate(pm2021 = ifelse(country == country_select, pm2013, pm2021)) %>%
     mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2013_pop_weighted = pm2013*pop_weights, 
         pm2021_pop_weighted = pm2021*pop_weights) %>%
  summarise(avg_pm2.5_2013 = sum(pm2013_pop_weighted, na.rm = TRUE), 
            avg_pm2.5_2021 = sum(pm2021_pop_weighted, na.rm = TRUE))

# difference between adjusted and actual global average, i.e. India's contribution
adjusted_diff_global <- avg_pm2.5_global_adjusted$avg_pm2.5_2021 - avg_pm2.5_global_adjusted$avg_pm2.5_2013
 
# final answer
final_answer <- round(((actual_diff_global - adjusted_diff_global)/actual_diff_global)*100, 1)

#> Indo Gangetic Plain, population and average PM2.5----------------------------------

# average pm2.5 and total population in Indo-Gangetic plains in 2021
summary_indo_gangetic_plain <- gadm2_aqli_2021 %>%
  filter(country == "India", name_1 %in% indo_gangetic_plains_states) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2021_pop_weighted = pm2021*pop_weights) %>%
  summarise(avg_pm2.5_2021 = sum(pm2021_pop_weighted, na.rm = TRUE), 
            total_population = sum(population, na.rm = TRUE))

#> Fig 1: Potential gain in Life Expectancy from permanently reducing PM2.5 from 2021 levels to the-------- 
# WHO PM2.5 guideline.

# separately getting Gilgit Baltistan and Azad Kashmir
azad_kashmir_gilgit_baltistan <- gadm2_aqli_2021 %>%
  filter(country == "Pakistan", name_1 %in% c("Azad Kashmir", "Gilgit Baltistan"))

# plot 3 data
india_fs_fig1_data <- gadm2_aqli_2021 %>%
  filter(country == "India") %>%
  bind_rows(azad_kashmir_gilgit_baltistan) %>%
  left_join(gadm2_aqli_2021_shp, by = c("objectid_gadm2" = "obidgadm2")) %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021") %>%
  select(-geometry, geometry) %>%
  st_as_sf()

# change lyl_bucket and order_lyl_bucket columns to factor
# india_fs_fig1_data$lyl_bucket <- factor(india_fs_fig1_data$lyl_bucket)
# india_fs_fig1_data$order_lyl_bucket <- factor(india_fs_fig1_data$order_lyl_bucket)

# india factsheet figure 1
india_fs_fig1 <- india_fs_fig1_data %>%
  ggplot() +
  geom_sf(mapping = aes(fill = forcats::fct_reorder(lyl_bucket, order_lyl_bucket)), color = "lightgrey", lwd = 0.05) +
  geom_sf(data = india_state, color = "black", fill = "transparent", lwd = 0.5) +
  ggthemes::theme_map() + 
 scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  ggthemes::theme_map() +
  labs(fill = "Potential gain in life expectancy (Years) ", title = "") + 
 theme(legend.position = "bottom", 
        legend.justification = c(0.5, 3), 
        legend.background = element_rect(color = "black"), 
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15), 
        plot.title = element_text(hjust = 0.5, size = 15), 
       # legend.key = element_rect(color = "black"),
       legend.box.margin = margin(b = 1, unit = "cm"),
        plot.subtitle = element_text(hjust = 0.5, size = 7), 
        plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
       legend.key = element_rect(color = "black"), 
       legend.box.spacing = unit(0, "cm"), 
        legend.direction = "horizontal", 
       plot.background = element_rect(fill = "white", color = "white")) +
  guides(fill = guide_legend(nrow = 1))


#> State wise maps section commented for now===================================================================================

# Figure 1.1: state wise figures (uses figure 1's data)

# # separately getting Gilgit Baltistan and Azad Kashmir
# azad_kashmir_gilgit_baltistan <- gadm2_aqli_2021 %>%
#   filter(country == "Pakistan", name_1 %in% c("Azad Kashmir", "Gilgit Baltistan"))
# 
# # plot 3 data
# india_fs_fig1.1_data <- gadm2_aqli_2021 %>%
#   filter(country == "India") %>%
#   bind_rows(azad_kashmir_gilgit_baltistan) %>%
#   left_join(gadm2_aqli_2021_shp, by = c("objectid_gadm2" = "obidgadm2")) %>%
#   mutate(lyl_bucket = ifelse((llpp_who_2021 >= 0) & (llpp_who_2021 < 0.1), "0 - < 0.1", NA), 
#          lyl_bucket = ifelse((llpp_who_2021 >= 0.1) & (llpp_who_2021 <= 0.5), "0.1 - 0.5", lyl_bucket), 
#          lyl_bucket = ifelse((llpp_who_2021 > 0.5) & (llpp_who_2021 <= 1), "> 0.5 - 1", lyl_bucket), 
#          lyl_bucket = ifelse((llpp_who_2021 > 1) & (llpp_who_2021 <= 2), "> 1 - 2", lyl_bucket), 
#          lyl_bucket = ifelse((llpp_who_2021 > 2) & (llpp_who_2021 <= 3), "> 2 - 3", lyl_bucket), 
#          lyl_bucket = ifelse((llpp_who_2021 > 3) & (llpp_who_2021 <= 4), "> 3 - 4", lyl_bucket), 
#          lyl_bucket = ifelse((llpp_who_2021 > 4) & (llpp_who_2021 <= 5), "> 4 - 5", lyl_bucket), 
#          lyl_bucket = ifelse((llpp_who_2021 > 5) & (llpp_who_2021 < 6), "> 5 - < 6", lyl_bucket), 
#          lyl_bucket = ifelse((llpp_who_2021 >= 6), ">= 6", lyl_bucket)) %>%
#   mutate(order_lyl_bucket = ifelse(lyl_bucket == "0 - < 0.1", 1, NA), 
#          order_lyl_bucket = ifelse(lyl_bucket == "0.1 - 0.5", 2, order_lyl_bucket), 
#          order_lyl_bucket = ifelse(lyl_bucket == "> 0.5 - 1", 3, order_lyl_bucket), 
#          order_lyl_bucket = ifelse(lyl_bucket == "> 1 - 2", 4, order_lyl_bucket), 
#          order_lyl_bucket = ifelse(lyl_bucket == "> 2 - 3", 5, order_lyl_bucket), 
#          order_lyl_bucket = ifelse(lyl_bucket == "> 3 - 4", 6, order_lyl_bucket), 
#          order_lyl_bucket = ifelse(lyl_bucket == "> 4 - 5", 7, order_lyl_bucket), 
#          order_lyl_bucket = ifelse(lyl_bucket == "> 5 - < 6", 8, order_lyl_bucket), 
#          order_lyl_bucket = ifelse(lyl_bucket == ">= 6", 9, order_lyl_bucket)) %>%
#   select(-geometry, geometry) %>%
#   st_as_sf()
# 
# 
# 
# states_to_plot <- c("Jammu and Kashmir", "Haryana", "Andhra Pradesh", "Assam", "West Bengal", "Maharashtra", 
#                 "Tamil Nadu", "Azad Kashmir")
# 
# # india factsheet figure 1.1 (state wise)
# india_fs_fig1.1 <- india_fs_fig1.1_data %>%
#   filter(name_1 %in% states_to_plot) %>%
#   ggplot() +
#   geom_sf(mapping = aes(fill = forcats::fct_reorder(lyl_bucket, order_lyl_bucket)), color = "transparent") +
#   geom_sf(data = india_state, color = "grey", fill = "transparent", lwd = 0.1) +
#   geom_sf(data = india_state %>% filter(NAME_1 %in% states_to_plot), color = "black", fill = "transparent", lwd = 0.8) +
#     geom_sf(data = india_fs_fig1.1_data %>% filter(name_2 == "Chennai"), color = "black", lwd = 1) +
#    ggthemes::theme_map() +
#     ggsflabel::geom_sf_label_repel(data = india_state %>% filter(NAME_1 %in% states_to_plot), mapping = aes(label = NAME_1), force = 50, nudge_x = -10, nudge_y = -1.6, seed = 10, size = 3.5) +
#    ggsflabel::geom_sf_label_repel(data = india_fs_fig1.1_data %>% filter(name_2 == "Chennai"), mapping = aes(label = name_2), force = 50, nudge_x = 3, seed = 10, size = 2.8) +
#   ggthemes::theme_map() + 
#  scale_fill_manual(values = c("0 - < 0.1 years" = "#FFFFFF", 
#                                "0.1 - 0.5" = "#FFE6B3", 
#                                "> 0.5 - 1" = "#FFD25D", 
#                                "> 1 - 2" = "#FFBA00", 
#                                "> 2 - 3" = "#FF9600", 
#                                "> 3 - 4" = "#FF6908", 
#                                "> 4 - 5" = "#E63D23", 
#                                "> 5 - < 6" = "#BD251C", 
#                                ">= 6" = "#8C130E")) +
#   labs(fill = "Life years lost  ", title = expression("Potential Gains in Life Expectancy through Permanently Reducing" ~ PM[2.5] ~ "from 2021 concentrations to the WHO guideline"), 
#        subtitle = "") + 
#  theme(legend.position = "bottom", 
#         legend.justification = c(0.5, 3), 
#         legend.background = element_rect(color = "black"), 
#         legend.text = element_text(size = 14),
#         legend.title = element_text(size = 15), 
#         plot.title = element_text(hjust = 0.5, size = 15), 
#        plot.subtitle = element_text(hjust = 0.5, size = 9, margin = margin(b = 0.5, unit = "cm")),
#        # legend.key = element_rect(color = "black"),
#        legend.box.margin = margin(b = 1, unit = "cm"),
#         plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
#        legend.key = element_rect(color = "black"), 
#        legend.box.spacing = unit(0, "cm"), 
#         legend.direction = "horizontal") +
#   guides(fill = guide_legend(nrow = 1)) 
#    
#    
# #> Fig 1.2: individual state wise maps
# 
# state <- "Jammu and Kashmir"
# two_states <- c("Jammu and Kashmir", "Azad Kashmir")
# 
# india_fs_fig1.2 <- india_fs_fig1.1_data %>%
#   filter(name_1 %in% two_states) %>%
#   ggplot() +
#   geom_sf(mapping = aes(fill = forcats::fct_reorder(lyl_bucket, order_lyl_bucket)), color = "black", lwd = 0.1) +
#       #geom_sf(data = india_fs_fig1.1_data %>% filter(name_2 == "Chennai"), color = "black", lwd = 1, fill = "transparent") +
#      #ggsflabel::geom_sf_label_repel(data = india_fs_fig1.1_data %>% filter(name_2 == "Chennai"), mapping = aes(label = name_2), force = 100, nudge_x = -1, nudge_y = 0.5, seed = 10, size = 2.8) +
#   #geom_sf(data = india_state, color = "lightgrey", fill = "transparent", lwd = 0.1) +
#   #geom_sf(data = india_state %>% filter(NAME_1 %in% state), color = "black", fill = "transparent", lwd = 0.8) +
#    ggthemes::theme_map() +
#     #ggsflabel::geom_sf_label_repel(data = india_state %>% filter(NAME_1 %in% states_to_plot), mapping = aes(label = NAME_1), force = 50, nudge_x = -10, nudge_y = -1.6, seed = 10, size = 4) +
#   ggthemes::theme_map() + 
#  scale_fill_manual(values = c("0 - < 0.1 years" = "#FFFFFF", 
#                                "0.1 - 0.5" = "#FFE6B3", 
#                                "> 0.5 - 1" = "#FFD25D", 
#                                "> 1 - 2" = "#FFBA00", 
#                                "> 2 - 3" = "#FF9600", 
#                                "> 3 - 4" = "#FF6908", 
#                                "> 4 - 5" = "#E63D23", 
#                                "> 5 - < 6" = "#BD251C", 
#                                ">= 6" = "#8C130E")) +
#   labs(fill = "Life years lost  ", title = expression("Potential Gains in Life Expectancy through Permanently Reducing" ~ PM[2.5] ~ "from 2021 concentrations to the WHO guideline"), 
#        subtitle = str_c("(", state, ")")) + 
#  theme(legend.position = "bottom", 
#         legend.justification = c(0.5, 3), 
#         legend.background = element_rect(color = "black"), 
#         legend.text = element_text(size = 14),
#         legend.title = element_text(size = 15), 
#         plot.title = element_text(hjust = 0.5, size = 15, margin = margin(b = 0.3, unit = "cm")), 
#        plot.subtitle = element_text(hjust = 0.5, size = 14, margin = margin(b = 0.8, unit = "cm")),
#        # legend.key = element_rect(color = "black"),
#        legend.box.margin = margin(b = 1, unit = "cm"),
#         plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
#        legend.key = element_rect(color = "black"), 
#        legend.box.spacing = unit(0, "cm"), 
#         legend.direction = "horizontal") +
#   guides(fill = guide_legend(nrow = 1)) 

#====================================================================================================================

#> Fig 2: Potential gain in life expectancy in top 10 most populous states in India----------

india_fs_fig2_data <- gadm_level_summary(gadm2_aqli_2021, c("country", "name_1"), c(2021),  10) %>%
  filter(country == "India") %>% 
  slice_max(population, n = 10) %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021")


india_fs_fig2_data$lyl_bucket <- as.factor(india_fs_fig2_data$lyl_bucket)

india_fs_fig2_plt <- india_fs_fig2_data %>%
  ggplot() +
   geom_col(mapping = aes(x = forcats::fct_reorder(name_1, llpp_who_2021), y = llpp_who_2021, fill = lyl_bucket), width = 0.5) +
  labs(x = "State", y = "Potential Gain in Life Expectancy (Years)",
       title = "",
       subtitle = "", 
       caption = "", 
       fill = "Potential gain in life expectancy (Years)") +
  scale_y_continuous(breaks = seq(0, 9, 1), limits = c(0, 9)) +
 scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  coord_flip() +
  ggthemes::theme_tufte() +
  themes_aqli_base +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5, size = 16), 
        plot.subtitle = element_text(hjust =  0.5, size = 10, face = "italic", margin = margin(b = 0.8, unit = "cm")), 
        plot.caption = element_text(size = 8, hjust = 0, face = "italic"),
        axis.line = element_line(), 
        axis.text = element_text(size = 11), 
        axis.title = element_text(size = 13), 
        axis.title.y = element_text(margin = margin(r = 0.7, unit = "cm")), 
        axis.title.x = element_text(margin = margin(t = 0.6, b = 0.6, unit = "cm")), 
        axis.ticks = element_blank(),
        plot.background = element_rect(fill = "white", color = "white")) 


#> GBD India graph--------------------------------------------

# top 5 most deadly diseases
india_fs_fig3_dataset <- gbd_results_master_2021 %>%
  filter(country == "India") %>%
  slice_max(lyl, n = 5)

colnames(india_fs_fig3_dataset)[3] <- c("llpp_who_2021")

india_fs_fig3_dataset <- india_fs_fig3_dataset %>%
add_aqli_color_scale_buckets("lyl", "llpp_who_2021")


#> figure 3 plot

# figure 3 caption removed: Source: Global Burden of Disease (https://vizhub.healthdata.org/gbd-results/) causes and risks data and WHO Life Tables (https://apps.who.int/gho/data/node.main.LIFECOUNTRY?lang=en) were used combined with the Life table method to arrive at these results. 'PM2.5 relative to WHO Guideline' bar displays life years lost relative to the WHO guideline as calculated by latest AQLI (2021) data, which will be published in September 2023.

india_fs_fig3 <- india_fs_fig3_dataset %>%
  ggplot() + 
  geom_col(mapping = aes(x = forcats::fct_reorder(cause_of_death, llpp_who_2021), y = llpp_who_2021, fill = forcats::fct_reorder(lyl_bucket, order_lyl_bucket)), width = 0.4, color = "black") +
  labs(x = "Threats to Life Expectancy", y = "Life Years Lost", fill = "Life years lost", 
       title = expression("")) +
  coord_flip() + 
  ggthemes::theme_tufte() +
  themes_aqli_base +
  theme(legend.position = "bottom",
        axis.text = element_text(size = 14),
        axis.title.y = element_text(size = 16, margin = margin(r = 0.6, unit = "cm")),
        axis.title.x = element_text(size = 16, margin = margin(t = 0.6, b = 0.6, unit = "cm")),
        plot.caption = element_text(hjust = 0, size = 8, margin = margin(t = 0.8, unit = "cm")),
        plot.title = element_text(hjust = 0.5, size = 20, margin = margin(b = 0.8, unit = "cm")),
        plot.subtitle = element_text(hjust = 0.5, size = 10, margin = margin(b = 0.8, unit = "cm")),
        legend.box.background = element_rect(color = "black"),
        axis.line = element_line(), 
        legend.text = element_text(size = 11), 
        legend.title = element_text(size = 14),
        panel.grid.major.y = element_blank(), 
        plot.background = element_rect(fill = "white", color = "white")) +
  scale_y_continuous(breaks = seq(0, 6, 0.5)) +
 # scale_x_discrete(limits = cause_of_death_ordered[seq(1, length(cause_of_death_ordered), by = 2)]) +
 scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) + 
  guides(fill = guide_legend(nrow = 1)) 

svglite("india_fs_fig3")
ggsave("./september.2023/factsheets/india/fig3/india_fs_fig3.svg", width = 15, height = 12)

india_fs_fig3_dataset %>%
   write_csv("./september.2023/factsheets/india/fig3/india_fs_fig3_data.csv")


#> Figure 4: Average PM2.5 concentration in India from 1998 to 2021------------------------

# adding a north India/rest of india region column (specifically Indo gangetic plain)
north_india <- c("West Bengal", "Uttar Pradesh", "Punjab", "Haryana", 
                 "Chandigarh", "Bihar", "NCT of Delhi")

india_fs_fig4_data_part1 <- gadm2_aqli_2021 %>%
  filter(country == "India", !is.na(population)) %>%
  mutate(region = ifelse(name_1 %in% north_india, "Northern Plains of India", "All other regions (excluding Northern Plains of India)"))


# creating India's region wise average PM2.5 data from 1998 to 2021 
india_fs_fig4_data_part1 <- india_fs_fig4_data_part1 %>%
  group_by(region) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2021_weighted, names_to = "years", 
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+")))) %>%
  select(years, region, pop_weighted_avg_pm2.5)

# creating a national average PM2.5 trendlines data from 1998 to 2021
india_fs_fig4_data_part2 <- gadm2_aqli_2021 %>%
  filter(country == "India") %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2021_weighted, names_to = "years", 
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+"))), 
         region = "National Average") %>% 
  select(years, region, pop_weighted_avg_pm2.5)

# India factsheet figure 4 dataset
india_fs_fig4_data <- rbind(india_fs_fig4_data_part1, india_fs_fig4_data_part2)

india_fs_fig4_data %>%
   write_csv("./september.2023/factsheets/india/fig4/india_fs_fig4_data.csv")

# India factsheet figure 4
# fig4 caption removed: "* We define the Indo-Gangetic plain region as containing the following seven states and union territories: Bihar, Chandigarh, NCT of Delhi, Haryana, Punjab, Uttar Pradesh, and West Bengal."

india_fs_fig4_data$region <- factor(india_fs_fig4_data$region, levels = c("Northern Plains of India", "National Average", "All other regions (excluding Northern Plains of India)"))

india_fs_fig4 <- ggplot(india_fs_fig4_data) +
  geom_line(mapping = ggplot2::aes(x = years, y = pop_weighted_avg_pm2.5, color = interaction(region), linetype = interaction(region)), lwd = 1.3) +
    geom_hline(mapping = aes(yintercept = 5), lwd = 0.8, linetype = "dotted") +
  scale_y_continuous(breaks = seq(0, 100, 10), limits = c(0, 100)) +
  scale_x_continuous(breaks = c(seq(1998, 2019, 3), 2021)) +
    scale_color_manual(values = c("Northern Plains of India" = "#1a1638", "National Average" =  "#3c456f", "All other regions (excluding Northern Plains of India)" = "#4e5e8b"), name = "legend") +
   scale_linetype_manual(values = c("Northern Plains of India" = "dashed", "National Average" = "solid", "All other regions (excluding Northern Plains of India)" = "dotted"), name = "legend")  +
  ggthemes::theme_hc() +
  labs(x = "Year", 
       y = expression("Annual Average   " ~ PM[2.5] ~ " Concentration (in µg/m³)"), 
       title = "") +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 11),
        legend.title = element_blank(),
        axis.title.y = element_text(size = 13, margin = margin(r = 0.6, unit = "cm")), 
        axis.title.x = element_text(size = 13, margin = margin(t = 0.6, b = 0.6, unit = "cm")), 
        axis.line = element_line(), 
        legend.box.background = element_rect(color = "black"),
        plot.title = element_text(hjust = 0.5, size = 16, margin = margin(b = 0.7, unit = "cm")), 
        plot.subtitle = element_text(hjust = 0.5, size = 8, face = "italic"), 
        plot.caption = element_text(size = 7, margin = margin(t = 0.8, unit = "cm"), hjust = 0, face = "italic"),
        axis.text = element_text(size = 12), 
        plot.background = element_rect(color = "white"), 
        axis.ticks = element_blank(), 
        legend.key.width = unit(1.5, "cm")) +
     geom_text(x = 2000.5, y = 7.6, label = expression("WHO" ~ PM[2.5] ~ "Guideline (last updated: 2021): 5 µg/m³"), size = 4.5) 


svglite("india_fs_fig4")
ggsave("./september.2023/factsheets/india/india_fs_fig4.svg", width = 12, height = 9)


# Appendix table

appendix_table_raw_india <- gadm_level_summary(gadm2_aqli_2021, c("country", "name_1"), c(2021), 10) %>%
filter(country == "India") %>%
   mutate(population_lakhs = round(population/100000, 1)) %>%
  select(name_1, population_lakhs, pm2021, llpp_who_2021, llpp_nat_2021) %>%
  rename("State/UT" = name_1, 
         "Population (Lakhs)" = population_lakhs, 
         "Annual Average 2021 PM2.5 Concentration (µg/m³)" = pm2021, 
         "Life Expectancy Gains from reducing PM2.5 from 2021 concentration to WHO PM2.5 guideline of 5 µg/m³" = llpp_who_2021, 
         "Life Expectancy Gains from reducing PM2.5 from 2021 concentration to National PM2.5 guideline of 40 µg/m³" = llpp_nat_2021)
```


# South Korea factsheet

```{r}

#> quick stats

# South Korea ranking amongst other countries in terms of pollution
gadm_level_summary(gadm2_aqli_2021, c("country"), c(2021), 10) %>%
  slice_max(pm2021, n = 50) %>%
  View()

# most populated region
gadm_level_summary(gadm2_aqli_2021, c("country", "name_1"), c(2021), 10) %>%
  filter(country == "South Korea") %>%
  slice_max(population, n = 10)

#> plot 1: map screenshot for South Korea

# south korea figure1 dataset
south_korea_fs_fig1_data <- gadm2_aqli_2021 %>%
  filter(country == "South Korea") %>%
  left_join(gadm2_aqli_2021_shp, by = c("objectid_gadm2" = "obidgadm2")) %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021") %>%
  select(-geometry, geometry) %>%
  st_as_sf()




# south korea figure 1
south_korea_fs_fig1 <- south_korea_fs_fig1_data %>%
  ggplot() +
  geom_sf(mapping = aes(fill = forcats::fct_reorder(lyl_bucket, order_lyl_bucket)), color = "aliceblue", lwd = 0.05) +
  geom_sf(data = gadm1_aqli_2021_shp %>% filter(name0 == "South Korea"), color = "azure4", fill = "transparent", lwd = 0.15) +
  geom_sf(data = gadm0_aqli_2021_shp %>% filter(name0 == "South Korea"), color = "cornsilk", fill = "transparent", lwd = 0.5) +
  ggthemes::theme_map() + 
scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  ggthemes::theme_map() +
  labs(fill = "Potential gain in life expectancy (Years) ", title = "") + 
 theme(legend.position = "bottom", 
        legend.justification = c(0.5, 3), 
        legend.background = element_rect(color = "black"), 
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15), 
        plot.title = element_text(hjust = 0.5, size = 15), 
       # legend.key = element_rect(color = "black"),
       legend.box.margin = margin(b = 1, unit = "cm"),
        plot.subtitle = element_text(hjust = 0.5, size = 7), 
        plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
       legend.key = element_rect(color = "black"), 
       legend.box.spacing = unit(0, "cm"), 
        legend.direction = "horizontal", 
       plot.background = element_rect(fill = "white", color = "white")) +
  guides(fill = guide_legend(nrow = 1))

ggsave("./september.2023/factsheets/southkorea/sk_fs_fig1.svg", width = 15, height = 10)

#> plot 2: Gain in LE in reducing 2021 pollution to WHO guideline in top 10 most populous regions

# fig2 dataset
southkorea_fs_fig2_dataset <- gadm2_aqli_2021 %>%
  filter(country == "South Korea") %>%
  add_aqli_color_scale_buckets(scale_type = "lyl", col_name = "llpp_who_2021") %>%
  slice_max(population, n = 10)

southkorea_fs_fig2_dataset %>%
   write_csv("./september.2023/factsheets/southkorea/fig2/sk_fs_fig2_data.csv")


# fig 2

south_korea_fs_fig2 <- southkorea_fs_fig2_dataset %>%
  aqli_bar(scale_type = "lyl", x_var = "name_2", y_var = "llpp_who_2021", title = "", subtitle = "", x_label = "Region", y_label = "Potential Gain in Life Expectancy (Years)", legend_title = "Potential gain in life expectancy (Years)", caption = "") +
  theme(plot.background = element_rect(fill = "white", color = "white"))
 
# plot 3: Trendlines: 1998 to 2021

# southkorea factsheet figure 3 dataset
southkorea_fs_fig3_dataset <- gadm2_aqli_2021 %>%
  filter(country == "South Korea", !is.na(population)) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2021_weighted, names_to = "years", 
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+"))), 
         region = "National Average") %>% 
  select(years, region, pop_weighted_avg_pm2.5)


southkorea_fs_fig3_dataset %>%
   write_csv("./september.2023/factsheets/southkorea/fig3/sk_fs_fig3_data.csv")


  southkorea_fs_fig3 <- southkorea_fs_fig3_dataset %>%
    ggplot() +
  geom_line(mapping = ggplot2::aes(x = years, y = pop_weighted_avg_pm2.5), lwd = 1.1, 
            color = "#7197be") +
    geom_hline(mapping = aes(yintercept = 5), lwd = 0.8, linetype = "dashed") +
    geom_hline(mapping = aes(yintercept = 15), lwd = 0.8, linetype = "dashed") + 
  scale_y_continuous(breaks = seq(0, 35, 5), limits = c(0, 35)) +
  scale_x_continuous(breaks = c(seq(1998, 2019, 3), 2021)) +
    scale_color_manual(values = c("National Average" = "#7197be")) +
  ggthemes::theme_clean() +
    themes_aqli_base +
  labs(x = "Year", 
       y = expression("Annual Average  " ~ PM[2.5] ~ "Concentration (in µg/m³)"), 
       title = "") +
  theme(legend.position = "bottom", legend.title = element_blank(), 
        plot.background = element_rect(fill = "white", color = "white")) +  
    geom_text(x = 2001.8, y = 6.1, label =  expression("WHO " ~ PM[2.5] ~ "Guideline (last updated in 2021): 5 µg/m³"), size = 5) +
    geom_text(x = 2001.2, y = 16.1, label = expression("South Korea National" ~ PM[2.5] ~ "Standard: 15 µg/m³"), size = 5) 
  
  
  ggsave("./september.2023/factsheets/southkorea/fig3/sk_fs_fig3.svg", width = 15, height = 10)



  # appendix table (gadm level 2)
  gadm2_aqli_2021 %>%
    filter(country == "South Korea") %>%
    select(name_2, population, pm2021, llpp_who_2021, llpp_nat_2021) %>%
    mutate(pop_millions = round(population/1000000, 1), 
           pm2021 = round(pm2021, 1), 
           llpp_who_2021 = round(llpp_who_2021, 1), 
           llpp_nat_2021 = round(llpp_nat_2021, 1)) %>%
    slice_max(population, n = 25) %>% 
    select(name_2, pop_millions, pm2021, llpp_who_2021, llpp_nat_2021) %>%
    rename(`Population (Millions)` = pop_millions, 
           "Region" = name_2, 
           "PM2.5 concentration 2021 (in µg/m³)" = pm2021, 
           "Life Expectancy Gains from reducing PM2.5 from 2021 Concentrations to the National Guideline of 15 µg/m³" = llpp_nat_2021, 
           "Life Expectancy Gains from reducing PM2.5 from 2021 Concentrations to the WHO Guideline of 5 µg/m³" = llpp_who_2021) %>% 
    write_csv("./[updatedOnJune072023]South Korea Factsheet 2023 appendix table.csv")
    

```

# China factsheet

```{r}

# sanity checks

# total life years lost for regions out of compliance with China's national standard
tmp_data <- gadm_level_summary(gadm2_aqli_2021, c("country", "name_1", "name_2"), c(2021), 10) %>%
  filter(country == "China") %>%
  filter(pm2021 > 5) 

tmp_data %>%
  gadm_level_summary(c("country"), c(2021), 10) %>%
  View()

#> plot 1: map screenshot--------------------

# china figure1 dataset
china_fs_fig1_data <- gadm2_aqli_2021 %>%
  filter(country == "China") %>%
  left_join(gadm2_aqli_2021_shp, by = c("objectid_gadm2" = "obidgadm2")) %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021") %>%
  select(-geometry, geometry) %>%
  st_as_sf()

# china_fs_fig1_data %>%
#   sf::write_sf("./september.2023/factsheets/southkorea/fig1/sk_fs_fig1.shp")


# china figure 1
china_fs_fig1 <- china_fs_fig1_data %>%
  ggplot() +
  geom_sf(mapping = aes(fill = forcats::fct_reorder(lyl_bucket, order_lyl_bucket)), color = "lightgrey", lwd = 0.05) +
 geom_sf(data = gadm1_aqli_2021_shp %>% filter(name0 == "China"), color = "black", fill = "transparent", lwd = 0.5) +
  ggthemes::theme_map() + 
 scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  ggthemes::theme_map() +
  labs(fill = "Potential gain in life expectancy (Years) ", title = "") + 
 theme(legend.position = "bottom", 
        legend.justification = c(0.5, 3), 
        legend.background = element_rect(color = "black"), 
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15), 
        plot.title = element_text(hjust = 0.5, size = 15), 
       # legend.key = element_rect(color = "black"),
       legend.box.margin = margin(b = 1, unit = "cm"),
        plot.subtitle = element_text(hjust = 0.5, size = 7), 
        plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
       legend.key = element_rect(color = "black"), 
       legend.box.spacing = unit(0, "cm"), 
        legend.direction = "horizontal", 
       plot.background = element_rect(fill = "white", color = "white")) +
  guides(fill = guide_legend(nrow = 1))


#> china fs fig 2 (difference between 2014 and 2021): LYL (experimental figure)-------------------------


# china figure1.1 dataset
china_fs_fig2_data <- gadm2_aqli_2021 %>%
  filter(country == "China") %>%
  mutate(lyl2014minus2021 = round((pm2014 - pm2021)*0.098, 1)) %>%
  add_aqli_color_scale_buckets(scale_type = "lyldiff", col_name = "lyl2014minus2021") %>%
  left_join(gadm2_aqli_2021_shp, by = c("objectid_gadm2" = "obidgadm2")) %>%
  select(-geometry, geometry) %>%
  st_as_sf()


# china figure 2
china_fs_fig2 <- china_fs_fig2_data %>%
  ggplot() +
  geom_sf(mapping = aes(fill = forcats::fct_reorder(lyldiff_bucket, order_lyldiff_bucket)), color = "aliceblue", lwd = 0.05) +
 geom_sf(data = gadm1_aqli_2021_shp %>% filter(name0 == "China"), color = "azure4", fill = "transparent", lwd = 0.15) +
   geom_sf(data = gadm0_aqli_2021_shp %>% filter(name0 == "China"), color = "cornsilk", fill = "transparent", lwd = 0.5) +
  ggthemes::theme_map() + 
 scale_fill_manual(values = c("< -2" = "#d73027", 
                               "-2 to (< -0.5)" = "#f46d43", 
                               "-0.5 to (< -0.1)" = "#fdae61", 
                               "-0.1 to (< 0)" = "#fee090", 
                               "0 to (< 0.1)" = "#e0f3f8", 
                               "0.1 to (< 0.5)" = "#abd9e9", 
                               "0.5 to (< 2)" = "#74add1", 
                               ">= 2" = "#4575b4")) +
  ggthemes::theme_map() +
  labs(fill = "Change in potential gains in life expectancy between 2014 and 2021 (Years)", title = "") + 
 theme(legend.position = "bottom", 
        legend.justification = c(0.5, 3), 
        legend.background = element_rect(color = "black"), 
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15), 
        plot.title = element_text(hjust = 0.5, size = 15), 
       # legend.key = element_rect(color = "black"),
       legend.box.margin = margin(b = 1, unit = "cm"),
        plot.subtitle = element_text(hjust = 0.5, size = 7), 
        plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
       legend.key = element_rect(color = "black"), 
       legend.box.spacing = unit(0, "cm"), 
        legend.direction = "horizontal", 
       plot.background = element_rect(fill = "white", color = "white")) +
  guides(fill = guide_legend(nrow = 1))




#> plot 3: Potential Gain in Life Expectancy from Reducing PM2.5 from 2021 to the WHO Guideline in 10 most populous regions of China -----------------------------------------

china_fs_fig3_dataset <- gadm2_aqli_2021 %>%
  filter(country == "China") %>%
  add_aqli_color_scale_buckets(scale_type = "lyl", col_name = "llpp_who_2021") %>%
  slice_max(population, n = 10)

china_fs_fig3 <- china_fs_fig3_dataset %>%
  aqli_bar(scale_type = "lyl", x_var = "name_2", y_var = "llpp_who_2021", title = "", subtitle = "", x_label = "Prefecture", y_label = "Potential Gain in Life Expectancy (Years)", legend_title = "Potential gain in life expectancy (Years)", caption = "") + 
  theme(plot.background = element_rect(fill = "white", color = "white"))



#> plot 4: GBD----------------------------------------- 

# top 5 most deadly diseases
china_fs_fig4_dataset <- gbd_results_master_2021 %>%
  filter(country == "China") %>%
  slice_max(lyl, n = 5)

colnames(china_fs_fig4_dataset)[3] <- c("llpp_who_2021")

china_fs_fig4_dataset <- china_fs_fig4_dataset %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021")


# getting disease (ordered from most deadly to least deadly) in a vector (to be used later in the
# scale_x_discrete function).

# cause_of_death_ordered <- india_fs_fig3_dataset %>%
#   arrange(llpp_who_2021) %>%
#   pull(cause_of_death) %>%
#   unlist()





#> figure 4 plot

china_fs_fig4 <- china_fs_fig4_dataset %>%
  ggplot() + 
  geom_col(mapping = aes(x = forcats::fct_reorder(cause_of_death, llpp_who_2021), y = llpp_who_2021, fill = forcats::fct_reorder(lyl_bucket, order_lyl_bucket)), width = 0.4, color = "black") +
  labs(x = "Threats to Life Expectancy", y = "Life Years Lost", fill = "Life years lost", 
       title = "") +
  coord_flip() + 
  ggthemes::theme_tufte() +
  themes_aqli_base +
  theme(legend.position = "bottom",
        axis.text = element_text(size = 14),
        axis.title.y = element_text(size = 16, margin = margin(r = 0.6, unit = "cm")),
        axis.title.x = element_text(size = 16, margin = margin(t = 0.6, b = 0.6, unit = "cm")),
        plot.caption = element_text(hjust = 0, size = 8, margin = margin(t = 0.8, unit = "cm")),
        plot.title = element_text(hjust = 0.5, size = 20, margin = margin(b = 0.8, unit = "cm")),
        plot.subtitle = element_text(hjust = 0.5, size = 10, margin = margin(b = 0.8, unit = "cm")),
        legend.box.background = element_rect(color = "black"),
        axis.line = element_line(), 
        legend.text = element_text(size = 11), 
        legend.title = element_text(size = 14),
        panel.grid.major.y = element_blank(), 
        plot.background = element_rect(fill = "white", color = "white")) +
  scale_y_continuous(breaks = seq(0, 7, 1)) +
 # scale_x_discrete(limits = cause_of_death_ordered[seq(1, length(cause_of_death_ordered), by = 2)]) +
 scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) + 
  guides(fill = guide_legend(nrow = 1)) 




#> plot 5: PM2.5 Concentrations in Major Regions in Mainland China Over Time (1998 to 2021)-----------------

# filtering the color file for China
color_2021_china <- gadm2_aqli_2021 %>%
  filter(country == "China", !is.na(population))

# BTH region (name_1)
bth_region <- c("Beijing", "Tianjin", "Hebei")

# YRD (name_1)
yrd_region <- c("Shanghai", "Jiangsu", "Zhejiang")

# PRD (name_1, name_2)

prd_region_name_2_guandong_regions <- c("Dongguan", "Foshan", "Guangzhou", 
                                        "Huizhou", "Jiangmen", "Shenzhen", 
                                        "Zhaoqing", "Zhongshan", "Zhuhai")

prd_region_name_1 <- c("Hong Kong", "Macau")

prd <- c(prd_region_name_2_guandong_regions, prd_region_name_1)


# add region column
color_2021_china  <- color_2021_china %>%
  mutate(region = ifelse(name_1 %in% bth_region, "BTH", "others"), 
         region = ifelse(name_1 %in% yrd_region,  "YRD", region), 
         region = ifelse(name_1 %in% prd_region_name_1, "PRD", region), 
         region = ifelse(name_2 %in% prd_region_name_2_guandong_regions, "PRD", region)) 


# China factsheet figure 3 (part-1): trend lines figure region wise (BTH, YRD, PRD) dataset
trendlines_china_region_wise_df <- color_2021_china %>%
  group_by(region) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>% 
  pivot_longer(cols = pm1998_weighted:pm2021_weighted, names_to = "years", 
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+")))) %>%
  select(years, region, pop_weighted_avg_pm2.5) %>%
  filter(region %in% c("YRD", "BTH", "PRD"))

# China factsheet figure 3 (part-2): trend line national average dataset
trendline_national_avg_df <- color_2021_china %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2021_weighted, names_to = "years", 
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+"))), 
         region = "China") %>% 
  select(years, region, pop_weighted_avg_pm2.5)

# China factsheet figure 3 dataset final
china_fs_fig5_dataset <- rbind(trendlines_china_region_wise_df, trendline_national_avg_df)

china_fs_fig5_dataset <-  china_fs_fig5_dataset %>%
    mutate(region_order = ifelse(region == "China", 1, NA), 
         region_order = ifelse(region == "PRD", 2, region_order), 
         region_order = ifelse(region == "YRD", 3, region_order), 
         region_order = ifelse(region == "BTH", 4, region_order))

# save China factsheet figure 3 dataset
# china_fs_fig3_dataset %>%
#   write_csv("./june.2022/factsheets/china/graph.wise.datasets/china_fs_fig3.csv")

china_fs_fig5_dataset$region <- factor(china_fs_fig5_dataset$region, levels = c("BTH", "China", "YRD", "PRD"))

# plot china factsheet figure 3
china_fs_fig5 <- china_fs_fig5_dataset %>%
  ggplot() +
  geom_line(mapping = ggplot2::aes(x = years, y = pop_weighted_avg_pm2.5, color = interaction(region), 
                                   linetype = interaction(region)), lwd = 1.1) +
    geom_hline(mapping = aes(yintercept = 5), lwd = 0.5, linetype = "dashed") +
    geom_vline(mapping = aes(xintercept = 2014), lwd = 0.5, linetype = "dashed") +
  scale_y_continuous(breaks = seq(0, 100, 10), limits = c(0, 100)) +
  scale_x_continuous(breaks = c(seq(1998, 2020, 2), 2021)) +
    scale_color_manual(values = c("PRD" = "#7197be", "China" = "#5f7aa5", "BTH" = "#5f7aa5", "YRD" = "#7197be"), name = "legend") +
    scale_linetype_manual(
    values = c("PRD" = "dashed", "China" = "solid", "BTH" = "dashed", "YRD" = "dashed"), name = "legend") +
  ggthemes::theme_clean() +
    themes_aqli_base +
  labs(x = "Year", 
       y = expression("Annual Average  " ~ PM[2.5] ~ " Concentration (in µg/m³)"), 
       title = "", 
    subtitle = "", 
    color = "Region") +
  theme(legend.position = "bottom", legend.title = element_blank(), 
        plot.background = element_rect(fill = "white", color = "white"), 
        legend.key.width = unit(2, "cm")) + 
    geom_text(x = 2001, y = 8.1, label = expression("WHO" ~ PM[2.5] ~ "Guideline (last updated: 2021): 5 µg/m³")) + 
    geom_text(x = 2015.3, y = 92.8, label = str_wrap("China announces war on pollution", width = 18)) 




#> appendix table-------------------------------

china_fs_appendix_table <- gadm2_aqli_2021 %>%
gadm_level_summary(c("country", "name_1", "name_2"), c(2014, 2021), 10) %>%
  filter(country == "China") %>%
  slice_max(population, n = 25) %>%
  mutate(pop_millions = round(population/1000000, 1), 
         le_gain_2014_to_2021 = round((pm2014 - pm2021)*0.098, 1)) %>%
  select(name_2, pop_millions, pm2021, le_gain_2014_to_2021,
         llpp_who_2021, llpp_nat_2021) %>%
  rename(Prefecture = name_2, `Population (Millions)` = pop_millions, 
         `PM2.5 concentration 2021 (µg/m³)` = pm2021, 
         `Life Expectancy Gains from reducing PM2.5 from 2014 concentrations to 2021 concentrations` = le_gain_2014_to_2021,
         `Life Expectancy Gains from reducing PM2.5 concentrations from 2021 Concentration to the WHO Guideline of 5 µg/m³` = llpp_who_2021, 
         `Life Expectancy Gains from reducing PM2.5 concentrations from 2021 Concentration to the National Standard of 35 µg/m³` = llpp_nat_2021)

china_fs_appendix_table %>% 
  write_csv("[June082023]china_fs_appendix_table.csv")


```


# North India Fact Sheet 2023

```{r}

# Filtering color dataset for India
color_2021_india <- gadm2_aqli_2021 %>%
  filter(country == "India") 

# adding a north India/rest of india region column (specifically Indo gangetic plain)
north_india <- c("West Bengal", "Uttar Pradesh", "Punjab", "Haryana", 
                 "Chandigarh", "Bihar", "NCT of Delhi")

# adding North India column
color_2021_india <- color_2021_india %>%
  mutate(region = ifelse(name_1 %in% north_india, "Northern plains of India", "All other regions (excluding Northern plains of India)"))

# quick stats
foo <- color_2021_india %>%
  filter(region == "Northern plains of India") %>%
  gadm_level_summary(c("country"), c(2021, 1998), 10)

# north india
gadm2_aqli_2021 %>%
  slice_max(pm2021, n = 90) %>%
  filter(region == "Northern plains of India") %>%
  slice_max(pm2021, n = 10)


# plot 1: 2 regions map (North India, All other regions)
plt <- india_state %>%
    mutate(region = ifelse(NAME_1 %in% north_india, "Northern Plains of India", "Other States and UTs")) %>%
    select(-geometry, geometry) %>%
    st_as_sf() %>%
    ggplot() +
    geom_sf(mapping = aes(fill = region), lwd = 0.8) +
    scale_fill_manual(values = c("Northern Plains of India" = "slategray2", "Other States and UTs" = "lightgrey")) +
      labs(fill = "") + 
  ggthemes::theme_tufte() +
  theme(legend.position = "bottom", 
        legend.text = element_text(size = 13),
        axis.line = element_blank(), 
        axis.ticks = element_blank(), 
        axis.text = element_blank(), 
        plot.background = element_rect(fill = "white", color = "white"))
  

   
#> plot 2: AQLI map screenshot (I have limited this to the Indo-Gangetic plain as opposed to the current screenshot that shows it for all of India)------------------


#> plot 2: map screenshot--------------------

# north india figure1 dataset
north_india_fs_fig1_data <- gadm2_aqli_2021 %>%
  filter(country == "India", name_1 %in% north_india) %>%
  left_join(gadm2_aqli_2021_shp, by = c("objectid_gadm2" = "obidgadm2")) %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021") %>%
  select(-geometry, geometry) %>%
  st_as_sf()



# north india figure 2
north_india_fs_fig1 <- north_india_fs_fig1_data %>%
  ggplot() +
  geom_sf(mapping = aes(fill = forcats::fct_reorder(lyl_bucket, order_lyl_bucket)), color = "lightgrey", lwd = 0.05) +
 geom_sf(data = gadm1_aqli_2021_shp %>% filter(name0 == "India", name1 %in% north_india), color = "black", fill = "transparent", lwd = 0.5) +
  ggthemes::theme_map() +
   scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  ggthemes::theme_map() +
  labs(fill = "Potential gain in life expectancy (Years) ", title = "") + 
 theme(legend.position = "bottom", 
        legend.justification = c(0.5, 3), 
        legend.background = element_rect(color = "black"), 
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15), 
        plot.title = element_text(hjust = 0.5, size = 15), 
       # legend.key = element_rect(color = "black"),
       legend.box.margin = margin(b = 1, unit = "cm"),
        plot.subtitle = element_text(hjust = 0.5, size = 7), 
        plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
       legend.key = element_rect(color = "black"), 
       legend.box.spacing = unit(0, "cm"), 
        legend.direction = "horizontal", 
       plot.background = element_rect(fill = "white", color = "white")) +
  guides(fill = guide_legend(nrow = 1)) +
   ggsflabel::geom_sf_label_repel(data = gadm1_aqli_2021_shp %>% filter(name0 == "India", name1 %in% north_india), mapping = aes(label = name1), force = 50, nudge_x = 3, seed = 10, size = 4)

  
  
  
  
#> plot 3: potential gain in life expectancy in 10 most populous districts of the Indo-Gangetic plains----------------

# fig3 dataset
north_india_fs_fig3_dataset <- gadm2_aqli_2021 %>%
  filter(country == "India", name_1 %in% north_india) %>%
  add_aqli_color_scale_buckets(scale_type = "lyl", col_name = "llpp_who_2021") %>%
  slice_max(population, n = 10)


# fig 3

north_india_fs_fig3 <- north_india_fs_fig3_dataset %>%
  aqli_bar(scale_type = "lyl", x_var = "name_2", y_var = "llpp_who_2021", title = "", subtitle = "", x_label = "District", y_label = "Potential Gain in Life Expectancy (Years)", legend_title = "Potential gain in life expectancy (Years)", caption = "") +
  scale_y_continuous(breaks = seq(0, 12, 2)) +
  theme(plot.background = element_rect(fill = "white", color = "white"))
 

  
  

#> plot 4: Trend lines graph comparing Indo-Gangetic plains and all other regions in India-------------

# adding a north India/rest of india region column (specifically Indo gangetic plain)
north_india <- c("West Bengal", "Uttar Pradesh", "Punjab", "Haryana", 
                 "Chandigarh", "Bihar", "NCT of Delhi")

north_india_fs_fig4_data_part1 <- gadm2_aqli_2021 %>%
  filter(country == "India") %>%
  mutate(region = ifelse(name_1 %in% north_india, "Northern Plains of India", "All other regions (excluding Northern Plains of India)"))


# creating India's region wise average PM2.5 data from 1998 to 2021 
north_india_fs_fig4_data_part1 <- north_india_fs_fig4_data_part1 %>%
  group_by(region) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2021_weighted, names_to = "years", 
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+")))) %>%
  select(years, region, pop_weighted_avg_pm2.5)

# creating a national average PM2.5 trendlines data from 1998 to 2021
north_india_fs_fig4_data_part2 <- gadm2_aqli_2021 %>%
  filter(country == "India") %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2021_weighted, names_to = "years", 
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+"))), 
         region = "National Average") %>% 
  select(years, region, pop_weighted_avg_pm2.5)

# India factsheet figure 4 dataset
north_india_fs_fig4_data <- rbind(north_india_fs_fig4_data_part1, north_india_fs_fig4_data_part2)


# India factsheet figure 4
# fig4 caption removed: "* We define the Indo-Gangetic plain region as containing the following seven states and union territories: Bihar, Chandigarh, NCT of Delhi, Haryana, Punjab, Uttar Pradesh, and West Bengal."

north_india_fs_fig4_data$region <- factor(north_india_fs_fig4_data$region, levels = c("Northern Plains of India", "National Average", "All other regions (excluding Northern Plains of India)"))

north_india_fs_fig4 <- ggplot(north_india_fs_fig4_data) +
  geom_line(mapping = ggplot2::aes(x = years, y = pop_weighted_avg_pm2.5, color = region, linetype = region), lwd = 1.1) +
    geom_hline(mapping = aes(yintercept = 5), lwd = 0.8, linetype = "dotted") +
  scale_y_continuous(breaks = seq(0, 100, 10), limits = c(0, 100)) +
  scale_x_continuous(breaks = c(seq(1998, 2019, 3), 2021)) +
    scale_color_manual(values = c("Northern Plains of India" = "#1a1638", "National Average" = "#3c456f", "All other regions (excluding Northern Plains of India)" = "#4e5e8b")) +
  ggthemes::theme_tufte() +
  scale_linetype_manual(values = c("Northern Plains of India" = "dashed", "National Average" = "solid", "All other regions (excluding Northern Plains of India)" = "dotted")) +
  labs(x = "Year", 
       y = expression("Annual Average  " ~ PM[2.5] ~ " Concentration (in µg/m³)"), 
       title = "") +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 11),
        legend.title = element_blank(),
        axis.title.y = element_text(size = 13, margin = margin(r = 0.6, unit = "cm")), 
        axis.title.x = element_text(size = 13, margin = margin(t = 0.6, b = 0.6, unit = "cm")), 
        axis.line = element_line(), 
        legend.box.background = element_rect(color = "black"),
        plot.title = element_text(hjust = 0.5, size = 16, margin = margin(b = 0.7, unit = "cm")), 
        plot.subtitle = element_text(hjust = 0.5, size = 8, face = "italic"), 
        plot.caption = element_text(size = 7, margin = margin(t = 0.8, unit = "cm"), hjust = 0, face = "italic"),
        axis.text = element_text(size = 12), 
        plot.background = element_rect(color = "white"), 
        axis.ticks = element_blank(), 
        legend.key.width = unit(2, "cm")) +
     geom_text(x = 2000.5, y = 7.6, label = expression("WHO" ~ PM[2.5] ~ "Guideline (last updated: 2021): 5 µg/m³"), size = 4.5) 

# appendix table


#> top 4 most populous in each state----------------------
gadm2_aqli_2021 %>%
  filter(country == "India", name_1 %in% north_india) %>%
  group_by(name_1) %>%
  slice_max(population, n = 4) %>%
  mutate(pop_millions = round(population/1000000, 1)) %>%
  select(name_1, name_2, pop_millions, pm2021, llpp_who_2021, llpp_nat_2021) %>%
    mutate(pm2021 = round(pm2021, 1), 
           llpp_who_2021 = round(llpp_who_2021, 1), 
           llpp_nat_2021 = round(llpp_nat_2021, 1)) %>%
  rename(State = name_1, District = name_2, `Population (in millions)` = pop_millions, 
         "Annual Average PM2.5 in 2021 (in µg/m³)" = pm2021, 
         "Life Expectancy Gains from reducing PM2.5 concentrations from 2021 Concentration to WHO Guideline of 5 µg/m³" = llpp_who_2021, 
         "Life Expectancy Gains from reducing PM2.5 concentrations from 2021 Concentration to National Guideline of 40 µg/m³" = llpp_nat_2021) %>% 
  write_csv("./[June162023]north_india_fs_appendix_table.csv")



```


# Bangladesh factsheet 2023

```{r}

#> stats check/update

# by what multiple does particulate pollution exceed the WHO guideline in each of Bangladesh's districts
gadm2_aqli_2021 %>%
  filter(country == "Bangladesh") %>%
  mutate(mult_of_who = pm2021/5, 
         mult_of_nat = pm2021/15) %>%
  select(name_1, name_2, mult_of_who, mult_of_nat) %>% 
  slice_min(mult_of_who, n = 5) %>%
  View()


gadm2_aqli_2021 %>%
  filter(country == "Bangladesh") %>%
  slice_max(population, n = 5)

gadm2_aqli_2021 %>%
  gadm_level_summary(c("country"), c(2021), 10) %>%
  filter(country == "Bangladesh")


#> plot 1: map screenshot--------------------------------


# bangladesh figure1 dataset
bangladesh_fs_fig1_data <- gadm2_aqli_2021 %>%
  filter(country == "Bangladesh") %>%
  left_join(gadm2_aqli_2021_shp, by = c("objectid_gadm2" = "obidgadm2")) %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021") %>%
  select(-geometry, geometry) %>%
  st_as_sf()



# bangladesh figure 1
bangladesh_fs_fig1 <- bangladesh_fs_fig1_data %>%
  ggplot() +
  geom_sf(mapping = aes(fill = forcats::fct_reorder(lyl_bucket, order_lyl_bucket)), color = "lightgrey", lwd = 0.05) +
 geom_sf(data = gadm1_aqli_2021_shp %>% filter(name0 == "Bangladesh"), color = "black", fill = "transparent", lwd = 0.15) +
  ggthemes::theme_map() + 
 scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  ggthemes::theme_map() +
  labs(fill = "Potential gain in life expectancy (Years)  ", title = "") + 
 theme(legend.position = "bottom", 
        legend.justification = c(0.5, 3), 
        legend.background = element_rect(color = "black"), 
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15), 
        plot.title = element_text(hjust = 0.5, size = 15), 
       # legend.key = element_rect(color = "black"),
       legend.box.margin = margin(b = 1, unit = "cm"),
        plot.subtitle = element_text(hjust = 0.5, size = 7), 
        plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
       legend.key = element_rect(color = "black"), 
       legend.box.spacing = unit(0, "cm"), 
        legend.direction = "horizontal", 
       plot.background = element_rect(fill = "white", color = "white")) +
  guides(fill = guide_legend(nrow = 1))


#> plot 2: Potential Gain in Life Expectancy from Reducing PM2.5 from 2021 to the WHO Guideline in 10 most populous regions of Bangladesh -----------------------------------------

bangladesh_fs_fig2_dataset <- gadm2_aqli_2021 %>%
  filter(country == "Bangladesh") %>%
  add_aqli_color_scale_buckets(scale_type = "lyl", col_name = "llpp_who_2021") %>%
  slice_max(population, n = 10)

bangladesh_fs_fig2 <- bangladesh_fs_fig2_dataset %>%
  aqli_bar(scale_type = "lyl", x_var = "name_2", y_var = "llpp_who_2021", title = "", subtitle = "", x_label = "District", y_label = "Potential Gain in Life Expectancy (Years)", legend_title = "Potential gain in life expectancy (Years)", caption = "") +
  theme(plot.background = element_rect(fill = "white", color = "white"))


#> plot 3: GBD-------------------------------------------------------

# top 10 most deadly diseases
bangladesh_fs_fig3_dataset <- gbd_results_master_2021 %>%
  filter(country == "Bangladesh") %>%
  slice_max(lyl, n = 10)

colnames(bangladesh_fs_fig3_dataset)[3] <- c("llpp_who_2021")

bangladesh_fs_fig3_dataset <- bangladesh_fs_fig3_dataset %>%
   add_aqli_color_scale_buckets("lyl", "llpp_who_2021")


#> figure 3 plot

# figure 3 caption removed: Source: Global Burden of Disease (https://vizhub.healthdata.org/gbd-results/) causes and risks data and WHO Life Tables (https://apps.who.int/gho/data/node.main.LIFECOUNTRY?lang=en) were used combined with the Life table method to arrive at these results. 'PM2.5 relative to WHO Guideline' bar displays life years lost relative to the WHO guideline as calculated by latest AQLI (2021) data, which will be published in September 2023.

bangladesh_fs_fig3 <- bangladesh_fs_fig3_dataset %>%
  ggplot() + 
  geom_col(mapping = aes(x = forcats::fct_reorder(cause_of_death, llpp_who_2021), y = llpp_who_2021, fill = forcats::fct_reorder(lyl_bucket, order_lyl_bucket)), width = 0.4, color = "black") +
  labs(x = "Threats to Life Expectancy", y = "Life Years Lost", fill = "Life years lost", 
       title = "") +
  coord_flip() + 
  ggthemes::theme_tufte() +
  themes_aqli_base +
  theme(legend.position = "bottom",
        axis.text = element_text(size = 14),
        axis.title.y = element_text(size = 16, margin = margin(r = 0.6, unit = "cm")),
        axis.title.x = element_text(size = 16, margin = margin(t = 0.6, b = 0.6, unit = "cm")),
        plot.caption = element_text(hjust = 0, size = 8, margin = margin(t = 0.8, unit = "cm")),
        plot.title = element_text(hjust = 0.5, size = 20, margin = margin(b = 0.8, unit = "cm")),
        plot.subtitle = element_text(hjust = 0.5, size = 10, margin = margin(b = 0.8, unit = "cm")),
        legend.box.background = element_rect(color = "black"),
        plot.background = element_rect(fill = "white", color = "white"),
        axis.line = element_line(), 
        legend.text = element_text(size = 11), 
        legend.title = element_text(size = 14),
        panel.grid.major.y = element_blank()) +
  scale_y_continuous(breaks = seq(0, 7, 1)) +
 # scale_x_discrete(limits = cause_of_death_ordered[seq(1, length(cause_of_death_ordered), by = 2)]) +
 scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) + 
  guides(fill = guide_legend(nrow = 1)) 




#> plot 4: Trendlines: 1998 to 2021------------------------------------

# bangladesh factsheet figure 3 dataset
bangladesh_fs_fig4_dataset <- gadm2_aqli_2021 %>%
  filter(country == "Bangladesh", !is.na(population)) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2021_weighted, names_to = "years", 
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+"))), 
         region = "National Average") %>% 
  select(years, region, pop_weighted_avg_pm2.5)




  bangladesh_fs_fig4 <- bangladesh_fs_fig4_dataset %>%  
    ggplot() +
  geom_line(mapping = ggplot2::aes(x = years, y = pop_weighted_avg_pm2.5), lwd = 1.1,   
            color = "#1a1638") +
    geom_hline(mapping = aes(yintercept = 5), lwd = 0.8, linetype = "dashed") +
    geom_hline(mapping = aes(yintercept = 15), lwd = 0.8, linetype = "dashed") + 
  scale_y_continuous(breaks = seq(0, 80, 10), limits = c(0, 80)) +
  scale_x_continuous(breaks = c(seq(1998, 2019, 3), 2021)) +
    scale_color_manual(values = c("National Average" = "#1a1638")) +
  ggthemes::theme_clean() +
    themes_aqli_base +
  labs(x = "Year", 
       y = expression("Annual Average  " ~ PM[2.5] ~ " Concentration (in µg/m³)"), 
       title = "") +
  theme(legend.position = "bottom", legend.title = element_blank(), 
        legend.text = element_text(size = 7), 
        plot.background = element_rect(fill = "white", color = "white")) +  
    geom_text(x = 2001.8, y = 6.7, label =  expression("WHO " ~ PM[2.5] ~ " Guideline (last updated in 2021): 5 µg/m³"), size = 5) +
    geom_text(x = 2001.2, y = 16.7, label = expression("Bangladesh National" ~ PM[2.5] ~ "Standard: 15 µg/m³"), size = 5) 
  




# appendix table (gadm level 2)
gadm2_aqli_2021 %>%
    filter(country == "Bangladesh") %>%
    select(name_1, name_2, population, pm2021, llpp_who_2021, llpp_nat_2021) %>%
    mutate(pop_millions = round(population/1000000, 1), 
           pm2021 = round(pm2021, 1), 
           llpp_who_2021 = round(llpp_who_2021, 1), 
           llpp_nat_2021 = round(llpp_nat_2021, 1)) %>%
  mutate(lyg_red_pm2.5_30perc_2021 = round((pm2021*0.3)*0.098, 1)) %>%
    slice_max(population, n = 25) %>% 
    select(name_1, name_2, pop_millions, pm2021, llpp_who_2021, llpp_nat_2021, lyg_red_pm2.5_30perc_2021) %>%
    rename(`Population (Millions)` = pop_millions, 
           "Division" = name_1, 
           "District" = name_2, 
           "PM2.5 concentration 2021 (in µg/m³)" = pm2021, 
           "Life Expectancy Gains from reducing PM2.5 from 2021 Concentrations to the National Guideline of 15 µg/m³" = llpp_nat_2021, 
           "Life Expectancy Gains from reducing PM2.5 from 2021 Concentrations to the WHO Guideline of 5 µg/m³" = llpp_who_2021, 
           "Life Expectancy Gains from reducing PM2.5 from 2021 Concentrations by 30 percent" = lyg_red_pm2.5_30perc_2021) %>% View()
    write_csv("./[updatedOnJune082023]Bangladesh Factsheet 2023 appendix table.csv")
 



```


# Central and West Africa factsheet

```{r}

# central africa definition
central_african_countries <- c("Angola", "Burundi", "Cameroon", 
                                        "Central African Republic", "Chad", 
                                        "Republic of the Congo",
                                        "Democratic Republic of the Congo", 
                                        "Equatorial Guinea", "Gabon",
                                        "São Tomé and Príncipe", 
                                        "Rwanda")
# west africa definition
west_african_countries <- c("Benin", "Burkina Faso", "Cabo Verde", 
                            "Gambia", "Ghana", "Guinea", "Guinea-Bissau", 
                            "Côte d'Ivoire", "Liberia", "Mali", "Mauritania", 
                            "Niger", "Nigeria", "Senegal", "Sierra Leone", 
                            "Togo")

# central and west africa countries definition, combine in a single vector
central_and_west_african_countries <- c(central_african_countries, west_african_countries)

# sanity check: check if our dataset has all of the above countries (yes, it does)
gadm2_aqli_2021 %>%
  filter(country %in% central_and_west_african_countries) %>%
  select(country) %>%
  unique() 

# central and west african countries
gadm2_aqli_2021_cw_african <- gadm2_aqli_2021 %>%
  filter(country %in% central_and_west_african_countries) %>%
  mutate(name_1_country = str_c(name_1, " (", country, ")", sep = ""), 
         region = ifelse(country %in% central_african_countries, "Central African", 
                         "West African")) 

sum(gadm2_aqli_2021_cw_african$population, na.rm = TRUE)


#> stats check----------------------------------

# c/w africa region wide average stats
foo <- gadm2_aqli_2021_cw_african %>%
  mutate(country = "foo") %>%
  gadm_level_summary(c("country"), c(2021), 10) 

# top polluting countries
foo <- gadm2_aqli_2021_cw_african %>%
  gadm_level_summary(c("country"), c(2021), 10) 

# How many countries in this region are in the top n most polluted countries in the World
top20_most_pol_countries <- gadm2_aqli_2021 %>% gadm_level_summary(c("country"), c(2021), 10) %>% slice_max(pm2021, n = 30) %>% 
  select(country) %>% 
  unlist() %>% 
  as.vector()

# countries in central and west africa that are in the top n most polluted countries
foo <- central_and_west_african_countries[central_and_west_african_countries %in% top20_most_pol_countries]

# open aq data stats
foo <- openaq_data %>%
  filter(continent == "Africa") %>% 
  count(evid_govt_spon_aq_mon)

foo <- openaq_data %>%
  filter(continent == "Africa") %>% 
  count(prog_access)




#> plot 1: map screenshot--------------------------------


# cw africa figure1 dataset
cw_africa_fs_fig1_data <- gadm2_aqli_2021_cw_african %>%
  left_join(gadm2_aqli_2021_shp, by = c("objectid_gadm2" = "obidgadm2")) %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021") %>%
  select(-geometry, geometry) %>%
  st_as_sf()

# china_fs_fig1_data %>%
#   sf::write_sf("./september.2023/factsheets/southkorea/fig1/sk_fs_fig1.shp")


# cw africa fig1 (burlywood4)
cw_africa_fig1 <- cw_africa_fs_fig1_data %>%
  ggplot() +
  geom_sf(mapping = aes(fill = forcats::fct_reorder(lyl_bucket, order_lyl_bucket)), color = "aliceblue", lwd = 0.05) +
   geom_sf(data = gadm1_aqli_2021_shp %>% filter(name0 %in% central_and_west_african_countries), color = "azure4", fill = "transparent", lwd = 0.1) +
 geom_sf(data = gadm0_aqli_2021_shp %>% filter(name0 %in% central_and_west_african_countries), color = "cornsilk4", fill = "transparent", lwd = 0.3) +
  ggthemes::theme_map() +
   scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  ggthemes::theme_map() +
  labs(fill = "Potential gain in life expectancy (Years)  ", title = "", 
       subtitle = "") + 
 theme(legend.position = "bottom", 
        legend.justification = c(0.5, 3), 
        legend.background = element_rect(color = "black"), 
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15), 
        plot.title = element_text(hjust = 0.5, size = 15), 
       # legend.key = element_rect(color = "black"),
       legend.box.margin = margin(b = 1, unit = "cm"),
        plot.subtitle = element_text(hjust = 0.5, size = 12), 
        plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
       legend.key = element_rect(color = "black"), 
       legend.box.spacing = unit(0, "cm"), 
        legend.direction = "horizontal", 
       plot.background = element_rect(fill = "white", color = "white")) +
  guides(fill = guide_legend(nrow = 1))



# NOT IN USE======================================================================================================================

# #> Central v/s West Africa average pollution and life years lost 2 color map---------------------
# 
# # central v/s west africa region
# cwafrica_fs_plt2_data <- gadm2_aqli_2021_cw_african %>%
#     left_join(gadm2_aqli_2021_shp %>% filter(name0 %in% central_and_west_african_countries), by = c("objectid_gadm2" = "obidgadm2")) %>%
#   select(-geometry, geometry) %>%
#   st_as_sf() 
# 
# # wrapping x-axis labels text 
# cwafrica_fs_plt2_data$region <- as.factor(cwafrica_fs_plt2_data$region)
# 
# cwafrica_fs_plt2_data$region <- factor(cwafrica_fs_plt2_data$region, levels = c("West African", "Central African"))
# 
# plt2_cwafrica <- cwafrica_fs_plt2_data %>%
#   ggplot() +
#    geom_sf(mapping = aes(fill = region), color = "aliceblue", lwd = 0.01) +
#    geom_sf(data = gadm1_aqli_2021_shp %>% filter(name0 %in% central_and_west_african_countries), color = "azure4", fill = "transparent", lwd = 0.1) +
#  geom_sf(data = gadm0_aqli_2021_shp %>% filter(name0 %in% central_and_west_african_countries), color = "cornsilk4", fill = "transparent", lwd = 0.3) +
#   ggthemes::theme_map() +
#   labs(fill = "", title = "", 
#        subtitle = "") + 
#   scale_fill_manual(values = c("West African" = "#D7ECF5", 
#                     "Central African" = "#B2C6D1")) +
#  theme(legend.position = "bottom", 
#         legend.justification = c(0.5, 3), 
#         legend.background = element_rect(color = "black"), 
#         legend.text = element_text(size = 14),
#         legend.title = element_text(size = 15), 
#         plot.title = element_text(hjust = 0.5, size = 15), 
#        # legend.key = element_rect(color = "black"),
#        legend.box.margin = margin(b = 1, unit = "cm"),
#         plot.subtitle = element_text(hjust = 
#                                        , size = 12), 
#         plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
#        legend.key = element_rect(color = "black"), 
#        legend.box.spacing = unit(0, "cm"), 
#         legend.direction = "horizontal", 
#        plot.background = element_rect(fill = "white", color = "white")) +
#   guides(fill = guide_legend(nrow = 1)) 
# 
# 
# # eastern v/s western europe average
# 
# east_vs_west_pol <- europe_fs_plt2.1_data %>%
#   st_drop_geometry() %>%
#   group_by(europe_region) %>%
#   mutate(pop_weights = population/sum(population, na.rm = TRUE), 
#          pm2021_pop_weighted = pm2021*pop_weights) %>%
#   summarise(avg_pm2.5_2021 = sum(pm2021_pop_weighted, na.rm = TRUE))
# 

# NOT IN USE======================================================================================================================


#> cw africa factsheet plot 2-------------------------------------


#> cwafrica fig2

# GBD results filtered for relevant cause of death and countries 
gbd_results_cwafrica_fig2 <- gbd_results_master_2021 %>%
  filter(cause_of_death %in% c("PM2.5 relative to WHO guideline",
                               "Neglected tropical diseases and malaria", "Unsafe water, sanitation, and handwashing", 
                               "HIV/AIDS and sexually transmitted infections"), country %in% c("Nigeria", "Democratic Republic of the Congo", "Angola", "Ghana", "Cameroon"))

# making the 'location' column of type factor
gbd_results_cwafrica_fig2$country <- factor(gbd_results_cwafrica_fig2$country, 
                                        levels = c("Nigeria", "Democratic Republic of the Congo", "Angola", "Ghana", "Cameroon"))

# Rename Democratic Republic of the Congo to DRC
gbd_results_cwafrica_fig2$country <-  str_replace(gbd_results_cwafrica_fig2$country, 
            "Democratic Republic of the Congo", "DR Congo")

# Converting 'cause_of_death' to type factor
gbd_results_cwafrica_fig2$cause_of_death <- as.factor(gbd_results_cwafrica_fig2$cause_of_death)

# Rearranging 'cause of death' levels
levels(gbd_results_cwafrica_fig2$cause_of_death) <- c( "HIV/AIDS and sexually transmitted infections", "Neglected tropical diseases and malaria", "PM2.5 relative to WHO guideline", "Unsafe water, sanitation, and handwashing")

# wrapping x-axis labels text 
levels(gbd_results_cwafrica_fig2$cause_of_death) <- str_wrap(levels(gbd_results_cwafrica_fig2$cause_of_death), 30)

# getting country wise population
country_wise_population <- gadm2_aqli_2021_cw_african %>%
  gadm_level_summary(c("country"), c(2021), 10) %>%
  filter(country %in% c("Cameroon", "Nigeria", "Angola", "Ghana", 
                  "Democratic Republic of the Congo")) %>%
  arrange(desc(population))

# reorder within each location as per the total life years lost column
gbd_results_cwafrica_fig2 <- gbd_results_cwafrica_fig2 %>% 
  mutate(cause_of_death = reorder_within(cause_of_death, lyl, country))

# clean the "cause of death" column and save the cwafrica factsheet figure 2
cwafrica_fs_fig2_dataset <- gbd_results_cwafrica_fig2 %>%
  mutate(cause_of_death = str_remove(cause_of_death, "___.+"))


# plot 
plt <- cwafrica_fs_fig2_dataset %>%
  ggplot(mapping = aes(x = reorder_within(cause_of_death, lyl, country), y = lyl)) + 
  geom_col(mapping = aes(fill = cause_of_death), width = 0.5, color = "white") +
  scale_x_reordered() +
  facet_wrap(~factor(country, levels = c("Angola", "Cameroon", "DR Congo", 
                  "Ghana", "Nigeria")), scales = "free_x", ncol = 5) +
  scale_fill_manual(values = c("#D3D9E0", "#7BC1D9", "#8F3931",
                               "#808A94")) +
  labs(x = "Threats to Life Expectancy", y = "Life Years Lost", title = "", 
       subtitle = "", fill = "Threats to Life Expectancy") +
  themes_aqli_base +
   theme(axis.text.x = element_blank(), legend.position = "bottom", axis.ticks = element_blank(), 
         strip.text = element_text(size = 14), 
         plot.background = element_rect(fill = "white", color = "white")) 


#> cw africa figure 3----------------------------------


# central and west africa figure 3 dataset
 cwafrica_fs_fig3_dataset <- gadm2_aqli_2021_cw_african %>%
  filter(!is.na(population)) %>%
  group_by(name_1_country) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2021_pop_weighted = pop_weights*pm2021) %>%
  summarise(tot_pop = sum(population, na.rm = TRUE), avg_pm2.5_pop_weighted = sum(pm2021_pop_weighted, na.rm = TRUE), 
            gain_in_le = (avg_pm2.5_pop_weighted - 5) * 0.098, 
            gain_in_le = ifelse(gain_in_le < 0, 0, gain_in_le)) %>%
  ungroup() %>%
  slice_max(tot_pop, n = 10) 
 

cwafrica_fs_fig3_dataset <- cwafrica_fs_fig3_dataset %>%
  add_aqli_color_scale_buckets(scale_type = "lyl", col_name = "gain_in_le") 

cwafrica_fs_fig3 <- cwafrica_fs_fig3_dataset %>%
  mutate(name_1_country = str_replace(name_1_country, "Democratic Republic of the Congo", "DR Congo")) %>%
  aqli_bar(scale_type = "lyl", x_var = "name_1_country", y_var = "gain_in_le", title = "", subtitle = "", x_label = "Region", y_label = "Potential Gain in Life Expectancy (Years)", legend_title = "Potential gain in life expectancy (Years)", caption = "") + 
  theme(plot.background = element_rect(fill = "white", color = "white"))


#> cw africa figure 4 trendlines -------------------------------------------------

#> Figure 4: Average PM2.5 concentration in India from 1998 to 2021------------------------


# creating region wise average PM2.5 data from 1998 to 2021 
cwafrica_fs_fig4_data <- gadm2_aqli_2021_cw_african %>%
  filter(!is.na(population)) %>%
  group_by(region) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2021_weighted, names_to = "years", 
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+")))) %>%
  select(years, region, pop_weighted_avg_pm2.5)


# creating a


# adding factor levels
cwafrica_fs_fig4_data$region <- factor(cwafrica_fs_fig4_data$region, levels = c("Central African", "West African"))

# fig 4
cwafrica_fs_fig4 <- cwafrica_fs_fig4_data %>%
  ggplot() +
  geom_line(mapping = ggplot2::aes(x = years, y = pop_weighted_avg_pm2.5, color = region), lwd = 1.3) +
    geom_hline(mapping = aes(yintercept = 5), lwd = 0.8, linetype = "dotted") +
  scale_y_continuous(breaks = seq(0, 40, 10), limits = c(0, 40)) +
  scale_x_continuous(breaks = c(seq(1998, 2019, 3), 2021)) +
    scale_color_manual(values = c("Central African" = "#7197be", "West African" = "#82b5d5")) +
  ggthemes::theme_tufte() +
  labs(x = "Year", 
       y = expression("Annual Average   " ~ PM[2.5] ~ " Concentration (in µg/m³)"), 
       title = "") +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 11),
        legend.title = element_blank(),
        axis.title.y = element_text(size = 13, margin = margin(r = 0.6, unit = "cm")), 
        axis.title.x = element_text(size = 13, margin = margin(t = 0.6, b = 0.6, unit = "cm")), 
        axis.line = element_line(), 
        legend.box.background = element_rect(color = "black"),
        plot.title = element_text(hjust = 0.5, size = 16, margin = margin(b = 0.7, unit = "cm")), 
        plot.subtitle = element_text(hjust = 0.5, size = 8, face = "italic"), 
        plot.caption = element_text(size = 7, margin = margin(t = 0.8, unit = "cm"), hjust = 0, face = "italic"),
        axis.text = element_text(size = 12), 
        plot.background = element_rect(color = "white"), 
        axis.ticks = element_blank()) +
     geom_text(x = 2000.5, y = 6, label = expression("WHO" ~ PM[2.5] ~ "Guideline (last updated: 2021): 5 µg/m³"), size = 4.5) 


  
#> appendix table cw africa (top 50 most polluted regions in cw africa)-------------------------
gadm2_aqli_2021_cw_african %>%
  slice_max(pm2021, n = 50) %>%
  mutate(le_gain_30_perc_red = round((pm2021*0.3)*0.098, 1), 
         pop_hund_thou = round(population/100000, 1), 
         pm2021 = round(pm2021, 1), 
         llpp_who_2021 = round(llpp_who_2021, 1)) %>%
  select(country, name_2, pop_hund_thou, pm2021, llpp_who_2021, le_gain_30_perc_red) %>%
   rename(`Population (in 100,000s)` = pop_hund_thou, 
           "Country" = country, 
           "Region" = name_2, 
           "PM2.5 concentration 2021 (in µg/m³)" = pm2021, 
           "Life Expectancy Gains from reducing PM2.5 from 2021 Concentrations to the WHO Guideline of 5 µg/m³" = llpp_who_2021, 
           "Life Expectancy Gains from reducing PM2.5 from 2021 Concentrations by 30 percent" = le_gain_30_perc_red) %>% 
  write_csv("./[July052023]cwafrica_fs_appendix_table.csv")




```


# Europe fact sheet 2023

```{r}

#> stats check-----------------------------------------------

# sanity check the total number of european countries present in the AQLI dataset
european_countries$Country[european_countries$Country %notin%  unique(gadm2_aqli_2021$country)]

# create a europe AQLI dataset
gadm2_aqli_2021_europe <- gadm2_aqli_2021 %>%
  filter(country %in% european_countries$Country)

# europe average pm2.5 pollution in 1998 and 2021
gadm2_aqli_2021_europe %>%
  mutate(country = "foo") %>%
  gadm_level_summary(c("country"), c(2021), 10)

# europe pop
europe_pop <- sum(gadm2_aqli_2021_europe$population, na.rm =  TRUE)

# pop living above who guideline
europe_above_who <- gadm2_aqli_2021_europe %>%
  filter(pm2021 > 10) %>%
  summarise(tot_pop = sum(population, na.rm = TRUE))

europe_above_who/europe_pop

# country wise average and how many are above WHO
europe_country_wise <- gadm2_aqli_2021_europe %>%
  gadm_level_summary(c("country"), c(2021), 10)

europe_country_wise %>%
  slice_max(pm2021, n = 10)

# each country wise percent population at or below WHO
gadm2_aqli_2021_europe %>%
  mutate(pop_at_below_who = ifelse(pm2021 <= 5, population, 0)) %>%
  group_by(country) %>%
  summarise(sum_new_pop = sum(pop_at_below_who, na.rm = TRUE)) %>%
  filter(sum_new_pop == 0) 


#> plot 1 (europe screenshot map) -----------------------------------------------------

# exclude the following countries to keep the map less wide and to show a stark difference between eastern and western europe
exclude_countries <-  c("Russia", "Turkey", "Sweden", "Finland", "Norway", "Kazakhstan", "Iceland", "Georgia", "Azerbaijan", "Armenia", "Cyprus", "Northern Cyprus", "Svalbard and Jan Mayen")


countries_except_excluded <- european_countries %>% 
  filter(Country %notin% exclude_countries)

# europe figure1 dataset
europe_fs_fig1_data <- gadm2_aqli_2021_europe %>%
  filter(country %notin% exclude_countries) %>%
  left_join(gadm2_aqli_2021_shp, by = c("objectid_gadm2" = "obidgadm2")) %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021") %>%
  select(-geometry, geometry) %>%
  st_as_sf()

# china_fs_fig1_data %>%
#   sf::write_sf("./september.2023/factsheets/southkorea/fig1/sk_fs_fig1.shp")


europe_fs_fig1_data <- europe_fs_fig1_data %>%
  filter(!(country == "Spain" & name_1 == "Islas Canarias")) %>%
  filter(!(country == "Portugal" & name_1 == "Azores"))


# europe fs fig1
europe_fs_fig1 <- europe_fs_fig1_data %>%
  filter(country %notin% c("Svalbard and Jan Mayen")) %>%
  ggplot() +
  geom_sf(mapping = aes(fill = forcats::fct_reorder(lyl_bucket, order_lyl_bucket)), color = "aliceblue", lwd = 0.05) +
   geom_sf(data = gadm1_aqli_2021_shp %>% filter(name0 %in% unlist(countries_except_excluded)) %>% 
                                                     filter(!(name0 == "Spain" & name1 == "Islas Canarias")) %>%
  filter(!(name0 == "Portugal" & name1 == "Azores")), color = "azure4", fill = "transparent", lwd = 0.1) +
 geom_sf(data = gadm0_aqli_2021_shp %>% filter(name0 %in% unlist(countries_except_excluded)), color = "cornsilk4", fill = "transparent", lwd = 0.3) +
  ggthemes::theme_map()  +
   scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  ggthemes::theme_map() +
  labs(fill = "Potential gain in life expectancy (Years)  ", title = "", 
       subtitle = "") + 
 theme(legend.position = "bottom", 
        legend.justification = c(0.5, 3), 
        legend.background = element_rect(color = "black"), 
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15), 
        plot.title = element_text(hjust = 0.5, size = 15), 
       # legend.key = element_rect(color = "black"),
       legend.box.margin = margin(b = 1, unit = "cm"),
        plot.subtitle = element_text(hjust = 0.5, size = 12), 
        plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
       legend.key = element_rect(color = "black"), 
       legend.box.spacing = unit(0, "cm"), 
        legend.direction = "horizontal", 
       plot.background = element_rect(fill = "white", color = "white")) +
  guides(fill = guide_legend(nrow = 1)) 

 
#> plot 2 (discontinued: will be replaced by eastern v/s western europe)============================================================

# europe_fs_plt2_data <- gadm2_aqli_2021_europe %>%
#   mutate(compliance_tag = ifelse(pm2021 <= 5, "In Compliance with new WHO guideline", NA), 
#          compliance_tag = ifelse((pm2021 > 5  & pm2021 <= 10), "Exceed the new WHO guideline, but within old guideline", compliance_tag), 
#          compliance_tag = ifelse((pm2021 > 10), "Exceed the old WHO guideline", compliance_tag)) %>%
#     left_join(gadm2_aqli_2021_shp, by = c("objectid_gadm2" = "obidgadm2")) %>%
#   select(-geometry, geometry) %>%
#   st_as_sf() %>%
#     filter(country %notin% exclude_countries) 
# 
# # wrapping x-axis labels text 
# europe_fs_plt2_data$compliance_tag <- as.factor(europe_fs_plt2_data$compliance_tag)
# levels(europe_fs_plt2_data$compliance_tag) <- str_wrap(levels(europe_fs_plt2_data$compliance_tag), 30)
# 
# 
# plt2 <- europe_fs_plt2_data %>%
#   ggplot() +
#    geom_sf(mapping = aes(fill = compliance_tag), color = "lightgrey", lwd = 0.05) +
#    geom_sf(data = gadm1_aqli_2021_shp %>% filter(name0 %in% unlist(countries_except_excluded)), color = "black", fill = "transparent", lwd = 0.1) +
#  geom_sf(data = gadm0_aqli_2021_shp %>% filter(name0 %in% unlist(countries_except_excluded)), color = "black", fill = "transparent", lwd = 0.3) +
#   ggthemes::theme_map() + 
#   ggthemes::theme_map() +
#   labs(fill = "", title = "Impact of the revised WHO guideline on Europe", 
#        subtitle = "") + 
#   scale_fill_manual(values = c("In Compliance with new WHO\nguideline" = "white", 
#                     "Exceed the old WHO guideline" = "darkgrey", 
#                     "Exceed the new WHO guideline,\nbut within old guideline" = "lightgrey")) +
#  theme(legend.position = "bottom", 
#         legend.justification = c(0.5, 3), 
#         legend.background = element_rect(color = "black"), 
#         legend.text = element_text(size = 14),
#         legend.title = element_text(size = 15), 
#         plot.title = element_text(hjust = 0.5, size = 15), 
#        # legend.key = element_rect(color = "black"),
#        legend.box.margin = margin(b = 1, unit = "cm"),
#         plot.subtitle = element_text(hjust = 0.5, size = 12), 
#         plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
#        legend.key = element_rect(color = "black"), 
#        legend.box.spacing = unit(0, "cm"), 
#         legend.direction = "horizontal", 
#        plot.background = element_rect(fill = "white", color = "white")) +
#   guides(fill = guide_legend(nrow = 1)) 

#============================================================================================================================


#> plot 2.1 east v/s west europe [DISCONTINUED] ==============================================================================
# europe_fs_plt2.1_data <- gadm2_aqli_2021_europe %>%
#   filter(country %notin% exclude_countries) %>%
#   mutate(europe_region = ifelse(country %in% western_european_countries, "Western Europe", "Eastern Europe")) %>%
#     left_join(gadm2_aqli_2021_shp, by = c("objectid_gadm2" = "obidgadm2")) %>%
#   select(-geometry, geometry) %>%
#   st_as_sf() %>%
#     filter(country %notin% exclude_countries) 
# 
# # wrapping x-axis labels text 
# europe_fs_plt2.1_data$europe_region <- as.factor(europe_fs_plt2.1_data$europe_region)
# #levels(europe_fs_plt2_data$compliance_tag) <- str_wrap(levels(europe_fs_plt2_data$compliance_tag), 30)
# 
# europe_fs_plt2.1_data$europe_region <- factor(europe_fs_plt2.1_data$europe_region, levels = c("Western Europe", "Eastern Europe"))
# 
# plt2.1 <- europe_fs_plt2.1_data %>%
#   ggplot() +
#    geom_sf(mapping = aes(fill = europe_region), color = "aliceblue", lwd = 0.01) +
#    geom_sf(data = gadm1_aqli_2021_shp %>% filter(name0 %in% unlist(countries_except_excluded)), color = "azure4", fill = "transparent", lwd = 0.1) +
#  geom_sf(data = gadm0_aqli_2021_shp %>% filter(name0 %in% unlist(countries_except_excluded)), color = "cornsilk4", fill = "transparent", lwd = 0.3) +
#   ggthemes::theme_map() + 
#   ggthemes::theme_map() +
#   labs(fill = "", title = "", 
#        subtitle = "") + 
#   scale_fill_manual(values = c("Western Europe" = "#D7ECF5", 
#                     "Eastern Europe" = "#B2C6D1")) +
#  theme(legend.position = "bottom", 
#         legend.justification = c(0.5, 3), 
#         legend.background = element_rect(color = "black"), 
#         legend.text = element_text(size = 14),
#         legend.title = element_text(size = 15), 
#         plot.title = element_text(hjust = 0.5, size = 15), 
#        # legend.key = element_rect(color = "black"),
#        legend.box.margin = margin(b = 1, unit = "cm"),
#         plot.subtitle = element_text(hjust = 
#                                        , size = 12), 
#         plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
#        legend.key = element_rect(color = "black"), 
#        legend.box.spacing = unit(0, "cm"), 
#         legend.direction = "horizontal", 
#        plot.background = element_rect(fill = "white", color = "white")) +
#   guides(fill = guide_legend(nrow = 1)) %>%
#   ggsflabel::geom_sf_label_repel(data = gadm1_aqli_2021_shp %>% filter(name0 == "India", name1 %in% north_india), mapping = aes(label = name1), force = 50, nudge_x = 3, seed = 10, size = 4)
# 
# 
# 
# # eastern v/s western europe average
# 
# east_vs_west_pol <- europe_fs_plt2.1_data %>%
#   st_drop_geometry() %>%
#   group_by(europe_region) %>%
#   mutate(pop_weights = population/sum(population, na.rm = TRUE), 
#          pm2021_pop_weighted = pm2021*pop_weights) %>%
#   summarise(avg_pm2.5_2021 = sum(pm2021_pop_weighted, na.rm = TRUE))
# 
# 

#====================================================================================================================

#> plot 2-----------------------------------------------------


# europe figure 3 dataset
 europe_fs_fig2_dataset <- gadm2_aqli_2021_europe %>%
  mutate(name_1_country = str_c(name_1, " (", country, ")")) %>%
  group_by(name_1_country) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2021_pop_weighted = pop_weights*pm2021) %>%
  summarise(tot_pop = sum(population, na.rm = TRUE), avg_pm2.5_pop_weighted = sum(pm2021_pop_weighted, na.rm = TRUE), 
            gain_in_le = (avg_pm2.5_pop_weighted - 5) * 0.098, 
            gain_in_le = ifelse(gain_in_le < 0, 0, gain_in_le)) %>%
  ungroup() %>%
  slice_max(tot_pop, n = 10) 
 

europe_fs_fig2_dataset <-  europe_fs_fig2_dataset %>%
  add_aqli_color_scale_buckets(scale_type = "lyl", col_name = "gain_in_le") 

europe_fs_fig2 <- europe_fs_fig2_dataset %>%
  aqli_bar(scale_type = "lyl", x_var = "name_1_country", y_var = "gain_in_le", title = "", subtitle = "", x_label = "Region", y_label = "Potential Gain in Life Expectancy (Years)", legend_title = "Potential gain in life expectancy (Years)", caption = "") +
  theme(plot.background = element_rect(fill = "white", color = "white"))


# plot 3-------------------------------------------------------------


diseases_list <- c("PM2.5 relative to WHO guideline",
                               "Respiratory infections and tuberculosis", 
                               "Diabetes and kidney diseases", 
                     "Child and maternal malnutrition", 
                               "Transport injuries")

country_list <- c("Russian Federation", "Turkey", "Germany", "United Kingdom", "France")

# GBD results filtered for relevant cause of death (given Europe) and countries 
gbd_results_europe_fig3 <- gbd_results_master_2021 %>%
  filter(cause_of_death %in% diseases_list, country %in% country_list)

# making the 'location' column of type factor
gbd_results_europe_fig3$country <- factor(gbd_results_europe_fig3$country, 
                                        levels = country_list)



# Converting 'cause_of_death' to type factor
gbd_results_europe_fig3$cause_of_death <- factor(gbd_results_europe_fig3$cause_of_death, levels = diseases_list)

# wrapping x-axis labels text 
levels(gbd_results_europe_fig3$cause_of_death) <- str_wrap(levels(gbd_results_europe_fig3$cause_of_death), 30)


# reorder within each location as per the total life years lost column
gbd_results_europe_fig3 <- gbd_results_europe_fig3 %>% 
  mutate(cause_of_death = reorder_within(cause_of_death, lyl, country))

# clean the "cause of death" column and save the cwafrica factsheet figure 2
gbd_results_europe_fig3 <- gbd_results_europe_fig3 %>%
  mutate(cause_of_death = str_remove(cause_of_death, "___.+"))



# plot 
plt <- gbd_results_europe_fig3 %>%
  ggplot(mapping = aes(x = reorder_within(cause_of_death, lyl, country), y = lyl)) + 
  geom_col(mapping = aes(fill = cause_of_death), width = 0.5, color = "white") +
  scale_x_reordered() +
  facet_wrap(~factor(country, levels = country_list), scales = "free_x", ncol = 5) +
   scale_fill_manual(values = c("#B4CDD9", "#707F8C", "#8F3931",
                                "#ADE9FA", "#CBE8F3")) +
  labs(x = "Threats to Life Expectancy", y = "Life Years Lost", title = "", 
       subtitle = "", fill = "Threats to Life Expectancy") +
  themes_aqli_base +
   theme(axis.text.x = element_blank(), legend.position = "bottom", axis.ticks = element_blank(), 
         strip.text = element_text(size = 14), 
         plot.background = element_rect(fill = "white", color = "white")) 















# plot 4-------------------------------------------------------------

# creating region wise average PM2.5 data from 1998 to 2021 
europe_fs_fig4_data <- gadm2_aqli_2021_europe %>%
  filter(!is.na(population)) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2021_weighted, names_to = "years", 
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+")))) %>%
  select(years, pop_weighted_avg_pm2.5)


# fig 4
europe_fs_fig4 <- europe_fs_fig4_data %>%
  ggplot() +
  geom_line(mapping = ggplot2::aes(x = years, y = pop_weighted_avg_pm2.5), color =  "#82b5d5", lwd = 1.3) +
    geom_hline(mapping = aes(yintercept = 5), lwd = 0.8, linetype = "dotted") +
  scale_y_continuous(breaks = seq(0, 25, 5), limits = c(0, 25)) +
  scale_x_continuous(breaks = c(seq(1998, 2019, 3), 2021)) +
  ggthemes::theme_tufte() +
  labs(x = "Year", 
       y = expression("Annual Average   " ~ PM[2.5] ~ " Concentration (in µg/m³)"), 
       title = "") +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 11),
        legend.title = element_blank(),
        axis.title.y = element_text(size = 13, margin = margin(r = 0.6, unit = "cm")), 
        axis.title.x = element_text(size = 13, margin = margin(t = 0.6, b = 0.6, unit = "cm")), 
        axis.line = element_line(), 
        legend.box.background = element_rect(color = "black"),
        plot.title = element_text(hjust = 0.5, size = 16, margin = margin(b = 0.7, unit = "cm")), 
        plot.subtitle = element_text(hjust = 0.5, size = 8, face = "italic"), 
        plot.caption = element_text(size = 7, margin = margin(t = 0.8, unit = "cm"), hjust = 0, face = "italic"),
        axis.text = element_text(size = 12), 
        plot.background = element_rect(color = "white", fill = "white"), 
        axis.ticks = element_blank()) +
     geom_text(x = 2000.5, y = 5.7, label = expression("WHO" ~ PM[2.5] ~ "Guideline (last updated: 2021): 5 µg/m³"), size = 4.5) 


#> appendix table------------------------------------------

# part-1: country wise summary of average pm2021, populaton, lyl for country as a whole
country_wise_summary_pol <- gadm2_aqli_2021_europe %>%
  gadm_level_summary(c("country"), c(2021), 10) %>%
  select(country, pm2021, population, llpp_who_2021)



# part-2: country wise sum of population of areas above WHO guideline
country_wise_summary_areas_above_who <-  gadm2_aqli_2021_europe %>%
  mutate(pop_above_who = ifelse(pm2021 > 5, population, 0)) %>%
  group_by(country) %>%
  summarise(sum_new_pop_above_who = sum(pop_above_who, na.rm = TRUE))
 

# combine part 1 nad part 2 
country_wise_part1_2_combined <- country_wise_summary_pol %>%
  left_join(country_wise_summary_areas_above_who, by = c("country")) %>%
  mutate(perc_pop_above_who = round((sum_new_pop_above_who/population)*100, 1))

# part-3: country wise most polluted region, pollution, lyl
country_wise_most_polluted_region_stats <- gadm2_aqli_2021_europe %>%
  filter(!is.na(population), !is.na(pm2021)) %>%
  group_by(country) %>%
  summarise(most_polluted = name_2[which(pm2021 == max(pm2021))], 
            most_polluted_pm2021 = pm2021[which(pm2021 == max(pm2021))], 
            lyl_most_polluted_pm2021 = llpp_who_2021[which(pm2021 == max(pm2021))]) 

# final dataset
appendix_table <- country_wise_part1_2_combined %>%
  left_join(country_wise_most_polluted_region_stats, by = c("country"))

# select relevant columns and bring in final format
appendix_table_final <- appendix_table %>%
  select(country, pm2021, llpp_who_2021, perc_pop_above_who, most_polluted, most_polluted_pm2021, lyl_most_polluted_pm2021) %>%
  mutate(most_polluted_pm2021 = round(most_polluted_pm2021, 1), 
         lyl_most_polluted_pm2021 = round(lyl_most_polluted_pm2021, 1)) %>%
  rename(Country = country, 
         "Annual average PM2.5 concentration (in µg/m³)" = pm2021, 
          "Life Expectancy Gains from reducing PM2.5 from 2021 Concentrations to the WHO Guideline of 5 µg/m³ in the given country" = llpp_who_2021, 
         "Percent of population above WHO guideline" = perc_pop_above_who, 
         "Region with highest PM2.5 concentration in 2021" = most_polluted, 
         "Annual average PM2.5 concentration in most polluted region" = most_polluted_pm2021, 
          "Life Expectancy Gains from reducing PM2.5 from 2021 Concentrations to the WHO Guideline of 5 µg/m³ in the most polluted region" = lyl_most_polluted_pm2021)

appendix_table_final %>%
  arrange(Country) %>%
  write_csv("./[August072023]EuropeFactsheet2023_appendix_table.csv")

```


# Colombia factsheet---------------------------------


```{r}

#> stat checks

# country rankings
gadm2_aqli_2021 %>%
  gadm_level_summary(c("country"), c(2021), 10) %>%
  slice_max(pm2021, n = 246) %>%
  mutate(rownum = row_number()) %>%
  filter(country == "Colombia") %>%
  select(rownum, country)

# % people above WHO
foo <- gadm2_aqli_2021 %>%
  filter(country == "Colombia", pm2021 > 20) %>%
  summarise(tot_pop = sum(population, na.rm = TRUE))


# stats check
perc_pop_above_who_continent <- gadm2_aqli_2021 %>%
  filter(country == "Colombia") %>%
  mutate(above_who = ifelse(llpp_who_2021 > 0, 1, 0), 
         population_above_who = ifelse(above_who == 1, population, 0), 
         total_lyl_gadm2 = llpp_who_2021*population) %>%
  group_by(name_1) %>%
  summarise(pop_total = sum(population, na.rm = TRUE), 
            pop_total_above_who = sum(population_above_who, na.rm = TRUE), 
            perc_pop_above_who = round((pop_total_above_who/pop_total)*100, 2))

# open aq data stats
foo <- openaq_data %>%
  filter(continent == "South America") %>% 
  count(evid_govt_spon_aq_mon)


foo <- gadm2_aqli_2021 %>%
  filter(country == "Colombia", pm2021 > 10) %>%
  summarise(tot_pop = sum(population, na.rm = TRUE))

foo <- gadm2_aqli_2021 %>%
  filter(country == "Nigeria", name_1 %in% c("Akwa Ibom", "Cross River", "Rivers", "Abia")) %>%
  gadm_level_summary(c("country", "name_1"), c(2021), 10)
  
  
  
#> plot 1

# colombia figure1 dataset
colombia_fs_fig1_data <- gadm2_aqli_2021 %>%
  filter(country == "Colombia") %>%
  left_join(gadm2_aqli_2021_shp, by = c("objectid_gadm2" = "obidgadm2")) %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021") %>%
  select(-geometry, geometry) %>%
  st_as_sf()



# colombia figure 1
colombia_fs_fig1 <- colombia_fs_fig1_data %>%
  ggplot() +
  geom_sf(mapping = aes(fill = forcats::fct_reorder(lyl_bucket, order_lyl_bucket)), color = "aliceblue", lwd = 0.05) +
 geom_sf(data = gadm1_aqli_2021_shp %>% filter(name0 == "Colombia"), color = "azure4", fill = "transparent", lwd = 0.15) +
   geom_sf(data = gadm0_aqli_2021_shp %>% filter(name0 == "Colombia"), color = "cornsilk", fill = "transparent", lwd = 0.5) +
  ggthemes::theme_map()  +
     scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  ggthemes::theme_map() +
  labs(fill = "Potential gain in life expectancy (Years) ", title = "") + 
 theme(legend.position = "bottom", 
        legend.justification = c(0.5, 3), 
        legend.background = element_rect(color = "black"), 
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15), 
        plot.title = element_text(hjust = 0.5, size = 15), 
       # legend.key = element_rect(color = "black"),
       legend.box.margin = margin(b = 1, unit = "cm"),
        plot.subtitle = element_text(hjust = 0.5, size = 7), 
        plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
       legend.key = element_rect(color = "black"), 
       legend.box.spacing = unit(0, "cm"), 
        legend.direction = "horizontal", 
       plot.background = element_rect(fill = "white", color = "white")) +
  guides(fill = guide_legend(nrow = 1))


  


#> plot 2: Potential Gain in Life Expectancy from Reducing PM2.5 from 2021 to the WHO Guideline in 10 most populous regions of Colombia -----------------------------------------

colombia_fs_fig2_dataset <- gadm2_aqli_2021 %>%
  filter(country == "Colombia") %>%
  add_aqli_color_scale_buckets(scale_type = "lyl", col_name = "llpp_who_2021") %>%
  slice_max(population, n = 10)

colombia_fs_fig2 <- colombia_fs_fig2_dataset %>%
  aqli_bar(scale_type = "lyl", x_var = "name_2", y_var = "llpp_who_2021", title = "", subtitle = "", x_label = "Municipality", y_label = "Potential Gain in Life Expectancy (Years)", legend_title = "Potential gain in life expectancy (Years)", caption = "") +
  theme(plot.background = element_rect(fill = "white", color = "white"))


#> plot 3: GBD-------------------------------------------------------

# top 10 most deadly diseases
colombia_fs_fig3_dataset <- gbd_results_master_2021 %>%
  filter(country == "Colombia") %>%
  slice_max(lyl, n = 15)

colnames(colombia_fs_fig3_dataset)[3] <- c("llpp_who_2021")

colombia_fs_fig3_dataset <- colombia_fs_fig3_dataset %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021")


#> figure 3 plot


colombia_fs_fig3 <- colombia_fs_fig3_dataset %>%
  ggplot() + 
  geom_col(mapping = aes(x = forcats::fct_reorder(cause_of_death, llpp_who_2021), y = llpp_who_2021, fill = forcats::fct_reorder(lyl_bucket, order_lyl_bucket)), width = 0.4, color = "black") +
  labs(x = "Threats to Life Expectancy", y = "Life Years Lost", fill = "Life years lost", 
       title = "") +
  coord_flip() + 
  ggthemes::theme_tufte() +
  themes_aqli_base +
  theme(legend.position = "bottom",
        axis.text = element_text(size = 14),
        axis.title.y = element_text(size = 16, margin = margin(r = 0.6, unit = "cm")),
        axis.title.x = element_text(size = 16, margin = margin(t = 0.6, b = 0.6, unit = "cm")),
        plot.caption = element_text(hjust = 0, size = 8, margin = margin(t = 0.8, unit = "cm")),
        plot.title = element_text(hjust = 0.5, size = 20, margin = margin(b = 0.8, unit = "cm")),
        plot.subtitle = element_text(hjust = 0.5, size = 10, margin = margin(b = 0.8, unit = "cm")),
        legend.box.background = element_rect(color = "black"),
        plot.background = element_rect(fill = "white", color = "white"),
        axis.line = element_line(), 
        legend.text = element_text(size = 11), 
        legend.title = element_text(size = 14),
        panel.grid.major.y = element_blank()) +
  scale_y_continuous(breaks = seq(0, 6, 0.5)) +
 # scale_x_discrete(limits = cause_of_death_ordered[seq(1, length(cause_of_death_ordered), by = 2)]) +
  scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  guides(fill = guide_legend(nrow = 1)) 




#> plot 4: Trendlines: 1998 to 2021------------------------------------

# Colombia factsheet figure 3 dataset
colombia_fs_fig4_dataset <- gadm2_aqli_2021 %>%
  filter(!is.na(population)) %>%
  filter(country == "Colombia") %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2021_weighted, names_to = "years", 
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+"))), 
         region = "National Average") %>% 
  select(years, region, pop_weighted_avg_pm2.5)




  colombia_fs_fig4 <- colombia_fs_fig4_dataset %>%
    ggplot() +
  geom_line(mapping = ggplot2::aes(x = years, y = pop_weighted_avg_pm2.5), lwd = 1.1, 
            color = "#82b5d5") +
    geom_hline(mapping = aes(yintercept = 5), lwd = 0.8, linetype = "dashed") +
    geom_hline(mapping = aes(yintercept = 20), lwd = 0.8, linetype = "dashed") + 
  scale_y_continuous(breaks = seq(0, 20, 5), limits = c(0, 25)) +
  scale_x_continuous(breaks = c(seq(1998, 2019, 3), 2021)) +
    scale_color_manual(values = c("National Average" = "#82b5d5")) +
  ggthemes::theme_clean() +
    themes_aqli_base +
  labs(x = "Year", 
       y = expression("Annual Average  " ~ PM[2.5] ~ " Concentration (in µg/m³)"), 
       title = "") +
  theme(legend.position = "bottom", legend.title = element_blank(), 
        legend.text = element_text(size = 7), 
        plot.background = element_rect(fill = "white", color = "white")) +  
    geom_text(x = 2001.5, y = 5.6, label =  expression("WHO " ~ PM[2.5] ~ " Guideline (last updated in 2021): 5 µg/m³"), size = 5) +
    geom_text(x = 2000.7, y = 20.7, label = expression("Colombia National" ~ PM[2.5] ~ "Standard: 20 µg/m³"), size = 5) 

  
#> life years lost range graph------------------------------------

#  state wise min, average and max lyl dataset for 10 most populous states
lyl_range_df <- gadm2_aqli_2021 %>%
    filter(country == "Colombia") %>%
  group_by(name_1) %>%
    mutate(pop_weights = population/sum(population, na.rm = TRUE), 
           pm2021_pop_weighted = pm2021*pop_weights) %>%
  summarise(min_lyl = round(min(llpp_who_2021, na.rm = TRUE), 1),
            max_lyl = round(max(llpp_who_2021, na.rm = TRUE), 1),
            avg_pm2.5_2021 = sum(pm2021_pop_weighted, na.rm = TRUE),
            avg_lyl = round((avg_pm2.5_2021 - 5)*0.098, 1),
            range_lyl = max_lyl - min_lyl,
            total_population = sum(population, na.rm = TRUE)) %>%
    mutate(avg_lyl = ifelse(avg_lyl < 0, 0, avg_lyl))
  

# plot lyl range graph (click on zoom in the plots window in R-Studio to view the plot)
lyl_range_plt <- lyl_range_df  %>%
  ggplot(aes(x = forcats::fct_reorder(name_1, total_population), y = min_lyl)) +
  geom_point(aes(color = "Minimum life years lost"), size = 3) +
  geom_point(aes(y = max_lyl, color = "Maximum life years lost"), size = 3) +
  geom_point(aes(y = avg_lyl, color = "Average life years lost"), size = 3) +
  geom_segment(aes(xend = name_1, yend = max_lyl),
               linetype = "dashed", color = "black") +
  scale_color_manual(name = "", values = c("Minimum life years lost" = "cornflowerblue",
                                           "Average life years lost" = "darkgrey",
                                                   "Maximum life years lost" = "darkred"), 
                            breaks = c("Minimum life years lost", "Average life years lost", "Maximum life years lost"),
                     labels = c("Minimum life years lost", "Average life years lost", "Maximum life years lost")) +
  labs(title = expression("Minimum, Average and Maximum Life years lost to" ~ PM[2.5] ~ "Air Pollution"),
       x = "Department", y = "Life Years Lost") +
  coord_flip() +
  theme(legend.position = "bottom",
        legend.box.background = element_rect(color = "black"),
        plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(breaks = seq(0, 2, 0.5), limits = c(0, 2)) +
  ggthemes::theme_clean() +
    theme(legend.position = "bottom", 
        axis.title.y = element_text(margin = margin(r = 0.8, unit = "cm"), size = 16), 
        axis.title.x = element_text(margin = margin(t = 0.8, b = 1, unit = "cm"), size = 16), 
        axis.text = element_text(size = 14), 
        plot.title = element_text(hjust = 0.5, size = 18, margin = margin(b = 0.3, unit = "cm")),
        legend.box.background = element_rect(color = "black"),
        strip.text = element_text(size = 18, margin = margin(t = 1, b = 0.5, unit = "cm")),
        legend.title = element_text(size = 16), 
        legend.text = element_text(size = 14), 
        plot.subtitle = element_text(size = 12, hjust = 0.5, margin = margin(b = 0.8, unit = "cm"), face = "italic"),
        plot.caption = element_text(hjust = 0, size = 9, face = "italic", margin = margin(t = 1.3, unit = "cm")), 
        plot.background = element_rect(fill = "white", color = "white"))  


  
#> plot 6: Distribution of pollution in 2021-----------------------
  
col_name <- "pm2021"
plt <- gadm2_aqli_2021 %>%
      filter(country == "Colombia") %>%
      add_aqli_color_scale_buckets(scale_type = "pollution", col_name = "pm2021") %>%
      ggplot() +
      geom_histogram(mapping = aes(x = !!as.symbol(col_name), weight = population, fill = !!as.symbol(col_name), group = !!as.symbol(col_name))) +
  geom_vline(mapping = aes(xintercept = 5)) +
  geom_vline(mapping = aes(xintercept = 20)) +
      scale_fill_gradient(low = "#a1f5ff",
                          high = "#1a1638") +
  scale_x_continuous(breaks = seq(0, 40, 5)) +
  labs(x = expression("Annual Average" ~ PM[2.5] ~ " Concentration (in µg/m³)"), 
       y = "Number of people", 
       fill = expression("Annual average" ~ PM[2.5] ~ " concentration (in µg/m³)")) +
  themes_aqli_base +
  geom_text(x = 7, y = 10000000, label =  expression("WHO" ~ PM[2.5] ~ "guideline"), size = 5) +
    geom_text(x = 22, y = 10000000, label =  expression("National" ~ PM[2.5] ~ "standard"), size = 5) +
  theme(plot.background = element_rect(color = "white", fill = "white"))


  
  
# colombia factsheet appendix table
  
# appendix table (gadm level 2)
gadm2_aqli_2021 %>%
    filter(country == "Colombia") %>%
    select(name_1, name_2, population, pm2021, llpp_who_2021, llpp_nat_2021) %>%
    mutate(pop_millions = round(population/1000000, 1), 
           pm2021 = round(pm2021, 1), 
           llpp_who_2021 = round(llpp_who_2021, 1), 
           llpp_nat_2021 = round(llpp_nat_2021, 1)) %>%
  mutate(lyg_red_pm2.5_30perc_2021 = round((pm2021*0.3)*0.098, 1)) %>%
    slice_max(population, n = 25) %>% 
    select(name_1, name_2, pop_millions, pm2021, llpp_who_2021, lyg_red_pm2.5_30perc_2021) %>%
    rename(`Population (Millions)` = pop_millions, 
           "Department" = name_1, 
           "Muncipality" = name_2, 
           "PM2.5 concentration 2021 (in µg/m³)" = pm2021, 
           "Life Expectancy Gains from reducing PM2.5 from 2021 Concentrations to the WHO Guideline of 5 µg/m³" = llpp_who_2021, 
           "Life Expectancy Gains from reducing PM2.5 from 2021 Concentrations by 30 percent" = lyg_red_pm2.5_30perc_2021) %>%
    write_csv("./[July052023]Colombia Factsheet 2023 appendix table.csv")
  


```



# Guatemala Factsheet
```{r}
# figure 1 ---------

# guatemala fs fig 1 data
guatemala_fs_fig1_dataset <- gadm2_aqli_2021 %>%
  filter(country == "Guatemala") %>% 
  left_join(gadm2_aqli_2021, by = c("objectid_gadm2" = "obidgadm2")) %>%
  select('country', 'name_1', 'name_2', 'population', 'pm2021', 'llpp_who_2021', 'geometry') %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021") %>%
  select(-geometry, geometry) %>%
  st_as_sf()

# guatemala fs figure 1
guatemala_fs_fig1 <- guatemala_fs_fig1_dataset %>%
  ggplot() +
  geom_sf(mapping = aes(fill = reorder(lyl_bucket, order_lyl_bucket)), color = "aliceblue", lwd = 0.05) +
  geom_sf(data = gadm1_aqli_2021 %>% filter(name0 == "Guatemala"), color = "azure4", fill = "transparent", lwd = 0.15) +
  geom_sf(data = gadm0_aqli_2021 %>% filter(name0 == "Guatemala"), color = "cornsilk4", fill = "transparent", lwd = 0.5) +
  ggthemes::theme_map() + 
  scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  ggthemes::theme_map() +
  labs(fill = "Potential gain in life expectancy (Years)") + 
  theme(legend.position = "bottom", 
        legend.justification = c(0.5, 3), 
        legend.background = element_rect(color = "black"), 
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15), 
        plot.title = element_text(hjust = 0.5, size = 15), 
        legend.box.margin = margin(b = 1, unit = "cm"),
        plot.subtitle = element_text(hjust = 0.5, size = 7), 
        plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
        legend.key = element_rect(color = "black"), 
        legend.box.spacing = unit(0, "cm"), 
        legend.direction = "horizontal") +
  guides(fill = guide_legend(nrow = 1))

# figure 2 ---------

# guatemala fs fig 2 data
guatemala_fs_fig2_dataset <- gadm2_aqli_2021 %>%
  filter(country == "Guatemala") %>%
  select('country', 'name_1', 'name_2', 'population', 'pm2021', 'llpp_who_2021') %>%
  group_by(name_1) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE),
         pm2021_pop_weighted = pop_weights*pm2021,
         llpp_who_2021_pop_weighted = pop_weights*llpp_who_2021) %>%
  summarise(tot_pop = sum(population, na.rm = TRUE), 
            avg_pm2.5_2021 = sum(pm2021_pop_weighted, na.rm = TRUE),
            le_gain = (avg_pm2.5_2021 - who_guideline)*le_constant,
            llpp_who_2021 = sum(llpp_who_2021_pop_weighted, na.rm = TRUE),
            le_gain = ifelse(le_gain < 0 , 0, le_gain)) %>%
  slice_max(tot_pop, n = 10) %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021")

# guatemala fs figure 2
guatemala_fs_fig2 <- guatemala_fs_fig2_dataset %>%
  ggplot() +
  geom_col(mapping = aes(x = reorder(name_1, llpp_who_2021), y = llpp_who_2021, fill = lyl_bucket), width = 0.5) +
  labs(x = "Department", y = "Potential Gain in Life Expectancy (Years)", fill = "Potential gain in life expectancy (Years)") +
  scale_y_continuous(breaks = seq(0, 4, 1), limits = c(0, 4)) +
  scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  coord_flip() + 
  ggthemes::theme_tufte() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5, size = 16), 
        plot.subtitle = element_text(hjust =  0.5, size = 10, face = "italic", margin = margin(b = 0.8, unit = "cm")), 
        plot.caption = element_text(size = 8, hjust = 0, face = "italic"),
        legend.box.background = element_rect(color = "black"),
        plot.background = element_rect(color = "white"),
        axis.line = element_line(), 
        axis.text = element_text(size = 11), 
        axis.title = element_text(size = 13), 
        axis.title.y = element_text(margin = margin(r = 0.7, unit = "cm")), 
        axis.title.x = element_text(margin = margin(t = 0.6, b = 0.6, unit = "cm")), 
        axis.ticks = element_blank()) 

# figure 3 ---------

# read and filter gbd results for guatemala
gbd_results_guatemala <- gbd_results_master_2021 %>%
  filter(country == "Guatemala")

# filtering out those causes of death that are sort of* covered under PM2.5 in some broad way
colnames(gbd_results_guatemala)[3] <- c("llpp_who_2021")

# guatemala fs fig 3 data
guatemala_fs_fig3_dataset <- gbd_results_guatemala %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021") %>%
  slice_max(llpp_who_2021, n = 5)

# guatemala factsheet figure 3
guatemala_fs_fig3 <- guatemala_fs_fig3_dataset %>%
  ggplot() + 
  geom_col(mapping = aes(x = reorder(cause_of_death, llpp_who_2021), y = llpp_who_2021, fill = reorder(lyl_bucket, order_lyl_bucket)), width = 0.5, color = "black") +
  labs(x = "Threats to life expectancy", y = "Life Years Lost", fill = "Life years lost") +
  coord_flip() + 
  ggthemes::theme_tufte() +
  theme(legend.position = "bottom",
        axis.text = element_text(size = 14),
        axis.title.y = element_text(size = 16, margin = margin(r = 0.6, unit = "cm")),
        axis.title.x = element_text(size = 16, margin = margin(t = 0.6, b = 0.6, unit = "cm")),
        plot.caption = element_text(hjust = 0, size = 8, margin = margin(t = 0.8, unit = "cm"), face = "italic"),
        plot.title = element_text(hjust = 0.5, size = 20, margin = margin(b = 0.8, unit = "cm")),
        plot.subtitle = element_text(hjust = 0.5, size = 10, margin = margin(b = 0.8, unit = "cm"), face = "italic"),
        legend.box.background = element_rect(color = "black"),
        plot.background = element_rect(color = "white"),
        axis.line = element_line(), 
        legend.text = element_text(size = 11), 
        legend.title = element_text(size = 14),
        panel.grid.major.y = element_blank()) +
  scale_y_continuous(breaks = seq(0, 6, 0.5)) +
  # scale_x_discrete(limits = cause_of_death_ordered[seq(1, length(cause_of_death_ordered), by = 2)]) +
  scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  guides(fill = guide_legend(nrow = 1))

# figure 4 ---------

# guatemala factsheet figure 4 dataset
guatemala_fs_fig4_dataset <- gadm2_aqli_2021 %>%
  filter(country == "Guatemala") %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE),
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2021_weighted, names_to = "years",
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+"))),
         region = "National Average") %>%
  select(years, region, pop_weighted_avg_pm2.5)

# guatemala factsheet figure 4
guatemala_fs_fig4 <- guatemala_fs_fig4_dataset %>%
  ggplot() +
  geom_line(mapping = aes(x = as.integer(years), 
                          y = as.double(pop_weighted_avg_pm2.5)), 
            lwd = 1.1, color = "#5f7aa5") +
  geom_hline(mapping = aes(yintercept = 5), lwd = 0.8, linetype = "dotted") +
  scale_y_continuous(breaks = seq(0, 100, 5), limits = c(0, 35)) +
  scale_x_continuous(breaks = c(seq(1998, 2019, 3), 2021))  +
  ggthemes::theme_tufte() +
  labs(x = "Year", 
       y = expression("Annual Average" ~ PM[2.5] ~ "Concentration (in µg/m³)")) +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 11),
        legend.title = element_blank(),
        axis.title.y = element_text(size = 13, margin = margin(r = 0.6, unit = "cm")), 
        axis.title.x = element_text(size = 13, margin = margin(t = 0.6, b = 0.6, unit = "cm")), 
        axis.line = element_line(), 
        legend.box.background = element_rect(color = "black"),
        plot.title = element_text(hjust = 0.5, size = 16, margin = margin(b = 0.7, unit = "cm")), 
        plot.subtitle = element_text(hjust = 0.5, size = 8, face = "italic"), 
        plot.caption = element_text(size = 7, margin = margin(t = 0.8, unit = "cm"), hjust = 0, face = "italic"),
        axis.text = element_text(size = 12), 
        plot.background = element_rect(color = "white"), 
        axis.ticks = element_blank()) +
  geom_text(x = 2000.6, y = 5.9, label = expression("WHO" ~ PM[2.5] ~ "Guideline (last updated: 2021): 5 µg/m³"), size = 4.5)

# appendix table ---------

# guatemala factsheet appendix table 
guatemala_fs_appendix_table <- gadm2_aqli_2021 %>%
  filter(country == "Guatemala") %>%
  mutate(pm2021 = round(pm2021, 1),
         le_gain_red_to_who = round((pm2021 - who_guideline)*le_constant, 1),
         le_gain_red_to_who = ifelse(le_gain_red_to_who < 0, 0, le_gain_red_to_who),
         le_gain_red_by_30_percent = round((pm2021*0.3)*le_constant, 1), 
         pop_hun_thou = round(population/100000, 3)) %>%
  select(name_2, pop_hun_thou, pm2021, le_gain_red_to_who, 
         le_gain_red_by_30_percent) %>%
  ungroup() %>%
  slice_max(pop_hun_thou, n = 25) %>%
  mutate(pop_hun_thou = round(pop_hun_thou, 1)) %>%
  rename(`Municipality` = name_2, 
         `Population (Hundred thousands)` = pop_hun_thou, 
         `Annual Average 2021 PM2.5 Concentration (µg/m³)` = pm2021,
         `Life Expectancy Gains from reducing PM2.5 from 2021 concentration to WHO PM2.5 guideline of 5 µg/m` = le_gain_red_to_who, 
         `Life Expectancy Gains from reducing PM2.5 from 2021 concentration by 30 percent` = le_gain_red_by_30_percent) 

```



# Indonesia Factsheet
```{r}

# figure 1 ---------

# indonesia fs fig 1 data
indonesia_fs_fig1_dataset <- gadm2_aqli_2021 %>%
  filter(country == "Indonesia") %>% 
  left_join(gadm2_aqli_2021, by = c("objectid_gadm2" = "obidgadm2")) %>%
  select('country', 'name_1', 'name_2', 'population', 'pm2021', 'llpp_who_2021', 'geometry') %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021") %>%
  select(-geometry, geometry) %>%
  st_as_sf()

# indonesia fs figure 1
indonesia_fs_fig1 <- indonesia_fs_fig1_dataset %>%
  ggplot() +
  geom_sf(mapping = aes(fill = reorder(lyl_bucket, order_lyl_bucket)), color = "aliceblue", lwd = 0.05) +
  geom_sf(data = gadm1_aqli_2021 %>% filter(name0 == "Indonesia"), color = "azure4", fill = "transparent", lwd = 0.15) +
  geom_sf(data = gadm0_aqli_2021 %>% filter(name0 == "Indonesia"), color = "cornsilk4", fill = "transparent", lwd = 0.5) +
  ggthemes::theme_map() + 
  scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  ggthemes::theme_map() +
  labs(fill = "Potential gain in life expectancy (Years)") + 
  theme(legend.position = "bottom", 
        legend.justification = c(0.5, 3), 
        legend.background = element_rect(color = "black"), 
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15), 
        plot.title = element_text(hjust = 0.5, size = 15), 
        legend.box.margin = margin(b = 1, unit = "cm"),
        plot.subtitle = element_text(hjust = 0.5, size = 7), 
        plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
        legend.key = element_rect(color = "black"), 
        legend.box.spacing = unit(0, "cm"), 
        legend.direction = "horizontal") +
  guides(fill = guide_legend(nrow = 1))

# figure 2 ---------

# indonesia fs fig 2 data
indonesia_fs_fig2_dataset <- gadm_aqli_2021 %>%
  filter(country == "Indonesia") %>%
  select('country', 'name_1', 'name_2', 'population', 'pm2021', 'llpp_who_2021') %>%
  group_by(name_1) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE),
         pm2021_pop_weighted = pop_weights*pm2021,
         llpp_who_2021_pop_weighted = pop_weights*llpp_who_2021) %>%
  summarise(tot_pop = sum(population, na.rm = TRUE), 
            avg_pm2.5_2021 = sum(pm2021_pop_weighted, na.rm = TRUE),
            le_gain = (avg_pm2.5_2021 - who_guideline)*le_constant,
            llpp_who_2021 = sum(llpp_who_2021_pop_weighted, na.rm = TRUE),
            le_gain = ifelse(le_gain < 0 , 0, le_gain)) %>%
  slice_max(tot_pop, n = 10) %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021")

# indonesia fs figure 2
indonesia_fs_fig2 <- indonesia_fs_fig2_dataset %>%
  ggplot() +
  geom_col(mapping = aes(x = reorder(name_1, llpp_who_2021), y = llpp_who_2021, fill = lyl_bucket), width = 0.5) +
  labs(x = "Province", y = "Potential Gain in Life Expectancy (Years)", fill = "Potential gain in life expectancy (Years)") +
  scale_y_continuous(breaks = seq(0, 3, 1), limits = c(0, 3)) +
  scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  coord_flip() + 
  ggthemes::theme_tufte() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5, size = 16), 
        plot.subtitle = element_text(hjust =  0.5, size = 10, face = "italic", margin = margin(b = 0.8, unit = "cm")), 
        plot.caption = element_text(size = 8, hjust = 0, face = "italic"),
        legend.box.background = element_rect(color = "black"),
        plot.background = element_rect(color = "white"),
        axis.line = element_line(), 
        axis.text = element_text(size = 11), 
        axis.title = element_text(size = 13), 
        axis.title.y = element_text(margin = margin(r = 0.7, unit = "cm")), 
        axis.title.x = element_text(margin = margin(t = 0.6, b = 0.6, unit = "cm")), 
        axis.ticks = element_blank()) 

# figure 3 -----------

# read and filter gbd results for indonesia
gbd_results_indonesia <- gbd_results_master_2021 %>%
  filter(country == "Indonesia") 

# filtering out those causes of death that are sort of* covered under PM2.5 in some broad way
colnames(gbd_results_indonesia)[3] <- c("llpp_who_2021")

# indonesia fs fig 3 data
indonesia_fs_fig3_dataset <- gbd_results_indonesia %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021") %>%
  slice_max(llpp_who_2021, n = 10)

# indonesia factsheet figure 3
indonesia_fs_fig3 <- indonesia_fs_fig3_dataset %>%
  ggplot() + 
  geom_col(mapping = aes(x = reorder(cause_of_death, llpp_who_2021), y = llpp_who_2021, fill = reorder(lyl_bucket, order_lyl_bucket)), width = 0.5, color = "black") +
  labs(x = "Threats to life expectancy", y = "Life Years Lost", fill = "Life years lost") +
  coord_flip() + 
  ggthemes::theme_tufte() +
  theme(legend.position = "bottom",
        axis.text = element_text(size = 14),
        axis.title.y = element_text(size = 16, margin = margin(r = 0.6, unit = "cm")),
        axis.title.x = element_text(size = 16, margin = margin(t = 0.6, b = 0.6, unit = "cm")),
        plot.caption = element_text(hjust = 0, size = 8, margin = margin(t = 0.8, unit = "cm"), face = "italic"),
        plot.title = element_text(hjust = 0.5, size = 20, margin = margin(b = 0.8, unit = "cm")),
        plot.subtitle = element_text(hjust = 0.5, size = 10, margin = margin(b = 0.8, unit = "cm"), face = "italic"),
        legend.box.background = element_rect(color = "black"),
        plot.background = element_rect(color = "white"),
        axis.line = element_line(), 
        legend.text = element_text(size = 11), 
        legend.title = element_text(size = 14),
        panel.grid.major.y = element_blank()) +
  scale_y_continuous(breaks = seq(0, 7, 0.5)) +
  # scale_x_discrete(limits = cause_of_death_ordered[seq(1, length(cause_of_death_ordered), by = 2)]) +
  scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  guides(fill = guide_legend(nrow = 1))

# figure 4 ---------

# indonesia factsheet figure 4 dataset
indonesia_fs_fig4_dataset <- gadm2_aqli_2021 %>%
  filter(country == "Indonesia") %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE),
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2021_weighted, names_to = "years",
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+"))),
         region = "National Average") %>%
  select(years, region, pop_weighted_avg_pm2.5)

# indonesia factsheet figure 4
indonesia_fs_fig4 <- indonesia_fs_fig4_dataset %>%
  ggplot() +
  geom_line(mapping = aes(x = as.integer(years), 
                          y = as.double(pop_weighted_avg_pm2.5)), 
            lwd = 1.1, color = "#82b5d5") +
  geom_hline(mapping = aes(yintercept = 5), lwd = 0.8, linetype = "dotted") +
  geom_hline(mapping = aes(yintercept = 15), lwd = 0.8, linetype = "dotted") + 
  scale_y_continuous(breaks = seq(0, 100, 5), limits = c(0, 30)) +
  scale_x_continuous(breaks = c(seq(1998, 2019, 3), 2021))  +
  ggthemes::theme_tufte() +
  labs(x = "Year", 
       y = expression("Annual Average" ~ PM[2.5] ~ "Concentration (in µg/m³)")) +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 11),
        legend.title = element_blank(),
        axis.title.y = element_text(size = 13, margin = margin(r = 0.6, unit = "cm")), 
        axis.title.x = element_text(size = 13, margin = margin(t = 0.6, b = 0.6, unit = "cm")), 
        axis.line = element_line(), 
        legend.box.background = element_rect(color = "black"),
        plot.title = element_text(hjust = 0.5, size = 16, margin = margin(b = 0.7, unit = "cm")), 
        plot.subtitle = element_text(hjust = 0.5, size = 8, face = "italic"), 
        plot.caption = element_text(size = 7, margin = margin(t = 0.8, unit = "cm"), hjust = 0, face = "italic"),
        axis.text = element_text(size = 12), 
        plot.background = element_rect(color = "white"), 
        axis.ticks = element_blank()) +
  geom_text(x = 2001, y = 5.6, label = expression("WHO" ~ PM[2.5] ~ "Guideline (last updated: 2021): 5 µg/m³"), size = 5) +
  geom_text(x = 2006.6, y = 15.6, label = expression("Indonesia National" ~ PM[2.5] ~ "Standard: 15 µg/m³"), size = 5)

# appendix table ---------

# indonesia factsheet appendix table 
indonesia_fs_appendix_table <- gadm2_aqli_2021 %>%
  filter(country == "Indonesia") %>%
  mutate(pm2021 = round(pm2021, 1),
         le_gain_red_to_who = round((pm2021 - who_guideline)*le_constant, 1),
         le_gain_red_to_who = ifelse(le_gain_red_to_who < 0, 0, le_gain_red_to_who),
         le_gain_red_to_nat = round((pm2021 - natstandard)*le_constant, 1),
         le_gain_red_to_nat = ifelse(le_gain_red_to_nat < 0, 0, le_gain_red_to_nat),
         le_gain_red_by_30_percent = round((pm2021*0.3)*le_constant, 1), 
         pop_millions = round(population/1000000, 3)) %>%
  select(name_2, pop_millions, pm2021, le_gain_red_to_who, le_gain_red_to_nat,
         le_gain_red_by_30_percent) %>%
  ungroup() %>%
  slice_max(pop_millions, n = 25) %>%
  mutate(pop_millions = round(pop_millions, 1)) %>%
  rename(`Regency/City` = name_2, 
         `Population (millions)` = pop_millions, 
         `Annual Average 2021 PM2.5 Concentration (µg/m³)` = pm2021,
         `Life Expectancy Gains from reducing PM2.5 from 2021 concentration to WHO PM2.5 guideline of 5 µg/m` = le_gain_red_to_who, 
         `Life Expectancy Gains from reducing PM2.5 from 2021 concentration to National PM2.5 guideline of 15 µg/m³` = le_gain_red_to_nat,
         `Life Expectancy Gains from reducing PM2.5 from 2021 concentration by 30 percent` = le_gain_red_by_30_percent) 

```



# Nepal Factsheet
```{r}
# figure 1 ---------

# nepal fs fig 1 data
nepal_fs_fig1_dataset <- gadm2_aqli_2021 %>%
  filter(country == "Nepal") %>%
  left_join(gadm2_aqli_2021, by = c("objectid_gadm2" = "obidgadm2")) %>%
  select('country', 'name_1', 'name_2', 'population', 'pm2021', 'llpp_who_2021', 'geometry') %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021") %>%
  select(-geometry, geometry) %>%
  st_as_sf()

# nepal fs figure 1
nepal_fs_fig1 <- nepal_fs_fig1_dataset %>%
  ggplot() +
  geom_sf(mapping = aes(fill = reorder(lyl_bucket, order_lyl_bucket)), color = "aliceblue", lwd = 0.05) +
  geom_sf(data = gadm1_aqli_2021 %>% filter(name0 == "Nepal"), color = "azure4", fill = "transparent", lwd = 0.15) +
  geom_sf(data = gadm0_aqli_2021 %>% filter(name0 == "Nepal"), color = "cornsilk4", fill = "transparent", lwd = 0.5) +
  ggthemes::theme_map() + 
  scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  ggthemes::theme_map() +
  labs(fill = "Potential gain in life expectancy (Years)") + 
  theme(legend.position = "bottom", 
        legend.justification = c(0.5, 3), 
        legend.background = element_rect(color = "black"), 
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15), 
        plot.title = element_text(hjust = 0.5, size = 15), 
        legend.box.margin = margin(b = 1, unit = "cm"),
        plot.subtitle = element_text(hjust = 0.5, size = 7), 
        plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
        legend.key = element_rect(color = "black"), 
        legend.box.spacing = unit(0, "cm"), 
        legend.direction = "horizontal") +
  guides(fill = guide_legend(nrow = 1))

# figure 2 ----------

# nepal fs fig 2 data
nepal_fs_fig2_dataset <- gadm2_aqli_2021 %>%
  filter(country == "Nepal") %>%
  select('country', 'name_1', 'name_2', 'population', 'pm2021', 'llpp_who_2021') %>%
  group_by(name_1) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE),
         pm2021_pop_weighted = pop_weights*pm2021,
         llpp_who_2021_pop_weighted = pop_weights*llpp_who_2021) %>%
  summarise(tot_pop = sum(population, na.rm = TRUE), 
            avg_pm2.5_2021 = sum(pm2021_pop_weighted, na.rm = TRUE),
            le_gain = (avg_pm2.5_2021 - who_guideline)*le_constant,
            llpp_who_2021 = sum(llpp_who_2021_pop_weighted, na.rm = TRUE),
            le_gain = ifelse(le_gain < 0 , 0, le_gain)) %>%
  slice_max(tot_pop, n = 10) %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021")

# nepal fs figure 2
nepal_fs_fig2 <- nepal_fs_fig2_dataset %>%
  ggplot() +
  geom_col(mapping = aes(x = reorder(name_1, llpp_who_2021), y = llpp_who_2021, fill = lyl_bucket), width = 0.5) +
  labs(x = "Province", y = "Potential Gain in Life Expectancy (Years)", fill = "Potential gain in life expectancy (Years)") +
  scale_y_continuous(breaks = seq(0, 8, 1), limits = c(0, 8)) +
  scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  coord_flip() + 
  ggthemes::theme_tufte() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5, size = 16), 
        plot.subtitle = element_text(hjust =  0.5, size = 10, face = "italic", margin = margin(b = 0.8, unit = "cm")), 
        plot.caption = element_text(size = 8, hjust = 0, face = "italic"),
        legend.box.background = element_rect(color = "black"),
        plot.background = element_rect(color = "white"),
        axis.line = element_line(), 
        axis.text = element_text(size = 11), 
        axis.title = element_text(size = 13), 
        axis.title.y = element_text(margin = margin(r = 0.7, unit = "cm")), 
        axis.title.x = element_text(margin = margin(t = 0.6, b = 0.6, unit = "cm")), 
        axis.ticks = element_blank()) 

# figure 3 -----------

# read and filter gbd results for nepal
gbd_results_nepal <-  gbd_results_master_2021  %>%
  filter(country == "Nepal")

# filtering out those causes of death that are sort of* covered under PM2.5 in some broad way
colnames(gbd_results_nepal)[3] <- c("llpp_who_2021")

# nepal fs fig 3 data
nepal_fs_fig3_dataset <- gbd_results_master_2021 %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021") %>%
  slice_max(llpp_who_2021, n = 5)

# nepal factsheet figure 3
nepal_fs_fig3 <- nepal_fs_fig3_dataset %>%
  ggplot() + 
  geom_col(mapping = aes(x = reorder(cause_of_death, llpp_who_2021), y = llpp_who_2021, fill = reorder(lyl_bucket, order_lyl_bucket)), width = 0.5, color = "black") +
  labs(x = "Threats to life expectancy", y = "Life Years Lost", fill = "Life years lost") +
  coord_flip() + 
  ggthemes::theme_tufte() +
  theme(legend.position = "bottom",
        axis.text = element_text(size = 14),
        axis.title.y = element_text(size = 16, margin = margin(r = 0.6, unit = "cm")),
        axis.title.x = element_text(size = 16, margin = margin(t = 0.6, b = 0.6, unit = "cm")),
        plot.caption = element_text(hjust = 0, size = 8, margin = margin(t = 0.8, unit = "cm"), face = "italic"),
        plot.title = element_text(hjust = 0.5, size = 20, margin = margin(b = 0.8, unit = "cm")),
        plot.subtitle = element_text(hjust = 0.5, size = 10, margin = margin(b = 0.8, unit = "cm"), face = "italic"),
        legend.box.background = element_rect(color = "black"),
        plot.background = element_rect(color = "white"),
        axis.line = element_line(), 
        legend.text = element_text(size = 11), 
        legend.title = element_text(size = 14),
        panel.grid.major.y = element_blank()) +
  scale_y_continuous(breaks = seq(0, 6, 0.5)) +
  # scale_x_discrete(limits = cause_of_death_ordered[seq(1, length(cause_of_death_ordered), by = 2)]) +
  scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  guides(fill = guide_legend(nrow = 1))

# figure 4 --------

# nepal factsheet figure 4 dataset
nepal_fs_fig4_dataset <- gadm2_aqli_2021 %>%
  filter(country == "Nepal") %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE),
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2021_weighted, names_to = "years",
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+"))),
         region = "National Average") %>%
  select(years, region, pop_weighted_avg_pm2.5)

# nepal factsheet figure 4
nepal_fs_fig4 <- nepal_fs_fig4_dataset %>%
  ggplot() +
  geom_line(mapping = aes(x = as.integer(years), 
                          y = as.double(pop_weighted_avg_pm2.5)), 
            lwd = 1.1, color = "#3c456f") +
  geom_hline(mapping = aes(yintercept = 5), lwd = 0.8, linetype = "dotted") +
  scale_y_continuous(breaks = seq(0, 100, 5), limits = c(0, 60)) +
  scale_x_continuous(breaks = c(seq(1998, 2019, 3), 2021))  +
  ggthemes::theme_tufte() +
  labs(x = "Year", 
       y = expression("Annual Average" ~ PM[2.5] ~ "Concentration (in µg/m³)")) +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 11),
        legend.title = element_blank(),
        axis.title.y = element_text(size = 13, margin = margin(r = 0.6, unit = "cm")), 
        axis.title.x = element_text(size = 13, margin = margin(t = 0.6, b = 0.6, unit = "cm")), 
        axis.line = element_line(), 
        legend.box.background = element_rect(color = "black"),
        plot.title = element_text(hjust = 0.5, size = 16, margin = margin(b = 0.7, unit = "cm")), 
        plot.subtitle = element_text(hjust = 0.5, size = 8, face = "italic"), 
        plot.caption = element_text(size = 7, margin = margin(t = 0.8, unit = "cm"), hjust = 0, face = "italic"),
        axis.text = element_text(size = 12), 
        plot.background = element_rect(color = "white"), 
        axis.ticks = element_blank()) +
  geom_text(x = 2000.6, y = 6.8, label = expression("WHO" ~ PM[2.5] ~ "Guideline (last updated: 2021): 5 µg/m³"), size = 4.5)

# appendix table -----------

# nepal factsheet appendix table 
nepal_fs_appendix_table <- gadm_aqli_2021 %>%
  mutate(pm2021 = round(pm2021, 1),
         le_gain_red_to_who = round((pm2021 - who_guideline)*le_constant, 1),
         le_gain_red_to_who = ifelse(le_gain_red_to_who < 0, 0, le_gain_red_to_who),
         le_gain_red_by_30_percent = round((pm2021*0.3)*le_constant, 1), 
         pop_millions = round(population/1000000, 3)) %>%
  select(name_2, pop_millions, pm2021, le_gain_red_to_who, 
         le_gain_red_by_30_percent) %>%
  ungroup() %>%
  slice_max(pop_millions, n = 25) %>%
  mutate(pop_millions = round(pop_millions, 1)) %>%
  rename(`District Coordination Committee` = name_2, 
         `Population (Millions)` = pop_millions, 
         `Annual Average 2021 PM2.5 Concentration (µg/m³)` = pm2021,
         `Life Expectancy Gains from reducing PM2.5 from 2021 concentration to WHO PM2.5 guideline of 5 µg/m` = le_gain_red_to_who, 
         `Life Expectancy Gains from reducing PM2.5 from 2021 concentration by 30 percent` = le_gain_red_by_30_percent) 

```



# Nigeria Factsheet
```{r}

# figure 1 ---------

# nigeria fs fig 1 data
nigeria_fs_fig1_dataset <- gadm2_aqli_2021 %>%
  filter(country == "Nigeria") %>%
  left_join(gadm2_aqli_2021, by = c("objectid_gadm2" = "obidgadm2")) %>%
  select('country', 'name_1', 'name_2', 'population', 'pm2021', 'llpp_who_2021', 'geometry') %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021") %>%
  select(-geometry, geometry) %>%
  st_as_sf()

# nigeria fs figure 1
nigeria_fs_fig1 <- nigeria_fs_fig1_dataset %>%
  ggplot() +
  geom_sf(mapping = aes(fill = reorder(lyl_bucket, order_lyl_bucket)), color = "aliceblue", lwd = 0.05) +
  geom_sf(data = gadm1_aqli_2021 %>% filter(name0 == "Nigeria"), color = "azure4", fill = "transparent", lwd = 0.15) +
  geom_sf(data = gadm0_aqli_2021 %>% filter(name0 == "Nigeria"), color = "cornsilk4", fill = "transparent", lwd = 0.5) +
  ggthemes::theme_map() + 
  scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  ggthemes::theme_map() +
  labs(fill = "Potential gain in life expectancy (Years)") + 
  theme(legend.position = "bottom", 
        legend.justification = c(0.5, 3), 
        legend.background = element_rect(color = "black"), 
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15), 
        plot.title = element_text(hjust = 0.5, size = 15), 
        legend.box.margin = margin(b = 1, unit = "cm"),
        plot.subtitle = element_text(hjust = 0.5, size = 7), 
        plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
        legend.key = element_rect(color = "black"), 
        legend.box.spacing = unit(0, "cm"), 
        legend.direction = "horizontal") +
  guides(fill = guide_legend(nrow = 1))

# figure 2 ----------

# nigeria fs fig 2 data
nigeria_fs_fig2_dataset <- gadm2_aqli_2021 %>%
  filter(country == "Nigeria") %>%
  select('country', 'name_1', 'name_2', 'population', 'pm2021', 'llpp_who_2021') %>%
  group_by(name_1) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE),
         pm2021_pop_weighted = pop_weights*pm2021,
         llpp_who_2021_pop_weighted = pop_weights*llpp_who_2021) %>%
  summarise(tot_pop = sum(population, na.rm = TRUE), 
            avg_pm2.5_2021 = sum(pm2021_pop_weighted, na.rm = TRUE),
            le_gain = (avg_pm2.5_2021 - who_guideline)*le_constant,
            llpp_who_2021 = sum(llpp_who_2021_pop_weighted, na.rm = TRUE),
            le_gain = ifelse(le_gain < 0 , 0, le_gain)) %>%
  slice_max(tot_pop, n = 10) %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021")

# nigeria fs figure 2
nigeria_fs_fig2 <- nigeria_fs_fig2_dataset %>%
  ggplot() +
  geom_col(mapping = aes(x = reorder(name_1, llpp_who_2021), y = llpp_who_2021, fill = lyl_bucket), width = 0.5) +
  labs(x = "State", y = "Potential Gain in Life Expectancy (Years)", fill = "Potential gain in life expectancy (Years)") +
  scale_y_continuous(breaks = seq(0, 3, 1), limits = c(0, 3)) +
  scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  coord_flip() + 
  ggthemes::theme_tufte() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5, size = 16), 
        plot.subtitle = element_text(hjust =  0.5, size = 10, face = "italic", margin = margin(b = 0.8, unit = "cm")), 
        plot.caption = element_text(size = 8, hjust = 0, face = "italic"),
        legend.box.background = element_rect(color = "black"),
        plot.background = element_rect(color = "white"),
        axis.line = element_line(), 
        axis.text = element_text(size = 11), 
        axis.title = element_text(size = 13), 
        axis.title.y = element_text(margin = margin(r = 0.7, unit = "cm")), 
        axis.title.x = element_text(margin = margin(t = 0.6, b = 0.6, unit = "cm")), 
        axis.ticks = element_blank()) 

# figure 3 ---------

# read and filter gbd results for nigeria
gbd_results_nigeria <- gbd_results_master_2021  %>%
  filter(country == "Nigeria")

# filtering out those causes of death that are sort of* covered under PM2.5 in some broad way
colnames(gbd_results_nigeria)[3] <- c("llpp_who_2021")

# nigeria fs fig 3 data
nigeria_fs_fig3_dataset <- gbd_results_nigeria %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021") %>%
  slice_max(llpp_who_2021, n = 10)

# nigeria factsheet figure 3
nigeria_fs_fig3 <- nigeria_fs_fig3_dataset %>%
  ggplot() + 
  geom_col(mapping = aes(x = reorder(cause_of_death, llpp_who_2021), y = llpp_who_2021, fill = reorder(lyl_bucket, order_lyl_bucket)), width = 0.5, color = "black") +
  labs(x = "Threats to life expectancy", y = "Life Years Lost", fill = "Life years lost") +
  coord_flip() + 
  ggthemes::theme_tufte() +
  theme(legend.position = "bottom",
        axis.text = element_text(size = 14),
        axis.title.y = element_text(size = 16, margin = margin(r = 0.6, unit = "cm")),
        axis.title.x = element_text(size = 16, margin = margin(t = 0.6, b = 0.6, unit = "cm")),
        plot.caption = element_text(hjust = 0, size = 8, margin = margin(t = 0.8, unit = "cm"), face = "italic"),
        plot.title = element_text(hjust = 0.5, size = 20, margin = margin(b = 0.8, unit = "cm")),
        plot.subtitle = element_text(hjust = 0.5, size = 10, margin = margin(b = 0.8, unit = "cm"), face = "italic"),
        legend.box.background = element_rect(color = "black"),
        plot.background = element_rect(color = "white"),
        axis.line = element_line(), 
        legend.text = element_text(size = 11), 
        legend.title = element_text(size = 14),
        panel.grid.major.y = element_blank()) +
  scale_y_continuous(breaks = seq(0, 6, 0.5)) +
  # scale_x_discrete(limits = cause_of_death_ordered[seq(1, length(cause_of_death_ordered), by = 2)]) +
  scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  guides(fill = guide_legend(nrow = 1))

# figure 4 ----------

# nigeria factsheet figure 4 dataset
nigeria_fs_fig4_dataset <- gadm2_aqli_2021 %>%
  filter(country == "Nigeria") %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE),
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2021_weighted, names_to = "years",
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+"))),
         region = "National Average") %>%
  select(years, region, pop_weighted_avg_pm2.5)

# nigeria factsheet figure 4
nigeria_fs_fig4 <- nigeria_fs_fig4_dataset %>%
  ggplot() +
  geom_line(mapping = aes(x = as.integer(years), 
                          y = as.double(pop_weighted_avg_pm2.5)), 
            lwd = 1.1, color = "#7197be") +
  geom_hline(mapping = aes(yintercept = 5), lwd = 0.8, linetype = "dotted") +
  scale_y_continuous(breaks = seq(0, 100, 5), limits = c(0, 25)) +
  scale_x_continuous(breaks = c(seq(1998, 2019, 3), 2021))  +
  ggthemes::theme_tufte() +
  labs(x = "Year", 
       y = expression("Annual Average" ~ PM[2.5] ~ "Concentration (in µg/m³)")) +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 11),
        legend.title = element_blank(),
        axis.title.y = element_text(size = 13, margin = margin(r = 0.6, unit = "cm")), 
        axis.title.x = element_text(size = 13, margin = margin(t = 0.6, b = 0.6, unit = "cm")), 
        axis.line = element_line(), 
        legend.box.background = element_rect(color = "black"),
        plot.title = element_text(hjust = 0.5, size = 16, margin = margin(b = 0.7, unit = "cm")), 
        plot.subtitle = element_text(hjust = 0.5, size = 8, face = "italic"), 
        plot.caption = element_text(size = 7, margin = margin(t = 0.8, unit = "cm"), hjust = 0, face = "italic"),
        axis.text = element_text(size = 12), 
        plot.background = element_rect(color = "white"), 
        axis.ticks = element_blank()) +
  geom_text(x = 2000.6, y = 5.8, label = expression("WHO" ~ PM[2.5] ~ "Guideline (last updated: 2021): 5 µg/m³"), size = 4.5)

# appendix table ----------

# nigeria factsheet appendix table 
nigeria_fs_appendix_table <- gadm2_aqli_2021 %>%
  filter(country == "Nigeria") %>%
  mutate(pm2021 = round(pm2021, 1),
         le_gain_red_to_who = round((pm2021 - who_guideline)*le_constant, 1),
         le_gain_red_to_who = ifelse(le_gain_red_to_who < 0, 0, le_gain_red_to_who),
         le_gain_red_by_30_percent = round((pm2021*0.3)*le_constant, 1), 
         pop_millions = round(population/1000000, 3)) %>%
  select(name_2, pop_millions, pm2021, le_gain_red_to_who, 
         le_gain_red_by_30_percent) %>%
  ungroup() %>%
  slice_max(pop_millions, n = 25) %>%
  mutate(pop_millions = round(pop_millions, 1)) %>%
  rename(`Local Government Area` = name_2, 
         `Population (Millions)` = pop_millions, 
         `Annual Average 2021 PM2.5 Concentration (µg/m³)` = pm2021,
         `Life Expectancy Gains from reducing PM2.5 from 2021 concentration to WHO PM2.5 guideline of 5 µg/m` = le_gain_red_to_who, 
         `Life Expectancy Gains from reducing PM2.5 from 2021 concentration by 30 percent` = le_gain_red_by_30_percent) 

```



# Pakistan Factsheet
```{r}
# read and filter AQLI data
pak_aqli_2021 <- gadm2_aqli_2021 %>%
  filter(country == "Pakistan") %>%
  mutate(region = case_when(
    name_1 == "Islamabad" ~ "Islamabad",
    name_1 == "Punjab" ~ "Punjab",
    name_1 != "Islamabad"| name_1 != "Punjab" ~ "All other regions (excluding Islamabad and Punjab)"))

# figure 1 -----------

# pakistan fs fig 1 data
pak_fs_fig1_dataset <- pak_aqli_2021 %>%
  left_join(gadm2_aqli_2021, by = c("objectid_gadm2" = "obidgadm2")) %>%
  select('country', 'name_1', 'name_2', 'population', 'pm2021', 'llpp_who_2021', 'geometry') %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021") %>%
  select(-geometry, geometry) %>%
  st_as_sf()

# pakistan fs figure 1
pak_fs_fig1 <- pak_fs_fig1_dataset %>%
  ggplot() +
  geom_sf(mapping = aes(fill = reorder(lyl_bucket, order_lyl_bucket)), color = "aliceblue", lwd = 0.05) +
  geom_sf(data = gadm1_aqli_2021 %>% filter(name0 == "Pakistan"), color = "azure4", fill = "transparent", lwd = 0.15) +
  geom_sf(data = gadm0_aqli_2021 %>% filter(name0 == "Pakistan"), color = "cornsilk4", fill = "transparent", lwd = 0.5) +
  ggthemes::theme_map() + 
  scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  ggthemes::theme_map() +
  labs(fill = "Potential gain in life expectancy (Years)") + 
  theme(legend.position = "bottom", 
        legend.justification = c(0.5, 3), 
        legend.background = element_rect(color = "black"), 
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15), 
        plot.title = element_text(hjust = 0.5, size = 15), 
        legend.box.margin = margin(b = 1, unit = "cm"),
        plot.subtitle = element_text(hjust = 0.5, size = 7), 
        plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
        legend.key = element_rect(color = "black"), 
        legend.box.spacing = unit(0, "cm"), 
        legend.direction = "horizontal") +
  guides(fill = guide_legend(nrow = 1))

# figure 2 -----------

# pakistan fs fig 2 data
pak_fs_fig2_dataset <- pak_aqli_2021 %>%
  select('country', 'name_1', 'name_2', 'population', 'pm2021', 'llpp_who_2021', 'llpp_nat_2021') %>%
  group_by(name_1) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE),
         pm2021_pop_weighted = pop_weights*pm2021,
         llpp_who_2021_pop_weighted = pop_weights*llpp_who_2021,
         llpp_nat_2021_pop_weighted = pop_weights*llpp_nat_2021) %>%
  summarise(tot_pop = sum(population, na.rm = TRUE), 
            avg_pm2.5_2021 = sum(pm2021_pop_weighted, na.rm = TRUE),
            le_gain = (avg_pm2.5_2021 - who_guideline)*le_constant,
            llpp_who_2021 = sum(llpp_who_2021_pop_weighted, na.rm = TRUE),
            llpp_nat_2021 = sum(llpp_nat_2021_pop_weighted, na.rm = TRUE),
            le_gain = ifelse(le_gain < 0 , 0, le_gain)) %>%
  slice_max(tot_pop, n = 10) %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021")

# pakistan fs figure 2
pak_fs_fig2 <- pak_fs_fig2_dataset %>%
  ggplot() +
  geom_col(mapping = aes(x = reorder(name_1, llpp_who_2021), y = llpp_who_2021, fill = lyl_bucket), width = 0.5) +
  labs(x = "Province", y = "Potential Gain in Life Expectancy  (Years)", fill = "Potential gain in life expectancy (Years)") +
  scale_y_continuous(breaks = seq(0, 5, 1), limits = c(0, 5)) +
  scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  coord_flip() + 
  ggthemes::theme_tufte() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5, size = 16), 
        plot.subtitle = element_text(hjust =  0.5, size = 10, face = "italic", margin = margin(b = 0.8, unit = "cm")), 
        plot.caption = element_text(size = 8, hjust = 0, face = "italic"),
        legend.box.background = element_rect(color = "black"),
        plot.background = element_rect(color = "white"),
        axis.line = element_line(), 
        axis.text = element_text(size = 11), 
        axis.title = element_text(size = 13), 
        axis.title.y = element_text(margin = margin(r = 0.7, unit = "cm")), 
        axis.title.x = element_text(margin = margin(t = 0.6, b = 0.6, unit = "cm")), 
        axis.ticks = element_blank()) 

# figure 3 ----------

# read and filter gbd results for pakistan
gbd_results_pak <- gbd_results_master_2021 %>%
  filter(country == "Pakistan")

# filtering out those causes of death that are sort of* covered under PM2.5 in some broad way
colnames(gbd_results_pak)[3] <- c("llpp_who_2021")

# pakistan fs fig 3 data
pak_fs_fig3_dataset <- gbd_results_pak %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021") %>%
  slice_max(llpp_who_2021, n = 5)

# pakistan factsheet figure 3
pak_fs_fig3 <- pak_fs_fig3_dataset %>%
  ggplot() + 
  geom_col(mapping = aes(x = reorder(cause_of_death, llpp_who_2021), y = llpp_who_2021, fill = reorder(lyl_bucket, order_lyl_bucket)), width = 0.5, color = "black") +
  labs(x = "Threats to life expectancy", y = "Life Years Lost", fill = "Life years lost") +
  coord_flip() + 
  ggthemes::theme_tufte() +
  theme(legend.position = "bottom",
        axis.text = element_text(size = 14),
        axis.title.y = element_text(size = 16, margin = margin(r = 0.6, unit = "cm")),
        axis.title.x = element_text(size = 16, margin = margin(t = 0.6, b = 0.6, unit = "cm")),
        plot.caption = element_text(hjust = 0, size = 8, margin = margin(t = 0.8, unit = "cm"), face = "italic"),
        plot.title = element_text(hjust = 0.5, size = 20, margin = margin(b = 0.8, unit = "cm")),
        plot.subtitle = element_text(hjust = 0.5, size = 10, margin = margin(b = 0.8, unit = "cm"), face = "italic"),
        legend.box.background = element_rect(color = "black"),
        plot.background = element_rect(color = "white"),
        axis.line = element_line(), 
        legend.text = element_text(size = 11), 
        legend.title = element_text(size = 14),
        panel.grid.major.y = element_blank()) +
  scale_y_continuous(breaks = seq(0, 6, 0.5)) +
  # scale_x_discrete(limits = cause_of_death_ordered[seq(1, length(cause_of_death_ordered), by = 2)]) +
  scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  guides(fill = guide_legend(nrow = 1))

# figure 4 ---------

# pakistan factsheet figure 4 dataset
pak_region_avg_ts <- pak_aqli_2021 %>%
  group_by(region) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2021_weighted, names_to = "years", 
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+")))) %>%
  select(years, region, pop_weighted_avg_pm2.5)

pak_nat_avg_ts <- pak_aqli_2021 %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE),
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2021_weighted, names_to = "years",
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+"))),
         region = "National Average") %>%
  select(years, region, pop_weighted_avg_pm2.5)

pak_fs_fig4_dataset <- rbind(pak_region_avg_ts, pak_nat_avg_ts)

pak_fs_fig4_dataset$region = factor(pak_fs_fig4_dataset$region, levels = c('Islamabad', 'Punjab', 'National Average', 'All other regions (excluding Islamabad and Punjab)'))

# pakistan factsheet figure 4
pak_fs_fig4 <- pak_fs_fig4_dataset %>%
  ggplot() +
  geom_line(mapping = aes(x = as.integer(years), 
                          y = as.double(pop_weighted_avg_pm2.5),
                          colour = region, linetype = region), 
            lwd = 1.1) +
  geom_hline(mapping = aes(yintercept = 5), lwd = 0.8, linetype = "dotted") +
  scale_y_continuous(breaks = seq(0, 100, 5), limits = c(0, 60)) +
  scale_x_continuous(breaks = c(seq(1998, 2019, 3), 2021))  +
  scale_color_manual(values = c("Islamabad" = "#3c456f", "Punjab" = "#3c456f", "National Average" = "#4e5e8b", "All other regions (excluding Islamabad and Punjab)" = "#5f7aa5")) +
  scale_linetype_manual(values = c("Islamabad" = "dashed", "Punjab" = "dashed", "National Average" = "solid", "All other regions (excluding Islamabad and Punjab)" = "dotted")) +
  ggthemes::theme_tufte() +
  labs(x = "Year", 
       y = expression("Annual Average" ~ PM[2.5] ~ "Concentration (in µg/m³)")) +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 11),
        legend.title = element_blank(),
        axis.title.y = element_text(size = 13, margin = margin(r = 0.6, unit = "cm")), 
        axis.title.x = element_text(size = 13, margin = margin(t = 0.6, b = 0.6, unit = "cm")), 
        axis.line = element_line(), 
        legend.box.background = element_rect(color = "black"),
        plot.title = element_text(hjust = 0.5, size = 16, margin = margin(b = 0.7, unit = "cm")), 
        plot.subtitle = element_text(hjust = 0.5, size = 8, face = "italic"), 
        plot.caption = element_text(size = 7, margin = margin(t = 0.8, unit = "cm"), hjust = 0, face = "italic"),
        axis.text = element_text(size = 12), 
        plot.background = element_rect(color = "white"), 
        axis.ticks = element_blank()) +
  geom_text(x = 2000.6, y = 6.8, label = expression("WHO" ~ PM[2.5] ~ "Guideline (last updated: 2021): 5 µg/m³"), size = 4.5)

# appendix table ----------

# pakistan factsheet appendix table 
pak_fs_appendix_table <- pak_aqli_2021 %>%
  mutate(pm2021 = round(pm2021, 1),
         le_gain_red_to_who = round((pm2021 - who_guideline)*le_constant, 1),
         le_gain_red_to_who = ifelse(le_gain_red_to_who < 0, 0, le_gain_red_to_who),
         le_gain_red_to_nat = round((pm2021 - natstandard)*le_constant, 1),
         le_gain_red_to_nat = ifelse(le_gain_red_to_nat < 0, 0, le_gain_red_to_nat),
         le_gain_red_by_30_percent = round((pm2021*0.3)*le_constant, 1), 
         pop_millions = round(population/1000000, 3)) %>%
  select(name_2, pop_millions, pm2021, le_gain_red_to_who, le_gain_red_to_nat,
         le_gain_red_by_30_percent) %>%
  ungroup() %>%
  slice_max(pop_millions, n = 25) %>%
  mutate(pop_millions = round(pop_millions, 1)) %>%
  rename(`Region` = name_2, 
         `Population (Millions)` = pop_millions, 
         `Annual Average 2021 PM2.5 Concentration (µg/m³)` = pm2021,
         `Life Expectancy Gains from reducing PM2.5 from 2021 concentration to WHO PM2.5 guideline of 5 µg/m` = le_gain_red_to_who, 
         `Life Expectancy Gains from reducing PM2.5 from 2021 concentration to National PM2.5 guideline of 15 µg/m³` = le_gain_red_to_nat,
         `Life Expectancy Gains from reducing PM2.5 from 2021 concentration by 30 percent` = le_gain_red_by_30_percent) 

```



# Southeast Asia Factsheet
```{r}

# figure 1 ----------

# se_asia fs fig 1 data
se_asia_fs_fig1_dataset <- gadm2_aqli_2021 %>%
  filter(country %in% se_asia_vec) %>%
  left_join(gadm2_aqli_2021, by = c("objectid_gadm2" = "obidgadm2")) %>%
  select('country', 'name_1', 'name_2', 'population', 'pm2021', 'llpp_who_2021', 'geometry') %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021") %>%
  select(-geometry, geometry) %>%
  st_as_sf()

# se_asia fs figure 1
se_asia_fs_fig1 <- se_asia_fs_fig1_dataset %>%
  ggplot() +
  geom_sf(mapping = aes(fill = reorder(lyl_bucket, order_lyl_bucket)), color = "aliceblue", lwd = 0.05) +
  geom_sf(data = gadm1_aqli_2021 %>% filter(name0 %in% se_asia_countries), color = "azure4", fill = "transparent", lwd = 0.1) +
  geom_sf(data = gadm0_aqli_2021 %>% filter(name0 %in% se_asia_countries), color = "cornsilk4", fill = "transparent", lwd = 0.3) +
  ggthemes::theme_map() + 
  scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  ggthemes::theme_map() +
  labs(fill = "Potential gain in life expectancy (Years)") + 
  theme(legend.position = "bottom", 
        legend.justification = c(0.5, 3), 
        legend.background = element_rect(color = "black"), 
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15), 
        plot.title = element_text(hjust = 0.5, size = 15), 
        legend.box.margin = margin(b = 1, unit = "cm"),
        plot.subtitle = element_text(hjust = 0.5, size = 7), 
        plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
        legend.key = element_rect(color = "black"), 
        legend.box.spacing = unit(0, "cm"), 
        legend.direction = "horizontal") +
  guides(fill = guide_legend(nrow = 1))

# figure 2 ----------

# se_asia fs fig 2 data
se_asia_fs_fig2_dataset <- gadm2_aqli_2021 %>%
  filter(country %in% se_asia_vec) %>%
  select(country, name_1, name_2, name_1_country, population, pm2021, llpp_who_2021) %>%
  group_by(name_1_country) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE),
         pm2021_pop_weighted = pop_weights*pm2021,
         llpp_who_2021_pop_weighted = pop_weights*llpp_who_2021) %>%
  summarise(tot_pop = sum(population, na.rm = TRUE), 
            avg_pm2.5_2021 = sum(pm2021_pop_weighted, na.rm = TRUE),
            le_gain = (avg_pm2.5_2021 - who_guideline)*le_constant,
            llpp_who_2021 = sum(llpp_who_2021_pop_weighted, na.rm = TRUE),
            le_gain = ifelse(le_gain < 0 , 0, le_gain)) %>%
  slice_max(tot_pop, n = 10) %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021")
  
# se_asia fs figure 2
se_asia_fs_fig2 <- se_asia_fs_fig2_dataset %>%
  ggplot() +
  geom_col(mapping = aes(x = reorder(name_1_country, llpp_who_2021), y = llpp_who_2021, fill = lyl_bucket), width = 0.5) +
  labs(x = "Region", y = "Potential Gain in Life Expectancy (Years)", fill = "Potential gain in life expectancy (Years)") +
  scale_y_continuous(breaks = seq(0, 3, 1), limits = c(0, 3)) +
  scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  coord_flip() + 
  ggthemes::theme_tufte() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5, size = 16), 
        plot.subtitle = element_text(hjust =  0.5, size = 10, face = "italic", margin = margin(b = 0.8, unit = "cm")), 
        plot.caption = element_text(size = 8, hjust = 0, face = "italic"),
        legend.box.background = element_rect(color = "black"),
        plot.background = element_rect(color = "white"),
        axis.line = element_line(), 
        axis.text = element_text(size = 11), 
        axis.title = element_text(size = 13), 
        axis.title.y = element_text(margin = margin(r = 0.7, unit = "cm")), 
        axis.title.x = element_text(margin = margin(t = 0.6, b = 0.6, unit = "cm")), 
        axis.ticks = element_blank()) 

# figure 4 (time series)

# se_asia factsheet figure 4 dataset
se_asia_fs_fig4_dataset <- gadm2_aqli_2021 %>%
  filter(country %in% se_asia_vec) %>%
  filter(!is.na(population)) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE),
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2021_weighted, names_to = "years",
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+"))),
         region = "South East Asia Average") %>%
  select(years, region, pop_weighted_avg_pm2.5)

# se_asia factsheet figure 4
se_asia_fs_fig4 <- se_asia_fs_fig4_dataset %>%
  ggplot() +
  geom_line(mapping = aes(x = as.integer(years), 
                          y = as.double(pop_weighted_avg_pm2.5)), 
            lwd = 1.1, color = "#7197be") +
  geom_hline(mapping = aes(yintercept = 5), lwd = 0.8, linetype = "dotted") +
  scale_y_continuous(breaks = seq(0, 100, 5), limits = c(0, 30)) +
  scale_x_continuous(breaks = c(seq(1998, 2019, 3), 2021))  +
  ggthemes::theme_tufte() +
  labs(x = "Year", 
       y = expression("Annual Average" ~ PM[2.5] ~ "Concentration (in µg/m³)")) +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 11),
        legend.title = element_blank(),
        axis.title.y = element_text(size = 13, margin = margin(r = 0.6, unit = "cm")), 
        axis.title.x = element_text(size = 13, margin = margin(t = 0.6, b = 0.6, unit = "cm")), 
        axis.line = element_line(), 
        legend.box.background = element_rect(color = "black"),
        plot.title = element_text(hjust = 0.5, size = 16, margin = margin(b = 0.7, unit = "cm")), 
        plot.subtitle = element_text(hjust = 0.5, size = 8, face = "italic"), 
        plot.caption = element_text(size = 7, margin = margin(t = 0.8, unit = "cm"), hjust = 0, face = "italic"),
        axis.text = element_text(size = 12), 
        plot.background = element_rect(color = "white"), 
        axis.ticks = element_blank()) +
  geom_text(x = 2000.6, y = 5.8, label = expression("WHO" ~ PM[2.5] ~ "Guideline (last updated: 2021): 5 µg/m³"), size = 4.5)

# appendix table ----------

# se_asia factsheet appendix table 
se_asia_fs_appendix_table <- gadm2_aqli_2021 %>%
  filter(country %in% se_asia_vec) %>%
  group_by(country) %>%
  slice_max(population, n=5) %>%
  mutate(pm2021 = round(pm2021, 1),
         le_gain_red_to_who = round((pm2021 - who_guideline)*le_constant, 1),
         le_gain_red_to_who = ifelse(le_gain_red_to_who < 0, 0, le_gain_red_to_who),
         le_gain_red_by_30_percent = round((pm2021*0.3)*le_constant, 1), 
         pop_millions = round(population/100000, 3)) %>%
  select(country, name_2, pop_millions, pm2021, le_gain_red_to_who, 
         le_gain_red_by_30_percent) %>%
  mutate(pop_millions = round(pop_millions, 1)) %>%
  rename(`Country` = country,
         `Region` = name_2, 
         `Population (Hundred thousands)` = pop_millions, 
         `Annual Average 2021 PM2.5 Concentration (µg/m³)` = pm2021,
         `Life Expectancy Gains from reducing PM2.5 from 2021 concentration to WHO PM2.5 guideline of 5 µg/m` = le_gain_red_to_who, 
         `Life Expectancy Gains from reducing PM2.5 from 2021 concentration by 30 percent` = le_gain_red_by_30_percent) 


```



# Thailand Factsheet
```{r}
# read and filter AQLI data
ne_thai <- c("Amnat Charoen", "Bueng Kan", "Buri Ram", "Chaiyaphum", "Kalasin", "Khon Kaen", "Loei", 
             "Maha Sarakham", "Mukdahan", "Nakhon Phanom", "Nakhon Ratchasima", "Nong Bua Lam Phu", 
             "Nong Khai", "Roi Et", "Sakon Nakhon", "Si Sa Ket", "Surin", "Ubon Ratchathani", 
             "Udon Thani", "Yasothon")

n_thai <- c ("Chiang Mai", "Chiang Rai", "Lampang", "Lamphun", "Mae Hong Son", "Nan", "Phayao", "Phrae", 
             "Uttaradit", "Tak", "Kamphaeng Phet", "Phetchabun", "Phichit", "Phitsanulok", "Sukhothai",
             "Nakhon Sawan", "Uthai Thani")

c_thai <- c("Ang Thong", "Bangkok Metropolis", "Chai Nat", "Lop Buri", "Nakhon Pathom", "Nonthaburi", "Pathum Thani", 
            "Phra Nakhon Si Ayutthaya", "Samut Prakan", "Samut Sakhon", "Samut Songkhram", "Saraburi", 
            "Sing Buri", "Suphan Buri", "Nakhon Nayok", "Chachoengsao", "Chanthaburi", "Chon Buri", 
            "Prachin Buri", "Rayong", "Sa Kaeo", "Trat", "Kanchanaburi", "Ratchaburi", "Phetchaburi", "Prachuap Khiri Khan")

s_thai <- c("Chumphon", "Nakhon Si Thammarat", "Narathiwat", "Pattani", "Phatthalung", "Songkhla", "Surat Thani", 
            "Yala", "Krabi", "Phangnga", "Phuket", "Ranong", "Satun", "Trang")
  
thai_aqli_2021 <- gadm2_aqli_2021 %>%
  filter(country == "Thailand") %>%
  mutate(region = case_when(
    name_1 %in% ne_thai ~ "Northeastern",
    name_1 %in% n_thai ~ "Northern",
    name_1 %in% c_thai ~ "Central",
    name_1 %in% s_thai ~ "Southern"))

# figure 1 ---------

# thailand fs fig 1 data
thailand_fs_fig1_dataset <- thai_aqli_2021 %>%
  left_join(gadm2_aqli_2021, by = c("objectid_gadm2" = "obidgadm2")) %>%
  select('country', 'name_1', 'name_2', 'population', 'pm2021', 'llpp_who_2021', 'geometry') %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021") %>%
  select(-geometry, geometry) %>%
  st_as_sf()

# thailand fs figure 1
thailand_fs_fig1 <- thailand_fs_fig1_dataset %>%
  ggplot() +
  geom_sf(mapping = aes(fill = reorder(lyl_bucket, order_lyl_bucket)), color = "aliceblue", lwd = 0.05) +
  geom_sf(data = gadm1_aqli_2021 %>% filter(name0 == "Thailand"), color = "azure4", fill = "transparent", lwd = 0.15) +
  geom_sf(data = gadm0_aqli_2021 %>% filter(name0 == "Thailand"), color = "cornsilk4", fill = "transparent", lwd = 0.5) +
  ggthemes::theme_map() + 
  scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  ggthemes::theme_map() +
  labs(fill = "Potential gain in life expectancy (Years)") + 
  theme(legend.position = "bottom", 
        legend.justification = c(0.5, 3), 
        legend.background = element_rect(color = "black"), 
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15), 
        plot.title = element_text(hjust = 0.5, size = 15), 
        legend.box.margin = margin(b = 1, unit = "cm"),
        plot.subtitle = element_text(hjust = 0.5, size = 7), 
        plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
        legend.key = element_rect(color = "black"), 
        legend.box.spacing = unit(0, "cm"), 
        legend.direction = "horizontal") +
  guides(fill = guide_legend(nrow = 1))

# figure 2 ---------

# thailand fs fig 2 data
thailand_fs_fig2_dataset <- thai_aqli_2021 %>%
  select('country', 'name_1', 'name_2', 'population', 'pm2021', 'llpp_who_2021') %>%
  group_by(name_1) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE),
         pm2021_pop_weighted = pop_weights*pm2021,
         llpp_who_2021_pop_weighted = pop_weights*llpp_who_2021) %>%
  summarise(tot_pop = sum(population, na.rm = TRUE), 
            avg_pm2.5_2021 = sum(pm2021_pop_weighted, na.rm = TRUE),
            le_gain = (avg_pm2.5_2021 - who_guideline)*le_constant,
            llpp_who_2021 = sum(llpp_who_2021_pop_weighted, na.rm = TRUE),
            le_gain = ifelse(le_gain < 0 , 0, le_gain)) %>%
  slice_max(tot_pop, n = 10) %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021")

# thailand fs figure 2
thailand_fs_fig2 <- thailand_fs_fig2_dataset %>%
  ggplot() +
  geom_col(mapping = aes(x = reorder(name_1, llpp_who_2021), y = llpp_who_2021, fill = lyl_bucket), width = 0.5) +
  labs(x = "Province", y = "Potential Gain in Life Expectancy (Years)", fill = "Potential gain in life expectancy (Years)") +
  scale_y_continuous(breaks = seq(0, 3, 1), limits = c(0, 3)) +
  scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  coord_flip() + 
  ggthemes::theme_tufte() +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5, size = 16), 
        plot.subtitle = element_text(hjust =  0.5, size = 10, face = "italic", margin = margin(b = 0.8, unit = "cm")), 
        plot.caption = element_text(size = 8, hjust = 0, face = "italic"),
        legend.box.background = element_rect(color = "black"),
        plot.background = element_rect(color = "white"),
        axis.line = element_line(), 
        axis.text = element_text(size = 11), 
        axis.title = element_text(size = 13), 
        axis.title.y = element_text(margin = margin(r = 0.7, unit = "cm")), 
        axis.title.x = element_text(margin = margin(t = 0.6, b = 0.6, unit = "cm")), 
        axis.ticks = element_blank()) 

# figure 3 --------

# read and filter gbd results for thailand
gbd_results_thailand <- gbd_results_master_2021 %>%
  filter(country == "Thailand")

# filtering out those causes of death that are sort of* covered under PM2.5 in some broad way
colnames(gbd_results_thailand)[3] <- c("llpp_who_2021")

# thailand fs fig 3 data
thailand_fs_fig3_dataset <- gbd_results_thailand %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021") %>%
  slice_max(llpp_who_2021, n = 10)

# thailand factsheet figure 3
thailand_fs_fig3 <- thailand_fs_fig3_dataset %>%
  ggplot() + 
  geom_col(mapping = aes(x = reorder(cause_of_death, llpp_who_2021), y = llpp_who_2021, fill = reorder(lyl_bucket, order_lyl_bucket)), width = 0.5, color = "black") +
  labs(x = "Threats to life expectancy", y = "Life Years Lost", fill = "Life years lost") +
  coord_flip() + 
  ggthemes::theme_tufte() +
  theme(legend.position = "bottom",
        axis.text = element_text(size = 14),
        axis.title.y = element_text(size = 16, margin = margin(r = 0.6, unit = "cm")),
        axis.title.x = element_text(size = 16, margin = margin(t = 0.6, b = 0.6, unit = "cm")),
        plot.caption = element_text(hjust = 0, size = 8, margin = margin(t = 0.8, unit = "cm"), face = "italic"),
        plot.title = element_text(hjust = 0.5, size = 20, margin = margin(b = 0.8, unit = "cm")),
        plot.subtitle = element_text(hjust = 0.5, size = 10, margin = margin(b = 0.8, unit = "cm"), face = "italic"),
        legend.box.background = element_rect(color = "black"),
        plot.background = element_rect(color = "white"),
        axis.line = element_line(), 
        legend.text = element_text(size = 11), 
        legend.title = element_text(size = 14),
        panel.grid.major.y = element_blank()) +
  scale_y_continuous(breaks = seq(0, 6, 0.5)) +
  # scale_x_discrete(limits = cause_of_death_ordered[seq(1, length(cause_of_death_ordered), by = 2)]) +
  scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  guides(fill = guide_legend(nrow = 1))

# figure 4 ---------

# thailand factsheet figure 4 dataset
thailand_fs_fig4_regions <- thai_aqli_2021 %>%
  group_by(region) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2021_weighted, names_to = "years", 
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+")))) %>%
  select(years, region, pop_weighted_avg_pm2.5)

thailand_fs_fig4_nat <- thai_aqli_2021 %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE),
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2021_weighted, names_to = "years",
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+"))),
         region = "National Average") %>%
  select(years, region, pop_weighted_avg_pm2.5)

thailand_fs_fig4_dataset <- rbind(thailand_fs_fig4_regions, thailand_fs_fig4_nat)

thailand_fs_fig4_dataset$region = factor(thailand_fs_fig4_dataset$region, levels = c('National Average', 'Central', 'Northeastern', 'Northern', 'Southern'))

# thailand factsheet figure 4
thailand_fs_fig4 <- thailand_fs_fig4_dataset %>%
  ggplot() +
  geom_line(mapping = aes(x = as.integer(years), 
                          y = as.double(pop_weighted_avg_pm2.5),
                          colour = region, linetype = region), lwd = 1.1) +
  geom_hline(mapping = aes(yintercept = 5), lwd = 0.8, linetype = "dotted") +
  scale_y_continuous(breaks = seq(0, 100, 5), limits = c(0, 35)) +
  scale_x_continuous(breaks = c(seq(1998, 2019, 3), 2021))  +
  scale_color_manual(values = c("National Average" = "#7197be", "Northeastern" = "#7197be", "Northern" = "#5f7aa5", "Central" = "#7197be", "Southern" = "#CBE8F3")) +
  scale_linetype_manual(values = c("National Average" = "solid", "Northeastern" = "dashed", "Northern" = "dashed", "Central" = "dashed", "Southern" = "dashed")) +
  ggthemes::theme_tufte() +
  labs(x = "Year", 
       y = expression("Annual Average" ~ PM[2.5] ~ "Concentration (in µg/m³)")) +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 11),
        legend.title = element_blank(),
        axis.title.y = element_text(size = 13, margin = margin(r = 0.6, unit = "cm")), 
        axis.title.x = element_text(size = 13, margin = margin(t = 0.6, b = 0.6, unit = "cm")), 
        axis.line = element_line(), 
        legend.box.background = element_rect(color = "black"),
        plot.title = element_text(hjust = 0.5, size = 16, margin = margin(b = 0.7, unit = "cm")), 
        plot.subtitle = element_text(hjust = 0.5, size = 8, face = "italic"), 
        plot.caption = element_text(size = 7, margin = margin(t = 0.8, unit = "cm"), hjust = 0, face = "italic"),
        axis.text = element_text(size = 12), 
        plot.background = element_rect(color = "white"), 
        axis.ticks = element_blank()) +
  geom_text(x = 2001.15, y = 5.8, label = expression("WHO" ~ PM[2.5] ~ "Guideline (last updated: 2021): 5 µg/m³"), size = 5)
  
# appendix table

# thailand factsheet appendix table 
thailand_fs_appendix_table <- thai_aqli_2021 %>%
  mutate(pm2021 = round(pm2021, 1),
         le_gain_red_to_who = round((pm2021 - who_guideline)*le_constant, 1),
         le_gain_red_to_who = ifelse(le_gain_red_to_who < 0, 0, le_gain_red_to_who),
         le_gain_red_to_nat = round((pm2021 - natstandard)*le_constant, 1),
         le_gain_red_to_nat = ifelse(le_gain_red_to_nat < 0, 0, le_gain_red_to_nat),
         le_gain_red_by_30_percent = round((pm2021*0.3)*le_constant, 1), 
         pop_millions = round(population/100000, 3)) %>%
  select(name_2, pop_millions, pm2021, le_gain_red_to_who, le_gain_red_to_nat,
         le_gain_red_by_30_percent) %>%
  ungroup() %>%
  slice_max(pop_millions, n = 25) %>%
  mutate(pop_millions = round(pop_millions, 1)) %>%
  rename(`District` = name_2, 
         `Population (Hundred thousands)` = pop_millions, 
         `Annual Average 2021 PM2.5 Concentration (µg/m³)` = pm2021,
         `Life Expectancy Gains from reducing PM2.5 from 2021 concentration to WHO PM2.5 guideline of 5 µg/m³` = le_gain_red_to_who, 
         `Life Expectancy Gains from reducing PM2.5 from 2021 concentration to National PM2.5 standard of 15 µg/m³` = le_gain_red_to_nat,
         `Life Expectancy Gains from reducing PM2.5 from 2021 concentration by 30 percent` = le_gain_red_by_30_percent) 


```


# US factsheet

```{r}

#> Note that for all US factsheet calculations, involving the year 1970 we will use the us_calc_results_cleaned.csv file. This file contains data on 237 counties, for which 1970's PM2.5 data could be imputed. In factchecking, please use this file and not any other gadm file. Also, all calculations that involve comparing 1970's pollution with 2021 pollution, our reference point would be the 237 counties only (not the 3135 total counties present in the US) both for calculating pollution averages for 1970 and also for 2021 (or for that matter, any other year's) pollution.


#> stats check rough---------------------------

# 1970's average pollution using 237 counties
foo <- us_1970_calc_results_cleaned %>%
  gadm_level_summary(c("country"), c(1970), 10)


# 2021's pollution, using all US counties
foo1 <- gadm2_aqli_2021 %>%
  filter(country == "United States") %>%
  gadm_level_summary(c("country"), c(2020, 2021), 10)

# percent population above WHO guideline
gadm2_aqli_2021 %>%
  filter(country == "United States") %>%
  gadm_level_summary(c("country"), c(2021), 10)

# top 30 most polluted counties in the US
gadm2_aqli_2021 %>%
  filter(country == "United States") %>%
  slice_max(pm2021, n = 30) %>%
  select(name_1, name_2, pm2021, llpp_who_2021) %>% 
  View()

# State level pollution summary
gadm2_aqli_2021 %>%
  filter(country == "United States") %>%
  gadm_level_summary(c("country", "name_1"), c(2021), 10) %>%
  slice_max(pm2021, n = 10)

# Los Angeles pollution
us_1970_calc_results_cleaned %>%
  filter(name_2 == "Los Angeles") %>%
  select(name_2, pm1970, pm2021)

# For the counties, where pollution has decreased since 1970, which ones saw the greatest decrease
us_1970_calc_results_cleaned %>% 
  mutate(diff = pm2021 - pm1970) %>% 
  filter(diff < 0) %>% 
  mutate(diff_abs = abs(diff)) %>% 
  slice_max(diff_abs, n = 30) %>%
  select(name_1, name_2, pm1970, pm2021, diff_abs) 


us_1970_calc_results_cleaned %>%
  mutate(diff = pm2021 - pm1970) %>%
  filter(diff >= 0) %>%
  select(name_1, name_2, pm1970, pm2021) %>%
  View()


#> plot 1------------------------------------

# US figure1 dataset
us_fs_fig1_data <- gadm2_aqli_2021 %>%
  filter(country == "United States", name_1 %notin% c("Alaska", "Hawaii")) %>%
  left_join(gadm2_aqli_2021_shp, by = c("objectid_gadm2" = "obidgadm2")) %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021") %>%
  select(-geometry, geometry) %>%
  st_as_sf()



# US figure 1
us_fs_fig1 <- us_fs_fig1_data %>%
  ggplot() +
  geom_sf(mapping = aes(fill = forcats::fct_reorder(lyl_bucket, order_lyl_bucket)), color = "aliceblue", lwd = 0.05) +
 geom_sf(data = gadm1_aqli_2021_shp %>% filter(name0 == "United States", name1 %notin% c("Alaska", "Hawaii")), color = "azure4", fill = "transparent", lwd = 0.5) +
  ggthemes::theme_map() + 
scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  ggthemes::theme_map() +
  labs(fill = "Potential gain in life expectancy (Years)  ", title = "") + 
 theme(legend.position = "bottom", 
        legend.justification = c(0.5, 3), 
        legend.background = element_rect(color = "black"), 
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15), 
        plot.title = element_text(hjust = 0.5, size = 15), 
       # legend.key = element_rect(color = "black"),
       legend.box.margin = margin(b = 1, unit = "cm"),
        plot.subtitle = element_text(hjust = 0.5, size = 7), 
        plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
       legend.key = element_rect(color = "black"), 
       legend.box.spacing = unit(0, "cm"), 
        legend.direction = "horizontal", 
       plot.background = element_rect(fill = "white", color = "white")) +
  guides(fill = guide_legend(nrow = 1))


#> plot 2: Life expectancy change between 1970 and 2020 (this one is present in a separate script, the one that has the imputation calculation, I'll integrate it here soon)-------------------------------------------------------

# percent reduction in pollution since 1970
caa_pct_reduction <- 0.649

# set to where Clean Air Act folder files (as downloaded from the AQLI website)
dir <- "C:/Users/Aarsh/Desktop/aqli-epic/annual.updates/september.2023/CleanAirAct/fig17ARRawFiles/"



color_shp <- gadm2_aqli_2021_shp


#> use as is or source from our folder (or use gadm1_aqli_2021 shape file for the US)
us_states_shp <- sf::st_read(file.path(dir, "USA_adm1.shp"),
	stringsAsFactors = FALSE) %>%
	filter(!(NAME_1 %in% c("Alaska", "Hawaii")))


# this is the county level shape file. (Filter this for USA)
county_shp <- color_shp

county_shp <- county_shp %>%
  filter(name0 == "United States")


# use county pm25 for aqli csv file
county_data <- read_csv("C:/Users/Aarsh/Desktop/aqli-epic/annual.updates/september.2023/CleanAirAct/final/county_pm25_foraqli_stats.csv")

# country level files
country <- read_csv("C:/Users/Aarsh/Desktop/aqli-epic/annual.updates/september.2023/CleanAirAct/[june302023]gadm0_aqli_2021_internal_col_names.csv")


# Change in life expectancy map (change geo_name to name_2) and remove any counties that belong to Hawaii or Alaska
county_shp <- inner_join(county_shp, county_data, by = c("obidgadm2"="objectid_gadm2")) %>%
	filter(!(name2 %in% c("Anchorage", "Honolulu")))



# us figure 2
us_1970_2021_map_data <- county_shp %>%
  mutate(lifeyears_saved_reverse = round((pm25_1970_aqli - pm2021)*0.098, 2)) %>%
  add_aqli_color_scale_buckets("lyldiff", "lifeyears_saved_reverse") %>%
  select(-geometry, geometry)

  plt <- us_1970_2021_map_data %>%
  st_as_sf() %>%
  ggplot() +
  geom_sf(mapping = aes(fill = forcats::fct_reorder(lyldiff_bucket, order_lyldiff_bucket)), color = "aliceblue", lwd = 0.05) +
  geom_sf(data = gadm1_aqli_2021_shp %>% filter(name0 == "United States", name1 %notin% c("Alaska", "Hawaii")), color = "azure4", fill = "transparent", lwd = 0.5) +
  ggthemes::theme_map() +
 scale_fill_manual(values = c("< -2" = "#d73027", 
                               "-2 to (< -0.5)" = "#f46d43", 
                               "-0.5 to (< -0.1)" = "#fdae61", 
                               "-0.1 to (< 0)" = "#fee090", 
                               "0 to (< 0.1)" = "#e0f3f8", 
                               "0.1 to (< 0.5)" = "#abd9e9", 
                               "0.5 to (< 2)" = "#74add1", 
                               ">= 2" = "#4575b4")) +
  ggthemes::theme_map() +
  labs(fill = "Change in life expectancy between 1970 and 2021 (Years; blue values indicate improvement)", title = "") +
  theme(legend.position = "bottom",
        legend.justification = c(0.5, 3),
        legend.background = element_rect(color = "black"),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15),
        plot.title = element_text(hjust = 0.5, size = 15),
        # legend.key = element_rect(color = "black"),
        legend.box.margin = margin(b = 1, unit = "cm"),
        plot.subtitle = element_text(hjust = 0.5, size = 7),
        plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"),
        legend.key = element_rect(color = "black"),
        legend.box.spacing = unit(0, "cm"),
        legend.direction = "horizontal",
        plot.background = element_rect(fill = "white", color = "white")) +
  guides(fill = guide_legend(nrow = 1))


#> plot 3----------------------------------------------

# calculate the x most populous states
x_most_populous_us_states <- gadm2_aqli_2021 %>%
  filter(country == "United States") %>%
  gadm_level_summary(c("country", "name_1"), c(2021), 10) %>%
  slice_max(population, n = 11) %>%
  select(name_1) %>%
  unlist() %>%
  as.vector()
 
# calculate pollution in the above states for the year 2021
us_fs_fig3_dataset_part1 <- gadm2_aqli_2021 %>%
  filter(country == "United States") %>%
  gadm_level_summary(c("country", "name_1"), c(2021), 10) %>%
  filter(name_1 %in% x_most_populous_us_states) %>%
  select(country, name_1, pm2021)

# calculate pollution in the above states for the year 1970
us_fs_fig3_dataset_part2 <- us_1970_calc_results_cleaned %>%
  gadm_level_summary(c("country", "name_1"), c(1970), 10) %>%
  filter(name_1 %in% x_most_populous_us_states) %>%
  select(country, name_1, pm1970)

# final data set for figure 3
us_fs_fig3_final_data <- us_fs_fig3_dataset_part1 %>%
  left_join(us_fs_fig3_dataset_part2, by = c("country", "name_1")) %>%
  mutate(lyg_1970_2021 = round((pm1970 - pm2021)*0.098, 1)) %>%
  add_aqli_color_scale_buckets(scale_type = "lyldiff", "lyg_1970_2021")

# figure 3
us_fs_fig3 <- us_fs_fig3_final_data %>%
  filter(name_1 != "Georgia") %>%
   ggplot() +
      geom_col(mapping = aes(x = forcats::fct_reorder(name_1, lyg_1970_2021), y = lyg_1970_2021, fill = fct_reorder(lyldiff_bucket, order_lyldiff_bucket))) +
      labs(x = "State", y = "Life years gained", title = "", subtitle = "", caption = "", fill = "Life years gained") +   
      scale_y_continuous(breaks = seq(0, 3, 0.5)) +
  themes_aqli_base + 
 scale_fill_manual(values = c("< -2" = "#d73027", 
                               "-2 to (< -0.5)" = "#f46d43", 
                               "-0.5 to (< -0.1)" = "#fdae61", 
                               "-0.1 to (< 0)" = "#fee090", 
                               "0 to (< 0.1)" = "#e0f3f8", 
                               "0.1 to (< 0.5)" = "#abd9e9", 
                               "0.5 to (< 2)" = "#74add1", 
                               ">= 2" = "#4575b4")) +
      coord_flip() +
  theme(legend.position = "bottom", 
        plot.background = element_rect(fill = "white", color = "white")) 
  



#> plot 4-------------------------------------------------



# top 25 most deadly diseases
us_fs_fig4_dataset <- gbd_results_master_2021 %>%
  filter(country == "United States") %>%
  slice_max(lyl, n = 25)

colnames(us_fs_fig4_dataset)[3] <- c("llpp_who_2021")

us_fs_fig4_dataset <- us_fs_fig4_dataset %>%
add_aqli_color_scale_buckets("lyl", "llpp_who_2021")



# US factsheet figure 4
us_fs_fig4 <- us_fs_fig4_dataset %>%
  ggplot() + 
  geom_col(mapping = aes(x = forcats::fct_reorder(cause_of_death, llpp_who_2021), y = llpp_who_2021, fill = forcats::fct_reorder(lyl_bucket, order_lyl_bucket)), width = 0.4, color = "black") +
  labs(x = "Threats to Life Expectancy", y = "Life Years Lost", fill = "Life years lost", 
       title = "") +
  coord_flip() + 
  ggthemes::theme_tufte() +
  themes_aqli_base +
  theme(legend.position = "bottom",
        axis.text = element_text(size = 14),
        axis.title.y = element_text(size = 16, margin = margin(r = 0.6, unit = "cm")),
        axis.title.x = element_text(size = 16, margin = margin(t = 0.6, b = 0.6, unit = "cm")),
        plot.caption = element_text(hjust = 0, size = 8, margin = margin(t = 0.8, unit = "cm")),
        plot.title = element_text(hjust = 0.5, size = 20, margin = margin(b = 0.8, unit = "cm")),
        plot.subtitle = element_text(hjust = 0.5, size = 10, margin = margin(b = 0.8, unit = "cm")),
        legend.box.background = element_rect(color = "black"),
        plot.background = element_rect(color = "white", fill = "white"),
        axis.line = element_line(), 
        legend.text = element_text(size = 11), 
        legend.title = element_text(size = 14),
        panel.grid.major.y = element_blank()) +
  scale_y_continuous(breaks = seq(0, 6, 0.5)) +
 # scale_x_discrete(limits = cause_of_death_ordered[seq(1, length(cause_of_death_ordered), by = 2)]) +
   scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  guides(fill = guide_legend(nrow = 1)) 


#> plot 5------------------------------------------------

# US factsheet figure 5 dataset
us_fs_fig5_dataset <- gadm2_aqli_2021 %>%
  filter(country == "United States", !is.na(population)) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2021_weighted, names_to = "years", 
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+"))), 
         region = "National Average") %>% 
  select(years, region, pop_weighted_avg_pm2.5)




  us_fs_fig5 <- us_fs_fig5_dataset %>%
    ggplot() +
  geom_line(mapping = ggplot2::aes(x = years, y = pop_weighted_avg_pm2.5), lwd = 1.1, 
            color = "#92d4eb") +
    geom_hline(mapping = aes(yintercept = 5), lwd = 0.8, linetype = "dashed") +
    geom_hline(mapping = aes(yintercept = 12), lwd = 0.8, linetype = "dashed") + 
  scale_y_continuous(breaks = seq(0, 20, 5), limits = c(0, 20)) +
  scale_x_continuous(breaks = c(seq(1998, 2019, 3), 2021)) +
    scale_color_manual(values = c("National Average" = "#92d4eb")) +
  ggthemes::theme_clean() +
  labs(x = "Year", 
       y = expression("Annual Average  " ~ PM[2.5] ~ " Concentration (in µg/m³)"), 
       title = "") +
     themes_aqli_base +
  theme(legend.position = "bottom", legend.title = element_blank(), 
        legend.text = element_text(size = 7), 
        plot.background = element_rect(fill = "white", color = "white")) +  
    geom_text(x = 2001.5, y = 5.5, label =  expression("WHO " ~ PM[2.5] ~ " Guideline (last updated in 2021): 5 µg/m³"), size = 5) +
    geom_text(x = 2004.2, y = 12.5, label = expression("US National" ~ PM[2.5] ~ "Standard: 12 µg/m³"), size = 5) 

  
#> [not part of the factsheet] life years lost range graph------------------------------------

  
# get country wise lyl min, max, range. Use gadm2 aqli dataset
lyl_range_df <- gadm2_aqli_2021 %>%
    filter(country == "United States") %>%
  group_by(name_1) %>%
  summarise(min_lyl = min(llpp_who_2021, na.rm = TRUE),
            max_lyl = max(llpp_who_2021, na.rm = TRUE),
            range_lyl = max_lyl - min_lyl,
            total_population = sum(population, na.rm = TRUE))
  

# plot 5: lyl range graph
#> Range of life years lost graph-------------------------------

# plot lyl range graph
lyl_range_plt <- lyl_range_df  %>%
  ggplot(aes(x = forcats::fct_reorder(name_1, total_population), y = min_lyl)) +
  geom_point(aes(color = "Minimum life years lost"), size = 3) +
  geom_point(aes(y = max_lyl, color = "Maximum life years lost"), size = 3) +
  geom_segment(aes(xend = name_1, yend = max_lyl),
               linetype = "dashed", color = "black") +
  scale_color_manual(name = "", values = c("Minimum life years lost" = "cornflowerblue",
                                                   "Maximum life years lost" = "darkred")) +
  labs(title = "",
       x = "Department", y = "Life years lost") +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "bottom",
        legend.box.background = element_rect(color = "black"),
        plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(breaks = seq(0, 13, 1)) +
    guides(color = guide_legend(reverse = TRUE))
  


#> appendix table--------------------------------------------

  
# calculate pollution in the above states for the year 2021
app_table_part1 <- gadm2_aqli_2021 %>%
  filter(country == "United States") %>%
  gadm_level_summary(c("country", "name_1"), c(2021), 10) %>%
  select(country, name_1, population, pm2021, llpp_who_2021)

# calculate pollution in the above states for the year 1970
app_table_part2 <- us_1970_calc_results_cleaned %>%
  gadm_level_summary(c("country", "name_1"), c(1970), 10) %>%
  select(country, name_1, pm1970)

# final data set for figure 3
 app_table_part1 %>%
  left_join(app_table_part2, by = c("country", "name_1")) %>%
  mutate(lyg_1970_2021 = round((pm1970 - pm2021)*0.098, 1)) %>%
  mutate(pop_millions = round(population/1000000, 1)) %>%
    select(name_1, pop_millions, pm1970, pm2021, lyg_1970_2021, llpp_who_2021) %>%
  rename(`PM2.5 Concentration, 1970 (µg/m³)` = pm1970, 
         `PM2.5 Concentration, 2021 (µg/m³)` = pm2021, 
         `Years of Life Expectancy Gained due to Decrease in PM2.5, 1970-2021` = lyg_1970_2021, 
         `Years of Life Expectancy Gain through Reducing PM2.5 from 2021 Concentration to WHO Guideline` = llpp_who_2021, 
         `Population (millions)` = pop_millions, 
         State = name_1) %>%
   write_csv("[July052023]USFactsheet2023_appendix_table.csv")



```


# Poland factsheet

```{r}

#> plot 1

# poland figure1 dataset
poland_fs_fig1_data <- gadm2_aqli_2021 %>%
  filter(country == "Poland") %>%
  left_join(gadm2_aqli_2021_shp, by = c("objectid_gadm2" = "obidgadm2")) %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021") %>%
  select(-geometry, geometry) %>%
  st_as_sf()



# poland figure 1
poland_fs_fig1 <- poland_fs_fig1_data %>%
  ggplot() +
  geom_sf(mapping = aes(fill = forcats::fct_reorder(lyl_bucket, order_lyl_bucket)), color = "aliceblue", lwd = 0.05) +
 geom_sf(data = gadm1_aqli_2021_shp %>% filter(name0 == "Poland"), color = "azure4", fill = "transparent", lwd = 0.15) +
   geom_sf(data = gadm0_aqli_2021_shp %>% filter(name0 == "Poland"), color = "cornsilk", fill = "transparent", lwd = 0.5) +
  ggthemes::theme_map()  +
     scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  ggthemes::theme_map() +
  labs(fill = "Potential gain in life expectancy (Years) ", title = "") + 
 theme(legend.position = "bottom", 
        legend.justification = c(0.5, 3), 
        legend.background = element_rect(color = "black"), 
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15), 
        plot.title = element_text(hjust = 0.5, size = 15), 
       # legend.key = element_rect(color = "black"),
       legend.box.margin = margin(b = 1, unit = "cm"),
        plot.subtitle = element_text(hjust = 0.5, size = 7), 
        plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
       legend.key = element_rect(color = "black"), 
       legend.box.spacing = unit(0, "cm"), 
        legend.direction = "horizontal", 
       plot.background = element_rect(fill = "white", color = "white")) +
  guides(fill = guide_legend(nrow = 1))



#> plot 2: Potential Gain in Life Expectancy from Reducing PM2.5 from 2021 to the WHO Guideline in 10 most populous counties of Poland -----------------------------------------

poland_fs_fig2_dataset <- gadm2_aqli_2021 %>%
  filter(country == "Poland") %>%
  add_aqli_color_scale_buckets(scale_type = "lyl", col_name = "llpp_who_2021") %>%
  slice_max(population, n = 10)

poland_fs_fig2 <- poland_fs_fig2_dataset %>%
  aqli_bar(scale_type = "lyl", x_var = "name_2", y_var = "llpp_who_2021", title = "", subtitle = "", x_label = "County", y_label = "Potential Gain in Life Expectancy (Years)", legend_title = "Potential gain in life expectancy (Years)", caption = "") +
  theme(plot.background = element_rect(fill = "white", color = "white"))


#> plot 3: GBD-------------------------------------------------------

# top 10 most deadly diseases
poland_fs_fig3_dataset <- gbd_results_master_2021 %>%
  filter(country == "Poland") %>%
  slice_max(lyl, n = 10)

colnames(poland_fs_fig3_dataset)[3] <- c("llpp_who_2021")

poland_fs_fig3_dataset <- poland_fs_fig3_dataset %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2021")


#> figure 3 plot


poland_fs_fig3 <- poland_fs_fig3_dataset %>%
  ggplot() + 
  geom_col(mapping = aes(x = forcats::fct_reorder(cause_of_death, llpp_who_2021), y = llpp_who_2021, fill = forcats::fct_reorder(lyl_bucket, order_lyl_bucket)), width = 0.4, color = "black") +
  labs(x = "Threats to Life Expectancy", y = "Life Years Lost", fill = "Life years lost", 
       title = "") +
  coord_flip() + 
  ggthemes::theme_tufte() +
  themes_aqli_base +
  theme(legend.position = "bottom",
        axis.text = element_text(size = 14),
        axis.title.y = element_text(size = 16, margin = margin(r = 0.6, unit = "cm")),
        axis.title.x = element_text(size = 16, margin = margin(t = 0.6, b = 0.6, unit = "cm")),
        plot.caption = element_text(hjust = 0, size = 8, margin = margin(t = 0.8, unit = "cm")),
        plot.title = element_text(hjust = 0.5, size = 20, margin = margin(b = 0.8, unit = "cm")),
        plot.subtitle = element_text(hjust = 0.5, size = 10, margin = margin(b = 0.8, unit = "cm")),
        legend.box.background = element_rect(color = "black"),
        plot.background = element_rect(fill = "white", color = "white"),
        axis.line = element_line(), 
        legend.text = element_text(size = 11), 
        legend.title = element_text(size = 14),
        panel.grid.major.y = element_blank()) +
  scale_y_continuous(breaks = seq(0, 9, 1)) +
 # scale_x_discrete(limits = cause_of_death_ordered[seq(1, length(cause_of_death_ordered), by = 2)]) +
  scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  guides(fill = guide_legend(nrow = 1)) 


#> plot 4: Trendlines: 1998 to 2021------------------------------------

# Colombia factsheet figure 3 dataset
poland_fs_fig4_dataset <- gadm2_aqli_2021 %>%
  filter(!is.na(population)) %>%
  filter(country == "Poland") %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2021_weighted, names_to = "years", 
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+"))), 
         region = "National Average") %>% 
  select(years, region, pop_weighted_avg_pm2.5)




  poland_fs_fig4 <- poland_fs_fig4_dataset %>%
    ggplot() +
  geom_line(mapping = ggplot2::aes(x = years, y = pop_weighted_avg_pm2.5), lwd = 1.1, 
            color = "#82b5d5") +
    geom_hline(mapping = aes(yintercept = 5), lwd = 0.8, linetype = "dashed") +
    geom_hline(mapping = aes(yintercept = 25), lwd = 0.8, linetype = "dashed") + 
  scale_y_continuous(breaks = seq(0, 30, 5), limits = c(0, 30)) +
  scale_x_continuous(breaks = c(seq(1998, 2019, 3), 2021)) +
    scale_color_manual(values = c("National Average" = "#82b5d5")) +
  ggthemes::theme_clean() +
    themes_aqli_base +
  labs(x = "Year", 
       y = expression("Annual Average  " ~ PM[2.5] ~ " Concentration (in µg/m³)"), 
       title = "") +
  theme(legend.position = "bottom", legend.title = element_blank(), 
        legend.text = element_text(size = 7), 
        plot.background = element_rect(fill = "white", color = "white")) +  
    geom_text(x = 2001.5, y = 5.6, label =  expression("WHO " ~ PM[2.5] ~ " Guideline (last updated in 2021): 5 µg/m³"), size = 5) +
    geom_text(x = 2015.7, y = 25.7, label = expression("Poland National" ~ PM[2.5] ~ "Standard: 25 µg/m³"), size = 5) 


  
#> life years lost range graph------------------------------------

#  state wise min, average and max lyl dataset for 10 most populous states
lyl_range_df <- gadm2_aqli_2021 %>%
    filter(country == "Poland") %>%
  group_by(name_1) %>%
    mutate(pop_weights = population/sum(population, na.rm = TRUE), 
           pm2021_pop_weighted = pm2021*pop_weights) %>%
  summarise(min_lyl = round(min(llpp_who_2021, na.rm = TRUE), 1),
            max_lyl = round(max(llpp_who_2021, na.rm = TRUE), 1),
            avg_pm2.5_2021 = sum(pm2021_pop_weighted, na.rm = TRUE),
            avg_lyl = round((avg_pm2.5_2021 - 5)*0.098, 1),
            range_lyl = max_lyl - min_lyl,
            total_population = sum(population, na.rm = TRUE)) %>%
    mutate(avg_lyl = ifelse(avg_lyl < 0, 0, avg_lyl))



  

# plot lyl range graph (click on zoom in the plots window in R-Studio to view the plot)
lyl_range_plt <- lyl_range_df  %>%
  ggplot(aes(x = forcats::fct_reorder(name_1, total_population), y = min_lyl)) +
  geom_point(aes(color = "Minimum life years lost"), size = 3) +
  geom_point(aes(y = max_lyl, color = "Maximum life years lost"), size = 3) +
  geom_point(aes(y = avg_lyl, color = "Average life years lost"), size = 3) +
  geom_segment(aes(xend = name_1, yend = max_lyl),
               linetype = "dashed", color = "black") +
  scale_color_manual(name = "", values = c("Minimum life years lost" = "cornflowerblue",
                                           "Average life years lost" = "darkgrey",
                                                   "Maximum life years lost" = "darkred"), 
                            breaks = c("Minimum life years lost", "Average life years lost", "Maximum life years lost"),
                     labels = c("Minimum life years lost", "Average life years lost", "Maximum life years lost")) +
  labs(title = expression("Minimum, Average and Maximum Life years lost to" ~ PM[2.5] ~ "Air Pollution"),
       x = "Province", y = "Life Years Lost") +
  coord_flip() +
  theme(legend.position = "bottom",
        legend.box.background = element_rect(color = "black"),
        plot.title = element_text(hjust = 0.5)) +
  scale_y_continuous(breaks = seq(0, 2.5, 0.5), limits = c(0, 2.5)) +
  ggthemes::theme_clean() +
    theme(legend.position = "bottom", 
        axis.title.y = element_text(margin = margin(r = 0.8, unit = "cm"), size = 16), 
        axis.title.x = element_text(margin = margin(t = 0.8, b = 1, unit = "cm"), size = 16), 
        axis.text = element_text(size = 14), 
        plot.title = element_text(hjust = 0.5, size = 18, margin = margin(b = 0.3, unit = "cm")),
        legend.box.background = element_rect(color = "black"),
        strip.text = element_text(size = 18, margin = margin(t = 1, b = 0.5, unit = "cm")),
        legend.title = element_text(size = 16), 
        legend.text = element_text(size = 14), 
        plot.subtitle = element_text(size = 12, hjust = 0.5, margin = margin(b = 0.8, unit = "cm"), face = "italic"),
        plot.caption = element_text(hjust = 0, size = 9, face = "italic", margin = margin(t = 1.3, unit = "cm")), 
        plot.background = element_rect(fill = "white", color = "white"))  



#> plot 6: Distribution of pollution in 2021-----------------------
  
col_name <- "pm2021"
plt <- gadm2_aqli_2021 %>%
      filter(country == "Poland") %>%
      add_aqli_color_scale_buckets(scale_type = "pollution", col_name = "pm2021") %>%
      ggplot() +
      geom_histogram(mapping = aes(x = !!as.symbol(col_name), weight = population, fill = !!as.symbol(col_name), group = !!as.symbol(col_name))) +
  geom_vline(mapping = aes(xintercept = 5), linetype = "dotted") +
  geom_vline(mapping = aes(xintercept = 25), linetype = "dotted") +
      scale_fill_gradient(low = "#a1f5ff",
                          high = "#1a1638") +
  scale_x_continuous(breaks = seq(0, 40, 5), limits = c(0, 30)) +
  labs(x = expression("Annual Average" ~ PM[2.5] ~ " Concentration (in µg/m³)"), 
       y = "Number of people", 
       fill = expression("Annual Average" ~ PM[2.5] ~ " Concentration (in µg/m³)")) +
  themes_aqli_base +
  geom_text(x = 7.5, y = 6000000, label =  expression("WHO" ~ PM[2.5] ~ "guideline"), size = 5) +
    geom_text(x = 27.8, y = 6000000, label =  expression("National" ~ PM[2.5] ~ "standard"), size = 5) +
  theme(plot.background = element_rect(color = "white", fill = "white"))



```







# ================sanity checks section (deactivated, just for testing purposes)===========================================

```{r eval=FALSE, include=FALSE}

# Nepal

nepal_fs_fig1_data <- gadm2_aqli_2021 %>%
  filter(country == "Nepal") %>%
  left_join(gadm2_aqli_2021_shp, by = c("objectid_gadm2" = "objidgadm2")) %>%
  mutate(lyl_bucket = ifelse((llpp_who_2021 >= 0) & (llpp_who_2021 < 0.1), "0 - < 0.1", NA), 
         lyl_bucket = ifelse((llpp_who_2021 >= 0.1) & (llpp_who_2021 <= 0.5), "0.1 - 0.5", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 0.5) & (llpp_who_2021 <= 1), "> 0.5 - 1", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 1) & (llpp_who_2021 <= 2), "> 1 - 2", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 2) & (llpp_who_2021 <= 3), "> 2 - 3", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 3) & (llpp_who_2021 <= 4), "> 3 - 4", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 4) & (llpp_who_2021 <= 5), "> 4 - 5", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 5) & (llpp_who_2021 < 6), "> 5 - < 6", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 >= 6), ">= 6", lyl_bucket)) %>%
  mutate(order_lyl_bucket = ifelse(lyl_bucket == "0 - < 0.1", 1, NA), 
         order_lyl_bucket = ifelse(lyl_bucket == "0.1 - 0.5", 2, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 0.5 - 1", 3, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 1 - 2", 4, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 2 - 3", 5, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 3 - 4", 6, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 4 - 5", 7, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 5 - < 6", 8, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == ">= 6", 9, order_lyl_bucket)) %>%
  select(-geometry, geometry) %>%
  st_as_sf()

south_korea_fs_fig1_data %>%
  sf::write_sf("./september.2023/factsheets/southkorea/fig1/sk_fs_fig1.shp")


# south korea figure 1
nepal_fs_fig1 <- nepal_fs_fig1_data %>%
  ggplot() +
  geom_sf(mapping = aes(fill = forcats::fct_reorder(lyl_bucket, order_lyl_bucket)), color = "transparent") +
  geom_sf(data = gadm1_aqli_2021_shp %>% filter(name0 == "Nepal"), color = "black", fill = "transparent", lwd = 0.5) +
  ggthemes::theme_map() + 
 scale_fill_manual(values = c("0 - < 0.1 years" = "#FFFFFF", 
                               "0.1 - 0.5" = "#FFE6B3", 
                               "> 0.5 - 1" = "#FFD25D", 
                               "> 1 - 2" = "#FFBA00", 
                               "> 2 - 3" = "#FF9600", 
                               "> 3 - 4" = "#FF6908", 
                               "> 4 - 5" = "#E63D23", 
                               "> 5 - < 6" = "#BD251C", 
                               ">= 6" = "#8C130E")) +
  ggthemes::theme_map() +
  labs(fill = "Life years lost  ", title = expression("Potential Gains in Life Expectancy through Permanently Reducing" ~ PM[2.5] ~ "from 2021 concentrations to the WHO guideline")) + 
 theme(legend.position = "bottom", 
        legend.justification = c(0.5, 3), 
        legend.background = element_rect(color = "black"), 
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15), 
        plot.title = element_text(hjust = 0.5, size = 15), 
       # legend.key = element_rect(color = "black"),
       legend.box.margin = margin(b = 1, unit = "cm"),
        plot.subtitle = element_text(hjust = 0.5, size = 7), 
        plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
       legend.key = element_rect(color = "black"), 
       legend.box.spacing = unit(0, "cm"), 
        legend.direction = "horizontal") +
  guides(fill = guide_legend(nrow = 1))


# nepal fs figure 3

# top 5 most deadly diseases
nepal_fs_fig3_dataset <- gbd_results_master_2021 %>%
  filter(country == "Nepal")

colnames(nepal_fs_fig3_dataset)[3] <- c("llpp_who_2021")

nepal_fs_fig3_dataset <- nepal_fs_fig3_dataset %>%
    mutate(lyl_bucket = ifelse((llpp_who_2021 >= 0) & (llpp_who_2021 < 0.1), "0 - < 0.1 years", NA), 
         lyl_bucket = ifelse((llpp_who_2021 >= 0.1) & (llpp_who_2021 <= 0.5), "0.1 - 0.5", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 0.5) & (llpp_who_2021 <= 1), "> 0.5 - 1", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 1) & (llpp_who_2021 <= 2), "> 1 - 2", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 2) & (llpp_who_2021 <= 3), "> 2 - 3", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 3) & (llpp_who_2021 <= 4), "> 3 - 4", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 4) & (llpp_who_2021 <= 5), "> 4 - 5", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 5) & (llpp_who_2021 < 6), "> 5 - < 6 years", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 >= 6), ">= 6 years", lyl_bucket)) %>%
  mutate(order_lyl_bucket = ifelse(lyl_bucket == "0 - < 0.1 years", 1, NA), 
         order_lyl_bucket = ifelse(lyl_bucket == "0.1 - 0.5", 2, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 0.5 - 1", 3, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 1 - 2", 4, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 2 - 3", 5, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 3 - 4", 6, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 4 - 5", 7, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 5 - 6 years", 8, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == ">= 6 years", 9, order_lyl_bucket))


# getting disease (ordered from most deadly to least deadly) in a vector (to be used later in the
# scale_x_discrete function).

# cause_of_death_ordered <- india_fs_fig3_dataset %>%
#   arrange(llpp_who_2021) %>%
#   pull(cause_of_death) %>%
#   unlist()


# figure 3 plot
nepal_fs_fig3 <- nepal_fs_fig3_dataset %>%
  ggplot() + 
  geom_col(mapping = aes(x = forcats::fct_reorder(cause_of_death, llpp_who_2021), y = llpp_who_2021, fill = forcats::fct_reorder(lyl_bucket, order_lyl_bucket)), width = 0.5, color = "black") +
  labs(x = "Cause of Death", y = "Life Years Lost", fill = "Life years lost", 
       caption = str_wrap("* Source: Global Burden of Disease (https://vizhub.healthdata.org/gbd-results/) causes and risks data and WHO Life Tables (https://apps.who.int/gho/data/node.main.LIFECOUNTRY?lang=en) were used combined with the Life table method to arrive at these results. 'PM2.5 relative to WHO Guideline' bar displays life years lost relative to the WHO guideline as calculated by latest AQLI (2021) data, which will be published in September 2023.", width = 130), title = expression("Life Expectancy Impact of" ~ PM[2.5] ~ "and Unassociated Causes/Risks of Deaths in India")) +
  coord_flip() + 
  ggthemes::theme_tufte() +
  theme(legend.position = "bottom",
        axis.text = element_text(size = 14),
        axis.title.y = element_text(size = 16, margin = margin(r = 0.6, unit = "cm")),
        axis.title.x = element_text(size = 16, margin = margin(t = 0.6, b = 0.6, unit = "cm")),
        plot.caption = element_text(hjust = 0, size = 8, margin = margin(t = 0.8, unit = "cm")),
        plot.title = element_text(hjust = 0.5, size = 20, margin = margin(b = 0.8, unit = "cm")),
        plot.subtitle = element_text(hjust = 0.5, size = 10, margin = margin(b = 0.8, unit = "cm")),
        legend.box.background = element_rect(color = "black"),
        plot.background = element_rect(color = "white"),
        axis.line = element_line(), 
        legend.text = element_text(size = 11), 
        legend.title = element_text(size = 14),
        panel.grid.major.y = element_blank()) +
  scale_y_continuous(breaks = seq(0, 6, 0.5)) +
 # scale_x_discrete(limits = cause_of_death_ordered[seq(1, length(cause_of_death_ordered), by = 2)]) +
  scale_fill_manual(values = c("0 - < 0.1 years" = "#FFFFFF", 
                               "0.1 - 0.5" = "#FFE6B3", 
                               "> 0.5 - 1" = "#FFD25D", 
                               "> 1 - 2" = "#FFBA00", 
                               "> 2 - 3" = "#FF9600", 
                               "> 3 - 4" = "#FF6908", 
                               "> 4 - 5" = "#E63D23", 
                               "> 5 - < 6 years" = "#BD251C", 
                               ">= 6 years" = "#8C130E")) + 
  guides(fill = guide_legend(nrow = 1))


# outer terai region lyl calculation
outer_terai <- c("Kapilbastu", "Rupandehi", "Nawalparasi West", "Nawalparasi East", "Parsa", "Bara", "Rautahat", "Sarlahi", "Mahottari", "Dhanusha", "Siraha", "Saptari", "Sunsari", "Morang", "Jhapa")

south_nepal <- c("Kapilbastu", "Rupandehi", "Nawalparasi West", "Parsa", "Bara", "Rautahat", "Sarlahi", "Mahottari", "Siraha", "Saptari")

gadm2_aqli_2021 %>%
  filter(country == "Nepal", name_2 %in% outer_terai) %>%
  gadm_level_summary(c("country"), c(2021), 10)


# 

#> What percent of the world’s population live in places, at the country-level, (district level) where they are losing at least 2 years (3 years) of life)?

threshold <- 2

# global total population
tot_pop_world <- gadm2_aqli_2021 %>%
  summarise(tot_pop = sum(population, na.rm = TRUE))


# district wise
tot_pop_atleast_eq_thresh <- gadm2_aqli_2021 %>%
  filter(llpp_who_2021 >= threshold) %>%
  summarise(tot_pop = sum(population, na.rm = TRUE))


perc_pop_losing_atleast_x_lyl_level <- function(threshold, level = "district"){
  tot_pop_world <- gadm2_aqli_2021 %>%
  summarise(tot_pop = sum(population, na.rm = TRUE)) 
  
  if(level == "district"){
 
 tot_pop_atleast_eq_thresh <- gadm2_aqli_2021 %>%
  filter(llpp_who_2021 >= threshold) %>%
  summarise(tot_pop = sum(population, na.rm = TRUE))
 
 return(round((tot_pop_atleast_eq_thresh/tot_pop_world)*100, 4))

  } else if (level == "state"){
     tot_pop_atleast_eq_thresh <- gadm1_aqli_2021 %>%
  filter(llpp_who_2021 >= threshold) %>%
  summarise(tot_pop = sum(population, na.rm = TRUE))
     
      return(round((tot_pop_atleast_eq_thresh/tot_pop_world)*100, 4))
     
  } else if (level == "country"){
     tot_pop_atleast_eq_thresh <- gadm0_aqli_2021 %>%
  filter(llpp_who_2021 >= threshold) %>%
  summarise(tot_pop = sum(population, na.rm = TRUE))
     
      return(round((tot_pop_atleast_eq_thresh/tot_pop_world)*100, 4))
  } 
}
  

df_lyl <- tibble(min_lyl = seq(0, 13, 0.2), district_level_calc_perc_pop_above_lyl = NA, 
                 state_level_calc_perc_pop_above_lyl = NA, 
                 country_level_calc_perc_pop_above_lyl = NA)

for(i in 1:nrow(df_lyl)){
  df_lyl$district_level_calc_perc_pop_above_lyl[i] <- perc_pop_losing_atleast_x_lyl_level(df_lyl$min_lyl[i], "district")
  df_lyl$state_level_calc_perc_pop_above_lyl[i] <- perc_pop_losing_atleast_x_lyl_level(df_lyl$min_lyl[i], "state")
  df_lyl$country_level_calc_perc_pop_above_lyl[i] <- perc_pop_losing_atleast_x_lyl_level(df_lyl$min_lyl[i], "country")
}



df_lyl <- df_lyl %>%
  mutate(district_level_calc_perc_pop_above_lyl = perc_pop_losing_atleast_x_lyl_level(df_lyl, "district"), 
         state_level_calc_perc_pop_above_lyl = perc_pop_losing_atleast_x_lyl_level(df_lyl, "state"), 
         country_level_calc_perc_pop_above_lyl = perc_pop_losing_atleast_x_lyl_level(df_lyl, "country"))


df_lyl_long <- df_lyl %>%
  pivot_longer(district_level_calc_perc_pop_above_lyl:country_level_calc_perc_pop_above_lyl, names_to = "summary_level", values_to = "percentage_pop_atleast_x_lyl")

df_lyl_long <- df_lyl_long %>%
  mutate(summary_level = ifelse(summary_level == "district_level_calc_perc_pop_above_lyl", "district", summary_level), 
         summary_level = ifelse(summary_level == "state_level_calc_perc_pop_above_lyl", "state", summary_level), 
         summary_level = ifelse(summary_level == "country_level_calc_perc_pop_above_lyl", "country", summary_level))

df_lyl_long$min_lyl <- as.numeric(unlist(df_lyl_long$min_lyl))
df_lyl_long$percentage_pop_atleast_x_lyl <- as.numeric(unlist(df_lyl_long$percentage_pop_atleast_x_lyl))
df_lyl_long$summary_level <- as.factor(df_lyl_long$summary_level)


plt <- df_lyl_long %>%
  ggplot() +
  geom_smooth(mapping = aes(x = min_lyl, y = percentage_pop_atleast_x_lyl, color = summary_level), lwd = 2, se =FALSE) +
  labs(x = "Minimum life years lost", y = "% population corresp to min lyl", color = "Summary level", 
       title = "Percent population losing atleast x life years at different summary levels") +
  scale_x_continuous(breaks = seq(0, 12, 2)) +
  scale_color_viridis(discrete = TRUE) +
  themes_aqli_base 


# pakistan factsheet map (world view adjusted)

# pakistan figure1 dataset
pak_fs_fig1_data <- gadm2_aqli_2021 %>%
  filter(country == "Pakistan") %>%
  left_join(gadm2_aqli_2021_shp, by = c("objectid_gadm2" = "obidgadm2")) %>%
  mutate(lyl_bucket = ifelse((llpp_who_2021 >= 0) & (llpp_who_2021 < 0.1), "0 - < 0.1", NA), 
         lyl_bucket = ifelse((llpp_who_2021 >= 0.1) & (llpp_who_2021 <= 0.5), "0.1 - 0.5", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 0.5) & (llpp_who_2021 <= 1), "> 0.5 - 1", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 1) & (llpp_who_2021 <= 2), "> 1 - 2", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 2) & (llpp_who_2021 <= 3), "> 2 - 3", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 3) & (llpp_who_2021 <= 4), "> 3 - 4", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 4) & (llpp_who_2021 <= 5), "> 4 - 5", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 5) & (llpp_who_2021 < 6), "> 5 - < 6", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 >= 6), ">= 6", lyl_bucket)) %>%
  mutate(order_lyl_bucket = ifelse(lyl_bucket == "0 - < 0.1", 1, NA), 
         order_lyl_bucket = ifelse(lyl_bucket == "0.1 - 0.5", 2, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 0.5 - 1", 3, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 1 - 2", 4, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 2 - 3", 5, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 3 - 4", 6, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 4 - 5", 7, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 5 - < 6", 8, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == ">= 6", 9, order_lyl_bucket)) %>%
  select(-geometry, geometry) %>%
  st_as_sf()

# china_fs_fig1_data %>%
#   sf::write_sf("./september.2023/factsheets/southkorea/fig1/sk_fs_fig1.shp")


# china figure 1
pak_fs_fig1 <- pak_fs_fig1_data %>%
  ggplot() +
  geom_sf(mapping = aes(fill = forcats::fct_reorder(lyl_bucket, order_lyl_bucket)), color = "lightgrey", lwd = 0.05) +
 geom_sf(data = gadm1_aqli_2021_shp %>% filter(name0 == "Pakistan"), color = "black", fill = "transparent", lwd = 0.5) +
  ggthemes::theme_map() + 
 scale_fill_manual(values = c("0 - < 0.1" = "#FFFFFF", 
                               "0.1 - 0.5" = "#FFE6B3", 
                               "> 0.5 - 1" = "#FFD25D", 
                               "> 1 - 2" = "#FFBA00", 
                               "> 2 - 3" = "#FF9600", 
                               "> 3 - 4" = "#FF6908", 
                               "> 4 - 5" = "#E63D23", 
                               "> 5 - < 6" = "#BD251C", 
                               ">= 6" = "#8C130E")) +
  ggthemes::theme_map() +
  labs(fill = "Gain in years of life expectancy  ", title = expression("Potential Gains in Life Expectancy (China) through Permanently Reducing" ~ PM[2.5] ~ "from 2021 concentrations to the WHO guideline")) + 
 theme(legend.position = "bottom", 
        legend.justification = c(0.5, 3), 
        legend.background = element_rect(color = "black"), 
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15), 
        plot.title = element_text(hjust = 0.5, size = 15), 
       # legend.key = element_rect(color = "black"),
       legend.box.margin = margin(b = 1, unit = "cm"),
        plot.subtitle = element_text(hjust = 0.5, size = 7), 
        plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
       legend.key = element_rect(color = "black"), 
       legend.box.spacing = unit(0, "cm"), 
        legend.direction = "horizontal", 
       plot.background = element_rect(fill = "white", color = "white")) +
  guides(fill = guide_legend(nrow = 1))



# Pakistan factsheet

# filtering color level data for Pakistan and adding a "region" column
color_2020_pak <- gadm2_aqli_2021 %>%
  filter(country == "Pakistan") %>%
  mutate(region = ifelse(name_1  %in% c("Islamabad", "Punjab"), 
                         name_1, "All other regions (excluding Islanabad and Punjab)"))


# region wise pakistan data for 1998 to 2020
region_wise_pak_average_ts <- color_2020_pak %>%
  group_by(region) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2021_weighted, names_to = "years", 
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+")))) %>%
  select(years, region, pop_weighted_avg_pm2.5)

# national average pakistan data for 1998 to 2020
 national_average_pak_ts <- color_2020_pak %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2020_weighted, names_to = "years", 
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+"))), 
         region = "National Average") %>% 
  select(years, region, pop_weighted_avg_pm2.5)

# pakistan factsheet figure 4 final dataset 
pak_fs_fig4_dataset <- rbind(region_wise_pak_average_ts, national_average_pak_ts)

# save figure 4 dataset
pak_fs_fig4_dataset %>%
  write_csv("./june.2022/factsheets/pakistan/graph.wise.datasets/pak_fs_fig_4_dataset.csv")
  
# pakistan factsheet figure 4
pak_fs_fig4 <- ggplot(pak_fs_fig4_dataset) +
  geom_line(mapping = ggplot2::aes(x = years, y = pop_weighted_avg_pm2.5, color = region), lwd = 1.1) +
    geom_hline(mapping = aes(yintercept = 5), lwd = 0.8) +
  scale_y_continuous(breaks = seq(0, 60, 5), limits = c(0, 60)) +
  scale_x_continuous(breaks = seq(1998, 2020, 2)) +
    scale_color_manual(values = c("National Average" = "darkgrey", "Islamabad" = "darkred", "Punjab" = "orange", "All other regions (excluding Islamabad and Punjab)" = "tan")) +
  ggthemes::theme_clean() +
  labs(x = "Years", 
       y = expression(paste("Average PM2.5 concentration ( ", mu, "g", "/", m^3, " )")), 
       caption = "*FCT refers to the Federal Capital Territory region in Pakistan") +
  theme(legend.position = "bottom", legend.title = element_blank(), 
        legend.text = element_text(size = 7), 
        axis.title.y = element_text(size = 9), 
        axis.title.x = element_text(size = 9), 
        plot.caption = element_text(hjust = 0, size = 5), plot.caption.position = "plot") +
    geom_text(x = 2002.7, y = 8, label = expression(paste("WHO PM2.5 Guideline (last updated: 2021): 5 ", mu, "g","/", m^3, "")))


# country wise screenshots sanity checks


country_select <- "Turkey"

europe_fs_fig1_data_bh <-   gadm2_aqli_2021 %>% 
  filter(country == "Turkey") %>%
  left_join(gadm2_aqli_2021_shp, by = c("objectid_gadm2" = "obidgadm2")) %>%
  mutate(lyl_bucket = ifelse((llpp_who_2021 >= 0) & (llpp_who_2021 < 0.1), "0 - < 0.1", NA), 
         lyl_bucket = ifelse((llpp_who_2021 >= 0.1) & (llpp_who_2021 <= 0.5), "0.1 - 0.5", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 0.5) & (llpp_who_2021 <= 1), "> 0.5 - 1", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 1) & (llpp_who_2021 <= 2), "> 1 - 2", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 2) & (llpp_who_2021 <= 3), "> 2 - 3", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 3) & (llpp_who_2021 <= 4), "> 3 - 4", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 4) & (llpp_who_2021 <= 5), "> 4 - 5", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 5) & (llpp_who_2021 < 6), "> 5 - < 6", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 >= 6), ">= 6", lyl_bucket)) %>%
  mutate(order_lyl_bucket = ifelse(lyl_bucket == "0 - < 0.1", 1, NA), 
         order_lyl_bucket = ifelse(lyl_bucket == "0.1 - 0.5", 2, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 0.5 - 1", 3, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 1 - 2", 4, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 2 - 3", 5, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 3 - 4", 6, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 4 - 5", 7, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 5 - < 6", 8, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == ">= 6", 9, order_lyl_bucket)) %>%
  select(-geometry, geometry) %>%
  st_as_sf()

europe_country_fig <- europe_fs_fig1_data_bh %>%
  ggplot() +
  geom_sf(mapping = aes(fill = forcats::fct_reorder(lyl_bucket, order_lyl_bucket)), color = "aliceblue", lwd = 0.05) +
   geom_sf(data = gadm1_aqli_2021_shp %>% filter(name0 %in% country_select), color = "azure4", fill = "transparent", lwd = 0.1) +
 geom_sf(data = gadm0_aqli_2021_shp %>% filter(name0 %in% country_select), color = "cornsilk4", fill = "transparent", lwd = 0.3) +
  ggthemes::theme_map() + 
 scale_fill_manual(values = c("0 - < 0.1" = "#FFFFFF", 
                               "0.1 - 0.5" = "#FFE6B3", 
                               "> 0.5 - 1" = "#FFD25D", 
                               "> 1 - 2" = "#FFBA00", 
                               "> 2 - 3" = "#FF9600", 
                               "> 3 - 4" = "#FF6908", 
                               "> 4 - 5" = "#E63D23", 
                               "> 5 - < 6" = "#BD251C", 
                               ">= 6" = "#8C130E")) +
  ggthemes::theme_map() +
  labs(fill = "Gain in years of life expectancy  ", title = expression("Potential Gains in Life Expectancy through Permanently Reducing" ~ PM[2.5] ~ "from 2021 concentrations to the WHO guideline"), 
       subtitle = country_select) + 
 theme(legend.position = "bottom", 
        legend.justification = c(0.5, 3), 
        legend.background = element_rect(color = "black"), 
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15), 
        plot.title = element_text(hjust = 0.5, size = 15), 
       # legend.key = element_rect(color = "black"),
       legend.box.margin = margin(b = 1, unit = "cm"),
        plot.subtitle = element_text(hjust = 0.5, size = 12), 
        plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
       legend.key = element_rect(color = "black"), 
       legend.box.spacing = unit(0, "cm"), 
        legend.direction = "horizontal", 
       plot.background = element_rect(fill = "white", color = "white")) +
  guides(fill = guide_legend(nrow = 1)) 


# Pakistan sanity checks

gadm2_aqli_2021 %>%
  filter(name_2 %in% c("Lahore", "Sheikhupura", "Kasur", "Peshawar")) %>%
  # mutate(pop_weights = population/sum(population, na.rm = TRUE), 
  #        pm2021_pop_weighted = pm2021*pop_weights) %>%
  # summarise(avg_pm2.5_2021 = sum(pm2021_pop_weighted, na.rm = TRUE))
  gadm_level_summary(c("country"), c(2021), 10)

gadm2_aqli_2021 %>%
  filter(country == "Pakistan", name_2 %in% c("Central Karachi", "East Karachi", "Korangi Karachi", "Malir Karachi", 
                       "South Karachi", "West Karachi")) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE),
         pm2021_pop_weighted = pm2021*pop_weights) %>%
  summarise(avg_pm2.5_2021 = sum(pm2021_pop_weighted, na.rm = TRUE))

  gadm_level_summary(c("country"), c(2021), 10)


# GBD heatmap
  
# GBD heatmap
gbd_grouped_ranks <- gbd_results_master_2021 %>%
  group_by(country) %>%
  mutate(rank_lyl = rank(lyl)) %>%
  ungroup()

# europe's top 10 most populated countries
country_n_most_pop_europe <- gadm2_aqli_2021_europe %>%
  mutate(country == "foo") %>%
  gadm_level_summary(c("country"), c(2021), 10) %>%
  slice_max(population, n = 6) %>% 
  select(country) %>%
  unique() %>%
  unlist() %>%
  as.vector()

 test_df <- gbd_grouped_ranks %>%
  filter(country %in% country_n_most_pop_europe, 
         cause_of_death %in% c("Tobacco", "PM2.5 relative to WHO guideline", 
                               "Cardiovascular diseases", 
                               "Diabetes and kidney diseases", 
                               "Alcohol use")) %>%
      add_aqli_color_scale_buckets(scale_type = "lyl", col_name = "lyl") 
 
 test_df$cause_of_death <- factor(test_df$cause_of_death, levels = c("Tobacco", "Diabetes and kidney diseases", "Alcohol use", "PM2.5 relative to WHO guideline", "Cardiovascular diseases"))
  
 plt <- test_df %>%
   arrange(desc(cause_of_death)) %>%
   ggplot() +
  geom_raster(mapping = aes(x = country, y = cause_of_death, fill = forcats::fct_reorder(lyl_bucket, order_lyl_bucket))) +
       scale_fill_manual(values = c("0 - < 0.1" = "#FFFFFF", 
                               "0.1 - 0.5" = "#FFE6B3", 
                               "> 0.5 - 1" = "#FFD25D", 
                               "> 1 - 2" = "#FFBA00", 
                               "> 2 - 3" = "#FF9600", 
                               "> 3 - 4" = "#FF6908", 
                               "> 4 - 5" = "#E63D23", 
                               "> 5 - < 6" = "#BD251C", 
                               ">= 6" = "#8C130E")) +
   ggthemes::theme_tufte() +
   themes_aqli_base +
   theme(legend.position = "right", 
         plot.background = element_rect(fill = "white", color = "white")) +
   labs(fill = "Life years lost", 
        y = "Threats to Life Expectancy", 
        x = "Country") 

   
  scale_fill_viridis_b(breaks = c(0, 1, 2, 3, 3.5, 4, 6, 8), option = "magma", direction = -1)
  
  
  
#> Nigeria-------------------------------------

  
gadm2_aqli_2021 %>%
    filter(country == "Nigeria") %>%
    slice_max(pm2021, n = 10) %>%
    filter(name_1 == "Taraba") %>% 
    gadm_level_summary(c("country"), c(2021), 10)
  
gadm2_aqli_2021 %>%
    filter(country == "Nigeria") %>%
      gadm_level_summary(c("country", "name_1"), c(2021), 10) %>%
  slice_max(pm2021, n = 20)
  
gadm2_aqli_2021 %>%
  filter(country == "Nigeria", name_1 %in% c("Rivers", "Delta", "Akwa Ibom", "Imo", "Edo", "Ondo", "Cross River", "Abia", "Bayelsa")) %>% 
  gadm_level_summary(c("country"), c(2021), 10)




# nigeria figure1 dataset
nigeria_fs_fig1_data <- gadm2_aqli_2021 %>%
  filter(country == "Nigeria") %>%
  left_join(gadm2_aqli_2021_shp, by = c("objectid_gadm2" = "obidgadm2")) %>%
  mutate(lyl_bucket = ifelse((llpp_who_2021 >= 0) & (llpp_who_2021 < 0.1), "0 - < 0.1", NA), 
         lyl_bucket = ifelse((llpp_who_2021 >= 0.1) & (llpp_who_2021 <= 0.5), "0.1 - 0.5", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 0.5) & (llpp_who_2021 <= 1), "> 0.5 - 1", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 1) & (llpp_who_2021 <= 2), "> 1 - 2", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 2) & (llpp_who_2021 <= 3), "> 2 - 3", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 3) & (llpp_who_2021 <= 4), "> 3 - 4", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 4) & (llpp_who_2021 <= 5), "> 4 - 5", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 > 5) & (llpp_who_2021 < 6), "> 5 - < 6", lyl_bucket), 
         lyl_bucket = ifelse((llpp_who_2021 >= 6), ">= 6", lyl_bucket)) %>%
  mutate(order_lyl_bucket = ifelse(lyl_bucket == "0 - < 0.1", 1, NA), 
         order_lyl_bucket = ifelse(lyl_bucket == "0.1 - 0.5", 2, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 0.5 - 1", 3, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 1 - 2", 4, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 2 - 3", 5, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 3 - 4", 6, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 4 - 5", 7, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == "> 5 - < 6", 8, order_lyl_bucket), 
         order_lyl_bucket = ifelse(lyl_bucket == ">= 6", 9, order_lyl_bucket)) %>%
  select(-geometry, geometry) %>%
  st_as_sf()

# china_fs_fig1_data %>%
#   sf::write_sf("./september.2023/factsheets/southkorea/fig1/sk_fs_fig1.shp")


# nigeria figure 1
nigeria_fs_fig1 <- nigeria_fs_fig1_data %>%
  ggplot() +
  geom_sf(mapping = aes(fill = forcats::fct_reorder(lyl_bucket, order_lyl_bucket)), color = "lightgrey", lwd = 0.05) +
 geom_sf(data = gadm1_aqli_2021_shp %>% filter(name0 == "Nigeria"), color = "black", fill = "transparent", lwd = 0.5) +
  ggthemes::theme_map() + 
 scale_fill_manual(values = c("0 - < 0.1" = "#FFFFFF", 
                               "0.1 - 0.5" = "#FFE6B3", 
                               "> 0.5 - 1" = "#FFD25D", 
                               "> 1 - 2" = "#FFBA00", 
                               "> 2 - 3" = "#FF9600", 
                               "> 3 - 4" = "#FF6908", 
                               "> 4 - 5" = "#E63D23", 
                               "> 5 - < 6" = "#BD251C", 
                               ">= 6" = "#8C130E")) +
  ggthemes::theme_map() +
  labs(fill = "Gain in years of life expectancy  ", title = "") + 
 theme(legend.position = "bottom", 
        legend.justification = c(0.5, 3), 
        legend.background = element_rect(color = "black"), 
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15), 
        plot.title = element_text(hjust = 0.5, size = 15), 
       # legend.key = element_rect(color = "black"),
       legend.box.margin = margin(b = 1, unit = "cm"),
        plot.subtitle = element_text(hjust = 0.5, size = 7), 
        plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
       legend.key = element_rect(color = "black"), 
       legend.box.spacing = unit(0, "cm"), 
        legend.direction = "horizontal", 
       plot.background = element_rect(fill = "white", color = "white")) +
  guides(fill = guide_legend(nrow = 1))



# South east asia sanity check

se_asia_countries <-  c("Brunei", "Myanmar", "Cambodia", "Timor-Leste", "Indonesia", 
                        "Laos", "Malaysia", "Philippines", "Singapore", "Thailand", 
                        "Vietnam")

gadm2_aqli_2021_se_asia <- gadm2_aqli_2021 %>%
    filter(!is.na(population)) %>% 
  filter(country %in% se_asia_countries)
  
gadm2_aqli_2021_se_asia %>%
mutate(country = "foo") %>%
  gadm_level_summary(c("country"), c(2021), 10)


gadm2_aqli_2021_se_asia %>%
  filter(pm2021 <= 5) %>%
  summarise(tot_pop = sum(population, na.rm = TRUE))

gadm2_aqli_2021_se_asia %>%
    gadm_level_summary(c("country"), c(2021, 1998), 10) %>%
  filter(country %in% se_asia_countries) %>%
  mutate(perc_inc = (((pm2021 - pm1998)/pm1998)*100)) %>%
  select(country, pm2021, pm1998, perc_inc)


gadm2_aqli_2021_se_asia %>%
    gadm_level_summary(c("country"), c(2021, 1998), 10) %>%
  filter(country %in% se_asia_countries) %>%
  slice_max(pm2021, n = 10)



foo_data <- gadm2_aqli_2021 %>%
  filter(country %in% se_asia_countries, !is.na(population)) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2021_weighted, names_to = "years", 
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+"))), 
         region = "National Average") %>% 
  select(years, region, pop_weighted_avg_pm2.5)


gadm2_aqli_2021_se_asia %>%
  gadm_level_summary(c("country", "name_1", "name_2"), c(2021), 30) %>%
  slice_max(population, n = 5) %>%
  select(country, name_1, name_2, population, pm2021, llpp_who_2021)
  


 
```


```{r}

aqli_map_sentence_stats(gadm2_aqli_2021, level = "country", data_type = "lyl", year1_col = "llpp_nat_2021",
                                    year2_col = "llpp_nat_2014", country_name = "India",
                                    state_name = "Uttar Pradesh", district_name = "Ghaziabad")


gadm2_aqli_2021 %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm_x_pop_weighted = pop_weights*pm1998, 
         pm_y_pop_weighted = pop_weights*pm2021) %>%
  summarise(avg_pm_x = round(sum(pm_x_pop_weighted, na.rm = TRUE), 2), 
            avg_pm_y = round(sum(pm_y_pop_weighted, na.rm = TRUE), 2))


   gadm2_aqli_2021 %>%
      # filter(country == "Zambia", name_1 == "Lusaka") %>%
        mutate(pop_weights = population/sum(population, na.rm = TRUE),
               col_year1_weighted = pop_weights*(llpp_who_2021),
               col_year2_weighted = pop_weights*(llpp_who_2014)) %>%
   summarise(avg_col_year1 = round(sum(col_year1_weighted, na.rm = TRUE), 2),
                  avg_col_year2 = round(sum(col_year2_weighted, na.rm = TRUE), 2)) %>%
        mutate(col_diff = avg_col_year1 - avg_col_year2) %>%
      mutate(perc_change = round(((avg_col_year1 - avg_col_year2)/avg_col_year2)*100, 2))
   
   
      gadm2_aqli_2021 %>%
        filter(country == "Venezuela") %>%
        mutate(pop_weights = population/sum(population, na.rm = TRUE),
               col_year1_weighted = pop_weights*(pm2020),
               col_year2_weighted = pop_weights*(pm2019)) %>%
   summarise(avg_col_year1 = round(sum(col_year1_weighted, na.rm = TRUE), 2),
                  avg_col_year2 = round(sum(col_year2_weighted, na.rm = TRUE), 2)) %>%
        mutate(col_diff = avg_col_year1 - avg_col_year2) %>%
      mutate(perc_change = round(((avg_col_year1 - avg_col_year2)/avg_col_year2)*100, 2))
      

# website calculations
      
gadm2_aqli_2021 %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2021_pop_weighted = pm2021*pop_weights, 
         pm1998_pop_weighted = pm1998*pop_weights) %>%
  summarise(avg_pm2021 = sum(pm2021_pop_weighted, na.rm = TRUE), 
            avg_pm1998 = sum(pm1998_pop_weighted, na.rm = TRUE))
      
      

```


