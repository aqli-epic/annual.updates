---
title: "Clean Air Countdown Campaign"
author: "Aarsh"
date: '2022-12-06'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# get packages, global variables, datasets
```{r load-lib-helper-files-data-global-var}

# libraries
library(readr)
library(dplyr)
library(stringr)
library(magrittr)
library(ggplot2)
library(readr)
library(tidytext)
library(tidyr)
library(tidyverse)
library(sf)
library(usethis)
library(devtools)
#library(data.table)
library(stringr)
library(forcats) # for reordering bar graphs within a plot
library(cowplot) # for inset plots

# load and document to keep things updated
devtools::load_all()
devtools::document()

# read in latest color file
color_2020 <- read_csv("./june.2022/master.dataset/color_2020.csv")

# read in old available color datasets
color_2019 <- read_csv("./june.2022/master.dataset/color_2019.csv")
color_2016 <- read_csv("./june.2022/master.dataset/color_2016.csv")

# read in color map shape file
colormap_shp <- st_read("./june.2022/other.important.calculations.data/color.map.shape.file/colormap.shp")

# GBD final results file (resulting file that we get after applying the steps in the GBD technical appendix)
gbd_results <- read_csv("./june.2022/other.important.calculations.data/estimated_life_expectancy_differences_master_table_final.csv")

# Countries with Ambient Air Quality Standards
aaqs_places <- read_csv("./june.2022/other.important.calculations.data/countries_list_with_aaqs.csv")
 
# read in "county for aqli pm2.5 dataset" (US technical appendix output file)
county_for_aqli_pm2.5_dataset <- read_csv("./june.2022/other.important.calculations.data/county_pm25_foraqli_stats.csv")


# investments in NCAP data (not using)
# ncap_budget_tracker <- read_csv("./june.2022/clean.air.countdown.campaign.2023/input/ncap_budget_tracker_data.csv")

# NCAP city, districts, state list 
ncap_regions_list <- read_csv("./june.2022/clean.air.countdown.india.campaign.2023/input.data.shared.between.graphs/ncap_cities_district_state_long.csv")

# AQLI district level data classified as Rural/Urban using CSE's classification
aqli_2020_district_level_rural_urban_subset <- read_csv("./june.2022/clean.air.countdown.india.campaign.2023/input.data.shared.between.graphs/aqli_2020_district_level_rural_urban_subset.csv")

# india state
india_state <- st_read("./june.2022/clean.air.countdown.india.campaign.2023/input.data.shared.between.graphs/india_state.shp")


# global variables
who_guideline <- 5
le_constant <- 0.098
ncap_midpoint <- 25
nat_stan_india <- 40

# global operations
`%notin%` <- Negate(`%in%`)


```


# Figure 1: Five Indian states with greatest increase in pollution over the past five years

```{r fig1}

# five states with greatest increase in pollution over the past five years
five_states_with_greatest_increase <- color_2020 %>%
  filter(country == "India") %>%
  group_by(name_1) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2020_pop_weighted = pm2020*pop_weights, 
         pm2016_pop_weighted = pm2016*pop_weights) %>%
  summarise(avg_pm2.5_2016 = sum(pm2016_pop_weighted, na.rm = TRUE), 
            avg_pm2.5_2020 = sum(pm2020_pop_weighted, na.rm = TRUE)) %>%
  mutate(avg_pm2.5_2020_vs_2016 = avg_pm2.5_2020 - avg_pm2.5_2016, 
         avg_pm2.5_2020_vs_2016_prop_change = round((avg_pm2.5_2020_vs_2016/avg_pm2.5_2016)*100, 2)) %>%
  slice_max(avg_pm2.5_2020_vs_2016, n = 5) %>%
  select(name_1) %>%
  unlist() %>%
  as.vector()


# figure 1 data
figure_1_data <-  color_2020 %>%
  filter(country == "India") %>%
  group_by(name_1) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2020_pop_weighted = pm2020*pop_weights, 
         pm2016_pop_weighted = pm2016*pop_weights) %>%
  summarise(avg_pm2.5_2016 = sum(pm2016_pop_weighted, na.rm = TRUE), 
            avg_pm2.5_2020 = sum(pm2020_pop_weighted, na.rm = TRUE)) %>%
  mutate(avg_pm2.5_2020_vs_2016 = avg_pm2.5_2020 - avg_pm2.5_2016, 
         avg_pm2.5_2020_vs_2016_prop_change = round((avg_pm2.5_2020_vs_2016/avg_pm2.5_2016)*100, 2)) %>%
  filter(name_1 %in% five_states_with_greatest_increase) %>%
  select(-avg_pm2.5_2020_vs_2016, -avg_pm2.5_2020_vs_2016_prop_change) %>%
  pivot_longer(avg_pm2.5_2016:avg_pm2.5_2020, names_to = "year", values_to = "pm2.5_pollution")%>% mutate(year = str_extract(str_extract(year, "_\\d+"), "\\d+")) %>%
  mutate(order_var = ifelse(name_1 == "Daman and Diu", 1, 0), 
         order_var = ifelse(name_1 == "Gujarat", 2, order_var), 
         order_var = ifelse(name_1 == "Madhya Pradesh", 3, order_var), 
         order_var = ifelse(name_1 == "Rajasthan", 4, order_var), 
         order_var = ifelse(name_1 == "Chhattisgarh", 5, order_var)) 

# figure 1 plot
figure_1_plot <- figure_1_data %>%
  ggplot(mapping = aes(x = year, y = pm2.5_pollution, fill = name_1)) +
  geom_col(width = 0.5, color = "white") +
  facet_wrap(~fct_reorder(name_1, order_var), ncol = 5) +
  labs(fill = "State", title = expression("Five Indian states with greatest increase in" ~ PM[2.5] ~ pollution ~ "over the past 5 years"), subtitle = "2016 to 2020") +
  scale_fill_manual(values = c("Daman and Diu" = "cadetblue1", "Gujarat" = "steelblue1", "Madhya Pradesh" = "steelblue3", "Rajasthan" = "steelblue4" , "Chhattisgarh" = "navyblue")) +
  ggthemes::theme_clean() +
  labs(x = "Years", y = expression(Average ~ PM[2.5] ~ concentration ~ "("*"in"*~mu*g*"/"*m^3*")")) +
  theme(axis.line.x = element_line(), 
        axis.line.y = element_line(), 
        strip.text.x = element_text(size = 12), 
        legend.position = "bottom", 
        plot.title = element_text(size = 15), 
        legend.box.background = element_rect(linetype = 1, size = 0.5), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12), 
        plot.subtitle = element_text(size = 10)) +
  scale_y_continuous(breaks = seq(0, 70, 10)) +
  geom_text(mapping = aes(label = round(pm2.5_pollution, 1)), position = position_dodge(width = 1), vjust = -0.25, size = 3.8) 


  
```





# Figure 2: Five Indian states with greatest decrease in pollution over the past five years

```{r}

# five states with greatest decrease in pollution over the past five years
five_states_with_greatest_decrease <- color_2020 %>%
  filter(country == "India") %>%
  group_by(name_1) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2020_pop_weighted = pm2020*pop_weights, 
         pm2016_pop_weighted = pm2016*pop_weights) %>%
  summarise(avg_pm2.5_2016 = sum(pm2016_pop_weighted, na.rm = TRUE), 
            avg_pm2.5_2020 = sum(pm2020_pop_weighted, na.rm = TRUE)) %>%
  mutate(avg_pm2.5_2020_vs_2016 = avg_pm2.5_2020 - avg_pm2.5_2016, 
         avg_pm2.5_2020_vs_2016_prop_change = round((avg_pm2.5_2020_vs_2016/avg_pm2.5_2016)*100, 2)) %>%
  slice_min(avg_pm2.5_2020_vs_2016, n = 5) %>%
  select(name_1) %>%
  unlist() %>%
  as.vector()


# figure 2 data
figure_2_data <-  color_2020 %>%
  filter(country == "India") %>%
  group_by(name_1) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2020_pop_weighted = pm2020*pop_weights, 
         pm2016_pop_weighted = pm2016*pop_weights) %>%
  summarise(avg_pm2.5_2016 = sum(pm2016_pop_weighted, na.rm = TRUE), 
            avg_pm2.5_2020 = sum(pm2020_pop_weighted, na.rm = TRUE)) %>%
  mutate(avg_pm2.5_2020_vs_2016 = avg_pm2.5_2020 - avg_pm2.5_2016, 
         avg_pm2.5_2020_vs_2016_prop_change = round((avg_pm2.5_2020_vs_2016/avg_pm2.5_2016)*100, 2)) %>%
  filter(name_1 %in% five_states_with_greatest_decrease) %>%
  select(-avg_pm2.5_2020_vs_2016, -avg_pm2.5_2020_vs_2016_prop_change) %>%
  pivot_longer(avg_pm2.5_2016:avg_pm2.5_2020, names_to = "year", values_to = "pm2.5_pollution")%>% mutate(year = str_extract(str_extract(year, "_\\d+"), "\\d+")) %>%
  mutate(order_var = ifelse(name_1 == "Himachal Pradesh", 1, 0), 
         order_var = ifelse(name_1 == "Jammu and Kashmir", 2, order_var), 
         order_var = ifelse(name_1 == "Uttarakhand", 3, order_var), 
         order_var = ifelse(name_1 == "Punjab", 4, order_var), 
         order_var = ifelse(name_1 == "NCT of Delhi", 5, order_var)) 


# figure 2 plot
figure_2_plot <- figure_2_data %>%
  ggplot(mapping = aes(x = year, y = pm2.5_pollution, fill = name_1)) +
  geom_col(width = 0.5) +
  facet_wrap(~fct_reorder(name_1, order_var), ncol = 5) +
  theme(legend.position = "bottom") +
    scale_fill_manual(values = c("Himachal Pradesh" = "cadetblue1", "Jammu and Kashmir" = "steelblue1", "Uttarakhand" = "steelblue3", "Punjab" = "steelblue4" , "NCT of Delhi" = "navyblue")) +
    ggthemes::theme_clean() +
  labs(x = "Years", y = expression(Average ~ PM[2.5] ~ concentration ~ "("*"in"*~mu*g*"/"*m^3*")"), 
       title = expression("Five Indian states with greatest decrease in" ~ PM[2.5] ~ pollution ~ "over the past 5 years"), subtitle = "2016 to 2020", 
       fill = "State") +
    theme(axis.line.x = element_line(), 
        axis.line.y = element_line(), 
        strip.text.x = element_text(size = 12), 
        legend.position = "bottom", 
        plot.title = element_text(size = 15), 
        legend.box.background = element_rect(linetype = 1, size = 0.5), 
        axis.title.y = element_text(size = 12), 
        axis.title.x = element_text(size = 12),
        legend.text = element_text(size = 12), 
        plot.subtitle = element_text(size = 10)) +
    geom_text(mapping = aes(label = round(pm2.5_pollution, 1)), position = position_dodge(width = 1), vjust = -0.25, size = 3.2) 


  

```






# Figure 3: Pollution in the top 5 most populated districts not touched by NCAP

```{r}

# ncap regions dataset
ncap_regions_list <- ncap_regions_list %>%
  dplyr::select(state_ut, city, district) %>%
  dplyr::filter(!is.na(district))

# ncap state and district list
ncap_state_list <- unique(ncap_regions_list$state_ut)
ncap_district_list <- unique(ncap_regions_list$district)

# pollution levels in the top 5 most populated districts not touched by NCAP
non_ncap_district_top5_most_populated_data <- color_2020 %>%
  filter(country == "India") %>%
  filter(name_2 %notin% ncap_district_list) %>%
  slice_max(population, n = 5) 

# top 5 most populated districts not touched by NCAP list 
non_ncap_district_top5_most_populated_list <- non_ncap_district_top5_most_populated_data %>% .$name_2

# states in which the top 5 most populated districts lie
states_of_interest <- non_ncap_district_top5_most_populated_data %>% .$name_1 %>% unique()

# states of interest shape file
states_of_focus_shp_file <- india_state %>%
  filter(NAME_1 %in% states_of_interest)

# districts of interest (within the above states of interest) shape file
districts_of_interst_shp_file <- colormap_shp %>%
  filter(NAME_0 == "India", NAME_1 %in% states_of_interest, NAME_2 %in% non_ncap_district_top5_most_populated_list)

# states of interest bounding box
states_of_interest_bb <- st_as_sfc(st_bbox(states_of_focus_shp_file))

# a state level India map with a bounding box on states of interest
figure_3_plot_part_1 <- india_state %>%
  ggplot() +
  geom_sf(fill = "snow2") +
  geom_sf(data = states_of_focus_shp_file, fill = "white", size = 1.2) +
  geom_sf(data = districts_of_interst_shp_file, fill = "red", size = 1) +
  geom_sf(data = states_of_interest_bb, fill = NA, color = "red", size = 1.2) +
  theme_map() 

figure_3_plot_part_2 <- states_of_focus_shp_file %>%
  ggplot() + 
    geom_sf(fill = "white", size = 1.2) +
   geom_sf(data = districts_of_interst_shp_file, fill = "red", size = 1.6) +
  theme_map() +
  labs(title = "India's top 5 most populated districts not touched by NCAP*", 
       caption = str_wrap(expression("*NCAP is India's National Clean Air Programme. Pollution values specifically refer to" ~ PM[2.5] ~ pollution ~ "and are reported in µg/m³. Life years lost are relative to WHO" ~ PM[2.5] ~ pollution ~ "guideline"), 90), subtitle = "2016 to 2020") +
  theme_map() +
   ggsflabel::geom_sf_label_repel(data = districts_of_interst_shp_file, mapping = aes(label = NAME_2), force = 100, nudge_x = -2, seed = 10, size = 7) +
  theme(plot.background = element_rect(fill = "azure2"), 
        plot.caption = element_text(hjust = 0, size = 9), plot.caption.position = "plot") 
  
 
 

# combined inset map
figure_3_plot <- cowplot::ggdraw() +
  draw_plot(figure_3_plot_part_2, x = 0.1, y = 0.0001) +
  draw_plot(figure_3_plot_part_1, x = 0, y = 0.1, width = 0.4, height = 0.4)
  

```




# Figure 4: Calculating 2 average pollution and (corresponding life years lost) number for all regions north and south of the tropic of cancer respectively.

```{r}

# states north of the tropic of cancer
states_north_of_toc <- c("Jammu and Kashmir", "Punjab", "Chandigarh", "Himachal Pradesh", 
                         "Uttarakhand", "Haryana", "NCT of Delhi", "Rajasthan", 
                         "Uttar Pradesh", "Bihar", "Sikkim", "Assam", 
                         "Arunachal Pradesh", "Nagaland", "Manipur", 
                         "Mizoram", "Tripura", "West Bengal", 
                         "Madhya Pradesh", "Jharkhand")

# sanity check to see if all of the above states are in the color file. # yes they are
color_2020 %>% filter(country == "India", name_1 %in% states_north_of_toc) %>% .$name_1 %>% unique()

# states south of toc
states_south_of_toc <- color_2020 %>%
  filter(country == "India", name_1 %notin% states_north_of_toc) %>%
  .$name_1 %>%
  unique()

# color 2020 with north/south toc column
color_2020_india_toc <- color_2020 %>%
  filter(country == "India") %>%
  mutate(toc_direction = ifelse(name_1 %in% states_north_of_toc, "north_toc", "south_toc"))

# calculating the average pollution number for north toc and south toc
india_toc_division_summary <- color_2020_india_toc %>%
  group_by(toc_direction) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2020_pop_weighted = pop_weights*pm2020) %>%
  summarise(avg_pm2.5_2020 = sum(pm2020_pop_weighted, na.rm = TRUE), 
            lyl_rel_who_guideline = round((avg_pm2.5_2020 - who_guideline)*le_constant, 2), 
            lyl_rel_who_guideline = ifelse(lyl_rel_who_guideline < 0, 0, lyl_rel_who_guideline))

india_toc_division_summary %>% write_csv("./june.2022/clean.air.countdown.india.campaign.2023/chart.4.data.graph.code/chart4.plot.csv")

# export prettified India state level shapefile 
india_state %>%
  ggplot() +
  geom_sf(fill = "white", color = "black", size = 1) +
  ggthemes::theme_map()


```





# Figure 5: generate a life years lost graph grouped by population, for India as a whole, Rural India and Urban India
```{r}

# global aqli file grouped by pop_buckets
  aqli_2020_district_level_pop_buckets <- aqli_2020_district_level_rural_urban_subset %>%
  mutate(pop_bucket = ifelse(lyl_rel_to_who_2020 < 1, "<1 year", lyl_rel_to_who_2020), 
         pop_bucket = ifelse(((pop_bucket >= 1) & (pop_bucket < 3)), "1 - <3", pop_bucket), 
         pop_bucket = ifelse(((pop_bucket >= 3) & (pop_bucket < 5)), "3 - <5", pop_bucket), 
         pop_bucket = ifelse(((pop_bucket >= 5) & (pop_bucket <= 7)), "5 - 7", pop_bucket), 
         pop_bucket = ifelse(pop_bucket > 7, ">7 years", pop_bucket)) %>%
  mutate(order_pop_buckets = ifelse(pop_bucket == "<1 year", 1, 0), 
         order_pop_buckets = ifelse(pop_bucket == "1 - <3", 2, order_pop_buckets), 
         order_pop_buckets = ifelse(pop_bucket == "3 - <5", 3, order_pop_buckets), 
         order_pop_buckets = ifelse(pop_bucket == "5 - 7", 4, order_pop_buckets), 
         order_pop_buckets = ifelse(pop_bucket == ">7 years", 5, order_pop_buckets)) 

# overall summary
aqli_2020_district_level_pop_buckets_summary <- aqli_2020_district_level_pop_buckets %>%
  group_by(pop_bucket) %>%
  summarise(tot_pop = sum(population, na.rm = TRUE), 
            order_var = order_pop_buckets[1]) %>%
  arrange(order_var) %>%
  ungroup() %>%
     mutate(tot_fin_pop = sum(tot_pop, na.rm = TRUE), 
            prop_pop = round((tot_pop/tot_fin_pop)*100, 2)) %>%
    ungroup() %>%
    select(pop_bucket, prop_pop, order_var) %>%
  mutate(order_var_2 = 1)

# summary for the rural region
aqli_2020_district_level_pop_buckets_summary_r <- aqli_2020_district_level_pop_buckets %>%
  filter(region_type == "Predominantly Rural") %>%
  group_by(pop_bucket) %>%
  summarise(tot_pop = sum(population, na.rm = TRUE), 
            order_var = order_pop_buckets[1]) %>%
  arrange(order_var) %>%
  ungroup() %>%
     mutate(tot_fin_pop = sum(tot_pop, na.rm = TRUE), 
            prop_pop = round((tot_pop/tot_fin_pop)*100, 2)) %>%
    ungroup() %>%
    select(pop_bucket, prop_pop, order_var) %>%
  mutate(order_var_2 = 1)

# summary for the urban data
aqli_2020_district_level_pop_buckets_summary_u <- aqli_2020_district_level_pop_buckets %>%
  filter(region_type == "Predominantly Urban") %>%
  group_by(pop_bucket) %>%
  summarise(tot_pop = sum(population, na.rm = TRUE), 
            order_var = order_pop_buckets[1]) %>%
  arrange(order_var) %>%
  ungroup() %>%
     mutate(tot_fin_pop = sum(tot_pop, na.rm = TRUE), 
            prop_pop = round((tot_pop/tot_fin_pop)*100, 2)) %>%
    ungroup() %>%
    select(pop_bucket, prop_pop, order_var) %>%
  mutate(order_var_2 = 1)


# v1 of the graph (not stacked)
aqli_2020_district_level_pop_buckets_summary %>%
  ggplot() +
  geom_col(mapping = aes(x = forcats::fct_reorder(pop_bucket, order_var), y = prop_pop, fill = pop_bucket)) +
     scale_fill_manual(values = c(">7 years" = "black", "5 - 7" = "darkred", "3 - <5" = "red", "1 - <3" = "orange", "<1 year" = "burlywood1")) +
  labs(x = "Life Years Lost", y = "% population", title = "Proportion population in different life years lost buckets", fill = "Life Years Lost") +
  theme(axis.title = element_text(size = 11) ,
        axis.text.x = element_text(size = 10), 
        axis.text.y = element_text(size = 10)) +
  coord_flip() +
  ggthemes::theme_hc() + 
  theme(plot.title = element_text(size = 14)) 

# v2.1 of the graph (stacked)  
foo <- aqli_2020_district_level_pop_buckets_summary %>% 
  ggplot() + 
  geom_bar(mapping = aes(x = order_var_2, y = prop_pop, fill = forcats::fct_reorder(pop_bucket, order_var, .desc = TRUE)), position = "stack", stat = "identity", height = 1, color = "black", size = 1) +
   scale_fill_manual(values = c("<1 year" = "burlywood1", "1 - <3" = "orange", "3 - <5" = "red", "5 - 7" = "darkred", ">7 years" = "black")) +
  labs(x = "", y = "", title = "Proportion population in different life years lost buckets", fill = "Life Years Lost") +
  coord_flip() +
  ggthemes::theme_clean() +
  theme(plot.title = element_text(size = 15), 
        axis.text.y = element_blank(), 
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), 
        axis.title = element_text(size = 11), 
        legend.position = "bottom", 
        legend.background = element_rect(), 
        axis.line.x = element_blank(), 
        axis.line.y = element_blank(), 
        axis.ticks = element_blank()) 

# v2.2 (stacked, rural, urban division)
foo2 <- aqli_2020_district_level_pop_buckets_summary_r %>% 
  ggplot() + 
  geom_bar(mapping = aes(x = order_var_2, y = prop_pop, fill = forcats::fct_reorder(pop_bucket, order_var, .desc = TRUE)), position = "stack", stat = "identity", height = 1, color = "black", size = 1) +
   scale_fill_manual(values = c("<1 year" = "burlywood1", "1 - <3" = "orange", "3 - <5" = "red", "5 - 7" = "darkred", ">7 years" = "black")) +
  labs(x = "", y = "", title = "Proportion population in different life years lost buckets", fill = "Life Years Lost") +
  coord_flip() +
  ggthemes::theme_clean() +
  theme(plot.title = element_text(size = 15), 
        axis.text.y = element_blank(), 
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), 
        axis.title = element_text(size = 11), 
        legend.position = "bottom", 
        legend.background = element_rect(), 
        axis.line.x = element_blank(), 
        axis.line.y = element_blank(), 
        axis.ticks = element_blank()) 


# v2.3 (stacked, rural, urban division)
foo3 <- aqli_2020_district_level_pop_buckets_summary_u %>% 
  ggplot() + 
  geom_bar(mapping = aes(x = order_var_2, y = prop_pop, fill = forcats::fct_reorder(pop_bucket, order_var, .desc = TRUE)), position = "stack", stat = "identity", height = 1, color = "black", size = 1) +
   scale_fill_manual(values = c("<1 year" = "burlywood1", "1 - <3" = "orange", "3 - <5" = "red", "5 - 7" = "darkred", ">7 years" = "black")) +
  labs(x = "", y = "", title = "Proportion population in different life years lost buckets", fill = "Life Years Lost") +
  coord_flip() +
  ggthemes::theme_clean() +
  theme(plot.title = element_text(size = 15), 
        axis.text.y = element_blank(), 
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), 
        axis.title = element_text(size = 11), 
        legend.position = "bottom", 
        legend.background = element_rect(), 
        axis.line.x = element_blank(), 
        axis.line.y = element_blank(), 
        axis.ticks = element_blank()) 



# v3 (waffle package, waffle plot), # problem is that we have to round up to a whole number
x <- round(c(0.87, 30, 25.7, 21.2, 22.2))
waffle(x, rows = 10)

# v4 (lessR, donut chart):this will not work
PieChart(pop_bucket, data = aqli_2020_district_level_pop_buckets)

# v5 (treemapify)
ggplot(data = aqli_2020_district_level_pop_buckets_summary, aes(area = prop_pop, fill = prop_pop)) +
  geom_treemap() +
  viridis::scale_fill_viridis(direction = -1, option = "rocket")


```











































############# Other graphs ##########################

# Figure 6:  5 Indian districts with the greatest increase in pollution over the past five years
```{r}

# five datasets with greatest increase
five_districts_with_greatest_increase <- color_2020 %>%
  filter(country == "India") %>%
  select(country, name_1, name_2, pm2016, pm2020) %>%
  mutate(district_state = str_c(name_2, " ", "(", name_1, ")"), 
         pol_2020_vs_2016  = pm2020 - pm2016) %>%
  select(country, name_1, name_2, district_state, everything()) %>%
   slice_max(pol_2020_vs_2016, n = 5) %>%
  select(district_state) %>%
  unlist() %>%
  as.vector()

# figure 1 data
figure_1_data <- color_2020 %>%
  filter(country == "India") %>%
  select(country, name_1, name_2, pm2016, pm2020) %>%
  mutate(district_state = str_c(name_2, " ", "(", name_1, ")"), 
         pol_2020_vs_2016  = pm2020 - pm2016) %>%
  select(country, name_1, name_2, district_state, everything()) %>%
  filter(district_state %in% five_districts_with_greatest_increase) %>%
  select(-pol_2020_vs_2016) %>%
  pivot_longer(pm2016:pm2020, names_to = "year", values_to = "pm2.5_pollution") %>%
  mutate(year = str_extract(year, "\\d+"))
  
# figure 1 plot  
figure_1_plot <- figure_1_data %>%
  ggplot() +
  geom_col(mapping = aes(x = year, y = pm2.5_pollution, fill = district_state), width = 0.5) +
  facet_wrap(~district_state, ncol = 5) +
  theme(legend.position = "bottom") +
  labs(fill = "District (State)", title = "5 Indian districts with the greatest increase in pollution over the past five years") +
   scale_fill_brewer(palette = "Accent") +
  ggthemes::theme_hc()
 

figure_1_plot


```

# Figure 7: 5 Indian cities with the greatest reduction in pollution over the past five years

```{r}

# five districts with greatest decrease in pollution
five_districts_with_greatest_decrease <- color_2020 %>%
  filter(country == "India") %>%
  select(country, name_1, name_2, pm2016, pm2020) %>%
  mutate(district_state = str_c(name_2, " ", "(", name_1, ")"), 
         pol_2020_vs_2016  = pm2020 - pm2016) %>%
  select(country, name_1, name_2, district_state, everything()) %>%
   slice_min(pol_2020_vs_2016, n = 5) %>%
  select(district_state) %>%
  unlist() %>%
  as.vector()


figure_2_data <- color_2020 %>%
  filter(country == "India") %>%
  select(country, name_1, name_2, pm2016, pm2020) %>%
  mutate(district_state = str_c(name_2, " ", "(", name_1, ")"), 
         pol_2020_vs_2016  = pm2020 - pm2016) %>%
  select(country, name_1, name_2, district_state, everything()) %>%
  filter(district_state %in% five_districts_with_greatest_decrease) %>%
  select(-pol_2020_vs_2016) %>%
  pivot_longer(pm2016:pm2020, names_to = "year", values_to = "pm2.5_pollution") %>%
  mutate(year = str_extract(year, "\\d+"))
  
  
figure_2_plot <- figure_2_data %>%
  ggplot() +
  geom_col(mapping = aes(x = year, y = pm2.5_pollution, fill = district_state), width = 0.5) +
  facet_wrap(~district_state, ncol = 5) +
  theme(legend.position = "bottom") +
  labs(fill = "District (State)", title = "5 Indian districts with the greatest reduction in pollution over the past five years") +
   scale_fill_brewer(palette = "Accent") +
  ggthemes::theme_hc()
 


```



# Figure 8: Pollution levels in the top 5 most polluted districts in India not touched by NCAP (bar graph)

```{r}


# figure 8 plot
figure_5_plot <- non_ncap_district_top5_most_populated_data  %>% # data from figure 3
  ggplot() +
  geom_col(mapping = aes(x = fct_reorder(name_2, pm2020), y = pm2020, fill = name_2), width = 0.3) +
  labs(x = "District", y = "PM2.5 pollution", fill = "District", 
       title = "Pollution levels in the top 5 most 'polluted' districts in India not touched by NCAP") +
  scale_fill_brewer(palette = "Accent") +
  scale_y_continuous(breaks = seq(0, 110, 15)) +
  ggthemes::theme_hc()
  

```

# Figure 9: Pollution levels in the top 5 most populated districts in India not touched by NCAP

```{r}

# figure 5 data
figure_6_data <- color_2020 %>%
  filter(country == "India") %>%
  filter(name_2 %notin% ncap_district_list) %>%
  slice_max(population, n = 5) 

# figure 5 plot
figure_6_plot <- figure_6_data %>%
  ggplot() +
  geom_col(mapping = aes(x = fct_reorder(name_2, pm2020), y = pm2020, fill = name_2), width = 0.3) +
  labs(x = "District", y = "PM2.5 pollution", fill = "District", 
       title = "Pollution levels in the top 5 most 'populated' districts in India not touched by NCAP") +
  scale_fill_brewer(palette = "Accent") +
  scale_y_continuous(breaks = seq(0, 110, 15)) +
  ggthemes::theme_hc()
```


# Figure 10: Top 5 NCAP districts that have seen a rise in pollution from 2019 to 2020

```{r}

districts_2019_2020_top5 <- color_2020 %>%
  filter(country == "India") %>%
  select(country, name_1, name_2, pm2019, pm2020) %>%
  mutate(district_state = str_c(name_2, " ", "(", name_1, ")"), 
         pol_2020_vs_2019  = pm2020 - pm2019) %>%
  select(country, name_1, name_2, district_state, everything()) %>%
  filter(name_2 %in% ncap_district_list) %>%
   slice_max(pol_2020_vs_2019, n = 5) %>%
  select(district_state) %>%
  unlist() %>%
  as.vector()
  
# figure 7 data
figure_7_data <- color_2020 %>%
  filter(country == "India") %>%
  select(country, name_1, name_2, pm2019, pm2020) %>%
  mutate(district_state = str_c(name_2, " ", "(", name_1, ")"), 
         pol_2020_vs_2019  = pm2020 - pm2019) %>%
  select(country, name_1, name_2, district_state, everything()) %>%
  filter(district_state %in% districts_2019_2020_top5) %>%
  select(-pol_2020_vs_2019) %>%
  pivot_longer(pm2019:pm2020, names_to = "year", values_to = "pm2.5_pollution") %>%
  mutate(year = str_extract(year, "\\d+"))
  
# figure 7 plot  
figure_7_plot <- figure_7_data %>%
  ggplot() +
  geom_col(mapping = aes(x = year, y = pm2.5_pollution, fill = district_state), size = 0.3) +
  facet_wrap(~district_state, ncol = 5) +
  theme(legend.position = "bottom") +
  labs(fill = "District (State)", title = "Top 5 NCAP districts that have seen a rise in pollution from 2019 to 2020") +
   scale_fill_brewer(palette = "Accent") +
  ggthemes::theme_hc()



```

# Figure 11: Top 5 NCAP districts that have seen a decline in pollution from 2019 to 2020

```{r}

districts_2019_2020_top5_dec <- color_2020 %>%
  filter(country == "India") %>%
  select(country, name_1, name_2, pm2019, pm2020) %>%
  mutate(district_state = str_c(name_2, " ", "(", name_1, ")"), 
         pol_2020_vs_2019  = pm2020 - pm2019) %>%
  select(country, name_1, name_2, district_state, everything()) %>%
  filter(name_2 %in% ncap_district_list) %>%
   slice_min(pol_2020_vs_2019, n = 5) %>%
  select(district_state) %>%
  unlist() %>%
  as.vector()
  
# figure 8 data
figure_8_data <- color_2020 %>%
  filter(country == "India") %>%
  select(country, name_1, name_2, pm2019, pm2020) %>%
  mutate(district_state = str_c(name_2, " ", "(", name_1, ")"), 
         pol_2020_vs_2019  = pm2020 - pm2019) %>%
  select(country, name_1, name_2, district_state, everything()) %>%
  filter(district_state %in% districts_2019_2020_top5_dec) %>%
  select(-pol_2020_vs_2019) %>%
  pivot_longer(pm2019:pm2020, names_to = "year", values_to = "pm2.5_pollution") %>%
  mutate(year = str_extract(year, "\\d+"))
  
# figure 8 plot  
figure_8_plot <- figure_8_data %>%
  ggplot() +
  geom_col(mapping = aes(x = year, y = pm2.5_pollution, fill = district_state), size = 0.3) +
  facet_wrap(~district_state, ncol = 5) +
  theme(legend.position = "bottom") +
  labs(fill = "District (State)", title = "Top 5 NCAP districts that have seen a decline in pollution from 2019 to 2020") +
   scale_fill_brewer(palette = "Accent") +
  ggthemes::theme_hc()



```


# Figure 12: Gujarat, trenlines pollution last 20 years.

```{r}
figure_9_data <- color_2020 %>%
  filter(country == "India") %>%
  group_by(name_1) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2020_weighted, names_to = "years", 
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+")))) %>%
  select(years, name_1, pop_weighted_avg_pm2.5)


  plt <- figure_9_data %>% 
    filter(name_1 == "Gujarat") %>%
    ggplot() +
  geom_line(mapping = ggplot2::aes(x = years, y = pop_weighted_avg_pm2.5), lwd = 1.1, 
            color = "darkred") +
    geom_hline(mapping = aes(yintercept = 5), lwd = 0.8) +
  scale_y_continuous(breaks = seq(0, 40, 5), limits = c(0, 40)) +
  scale_x_continuous(breaks = seq(1998, 2020, 2)) +
  ggthemes::theme_clean() +
  labs(x = "Years", 
       y = expression(paste("Average PM2.5 concentration ( ", mu, "g", "/", m^3, " )")), 
       title = "Average PM2.5 pollution in the state of Gujarat, India", 
       subtitle = "1998 to 2020") +
  theme(legend.position = "bottom", legend.title = element_blank(), 
        legend.text = element_text(size = 7), 
        axis.title.y = element_text(size = 9), 
        axis.title.x = element_text(size = 9)) + 
     geom_text(x = 2002.5, y = 7.2, label = expression(paste("WHO PM2.5 Guideline (last updated: 2021): 5 ", mu, "g","/", m^3, "")))

```

# Figure 13, Surat pollution 1998 to 2020

```{r}
figure_10_data <- color_2020 %>%
  filter(country == "India", name_1 == "Gujarat", name_2 == "Surat") %>%
  select(country, name_1, name_2, starts_with("pm")) %>%
  pivot_longer(cols = pm1998:pm2020, names_to = "years", 
               values_to = "avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+")))) 


  figure_10_plot <- figure_10_data %>% 
    ggplot() +
  geom_line(mapping = ggplot2::aes(x = years, y = avg_pm2.5), lwd = 1.1, 
            color = "darkred") +
    geom_hline(mapping = aes(yintercept = 5), lwd = 0.8) +
  scale_y_continuous(breaks = seq(0, 40, 5), limits = c(0, 40)) +
  scale_x_continuous(breaks = seq(1998, 2020, 2)) +
  ggthemes::theme_clean() +
  labs(x = "Years", 
       y = expression(paste("Average PM2.5 concentration ( ", mu, "g", "/", m^3, " )")), 
       title = "Average PM2.5 pollution in Surat district of Gujarat, India", 
       subtitle = "1998 to 2020") +
  theme(legend.position = "bottom", legend.title = element_blank(), 
        legend.text = element_text(size = 7), 
        axis.title.y = element_text(size = 9), 
        axis.title.x = element_text(size = 9)) + 
     geom_text(x = 2002.5, y = 7.2, label = expression(paste("WHO PM2.5 Guideline (last updated: 2021): 5 ", mu, "g","/", m^3, "")))

```


# Random
```{r}
# 
 color_2020 %>%
  filter(country == "India") %>%
  group_by(name_1) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2020_pop_weighted = pm2020*pop_weights, 
         pm2016_pop_weighted = pm2016*pop_weights) %>%
  summarise(avg_pm2.5_2016 = sum(pm2016_pop_weighted, na.rm = TRUE), 
            avg_pm2.5_2020 = sum(pm2020_pop_weighted, na.rm = TRUE)) %>%
  mutate(avg_pm2.5_2020_vs_2016 = avg_pm2.5_2020 - avg_pm2.5_2016, 
         avg_pm2.5_2020_vs_2016_prop_change = round((avg_pm2.5_2020_vs_2016/avg_pm2.5_2016)*100, 2)) %>%
  filter(avg_pm2.5_2020_vs_2016_prop_change <= -10) %>%
  nrow()


color_2020 %>%
  filter(country == "India") %>%
  mutate(pol_change = pm2020 - pm2016, 
         prop_change = (pol_change/pm2016)*100) %>%
  filter(prop_change < -10) %>%
  nrow()

# Michael graph (top 5 largest NCAP cities, pollution trend graph 2017 to 2020) and their corresponding pollution reduction targets horizontal lines.

ds_trendlines <- color_2020 %>%
  filter(name_2 %in% ncap_district_list) %>%
  slice_max(population, n = 5) %>%
  select(country, name_1, name_2, population, starts_with("pm")) %>%
  pivot_longer(pm1998:pm2020, names_to = "year", values_to = "pm2.5_pollution") %>%
  mutate(year = as.numeric(str_extract(year, "\\d+"))) %>%
  filter(year >= 2017) 

city_wise_reduction_target <- color_2020 %>%
  filter(country == "India", name_2 %in% c("Bangalore", "Mumbai Suburban", "NCT of Delhi", "North 24 Parganas", "Pune")) %>%
  select(country, name_1, name_2, pm2017) %>%
  mutate(pm2026_target = round(pm2017*0.6, 2))

foo <- ds_trendlines %>%
  ggplot() +
  geom_line(mapping = ggplot2::aes(x = year, y = pm2.5_pollution, color = name_2), lwd = 1.2) +
    geom_hline(mapping = aes(yintercept = 23.6), lwd = 1.1, linetype = "dashed", color = "olivedrab1") +
  geom_hline(mapping = aes(yintercept = 22.2), lwd = 1.1, linetype = "dashed", color = "darkslateblue") +
  geom_hline(mapping = aes(yintercept = 24.9), lwd = 1.1, linetype = "dashed", color = "orangered4") +
  geom_hline(mapping = aes(yintercept = 65.6), lwd = 1.1, linetype = "dashed", color = "magenta1") +
  geom_hline(mapping = aes(yintercept = 34.3), lwd = 1.1, linetype = "dashed", color = "lightsteelblue4") +
  geom_vline(mapping = aes(xintercept = 2019), lwd = 0.8) +
  scale_y_continuous(breaks = seq(0, 130, 20), limits = c(0, 130)) +
  scale_x_continuous(breaks = seq(2017, 2020, 1)) +
  labs(x = "Years", 
       y = expression(paste("Average PM2.5 concentration ( ", mu, "g", "/", m^3, ")")), 
       title = "Average PM2.5 pollution in 5 largest districts touched by NCAP, with 2026 reduction targets", 
       subtitle = "2017 to 2020", caption = "* 'largest NCAP districts' means, largest in terms of population and dashed lines show city wise reduction targets", 
       color = "District") +
    theme_classic() +
  theme(legend.position = "bottom", legend.title = element_blank(), 
        legend.text = element_text(size = 10), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        axis.text.x = element_text(size = 13), 
        axis.text.y = element_text(size = 13), 
        plot.caption = element_text(hjust = 0)) +
  scale_color_manual(values = c("Bangalore" = "olivedrab1", "Mumbai Suburban" = "darkslateblue", "NCT of Delhi" = "magenta1", "North 24 Parganas" = "lightsteelblue4", "Pune" = "orangered4"))


foo1 <- ds_trendlines %>%
  ggplot() +
  geom_line(mapping = ggplot2::aes(x = year, y = pm2.5_pollution, color = name_2), lwd = 1.1) +
    geom_hline(mapping = aes(yintercept = 23.6), lwd = 0.3, color = "orange4") +
  geom_hline(mapping = aes(yintercept = 22.2), lwd = 0.3,  color = "lightblue4") +
  geom_hline(mapping = aes(yintercept = 24.9), lwd = 0.3,  color = "mediumpurple4") +
  geom_hline(mapping = aes(yintercept = 65.6), lwd = 0.3, color = "darkred") +
  geom_hline(mapping = aes(yintercept = 34.3), lwd = 0.3, color = "navyblue") +
  geom_vline(mapping = aes(xintercept = 2019), lwd = 0.8) +
  scale_y_continuous(breaks = seq(0, 130, 20), limits = c(0, 130)) +
  scale_x_continuous(breaks = seq(2017, 2020, 1)) +
  labs(x = "Years", 
       y = expression(paste("Average PM2.5 concentration ( ", mu, "g", "/", m^3, ")")), 
       title = "Average PM2.5 pollution in 5 largest districts touched by NCAP", 
       subtitle = "2017 to 2020", caption = "* 'largest NCAP districts' means, largest in terms of population", 
       color = "District") +
    theme_classic() +
  theme(legend.position = "bottom", legend.title = element_blank(), 
        legend.text = element_text(size = 10), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        axis.text.x = element_text(size = 13), 
        axis.text.y = element_text(size = 13), 
        plot.caption = element_text(hjust = 0)) +
  scale_color_manual(values = c("Bangalore" = "orange4", "Mumbai Suburban" = "blue4", "NCT of Delhi" = "darkred", "North 24 Parganas" = "navyblue", "Pune" = "mediumpurple4"))  


foo2 <- ds_trendlines %>%
  ggplot() +
  geom_line(mapping = ggplot2::aes(x = year, y = pm2.5_pollution, color = name_2), lwd = 1.5) +
  geom_hline(data = city_wise_reduction_target, mapping = aes(yintercept = pm2026_target, color = name_2), lwd = 0.8, linetype = "dashed",  color = "lightblue4") +
  geom_vline(mapping = aes(xintercept = 2019), lwd = 0.8) +
  scale_y_continuous(breaks = seq(0, 130, 20), limits = c(0, 130)) +
  scale_x_continuous(breaks = seq(2017, 2020, 1)) +
  labs(x = "Years", 
       y = expression(paste("Average PM2.5 concentration ( ", mu, "g", "/", m^3, ")")), 
       title = "Average PM2.5 pollution in 5 largest districts touched by NCAP, with 2026 reduction targets", 
       subtitle = "2017 to 2020, NCAP begins in 2019 (vertical line)", caption = "* 'largest NCAP districts' means, largest in terms of population and dashed lines show city wise reduction targets", 
       color = "District") +
    ggthemes::theme_clean() +
  theme(legend.position = "bottom", legend.title = element_blank(), 
        legend.text = element_text(size = 10), 
        axis.title.y = element_text(size = 11), 
        axis.title.x = element_text(size = 11),
        axis.text.x = element_text(size = 9), 
        axis.text.y = element_text(size = 9), 
        plot.caption = element_text(hjust = 0), 
        plot.title = element_text(size = 13), 
        plot.subtitle = element_text(size = 11)) +
  facet_wrap(~name_2, ncol = 5)

+
  scale_color_manual(values = c("Bangalore" = "orange4", "Mumbai Suburban" = "blue4", "NCT of Delhi" = "darkred", "North 24 Parganas" = "navyblue", "Pune" = "mediumpurple4"))  

```


```{r}

bbox_state_of_interest <- st_as_sfc(st_bbox(colormap_shp %>% filter(NAME_0 == "India", NAME_1 %in% c("Uttar Pradesh", "Haryana", "NCT of Delhi"))))

india_state %>%
  filter(NAME_1 %notin% c("Andaman and Nicobar")) %>%
  ggplot() +
  geom_sf(fill = "white", color = "black", size = 1)  +
  ggthemes::theme_map() +
  geom_sf(data = india_state %>% filter(NAME_1 %in% c("Uttar Pradesh", "Haryana", "NCT of Delhi")), size = 1.5, fill = "white", color = "black") +
  geom_sf(data = bbox_state_of_interest, fill = NA, color = "red", size = 1)


districts_of_interest <- ggplot() +
  geom_sf(data = colormap_shp %>% filter(NAME_0 == "India", NAME_1 %in% c("Uttar Pradesh", "Haryana", "NCT of Delhi"), NAME_2 %in% c("Ghaziabad", "Gautam Buddha Nagar", "Muzaffarnagar", "Gurugram", "Panipat", "Faridabad")), color = "orange")




foo1 <- ggplot() + 
   geom_sf(data = india_state, fill = "white", color = "black", size = 1.2) +
  geom_sf(data = india_state %>% filter(NAME_1 %in% c("Uttar Pradesh", "NCT of Delhi", "Haryana")), color = "black", size = 1, fill = "white") +
  geom_sf(data = colormap_shp %>% filter(NAME_0 == "India", NAME_1 %in% c("Uttar Pradesh", "Haryana", "NCT of Delhi"), NAME_2 %in% c("Ghaziabad", "Gautam Buddha Nagar", "Muzaffarnagar", "Gurugram", "Panipat", "Faridabad", "NCT of Delhi")), color = "orange") +
   geom_sf(data = bbox_state_of_interest, fill = "NA", color = "red", size = 1.2) +
  theme_map()

 

foo2 <- ggplot() +
  geom_sf(data = india_state %>% filter(NAME_1 %in% c("Uttar Pradesh", "NCT of Delhi", "Haryana")), color = "black", size = 1, fill = "white") +
   geom_sf(data = colormap_shp %>% filter(NAME_0 == "India", NAME_1 %in% c("Uttar Pradesh", "Haryana", "NCT of Delhi"), NAME_2 %in% c("Ghaziabad", "Gautam Buddha Nagar", "Muzaffarnagar", "Gurugram", "Panipat", "Faridabad", "NCT of Delhi")), color = "black", fill = "orange", size = 1.2) +
  ggsflabel::geom_sf_label_repel(data = colormap_shp %>% filter(NAME_0 == "India", NAME_1 %in% c("Uttar Pradesh", "Haryana", "NCT of Delhi"), NAME_2 %in% c("Ghaziabad", "Gautam Buddha Nagar", "Muzaffarnagar", "Gurugram", "Panipat", "Faridabad", "NCT of Delhi")), mapping = aes(label = NAME_2), force = 100, nudge_x = -2, seed = 10, size = 7) +
  theme_map()
 
 
 
 inset_map_wb_with_5_most_pop_non_ncap_districts <- cowplot::ggdraw() +
  draw_plot(foo2) +
  draw_plot(foo1, x = 0, y = 0.1, width = 0.4, height = 0.4)
 
 
```


```{r}

foo <- read_csv("./foo.csv")

foo %>%
  pivot_longer(raasman:safar, names_to = "type", values_to = "pol") %>%
  ggplot() +
  geom_line(mapping = aes(x = Date, y = pol, color = type, size = 0.2))
  

```





























































