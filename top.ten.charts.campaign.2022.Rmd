---
title: "top.ten.charts.campaign"
author: "Aarsh"
date: '2022-07-25'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# get packages, global variables, datasets
```{r load-lib-helper-files-data-global-var}

# libraries
library(readr)
library(dplyr)
library(stringr)
library(magrittr)
library(ggplot2)
library(readr)
library(tidytext)
library(tidyr)
library(tidyverse)
library(sf)
library(usethis)
library(devtools)
library(data.table)

# load and document to keep things updated
devtools::load_all()
devtools::document()

# read in latest color file
color_2020 <- read_csv("./june.2022/master.dataset/color_2020.csv")

# read in old available color datasets
color_2019 <- read_csv("./june.2022/master.dataset/color_2019.csv")
color_2016 <- read_csv("./june.2022/master.dataset/color_2016.csv")

# GBD final results file (resulting file that we get after applying the steps in the GBD technical appendix)
gbd_results <- read_csv("./june.2022/other.important.calculations.data/estimated_life_expectancy_differences_master_table_final.csv")

# global variables
who_guideline <- 5
le_constant <- 0.098
ncap_midpoint <- 25
nat_stan_india <- 40

# global operations
`%notin%` <- Negate(`%in%`)


```


# Chart #10: Year over Year Change in PM2.5 Levels in 2020, the first year of the Pandemic

```{r chart#10}

# Prepare  data set for chart number 10
chart10_dataset <- color_2020 %>%
  group_by(country) %>%
  mutate(pop_weights = population/sum(population, na.rm =TRUE), 
         pm2019_pop_weighted = pop_weights*pm2019,
         pm2020_pop_weighted = pop_weights*pm2020) %>%
  summarise(avg_pm2.5_pop_weighted_2019 = sum(pm2019_pop_weighted, na.rm = TRUE), 
            avg_pm2.5_pop_weighted_2020 = sum(pm2020_pop_weighted, na.rm = TRUE),
            change_pm2.5_2019_to_2020 = avg_pm2.5_pop_weighted_2020 - avg_pm2.5_pop_weighted_2019,
            percent_change_pm2.5_2019_to_2020 = (change_pm2.5_2019_to_2020/avg_pm2.5_pop_weighted_2019)*100,
            total_population = sum(population, na.rm = TRUE)) %>%
  mutate(direction_label = ifelse(change_pm2.5_2019_to_2020 < 0, "Negative", "Positive")) %>%
  slice_max(total_population, n = 20) 

# Save AR chart number 10 dataset as a csv
chart10_dataset %>% 
  write_csv("./june.2022/top.ten.charts.campaign/chart10.data.graph/chart10_dataset.csv")

# Plot chart number 10
chart10 <- chart10_dataset %>%  
  ggplot(mapping = aes(x = fct_reorder(country, percent_change_pm2.5_2019_to_2020), y = percent_change_pm2.5_2019_to_2020, fill = direction_label)) + geom_bar(stat = "identity") +
  geom_hline(mapping = aes(yintercept = 0)) +
  scale_y_continuous(limits = c(-25, 25), breaks = seq(-25, 25, 5)) +
  labs(x = "country", y = "Year over Year change in PM2.5 (%)")+
  ggthemes::theme_clean() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5), legend.position = "none") 


# Save chart number 10
ggsave("./june.2022/top.ten.charts.campaign/chart10.data.graph/chart10.png", chart10)
```


# Chart #9: Life Expectancy Impacts of Particulate Pollution and Other Health Threats in the Four Most Populous Countries in Central and West Africa

```{r chart#9}

# GBD results filtered for relevant cause of death and countries 
chart9_dataset <- gbd_results %>%
  filter(cause_of_death %in% c("PM2.5 relative to WHO",
                               "Malaria", "Unsafe water, sanitation, and handwashing", 
                               "HIV/AIDS"), location %in% c("nigeria", "democratic republic of the congo", "Angola", "ghana", "cameroon"))

# making the 'location' column of type factor
chart9_dataset$location <- factor(chart9_dataset$location, 
                                        levels = c("nigeria", "democratic republic of the congo", "Angola", "ghana", "cameroon"))

# Rename Democratic Republic of the Congo to DRC
chart9_dataset$location <-  str_replace(chart9_dataset$location, 
            "democratic republic of the congo", "DRC")

# Converting 'cause_of_death' to type factor
chart9_dataset$cause_of_death <- as.factor(chart9_dataset$cause_of_death)

# Rearranging 'cause of death' levels
levels(chart9_dataset$cause_of_death) <- c("HIV/AIDS", "Malaria", "PM2.5 relative to WHO", "Unsafe Water, Sanitation and Handwashing")

# wrapping x-axis labels text 
levels(chart9_dataset$cause_of_death) <- str_wrap(levels(chart9_dataset$cause_of_death), 15)

# getting country wise population
country_wise_population <- color_2020 %>%
  group_by(country) %>%
  summarise(population_total = sum(population, na.rm = TRUE)) %>%
  ungroup() %>%
  filter(country %in% c("Cameroon", "Nigeria", "Angola", "Ghana", 
                  "Democratic Republic of the Congo")) %>%
  arrange(desc(population_total))

# reorder within each location as per the total life years lost column
chart9_dataset <- chart9_dataset %>% 
  mutate(cause_of_death = reorder_within(cause_of_death, est_le_diff_vs_actual_aggregate, location))

# clean the "cause of death" column and remove "Angola"
chart9_dataset <- chart9_dataset %>%
  mutate(`Cause of Death` = str_remove(cause_of_death, "___.+")) %>%
  filter(location %notin% "Angola")
  

# plot chart 9 
chart9 <- ggplot(chart9_dataset, mapping = aes(x = cause_of_death, y = est_le_diff_vs_actual_aggregate)) + 
  geom_col(mapping = aes(fill = `Cause of Death`), width = 0.7, color = "white") +
  facet_wrap(~factor(location, levels = c("nigeria", "DRC", "Angola", 
                  "ghana", "cameroon")), scales = "free_x", ncol = 5) +
  scale_fill_manual(values = c("darkcyan", "deepskyblue", "red",
                               "aquamarine")) +
  labs(x = "", y = "Years Lost", title = "Life Expectancy Impacts of PM2.5 & Other Health Threats", 
       subtitle = "Five Most Populous Countries in Central and West Africa") +
  ggthemes::theme_fivethirtyeight() +
  theme(axis.text.x = element_blank(), legend.position = "bottom", axis.ticks = element_blank()) 

# Save chart number 9
ggsave("./june.2022/top.ten.charts.campaign/chart9.data.graph/chart9.png", chart9)


# save chart9 dataset
chart9_dataset %>%
  select(location, cause_of_death, est_le_diff_vs_actual_aggregate) %>%
  rename(life_years_lost = est_le_diff_vs_actual_aggregate) %>%
  mutate(life_years_lost = round(life_years_lost, 1)) %>%
 write_csv("./june.2022/top.ten.charts.campaign/chart9.data.graph/chart9_dataset.csv")

```
# Chart #8: Comparison of Life Expectancy Lost Due to Particulate Pollution Not Meeting the WHO Guideline (Eastern v/s Western Europe)

```{r chart#8}

# make a copy of the color dataset, so as to convert the columns in the new dataset into lower case, specifically for this chart
color_2020_chart8 <- color_2020


# convert character columns to lower case
color_2020_chart8$country <- str_to_lower(color_2020_chart8$country)
color_2020_chart8$name_1 <- str_to_lower(color_2020_chart8$name_1)
color_2020_chart8$name_2 <- str_to_lower(color_2020_chart8$name_2)


# europe countries
europe_countries <- read_csv("./june.2022/other.important.calculations.data/europe_countries.csv")

# europe countries converted to lower case
europe_countries$Country <- str_to_lower(europe_countries$Country)

# replacing south and north macedonia with macedonia 
europe_countries$Country <- str_replace(europe_countries$Country, "(north macedonia)|(south macedonia)", "macedonia")


# filtering color level dataset to only include the european countries.
color_2020_europe_custom <- color_2020_chart8 %>%
  filter(country %in% europe_countries$Country) %>%
  filter(country %notin% c("russia", "turkey", "sweden", "finland", "norway", "kazakhstan", "iceland", "georgia", "azerbaijan", "armenia", "cyprus", "northern cyprus"))

# Western European definition as per chart #8
western_european_countries <- c("Germany", "Switzerland", "Italy", "Monaco", "Luxembourg", 
                                "Belgium", "France", "Netherlands", "Andorra", "Spain", 
                                "United Kingdom", "Portugal", "Denmark", "Ireland", "Iceland", "Austria")

# converting western european countries names to lower case
western_european_countries <- str_to_lower(western_european_countries)

# creating a country level dataset, calculating average PM2.5
color_2020_europe_custom_country_level <- color_2020_europe_custom %>%
  group_by(country) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2020_pop_weighted = pm2020*pop_weights) %>%
  summarise(avg_pm2.5_2020 = round(sum(pm2020_pop_weighted, na.rm = TRUE), 1))


# read in country level shape file (please request this separately from aqli-info@uchicago.edu, this is not present in the Git repository, its a heavy file)
# Note: for all operations in chart #8 post this point, you would need the country shape file, so please request that file in case you'd
# like to proceed.

country_shp <- st_read("./june.2022/other.important.calculations.data/world.country.level.shape.file/color_country.shp")

# renaming shape file columns and selecting only relevant columns
country_shp <- country_shp %>%
  rename(country = NAME_0, 
         name_1 = NAME_1, 
         name_2 = NAME_2) %>%
  select(-c(iso_alpha3, objectid))

# converting shape file country, name_1, name_2 columns to lower case so that they matcht the color file lower case columns
country_shp$country <- str_to_lower(country_shp$country)
country_shp$name_1 <- str_to_lower(country_shp$name_1)
country_shp$name_2 <- str_to_lower(country_shp$name_2)

# 
country_shp_europe_def <- country_shp %>%
  filter(country %in% color_2020_europe_custom_country_level$country)

# filter the shape file to only include those countries that are present in the custom europe color file.

color_2020_europe_custom_final <- color_2020_europe_custom_country_level %>%
  left_join(country_shp_europe_def, by = c("country")) %>%
  st_as_sf()
  
chart8_dataset <- color_2020_europe_custom_final %>%
  mutate(in_western_europe = ifelse(country %in% western_european_countries, "Western Europe", "Eastern Europe")) %>%
  select(country:name_2, in_western_europe, geometry)

# write chart8 shape file
st_write(chart8_dataset, "./june.2022/top.ten.charts.campaign/chart8.data.graph/chart8_dataset.shp")


# chart 8 plot (be careful with the column names in the fill aesthetic, st_read and st_write sometimes abbreviates them)
chart8 <- ggplot(data = foo, mapping = aes(fill = in_western_europe)) +
  geom_sf(color= "black") +
  scale_fill_manual(values = c("darkred", "darkorange")) +
  theme_void() + 
  theme(legend.position = "none") +
  ggtitle("") +
  ggthemes::theme_map() +
  theme(legend.position = "none")

# Save chart number 8
ggsave("./june.2022/top.ten.charts.campaign/chart8.data.graph/chart8.png", chart8)

```

# Chart #7: Average PM2.5 Concentrations in India, 1998 to 2020

```{r chart#7}

# filtering the color dataset for India
color_2020_india <- color_2020 %>%
  filter(country %in% "India")

# North India/Indo Gangetic Plain defintion
north_india <- c("West Bengal", "Uttar Pradesh", "Punjab", "Haryana", 
                 "Chandigarh", "Bihar", "NCT of Delhi")

# adding a north India/rest of india region column (specifically Indo gangetic plain)
color_2020_india <- color_2020_india %>%
  mutate(region = ifelse(name_1 %in% north_india, "North India", "All other regions (excluding North India)"))

# chart #7 region wise (North India/All other regions excluding North India) 1998 to 2020 average PM2.5
chart7_region_wise_data <- color_2020_india %>%
  group_by(region) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2020_weighted, names_to = "years", 
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+")))) %>%
  select(years, region, pop_weighted_avg_pm2.5)

# chart #7 (India National Average) 1998 to 2020 average PM2.5
chart_7_national_avg_1998_2020_tibble <- color_2020_india %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2020_weighted, names_to = "years", 
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+"))), 
         region = "National Average") %>% 
  select(years, region, pop_weighted_avg_pm2.5)

# creating final chart7 dataset by combining the above 2 datasets: region wise and national average datasets
chart7_dataset <- rbind(chart7_region_wise_data, chart_7_national_avg_1998_2020_tibble)

# chart 7 dataset write as csv
chart7_dataset %>%
  write_csv("./june.2022/top.ten.charts.campaign/chart7.data.graph/chart7_dataset.csv")
  
# chart 7 plot
chart7 <- ggplot(chart7_dataset) +
  geom_line(mapping = ggplot2::aes(x = years, y = pop_weighted_avg_pm2.5, color = region), lwd = 1.1) +
    geom_hline(mapping = aes(yintercept = 5), lwd = 0.8) +
  scale_y_continuous(breaks = seq(0, 100, 5), limits = c(0, 100)) +
  scale_x_continuous(breaks = seq(1998, 2020, 2)) +
    scale_color_manual(values = c("National Average" = "darkgrey", "North India" = "darkred", "All other regions (excluding North India)" = "orange")) +
  ggthemes::theme_clean() +
  labs(x = "Years", 
       y = expression(paste("Average PM2.5 concentration ( ", mu, "g", "/", m^3, " )"))) +
  theme(legend.position = "bottom", legend.title = element_blank(), 
        legend.text = element_text(size = 6.5), 
        axis.title.y = element_text(size = 9), 
        axis.title.x = element_text(size = 9)) +
     geom_text(x = 2002.8, y = 10, label = expression(paste("WHO PM2.5 Guideline (last updated: 2021): 5 ", mu, "g","/", m^3, "")))

# save chart7
ggsave("./june.2022/top.ten.charts.campaign/chart7.data.graph/chart7.png", chart7)
 
```

