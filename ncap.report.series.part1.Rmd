---
title: "NCAP report series: Part 1"
author: "Aarsh"
date: '2023-03-03'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# get packages, global variables, datasets
```{r load-lib-helper-files-data-global-var}

# libraries
library(readr)
library(dplyr)
library(stringr)
library(magrittr)
library(ggplot2)
library(readr)
library(tidytext)
library(tidyr)
library(tidyverse)
library(sf)
library(usethis)
library(devtools)
#library(data.table)
library(stringr)
library(forcats) # for reordering bar graphs within a plot
library(cowplot) # for inset plots
library(ggbeeswarm)

# load and document to keep things updated
# devtools::load_all()
# devtools::document()

# read in latest color file
color_2021 <- read_csv("./september.2023/master.dataset/[missingAndNAPopRegionsIncorpButViTcolNameChangesPartiallyIncorp]master_global_allyears_gadm2_non_geom.csv")

# updating the natstandard column (replacing 0's with NAs, corresponding llpp_nat columns already have NAs whereever natstandard is not available)
color_2021 <- color_2021 %>%
  dplyr::mutate(natstandard = ifelse(natstandard == 0, NA, natstandard))

# bringing the colnames back into the format in which our internal dashboard expects it (the above files are in a format in which ViT expects the colnames)
color_2021 <- color_2021 %>%
  dplyr::rename_with(~str_replace(.x, "who", "llpp_who_"), dplyr::contains("who")) %>%
  dplyr::rename_with(~str_replace(.x, "nat", "llpp_nat_"), dplyr::contains("nat")) %>%
  rename(whostandard = llpp_who_standard,
         natstandard = llpp_nat_standard)


#> read in color map shape file for 2021
colormap_shp_2021 <- st_read("./september.2023/master.dataset/shapefiles/master_global_allyears_gadm2_with_geom_Jan192023.shp")

# GBD final results file (resulting file that we get after applying the steps in the GBD technical appendix)
# gbd_results <- read_csv("./june.2022/other.important.calculations.data/estimated_life_expectancy_differences_master_table_final.csv")

# Countries with Ambient Air Quality Standards
# aaqs_places <- read_csv("./june.2022/other.important.calculations.data/countries_list_with_aaqs.csv")
 
# read in "county for aqli pm2.5 dataset" (US technical appendix output file)
# county_for_aqli_pm2.5_dataset <- read_csv("./june.2022/other.important.calculations.data/county_pm25_foraqli_stats.csv")


# investments in NCAP data (not using)
# ncap_budget_tracker <- read_csv("./june.2022/clean.air.countdown.campaign.2023/input/ncap_budget_tracker_data.csv")

# NCAP city, districts, state list 
ncap_regions_list <- read_csv("./september.2023/ncap.report.series.part.1/ncap_cities_district_state_long_updated_March_2023.csv")

# Also loading in the NCAP 102 cities old list that I recently (March, 2023) recompiled to calculate some stats in the report
ncap_102_cities_old_list <- read_csv("./september.2023/ncap.report.series.part.1/ncap_cities_district_state_102_cities_list.csv")


# India city level population data (124 NCAP cities + 7 non-attainment cities) and drop other_info column
ncap_city_level_population_census_2011 <- read_csv("./september.2023/ncap.report.series.part.1/india_city_pop_data_census_wikipedia.csv")

ncap_city_level_population_census_2011 <- ncap_city_level_population_census_2011 %>%
  select(-other_info)

# AQLI district level data classified as Rural/Urban using CSE's classification
# aqli_2020_district_level_rural_urban_subset <- read_csv("./june.2022/clean.air.countdown.india.campaign.2023/input.data.shared.between.graphs/aqli_2020_district_level_rural_urban_subset.csv")

# india state
india_state <- st_read("./june.2022/clean.air.countdown.india.campaign.2023/input.data.shared.between.graphs/india_state.shp")


# global variables
who_guideline <- 5
le_constant <- 0.098

# global operations
`%notin%` <- Negate(`%in%`)

# NCAP target (as of March 05, 2023): 40 percent reduction by 2026 relative to 2017
rel_to_year <- 2017
red_perc <- 40

# India national annual average PM2.5 standard (as in March, 2023)
nat_pm2.5_stan_india <- 40


```


# Create a dataset that contains all AQLI data columns but only for the NCAP districts and then assign the district pollution and life years lost values to the non-attainment cities contained in those districts. Also, replace the 2017 pollution column of the color_2020 dataset

```{r get_data_ready}

# sanity check (check to see how many city names match district names)
sum(ncap_regions_list$city == ncap_regions_list$district, na.rm =TRUE) # 67/124 54.03%

#> some cleaning given the 2021 dataset

# replace the "&" with "and" in Jammu and Kashmir and "Chandigarhs" district state from "Punjab" to "Chandigarh"
ncap_regions_list <- ncap_regions_list %>%
  mutate(state_ut = ifelse(state_ut == "Jammu & Kashmir", "Jammu and Kashmir", state_ut), 
         state_ut = ifelse((state_ut == "Punjab") & (district == "Chandigarh"), "Chandigarh", state_ut))

# create a gadm2 level 2 dataset with only those states that are part of NCAP.
color_2021_ncap_states <- color_2021 %>%
  filter(country == "India", name_1 %in% unique(ncap_regions_list$state_ut)) 

# join the ncap regions data with the states dataset to attach pm and lyl information to all non-attainment cities and do some basic cleaning to get it finalized.
ncap_analysis_dataset <- ncap_regions_list %>%
  left_join(color_2021_ncap_states, by = c("state_ut" = "name_1", "district" = "name_2")) %>%
  select(state_ut, district, city, everything()) %>%
  rename(name_1 = state_ut, name_2 = district) %>%
  select(-c(district_option2, other_1, comments)) %>%
  select(objectid_gadm2, iso_alpha3, country, name_1, name_2, everything()) 

```

# "[NO LONGER IN USE]" Getting city level population data from Census 2011

```{r eval=FALSE, include=FALSE}
census_2011 <- readxl::read_xlsx("./A-1_NO_OF_VILLAGES_TOWNS_HOUSEHOLDS_POPULATION_AND_AREA.xlsx")

# cleaning column names, making them: lowercase, spaces relaced with underscores, brackets removed
colnames(census_2011) <- census_2011[1, ]
colnames(census_2011) <- str_to_lower(colnames(census_2011))
colnames(census_2011) <- str_replace_all(colnames(census_2011), "/", "")
colnames(census_2011) <- str_replace_all(colnames(census_2011), "\\(", "") 
colnames(census_2011) <- str_replace_all(colnames(census_2011), "\\)", "") 
colnames(census_2011) <- str_replace_all(colnames(census_2011), "-", "") 
colnames(census_2011) <- str_replace_all(colnames(census_2011), "\\.", "")
colnames(census_2011) <- str_replace_all(colnames(census_2011),  " ", "_") 


# adding subcolumn names
colnames(census_2011)[7] <- "number_of_villages_inhabited" 
colnames(census_2011)[8] <- "number_of_villages_uninhabited"
colnames(census_2011)[11] <- "population_persons"
colnames(census_2011)[12] <- "population_males"
colnames(census_2011)[13] <- "population_females"
colnames(census_2011)[6] <- "total_rural_urban"
colnames(census_2011)[14] <- "area_in_sq_km"

# removing redundant column names
census_2011 <- census_2011[4:nrow(census_2011), ]
census_2011 <- as_tibble(census_2011)


# census 2011 subset
census_2011_subset <- census_2011 %>%
  filter(india_state_union_territory_district_subdistrict == "SUB-DISTRICT", 
         total_rural_urban == "Total")

# checking how many of ncap analysis dataset city names are available in census 2011 (after converting to lower case)

ncap_df_city_names <- unique(str_to_lower(ncap_analysis_dataset$city))
census_2011_names <- unique(str_to_lower(census_2011$name))
census_2011_subset_names <- unique(str_to_lower(census_2011_subset$name)) 

sum(ncap_df_city_names %in% census_2011_names) # 85
sum(ncap_df_city_names %in% census_2011_subset_names) # 61
```



# "[NO LONGER IN USE]" Getting city level population data from the Wikipedia article that links back to a Census 2011 data table (as the raw data from Census did not have all the NCAP cities population information in it)

```{r eval=FALSE, include=FALSE}

census_2011_wiki <- read_csv("./india_city_pop_data_census_wikipedia.csv")
census_2011_wiki$city <- str_to_lower(census_2011_wiki$city)
# 
# census_2011_wiki_names <- unique(str_to_lower(census_2011_wiki$city))
# 
# indices_city_pop_not_avail <- which(ncap_df_city_names %notin% census_2011_wiki_names)
# city_pop_not_avail_rows <- ncap_analysis_dataset[indices_city_pop_not_avail, ] 
# 
# sum(unique(str_to_lower(city_pop_not_avail_rows$city)) %in% census_2011_subset_names)

# adding a new city pop column after converting city names to lower case
ncap_analysis_dataset$city <- str_to_lower(ncap_analysis_dataset$city)

ncap_analysis_dataset <- ncap_analysis_dataset %>%
  left_join(census_2011_wiki %>% select(city, pop_2011), by = "city")

ncap_analysis_dataset %>%
  select(country, name_1, name_2, city, pop_2011) %>%
  write_csv("city_wise_pop_43_missing.csv")

```










# Reading in the city level population data, compiled partly (~80/131) using the city level Census 2011 population referred to in this article: https://en.wikipedia.org/wiki/List_of_cities_in_India_by_population and the rest using manual Google searches. It happens to be the case that a lot of cities have the same name as their district or tehsil and also the census raw data naming scheme/categorization seemed ambiguous (as in, for a lot of cases we were unsure if the population number refers to the city or the district). This is why, for a chunk of these, instead of cleaning the census 2011 data ourselves, we decided to refer to someone else's cleaned compilation who might have dug in a little bit more into this, compared to us. 

```{r city_level_pop_data}

# convert the city column of the ncap analysis data to lower case (to join with city level population)
ncap_analysis_dataset$city <- str_to_lower(ncap_analysis_dataset$city)

# join ncap analysis data with city level population data, using the city column
final_analysis_dataset <- ncap_analysis_dataset %>%
  left_join(ncap_city_level_population_census_2011, by = c("country", "name_1", "name_2", "city"))

# rename the aqli population column to pop_district and rename the census 2011 pop_2011_city column to  "population"

final_analysis_dataset <- final_analysis_dataset %>%
  rename(population_district = population, 
         population = pop_2011_city)

# convert the city column to title case, reorder columns and the data is ready for plotting.
final_analysis_dataset <- final_analysis_dataset %>%
  mutate(city = str_to_title(city)) %>%
  select(objectid_gadm2:city, population, population_district, everything())

# Replace Nct Of Delhi in final analysis dataset with NCT of Delhi
final_analysis_dataset <- final_analysis_dataset %>%
  mutate(city = ifelse(city == "Nct Of Delhi", "NCT of Delhi", city))

#-------------------------------------

#> getting the old NCAP cities list ready (similar to the above final analysis dataset)
ncap_102_cities_old_list <- ncap_102_cities_old_list %>%
    mutate(state_ut = ifelse(state_ut == "Jammu & Kashmir", "Jammu and Kashmir", state_ut), 
         state_ut = ifelse((state_ut == "Punjab") & (district == "Chandigarh"), "Chandigarh", state_ut)) 

# joiing the 102 cities data with the color file
ncap_102_cities_old_list <- ncap_102_cities_old_list %>%
  left_join(color_2021_ncap_states, by = c("state_ut" = "name_1", "district" = "name_2")) %>%
  select(state_ut, district, city, everything()) %>%
  rename(name_1 = state_ut, name_2 = district) %>%
  select(-c(district_option2, other_1, comments)) %>%
  select(objectid_gadm2, iso_alpha3, country, name_1, name_2, everything()) 

# convert city column to lower case
ncap_102_cities_old_list$city <- str_to_lower(ncap_102_cities_old_list$city)

# add population
final_analysis_dataset_102_cities <- ncap_102_cities_old_list %>%
  left_join(ncap_city_level_population_census_2011, by = c("country", "name_1", "name_2", "city"))

# rename the aqli population column to pop_district and rename the census 2011 pop_2011_city column to  "population"

final_analysis_dataset_102_cities <- final_analysis_dataset_102_cities %>%
  rename(population_district = population, 
         population = pop_2011_city)

# convert the city column to title case, reorder columns and the data is ready for plotting.
final_analysis_dataset_102_cities <- final_analysis_dataset_102_cities %>%
  mutate(city = str_to_title(city)) %>%
  select(objectid_gadm2:city, population, population_district, everything())

# Replace Nct Of Delhi in final analysis dataset with NCT of Delhi
final_analysis_dataset_102_cities <- final_analysis_dataset_102_cities %>%
  mutate(city = ifelse(city == "Nct Of Delhi", "NCT of Delhi", city))

# assign Dera Bassi to Punjab and remove Sangareddy from Telangana (then total count = 102).

final_analysis_dataset_102_cities <- final_analysis_dataset_102_cities %>%
  mutate(name_1 = ifelse(city == "Dera Bassi", "Punjab", name_1)) %>%
  filter(city != "Sangareddy")

# Adding the population for Tuticorin (to both 131 and 102 cities dataset) separately, which apparently is missing
final_analysis_dataset <- final_analysis_dataset %>%
  mutate(population = ifelse((name_1 == "Tamil Nadu" & name_2 == "Thoothukudi" & city == "Tuticorin"), 237830, population))

final_analysis_dataset_102_cities <- final_analysis_dataset_102_cities %>%
  mutate(population = ifelse((name_1 == "Tamil Nadu" & name_2 == "Thoothukudi" & city == "Tuticorin"), 237830, population))



#--------------------------------------
  

```



# Fig 1: PM2.5 concentrations in 10 largest non-attainment cities of India

```{r fig1}

# v1-----------------------------------------------------------------------------------------

# plot 1 data
plot1_data <- final_analysis_dataset %>%
  slice_max(population, n = 10) %>%
  mutate(pm2017_40_perc_red = pm2017*((100 - red_perc)/100)) %>%
  mutate(pm2017_25_perc_red = ifelse(city %in% final_analysis_dataset_102_cities$city, pm2017*0.75, NA)) %>%
  select(country, name_1, name_2, city, population, pm2017, pm2021, pm2017_40_perc_red, pm2017_25_perc_red) %>%
  slice_max(population, n = 10) %>%
  pivot_longer(cols = pm2017:pm2017_25_perc_red, names_to = "pol_type", values_to = "value") %>%
  add_row(country = "", name_1 = "", name_2 = "", 
          city = "India", population = 2, pol_type = "pm2017", value = 53.3) %>%
  add_row(country = "", name_1 = "", name_2 = "", 
          city = "India", population = 2, pol_type = "pm2017_40_perc_red", value = 46.6) %>%
  add_row(country = "", name_1 = "", name_2 = "", 
          city = "India", population = 2, pol_type = "pm2017_25_perc_red", value = 49.1) %>%
    add_row(country = "", name_1 = "", name_2 = "", 
          city = "India", population = 2, pol_type = "pm2021", value = 58.7)




plot1_data_with_empty_rows <- plot1_data %>%
  add_row(country = "", name_1 = "", name_2 = "", 
          city = " ", population = 1, pol_type = "pm2017", value = 0) %>%
  add_row(country = "", name_1 = "", name_2 = "", 
          city = " ", population = 1, pol_type = "pm2017_40_perc_red", value = 0) %>%
    add_row(country = "", name_1 = "", name_2 = "", 
          city = " ", population = 1, pol_type = "pm2017_25_perc_red", value = 0)  %>%
   add_row(country = "", name_1 = "", name_2 = "", 
          city = " ", population = 1, pol_type = "pm2021", value = 0) %>%
  add_row(country = "", name_1 = "", name_2 = "", 
          city = "  ", population = 0, pol_type = "pm2017", value = 0) %>%
  add_row(country = "", name_1 = "", name_2 = "", 
          city = "  ", population = 0, pol_type = "pm2017_40_perc_red", value = 0) %>%
    add_row(country = "", name_1 = "", name_2 = "", 
          city = "  ", population = 0, pol_type = "pm2017_25_perc_red", value = 0) %>%
   add_row(country = "", name_1 = "", name_2 = "", 
          city = " ", population = 0, pol_type = "pm2021", value = 0) 


# plot 1
plt1 <- plot1_data_with_empty_rows %>%
  ggplot() + 
  geom_col(mapping = aes(x = forcats::fct_reorder(city, population, .desc = TRUE), y = value, fill = pol_type), position = "dodge", width = 0.5) +
  geom_hline(mapping = aes(yintercept = who_guideline), color = "black", linetype = "dashed", size = 0.5) +
   geom_hline(mapping = aes(yintercept = nat_pm2.5_stan_india), color = "black", linetype = "dashed", size = 0.5) +
  scale_y_continuous(breaks = seq(0, 130, 20)) +
  labs(x = "City", y = expression("Annual average   " ~ PM[2.5] ~ "(in µg/m³)"), fill = "", 
       title = expression("Reduction in 2017" ~ PM[2.5] ~ "Concentrations in top 10 most populated Non-Attainment cities in India, and India as a whole."), subtitle = "(Comparing reductions under NCAP old and new goals, with status as in 2021)", caption = str_wrap("*Under NCAP's recently updated goals, a 40% reduction (in PM2.5) is targeted by 2026 (relative to 2017 levels). The cities in this graph are the 10 largest by population (2011 Census) of the 131 non-attainment cities singled out by NCAP. The cities are ordered from most populated to least populated and reductions from 2017 level are plotted both for a 25% reduction (under old goals, when only 102 cities were under NCAP) and 40% reduction (under new goals, with 29 newly added cities, taking the count to 131). This is further compared with the latest AQLI 2021 data. In the right end, India level annual average PM2.5 for 2017 is plotted and corresponding bars for 25% reduction (under old goals, 102 cities), 40% reduction (under new goals, 131 cities) and AQLI 2021 India level annual average PM2.5 are also plotted. Since AQLI produces results at the district-level, the statistics shown are for districts containing these cities. The dotted black lines represent the Annual Average PM2.5 guideline both as per WHO and as per India's National Ambient Air Quality Standard (NAAQS). Middle bars for Chennai and Vadodra are missing, because these cities were not part of the old list of original 102 non-attainment cities.", width = 180)) +
  scale_fill_manual(values = c("pm2017" = "#1B2B3A", "pm2017_40_perc_red" = "#808A94", 
                               "pm2017_25_perc_red" = "#495764", "pm2021" = "#D7ECF5"), labels = c("2017", "After 25% reduction under NCAP's old goals", "After 40% reduction under NCAP's new goals", "2021")) +
  guides(colour = guide_legend(override.aes = list(shape = 12))) +
   ggthemes::theme_tufte() +
   theme(axis.text.x = element_text(size = 13),
         axis.text.y = element_text(size = 13),
         axis.title.y = element_text(size = 13, margin = margin(r = 0.3, unit = "cm")),
         axis.title.x = element_text(size = 13, margin = margin(t = 0.3, unit = "cm")),
        legend.position = "bottom", 
        legend.text = element_text(size = 12), 
        plot.subtitle = element_text(size = 11, hjust = 0.5),
        panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
legend.box.margin = margin(b = 2, t = 1, unit="cm"),
plot.title = element_text(hjust = 0.5, size = 17), 
legend.background = element_rect(fill = "white", colour = "black"), 
axis.ticks = element_blank(), 
plot.caption = element_text(hjust = 0, margin = margin(0, 10, 0, 0), face = "italic")) +
  annotate("text", x = 11.5, y = 44.5, label = expression("National" ~ PM[2.5] ~ "Guideline (40 µg/m³)"), hjust = 0, size = 3.5) +
  annotate("text", x = 11.5, y = 9.5, label = expression("WHO" ~ PM[2.5] ~ "Guideline (5 µg/m³)"), hjust = 0, size = 3.5) 



# plot 1 data v2
plot1_data_v2 <- final_analysis_dataset %>%
  slice_max(population, n = 10) %>%
  mutate(pm2017_40_perc_red = pm2017*((100 - red_perc)/100)) %>%
  mutate(pm2017_25_perc_red = ifelse(city %in% final_analysis_dataset_102_cities$city, pm2017*0.75, NA)) %>%
  select(country, name_1, name_2, city, population, pm2017, pm2017_40_perc_red, pm2017_25_perc_red) %>%
  slice_max(population, n = 10) %>%
  pivot_longer(cols = pm2017:pm2017_25_perc_red, names_to = "pol_type", values_to = "value") %>%
  add_row(country = "", name_1 = "", name_2 = "", 
          city = "India", population = 2, pol_type = "pm2017", value = 53.4) %>%
  add_row(country = "", name_1 = "", name_2 = "", 
          city = "India", population = 2, pol_type = "pm2017_40_perc_red", value = 46.6) %>%
  add_row(country = "", name_1 = "", name_2 = "", 
          city = "India", population = 2, pol_type = "pm2017_25_perc_red", value = 49.1) 




plot1_data_with_empty_rows_v2 <- plot1_data_v2 %>%
  add_row(country = "", name_1 = "", name_2 = "", 
          city = " ", population = 1, pol_type = "pm2017", value = 0) %>%
  add_row(country = "", name_1 = "", name_2 = "", 
          city = " ", population = 1, pol_type = "pm2017_40_perc_red", value = 0) %>%
    add_row(country = "", name_1 = "", name_2 = "", 
          city = " ", population = 1, pol_type = "pm2017_25_perc_red", value = 0)  %>%
  add_row(country = "", name_1 = "", name_2 = "", 
          city = "  ", population = 0, pol_type = "pm2017", value = 0) %>%
  add_row(country = "", name_1 = "", name_2 = "", 
          city = "  ", population = 0, pol_type = "pm2017_40_perc_red", value = 0) %>%
    add_row(country = "", name_1 = "", name_2 = "", 
          city = "  ", population = 0, pol_type = "pm2017_25_perc_red", value = 0)


# plot 1 v2
plt1_v2 <- plot1_data_with_empty_rows_v2 %>%
  ggplot() + 
  geom_col(mapping = aes(x = forcats::fct_reorder(city, population, .desc = TRUE), y = value, fill = pol_type), position = "dodge", width = 0.5) +
  geom_hline(mapping = aes(yintercept = who_guideline), color = "black", linetype = "dashed", size = 0.5) +
   geom_hline(mapping = aes(yintercept = nat_pm2.5_stan_india), color = "black", linetype = "dashed", size = 0.5) +
  scale_y_continuous(breaks = seq(0, 130, 20)) +
  labs(x = "City", y = expression("Annual average   " ~ PM[2.5] ~ "(in µg/m³)"), fill = "", 
       title = expression("Reduction in 2017" ~ PM[2.5] ~ "Concentrations in top 10 most populated Non-Attainment cities in India, and India as a whole."), subtitle = "(Comparing reductions under NCAP old and new goals)", caption = str_wrap("*Under NCAP's recently updated goals, a 40% reduction (in PM2.5) is targeted by 2026 (relative to 2017 levels). The cities in this graph are the 10 largest by population (2011 Census) of the 131 non-attainment cities singled out by NCAP. The cities are ordered from most populated to least populated and reductions from 2017 level are plotted both for a 25% reduction (under old goals, when only 102 cities were under NCAP) and 40% reduction (under new goals, with 29 newly added cities, taking the count to 131). In the right end, India level annual average PM2.5 for 2017 is plotted and corresponding bars for 25% reduction (under old goals, 102 cities) and 40% reduction (under new goals, 131 cities) are also plotted. Since AQLI produces results at the district-level, the statistics shown are for districts containing these cities. The dotted black lines represent the Annual Average PM2.5 guideline both as per WHO and as per India's National Ambient Air Quality Standard (NAAQS). Middle bars for Chennai and Vadodra are missing, because these cities were not part of the old list of original 102 non-attainment cities.", width = 180)) +
  scale_fill_manual(values = c("pm2017" = "#1B2B3A", "pm2017_40_perc_red" = "#808A94", 
                               "pm2017_25_perc_red" = "#495764"), labels = c("2017", "After 25% reduction under NCAP's old goals", "After 40% reduction under NCAP's new goals")) +
  guides(colour = guide_legend(override.aes = list(shape = 12))) +
   ggthemes::theme_tufte() +
   theme(axis.text.x = element_text(size = 13),
         axis.text.y = element_text(size = 13),
         axis.title.y = element_text(size = 13, margin = margin(r = 0.3, unit = "cm")),
         axis.title.x = element_text(size = 13, margin = margin(t = 0.3, unit = "cm")),
        legend.position = "bottom", 
        legend.text = element_text(size = 12), 
        plot.subtitle = element_text(size = 11, hjust = 0.5),
        panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"),
legend.box.margin = margin(b = 2, t = 1, unit="cm"),
plot.title = element_text(hjust = 0.5, size = 17), 
legend.background = element_rect(fill = "white", colour = "black"), 
axis.ticks = element_blank(), 
plot.caption = element_text(hjust = 0, margin = margin(0, 10, 0, 0), face = "italic")) +
  annotate("text", x = 11.5, y = 44.5, label = expression("National" ~ PM[2.5] ~ "Guideline (40 µg/m³)"), hjust = 0, size = 3.5) +
  annotate("text", x = 11.5, y = 9.5, label = expression("WHO" ~ PM[2.5] ~ "Guideline (5 µg/m³)"), hjust = 0, size = 3.5) 

```

# Fig 2: Life Expectancy Gain from achieving 40% reduction, under NCAP in 10 largest non-attainment cities of India

```{r fig2}

# plot2 data v1

plot2_data_v1 <- final_analysis_dataset %>%
    slice_max(population, n = 10) %>%
  mutate(pm2017_40_perc = pm2017*((red_perc)/100), 
         pm2017_25_perc = ifelse(city %in% final_analysis_dataset_102_cities$city, pm2017*0.25, NA),
         le_gain_from_40_perc_red = pm2017_40_perc*0.098, 
         le_gain_from_25_perc_red = pm2017_25_perc*0.098) %>%
  select(country, name_1, name_2, city, population, pm2017, pm2017_40_perc, le_gain_from_40_perc_red) %>%
    mutate(lyl_bucket = ifelse((le_gain_from_40_perc_red < 0.1), "0 - 0.1 years", le_gain_from_40_perc_red), 
         lyl_bucket = ifelse((le_gain_from_40_perc_red >= 0.1) & (le_gain_from_40_perc_red < 0.5), "0.1 - < 0.5", lyl_bucket), 
         lyl_bucket = ifelse((le_gain_from_40_perc_red >= 0.5) & (le_gain_from_40_perc_red < 1), "0.5 - < 1", lyl_bucket), 
         lyl_bucket = ifelse((le_gain_from_40_perc_red >= 1) & (le_gain_from_40_perc_red < 2), "1 - < 2", lyl_bucket), 
         lyl_bucket = ifelse((le_gain_from_40_perc_red >= 2) & (le_gain_from_40_perc_red < 3), "2 - < 3", lyl_bucket), 
         lyl_bucket = ifelse((le_gain_from_40_perc_red >= 3) & (le_gain_from_40_perc_red < 4), "3 - < 4", lyl_bucket), 
         lyl_bucket = ifelse((le_gain_from_40_perc_red >= 4), ">= 4 years", lyl_bucket)) 

plot2_data$lyl_bucket <- factor(plot2_data$lyl_bucket, levels = c("1 - < 2", "2 - < 3", ">= 4 years"))

plt2 <- plot2_data_v1 %>%
  ggplot() + 
    geom_col(mapping = aes(x = forcats::fct_reorder(city, population, .desc = TRUE), y = le_gain_from_40_perc_red, ), fill = "darkred", width = 0.5) +
  labs(x = "City", y = "Life Expectancy Gains (in years)", title = expression("Life Expectancy Gains by reducing" ~ PM[2.5] ~ "by 40% relative to 2017"), fill = "Life Years Lost", 
       subtitle = "(Top 10 most populated non-attainment cities in India)", 
       caption = str_wrap("*Under NCAP's recently updated goals, a 40% reduction (in PM2.5) is targeted by 2026 (relative to 2017 levels). The cities in this graph are the 10 largest by population (2011 Census) of the 131 non-attainment cities singled out by NCAP. The cities are ordered from most populated to least populated and life expectancy gains from reductions from 2017 level are plotted both for a 25% reduction (under old goals, when only 102 cities were under NCAP) and 40% reduction (under new goals, with 29 newly added cities, taking the count to 131). In the right end, India level average life expectancy gains are plotted for a 25% reduction (under old goals, 102 cities) and 40% reduction (under new goals. 131 cities). Since AQLI produces results at the district-level, the statistics shown are for districts containing these cities. The dotted black lines represent the Annual Average PM2.5 guideline both as per WHO and as per India's National Ambient Air Quality Standard (NAAQS). Middle bars for Chennai and Vadodra are missing, because these cities were not part of the old list of original 102 non-attainment cities.", width = 70)) +
  ggthemes::theme_hc() +
  theme(axis.text.x = element_text(size = 10),
         axis.text.y = element_text(size = 10),
         axis.title = element_text(size = 12),
        legend.position = "bottom", 
        legend.text = element_text(size = 9), 
        panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), 
plot.title = element_text(hjust = 0.5, size = 14), 
plot.subtitle = element_text(hjust = 0.5, size = 9), 
legend.background = element_rect(fill = "white", colour = "black"),
axis.ticks = element_blank(), 
plot.caption = element_text(hjust = 0, margin = margin(0, 10, 0, 0), face = "italic")) +
  scale_fill_manual(values = c("0 - 0.1 years" = "#FFFFFF", "0.1 - < 0.5" = "#FFE6B3", "0.5 - < 1" = "#FFD25D", 
                                "1 - < 2" = "#FFBA00", "2 - < 3" = "#FF9600", "3 - < 4" = "#FF6908", 
                                ">= 4 years" = "#E63D23")) 

#--------------

# plot2 data v2

plot2_data_v2 <- final_analysis_dataset %>%
    slice_max(population, n = 10) %>%
  mutate(pm2017_40_perc = pm2017*((red_perc)/100), 
         pm2017_25_perc = ifelse(city %in% final_analysis_dataset_102_cities$city, pm2017*0.25, NA),
         le_gain_from_40_perc_red = pm2017_40_perc*0.098, 
         le_gain_from_25_perc_red = pm2017_25_perc*0.098) %>%
  select(country, name_1, name_2, city, population, pm2017_40_perc, pm2017_25_perc, pm2017, le_gain_from_40_perc_red, 
         le_gain_from_25_perc_red) %>%
  pivot_longer(cols = le_gain_from_40_perc_red : le_gain_from_25_perc_red, names_to = "lyl_type", values_to = "value") %>%
  add_row(country = "", name_1 = "", name_2 = "", city = "India", population = 1, pm2017_40_perc = NA, pm2017_25_perc = NA, pm2017 = NA, lyl_type = "le_gain_from_40_perc_red", value = 0.66) %>%
    add_row(country = "", name_1 = "", name_2 = "", city = "India", population = 1, pm2017_40_perc = NA, pm2017_25_perc = NA, pm2017 = NA, lyl_type = "le_gain_from_25_perc_red", value = 0.33)
  

plt2 <- plot2_data_v2 %>%
  ggplot() + 
    geom_col(mapping = aes(x = forcats::fct_reorder(city, population, .desc = TRUE), y = value, fill = lyl_type), position = "dodge", width = 0.5) +
  labs(x = "City", y = "Life Expectancy Gains (in years)", title = expression("Life Expectancy Gains by reducing" ~ PM[2.5] ~ "by 40% (under new NCAP goals) and 25% (under old NCAP goals) relative to 2017"), fill = "Life Years Gained", 
       subtitle = "(Top 10 most populated non-attainment cities in India)", 
       caption = str_wrap("*Under NCAP's recently updated goals, a 40% reduction (in PM2.5) is targeted by 2026 (relative to 2017 levels). The cities in this graph are the 10 largest by population (2011 Census) of the 131 non-attainment cities singled out by NCAP. The cities are ordered from most populated to least populated and life expectancy gains from reductions from 2017 level are plotted both for a 25% reduction (under old goals, when only 102 cities were under NCAP) and 40% reduction (under new goals, with 29 newly added cities, taking the count to 131). In the right end, India level average life expectancy gains are plotted for a 25% reduction (under old goals, 102 cities) and 40% reduction (under new goals, 131 cities). Since AQLI produces results at the district-level, the statistics shown are for districts containing these cities. 25% reduction bars for Chennai and Vadodra are missing, because these cities were not part of the old list of original 102 non-attainment cities.", width = 180)) +
  scale_fill_manual(values = c("le_gain_from_40_perc_red" = "#8C130E", "le_gain_from_25_perc_red" = "#FF6908"), labels = c("Life Expectancy Gain from 25 percent reduction under NCAP old goals", "Life Expectancy Gain from 40 percent reduction under NCAP new goals")) +
  guides(colour = guide_legend(override.aes = list(shape = 12))) +
  ggthemes::theme_tufte() +
  theme(axis.text.x = element_text(size = 13),
         axis.text.y = element_text(size = 13),
         axis.title.x = element_text(size = 14, margin = margin(t = 0.5, b = 0.5, unit = "cm")),
        axis.title.y = element_text(size = 14, margin = margin(r = 0.5, unit = "cm")),
        legend.box.background = element_rect(colour = "black"),
        legend.position = "bottom", 
        legend.text = element_text(size = 11),
        legend.title = element_text(size = 12),
        panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), 
plot.title = element_text(hjust = 0.5, size = 14), 
plot.subtitle = element_text(hjust = 0.5, size = 10),
axis.ticks = element_blank(), 
plot.caption = element_text(hjust = 0, margin = margin(1.5, unit = "cm"), face = "italic")) 
  
```


# Figure 3, Map: Change in PM2.5 from achieving the 40% reduction target under NCAP

```{r fig3}

# separately getting Gilgit Baltistan and Azad Kashmir
azad_kashmir_gilgit_baltistan <- color_2021 %>%
  filter(country == "Pakistan", name_1 %in% c("Azad Kashmir", "Gilgit Baltistan"))

# plot 3 data
plot3_data <- color_2021 %>%
  filter(country == "India") %>%
  bind_rows(azad_kashmir_gilgit_baltistan) %>%
  mutate(pm2017_40_perc_red = pm2017*((100 - red_perc)/100), 
         pm2017_40_perc = -(pm2017*(red_perc/100))) %>%
  left_join(colormap_shp_2021, by = c("objectid_gadm2" = "objidgadm2")) %>%
  mutate(pol_bucket = ifelse(((pm2017_40_perc > -5) & (pm2017_40_perc <= 0)), ">(-5) to 0", pm2017_40_perc), 
         pol_bucket = ifelse(((pm2017_40_perc > -10) & (pm2017_40_perc <= -5)), ">(-10) to -5", pol_bucket), 
         pol_bucket = ifelse(((pm2017_40_perc > -15) & (pm2017_40_perc <= -10)), ">(-15) to -10", pol_bucket), 
           pol_bucket = ifelse(((pm2017_40_perc > -30) & (pm2017_40_perc <= -15)), ">(-30) to -15", pol_bucket), 
           pol_bucket = ifelse(((pm2017_40_perc > -40) & (pm2017_40_perc <= -30)), ">(-40) to -30", pol_bucket), 
         pol_bucket = ifelse(((pm2017_40_perc > -50) & (pm2017_40_perc <= -40)), ">(-50) to -40", pol_bucket)) %>%
  mutate(pol_bucket_order = ifelse(pol_bucket == ">(-5) to 0", 1, 0), 
         pol_bucket_order = ifelse(pol_bucket == ">(-10) to -5", 2, pol_bucket_order), 
         pol_bucket_order = ifelse(pol_bucket == ">(-15) to -10", 3, pol_bucket_order), 
         pol_bucket_order = ifelse(pol_bucket == ">(-30) to -15", 4, pol_bucket_order), 
         pol_bucket_order = ifelse(pol_bucket == ">(-40) to -30", 5, pol_bucket_order), 
         pol_bucket_order = ifelse(pol_bucket == ">(-50) to -40", 5, pol_bucket_order)) %>%
  select(-geometry, geometry) %>%
  st_as_sf()

# plot 3  
plt3 <- plot3_data %>%
  ggplot() +
  rm(geom_sf(mapping = aes(fill = forcats::fct_reorder(pol_bucket, pol_bucket_order)), color = "transparent") +
  geom_sf(data = india_state, color = "black", fill = "transparent", lwd = 0.7) +
  geom_sf(data = plot3_data %>% filter(name_2 %in% final_analysis_dataset$name_2), color = "black", fill = "transparent", lwd = 0.1) +
  ggthemes::theme_map() + 
  scale_fill_manual(values = c(">(-5) to 0" = "#CBE8F3", ">(-10) to -5" = "#B4CDD9", ">(-15) to -10" = "#8FA1AD", ">(-30) to -15" = "#707F8C", ">(-40) to -30" = "#576572", ">(-50) to -40" = "#414F5D")) +
  theme(legend.position = "bottom", 
        legend.justification = c(0.5, 3), 
        legend.background = element_rect(color = "black"), 
        legend.text = element_text(size = 12), 
        legend.title = element_text(size = 15), 
        plot.subtitle = element_text(hjust = 0.5, size = 7),
        plot.title = element_text(hjust = 0.5, size = 20), 
        legend.box.margin = margin(b = 1, unit = "cm"),
        plot.caption = element_text(hjust = 0.5, size = 9, face = "italic")) +
  labs(fill = expression("Reduction in" ~ PM[2.5] ~ "(µg/m³)"), 
       title = expression("Change in" ~ PM[2.5] ~ "from achieving 40%" ~ PM[2.5] ~ "reduction target under NCAP's new goals"), caption = "*All districts containing atleast 1 of the 131 NCAP non-attainment cities are highlighted within each state (thin black borders). The state borders are relatively thicker, compared to district borders.") +
  guides(fill = guide_legend(nrow = 1))
  
  
  




```


# Figure 4, Map: Life Expectancy Gain from achieving the 40% reduction target under NCAP

```{r}

# plot 4 data
plot4_data <- color_2021 %>%
  filter(country == "India") %>%
  bind_rows(azad_kashmir_gilgit_baltistan) %>%
  mutate(pm2017_40_perc = (pm2017*(red_perc/100)),
         le_gain_pm2017_40_perc_red = pm2017_40_perc*0.098) %>%
  left_join(colormap_shp_2021, by = c("objectid_gadm2" = "objidgadm2")) %>%
  mutate(lyl_bucket = ifelse((le_gain_pm2017_40_perc_red < 0.1), "0 - 0.1 years", le_gain_pm2017_40_perc_red), 
         lyl_bucket = ifelse((le_gain_pm2017_40_perc_red >= 0.1) & (le_gain_pm2017_40_perc_red < 0.5), "0.1 - < 0.5", lyl_bucket), 
         lyl_bucket = ifelse((le_gain_pm2017_40_perc_red >= 0.5) & (le_gain_pm2017_40_perc_red < 1), "0.5 - < 1", lyl_bucket), 
         lyl_bucket = ifelse((le_gain_pm2017_40_perc_red >= 1) & (le_gain_pm2017_40_perc_red < 2), "1 - < 2", lyl_bucket), 
         lyl_bucket = ifelse((le_gain_pm2017_40_perc_red >= 2) & (le_gain_pm2017_40_perc_red < 3), "2 - < 3", lyl_bucket), 
         lyl_bucket = ifelse((le_gain_pm2017_40_perc_red >= 3) & (le_gain_pm2017_40_perc_red < 4), "3 - < 4", lyl_bucket), 
         lyl_bucket = ifelse((le_gain_pm2017_40_perc_red >= 4), ">= 4 years", lyl_bucket)) %>%
  mutate(lyl_bucket_order = ifelse(lyl_bucket == "0 - 0.1 years", 1, 0), 
         lyl_bucket_order = ifelse(lyl_bucket == "0.1 - < 0.5", 2, lyl_bucket_order), 
         lyl_bucket_order = ifelse(lyl_bucket == "0.5 - < 1", 3, lyl_bucket_order), 
         lyl_bucket_order = ifelse(lyl_bucket == "1 - < 2", 4, lyl_bucket_order), 
         lyl_bucket_order = ifelse(lyl_bucket == "2 - < 3", 5, lyl_bucket_order), 
         lyl_bucket_order = ifelse(lyl_bucket == "3 - < 4", 6, lyl_bucket_order), 
         lyl_bucket_order = ifelse(lyl_bucket == ">= 4 years", 7, lyl_bucket_order)) %>%
  select(-geometry, geometry) %>%
  st_as_sf()

# plot 4
plt4 <- plot4_data %>%
  ggplot() +
  geom_sf(mapping = aes(fill = forcats::fct_reorder(lyl_bucket, lyl_bucket_order)), color = "transparent") +
    geom_sf(data = india_state, color = "black", fill = "transparent", lwd = 0.7) +
 geom_sf(data = plot3_data %>% filter(name_2 %in% final_analysis_dataset$name_2), color = "black", fill = "transparent", lwd = 0.1) +
  ggthemes::theme_map() + 
scale_fill_manual(values = c("0 - 0.1 years" = "#FFFFFF", "0.1 - < 0.5" = "#FFE6B3", "0.5 - < 1" = "#FFD25D", 
                                "1 - < 2" = "#FFBA00", "2 - < 3" = "#FF9600", "3 - < 4" = "#FF6908", 
                                ">= 4 years" = "#E63D23")) +
  labs(fill = str_wrap("Gain in Life Expectancy (in years)", 10), 
       title = expression("Life Expectancy Gains from Achieving 40%" ~ PM[2.5] ~ "reduction target under NCAP's new goals"), 
caption = "*All districts containing atleast 1 NCAP non-attainment city are highlighted within each state (thin black borders). The state borders are relatively thicker, comapared to the district borders.") +
  guides(fill = guide_legend(nrow = 1)) +
    theme(legend.position = "bottom", 
        legend.justification = c(0.5, 3), 
        legend.background = element_rect(color = "black"), 
        legend.text = element_text(size = 14), 
        legend.title = element_text(size = 15), 
        plot.title = element_text(hjust = 0.5, size = 20), 
       # legend.key = element_rect(color = "black"),
       legend.box.margin = margin(b = 1, unit = "cm"),
        plot.subtitle = element_text(hjust = 0.5, size = 7), 
        plot.caption = element_text(hjust = 0.7, size = 9, face = "italic")) 


```


# Generating the appendix table for NCAP report part 1

```{r appendix_table}

# ncap analysis data
appendix_table <- final_analysis_dataset %>%
  select(-population_district) %>%
  mutate( pm2017 = round(pm2017, 1),
    pm2017_red_40_perc = round(pm2017*((100 - red_perc)/100), 1), 
         pm2017_40_perc = pm2017*(red_perc/100), 
         le_gain_pm2017_40_perc_red = pm2017_40_perc * le_constant, 
         le_gain_pm2017_40_perc_red = round(le_gain_pm2017_40_perc_red, 1)) %>%
  select(city, name_1, population, pm2017, pm2017_red_40_perc, le_gain_pm2017_40_perc_red) %>%
  rename(City = city, State = name_1, `City (Census 2011) Population` = population, `2017 PM2.5 Concentrations (µg/m³)` = pm2017, `2017 PM2.5 Concentrations (after 40% reduction)` = pm2017_red_40_perc, `Life Expectancy Gains (in years) from a 40% reduction` = le_gain_pm2017_40_perc_red) %>%
  mutate(City = ifelse(City %notin% final_analysis_dataset_102_cities$city, str_c("*", City), City)) %>%
  arrange(desc(`City (Census 2011) Population`))

appendix_table %>% 
  write_csv("./september.2023/ncap.report.series.part.1/output_files/[updated_April252023]ncap.2023.report.part1.appendix_table.csv")

```

# other calculations

```{r other_calculations}

#> gains in life years that an average Indian would experience if the NCAP 40 percent reduction target by 2026 (relative to 2017)
#>
red_perc <- 40

# calculate india average pollution in 2017 and then take 40% of it to calculate the life years lost for that reduction
foo <- final_analysis_dataset %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2017_pop_weighted = pm2017*pop_weights, 
         pm2021_pop_weighted = pm2021*pop_weights) %>%
  summarise(avg_pm2017_pop = sum(pm2017_pop_weighted, na.rm = TRUE), 
            avg_pm2021_pop = sum(pm2021_pop_weighted, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(avg_pm2017_pop_40_perc = ((red_perc/100)*(avg_pm2017_pop)), 
         lyg_40_perc_red = round((avg_pm2017_pop_40_perc*le_constant), 1))

#> average gains in life expectancy by reducing pollution in top 5 most polluted non-attainment cities

# top 5 most polluted non-attainment cities 
top_5_most_pol_non_att_cities <- final_analysis_dataset %>%
  slice_max(pm2017, n = 5) %>%
  pull(city) 

final_analysis_dataset %>%
  filter(city %in% top_5_most_pol_non_att_cities) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2017_pop_weighted = pop_weights*pm2017) %>%
  summarise(avg_pm2017_pop = sum(pm2017_pop_weighted, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(avg_pm2017_pop_40_perc = ((red_perc/100)*(avg_pm2017_pop)), 
         lyg_40_perc_red = round(avg_pm2017_pop_40_perc*le_constant, 1))

#> India's average PM2.5 percentage increase since 1998
color_2021 %>%
  filter(country == "India") %>%
  group_by(country) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2017_pop_weighted = pop_weights*pm2017, 
         pm1998_pop_weighted = pop_weights*pm1998) %>%
    summarise(avg_pm2017_pop = sum(pm2017_pop_weighted, na.rm = TRUE), 
              avg_pm1998_pop = sum(pm1998_pop_weighted, na.rm = TRUE)) %>%
    ungroup() %>%
  mutate(perc_inc_1998_2017 = (((avg_pm2017_pop - avg_pm1998_pop)/avg_pm1998_pop)*100))

#> Delhi's annual average PM2.5 value in 2017 and how many life years are lost by not being compliant with WHO and National PM2.5 standard

color_2021 %>%
  filter(country == "India", name_1 == "NCT of Delhi", name_2 == "NCT of Delhi") %>%
  select(pm2017) %>%
  mutate(lyl_rel_who = (pm2017 - who_guideline)*0.098, 
         lyl_rel_nat = (pm2017 - 40)*0.098)
  
#> country ranking in pollution given 2020 data

color_2021 %>%
  group_by(country) %>%
   mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2020_pop_weighted = pop_weights*pm2020, 
         pm1998_pop_weighted = pop_weights*pm1998) %>%
  summarise(avg_pm2020_pop = sum(pm2020_pop_weighted, na.rm = TRUE), 
            avg_pm1998_pop = sum(pm1998_pop_weighted, na.rm = TRUE)) %>%
  slice_max(avg_pm2020_pop, n = 10)
  

# India's average pollution increase from 1998 to 2020
color_2021 %>%
  filter(country == "India") %>%
  group_by(country) %>%
   mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2020_pop_weighted = pop_weights*pm2020, 
         pm1998_pop_weighted = pop_weights*pm1998) %>%
  summarise(avg_pm2020_pop = sum(pm2020_pop_weighted, na.rm = TRUE), 
            avg_pm1998_pop = sum(pm1998_pop_weighted, na.rm = TRUE))

# Top 5 most polluted states in ncap

final_analysis_dataset %>%
  slice_max(pm2017, n = 15) %>%
  pull(name_1) %>%
  unique()

# state level pm2.5
final_analysis_dataset %>%
  group_by(country, name_1) %>%
   mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2020_pop_weighted = pop_weights*pm2020, 
         pm1998_pop_weighted = pop_weights*pm1998, 
         pm2017_pop_weighted = pop_weights*pm2017) %>%
  summarise(avg_pm2020_pop = sum(pm2020_pop_weighted, na.rm = TRUE), 
            avg_pm1998_pop = sum(pm1998_pop_weighted, na.rm = TRUE), 
            avg_pm2017_pol = sum(pm2017_pop_weighted, na.rm = TRUE)) %>%
  ungroup() %>%
  filter(name_1 %in% c("NCT of Delhi", "Uttar Pradesh", "Bihar", "Haryana")) %>%
  mutate(times = avg_pm2020_pop/avg_pm1998_pop)
  
# top most polluted districts in 2020
final_analysis_dataset %>%
  slice_max(pm2020) %>%
  pull(pm2020)

# total population of all NCAP cities
sum(final_analysis_dataset$population, na.rm = TRUE)/1210854977

#> assuming that each of the district's (that include the NCAP cities) 2017 pollution is reduced by 40 percent and then recalculating India's pollution average.

ncap_districts <- final_analysis_dataset %>%
  count(country, name_1, name_2) 


# india's pollution average without any reductions in 2017. # 53.34 micrograms per cubic meter in 2017
foo <- color_2021 %>%
  filter(country == "India") %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2017_pop_weighted = pop_weights*pm2017, 
         pm1998_pop_weighted = pop_weights*pm1998) %>%
  summarise(avg_pm2017_pop = sum(pm2017_pop_weighted, na.rm = TRUE), 
            avg_pm1998_pop = sum(pm1998_pop_weighted, na.rm = TRUE))

# india's pollution average with 40% reduction in each of NCAP's district (as a proxy for 40% reduction in each of 131 ncap cities). # 46.56 micrograms per cubic meter in 2017 if reduction is achieved. 46.56434

foo1 <- color_2021 %>%
  filter(country == "India") %>%
  mutate(pm2017_red = ifelse((name_1 %in% ncap_districts$name_1) & (name_2 %in% ncap_districts$name_2), pm2017*0.75, pm2017)) %>%
    mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2017_pop_weighted_red = pop_weights*pm2017_red, 
         pm1998_pop_weighted = pop_weights*pm1998) %>%
  summarise(avg_pm2017_pop_red = sum(pm2017_pop_weighted_red, na.rm = TRUE), 
            avg_pm1998_pop = sum(pm1998_pop_weighted, na.rm = TRUE))


########################### doing what's done in the above chunk, but with 102 cities

ncap_districts_old <- final_analysis_dataset_102_cities %>%
  count(country, name_1, name_2) 


# india's pollution average without any reductions in 2017. # 53.34 micrograms per cubic meter in 2017
foo <- color_2021 %>%
  filter(country == "India") %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2017_pop_weighted = pop_weights*pm2017, 
         pm1998_pop_weighted = pop_weights*pm1998) %>%
  summarise(avg_pm2017_pop = sum(pm2017_pop_weighted, na.rm = TRUE), 
            avg_pm1998_pop = sum(pm1998_pop_weighted, na.rm = TRUE))

# india's pollution average with 40% reduction in each of NCAP's district (as a proxy for 40% reduction in each of 131 ncap cities). # 46.56 micrograms per cubic meter in 2017 if reduction is achieved. 46.56434

foo1 <- color_2021 %>%
  filter(country == "India") %>%
  mutate(pm2017_red = ifelse((name_1 %in% ncap_districts_old$name_1) & (name_2 %in% ncap_districts_old$name_2), pm2017*0.75, pm2017)) %>%
    mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2017_pop_weighted_red = pop_weights*pm2017_red, 
         pm1998_pop_weighted = pop_weights*pm1998) %>%
  summarise(avg_pm2017_pop_red = sum(pm2017_pop_weighted_red, na.rm = TRUE), 
            avg_pm1998_pop = sum(pm1998_pop_weighted, na.rm = TRUE))









###########################

# Range of gains as a result of reduction in pm2.5 by 40 percent
final_analysis_dataset %>%
  mutate(pm2017_40_perc = pm2017 * 0.4, 
         lyg_40_perc = pm2017_40_perc*0.098) %>%
  group_by(country, name_1) %>%
  summarise(min_lyg = min(lyg_40_perc, na.rm = TRUE), 
            max_lyg = max(lyg_40_perc, na.rm = TRUE)) %>% 
  slice_max(max_lyg, n = 10)

# india average pollution in 2020
foo <- color_2021 %>%
  filter(country == "India") %>%
   mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2020_pop_weighted = pop_weights*pm2020, 
         pm1998_pop_weighted = pop_weights*pm1998) %>%
  summarise(avg_pm2020_pop = sum(pm2020_pop_weighted, na.rm = TRUE), 
            avg_pm1998_pop = sum(pm1998_pop_weighted, na.rm = TRUE))

# life expectancy gains for an average Indian if NCAP meets the old 25% reduction target (49.1 micrograms per cubic meter v/s 53.4 micrograms per cubic meter)

foo1 <- color_2021 %>%
  filter(country == "India") %>%
   mutate(pm2017 = ifelse((name_1 %in% unique(final_analysis_dataset$name_1)) & (name_2 %in% unique(final_analysis_dataset$name_2)), pm2017*0.60, pm2017)) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2017_pop_weighted = pm2017*pop_weights) %>%
  summarise(avg_pm2.5_2017_40_perc_red = sum(pm2017_pop_weighted, na.rm = TRUE))


# average pollution percentage reduction in 131 NCAP cities
foo <- final_analysis_dataset %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2017_pop_weighted = pm2017*pop_weights, 
         pm2019_pop_weighted = pm2019*pop_weights,
         pm2020_pop_weighted = pm2020*pop_weights) %>%
  summarise(avg_pm2.5_2017 = sum(pm2017_pop_weighted, na.rm = TRUE), 
            avg_pm2.5_2020 = sum(pm2020_pop_weighted, na.rm = TRUE), 
            avg_pm2.5_2019 = sum(pm2019_pop_weighted, na.rm = TRUE))

# NCAP cities annual average PM2.5 in 2017
foo <- final_analysis_dataset %>%
 mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2017_pop_weighted = pm2017*pop_weights, 
        pm2021_pop_weighted = pm2021*pop_weights) %>%
  summarise(avg_pm2.5_2017 = sum(pm2017_pop_weighted, na.rm = TRUE), 
            avg_pm2.5_2021 = sum(pm2021_pop_weighted, na.rm = TRUE))

# city count by state
foo <- final_analysis_dataset %>%
  count(name_1)
  

foo <- color_2021 %>% group_by(country) %>% 
  mutate(pop_weights = population/sum(population, na.rm = TRUE), pop_weighted_pm2.5_2021 = pop_weights*pm2021, pop_weighted_pm2.5_2017 = pop_weights*pm2017, pop_weighted_pm2.5_1998 = pop_weights*pm1998) %>% 
  summarise(avg_pm2.5_2021 = sum(pop_weighted_pm2.5_2021, na.rm = TRUE), avg_pm2.5_2017 = sum(pop_weighted_pm2.5_2017, na.rm = TRUE), avg_pm2.5_1998 = sum(pop_weighted_pm2.5_1998, na.rm = TRUE))




#> state level summary of the final analysis dataset
foo <- final_analysis_dataset %>%
  group_by(name_1) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2017_pop_weighted = pm2017*pop_weights) %>%
  summarise(avg_pm2.5_2017 = sum(pm2017_pop_weighted, na.rm = TRUE), 
            lyg_40_perc_red = round(avg_pm2.5_2017*0.4*0.098, 1))


# old 102 cities list average 2017 pollution and gains by a 25% reduction target, i.e. the old target
foo <- ncap_102_cities_old_list %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2017_pop_weighted = pm2017*pop_weights, 
         pm2019_pop_weighted = pm2019*pop_weights,
         pm2020_pop_weighted = pm2020*pop_weights) %>%
  summarise(avg_pm2.5_2017 = sum(pm2017_pop_weighted, na.rm = TRUE), 
            avg_pm2.5_2020 = sum(pm2020_pop_weighted, na.rm = TRUE), 
            avg_pm2.5_2019 = sum(pm2019_pop_weighted, na.rm = TRUE))

# How much an average person living in the NCAP cities stands to gain on average if NCAP target are met.
foo <- final_analysis_dataset %>%
   mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2017_pop_weighted = pm2017*pop_weights, 
         pm2019_pop_weighted = pm2019*pop_weights,
         pm2020_pop_weighted = pm2020*pop_weights) %>%
  summarise(avg_pm2.5_2017 = sum(pm2017_pop_weighted, na.rm = TRUE), 
            avg_pm2.5_2020 = sum(pm2020_pop_weighted, na.rm = TRUE), 
            avg_pm2.5_2019 = sum(pm2019_pop_weighted, na.rm = TRUE))

  
  
### current dataset (131 city focus stats)

foo <- final_analysis_dataset %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2017_pop_weighted = pm2017*pop_weights) %>%
  summarise(avg_pm2.5_2017_40_perc_red = sum(pm2017_pop_weighted, na.rm = TRUE))


foo1 <- final_analysis_dataset %>%
  mutate(pm2017 = pm2017*0.75) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2017_pop_weighted = pm2017*pop_weights) %>%
  summarise(avg_pm2.5_2017_40_perc_red = sum(pm2017_pop_weighted, na.rm = TRUE))


### old dataset (131 city focus stats)

foo <- final_analysis_dataset_102_cities %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2017_pop_weighted = pm2017*pop_weights) %>%
  summarise(avg_pm2.5_2017_40_perc_red = sum(pm2017_pop_weighted, na.rm = TRUE))


foo1 <- final_analysis_dataset_102_cities %>%
  mutate(pm2017 = pm2017*0.75) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2017_pop_weighted = pm2017*pop_weights) %>%
  summarise(avg_pm2.5_2017_40_perc_red = sum(pm2017_pop_weighted, na.rm = TRUE))

###########------------------

#> hex plot

# hex plot data
hex_plt_data <- final_analysis_dataset %>%
  mutate(pm2017_40_perc_red = pm2017*0.6) %>%
  select(country, name_1, name_2, population, pm2017, pm2017_40_perc_red) %>%
  pivot_longer(pm2017:pm2017_40_perc_red, values_to = "pollution_value", names_to = "pol_type") %>%
  mutate(pol_type = ifelse(pol_type == "pm2017", "2017 PM2.5", "40% reduction in 2017 PM2.5"))

# hex plot: plot
hex_plot <- hex_plt_data %>%
  ggplot() +
  geom_hex(mapping = aes(x = population, y = pollution_value), color = "white", alpha = 0.7) +
  theme_bw() +
  scale_x_log10() + 
  viridis::scale_fill_viridis(option = "viridis", direction = -1) + 
geom_hline(mapping = aes(yintercept = 40)) +
  # geom_hline(mapping = aes(yintercept = 5)) +
  geom_vline(mapping = aes(xintercept = 50000)) + 
  scale_y_continuous(breaks = seq(0, 120, 10)) +
  facet_wrap(~pol_type) +
  labs(x = "Population", y = "PM2.5 pollution (in µg/m³)", 
       fill = "City Count", 
       title = "Population v/s Pollution in 131 non-attainment cities",
       subtitle = "(2017 PM2.5 levels v/s if NCAP targets are met)") +
  theme(legend.title.align = 0.5, 
        plot.title = element_text(hjust = 0.5), 
        plot.subtitle = element_text(size = 8, hjust = 0.5)) 


#> creating a heatmap snapshot of the 131 non-attainment cities--------

# snapshot heatmap data
snapshot_map_data <- final_analysis_dataset %>%
  select(country, name_1, name_2, population, city, starts_with("pm")) %>%
  pivot_longer(cols = pm1998:pm2021, names_to = "years", 
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+"))), 
         region = "City Average") 

# cities to plot in the snapshot heatmap
city_to_plot <- final_analysis_dataset %>%
  slice_max(pm2020, n = 10) %>%
  pull(city) 

# snapshot heatmap
snapshot_heatmap <- snapshot_map_data %>%
 filter(city %in% city_to_plot, years <= 2017) %>%
  ggplot() +
  geom_raster(mapping = aes(x = years, y = forcats::fct_reorder(city, pop_weighted_avg_pm2.5), fill = pop_weighted_avg_pm2.5), color = "black", size = 2) +
  scale_fill_viridis_b(option = "rocket", direction = -1) +
  scale_x_continuous(breaks = seq(1998, 2017, 2)) +
  labs(x = "Years", y = "City", 
       title = "PM2.5 pollution from 1998 to 2017 (NCAP baseline)", 
       subtitle = "(Cities in which PM2.5 pollution was above the national standard in 2017)", 
       fill = "PM2.5 (in µg/m³)") +
  theme(plot.title = element_text(hjust = 0.5, size = 12), 
        plot.subtitle = element_text(hjust = 0.5, size = 8))
  

#> creating a beeswarm plot------------------------------------------------------

snapshot_map_data$years <- as.character(snapshot_map_data$years)

snapshot_map_data <- snapshot_map_data %>%
  add_row(country = "", name_1 = "", name_2 = "", population = 0, city = "", years = NA, pop_weighted_avg_pm2.5 = 0, region = "")

years_vec <- c(1998, 2009, 2017, 2019, 2020, 2021, NA)

plt <- snapshot_map_data %>%
  mutate(years = as.factor(years), 
         population_lakhs = round(population/100000, 1)) %>%
  filter(years %in% years_vec) %>%
  ggplot(mapping = aes(x = years, y = pop_weighted_avg_pm2.5, color = years)) +
  geom_beeswarm(mapping = aes(size = population_lakhs)) +
   viridis::scale_color_viridis(discrete = TRUE) + 
  labs(x = "Year", y = expression("Annual Average   " ~ PM[2.5] ~ " in (µg/m³)"), title = expression(PM[2.5] ~ "Pollution in 131 NCAP cities from 1998 to 2021"), 
       color = "Years", 
       caption = str_wrap("*Within each year there are 131 dots, one corresponding to each of the 131 non-attainment cities. Each dot shows the annual average PM2.5 concentration (in µg/m³) of a given non-attainment city in the year in question. The size of the dot is scaled to the population (census 2011) of the underlying city.", width = 70)) +
  ggthemes::theme_tufte() +
    ggplot2::scale_size(breaks = c(1, 5, 10, 20, 50, 100), range = c(1, 6)) +
   theme(plot.title = element_text(hjust = 0.5, margin = margin(b = 0.5, unit = "cm"), size = 17), 
         axis.line = element_line(), 
         axis.text = element_text(size = 13),
         legend.title = element_text(hjust = 0.5, size = 13), 
         axis.title.x = element_text(size = 13, margin = margin(t = 0.5, b = 0.5,  unit = "cm")),
          axis.title.y = element_text(size = 13, margin = margin(r = 0.5, unit = "cm")),
         legend.text = element_text(size = 12),
         legend.position = "bottom", 
         plot.caption = element_text(hjust = 0, size = 10, margin = margin(t = 1, unit = "cm")),
         legend.background = element_rect(color = "black"), 
         legend.direction = "horizontal") +
  geom_hline(mapping = aes(yintercept = who_guideline), linetype = "dashed") +
  geom_hline(mapping = aes(yintercept = 40), linetype = "dashed") +
    annotate("text", x = 6.4, y = 43, label = expression("National" ~ PM[2.5] ~ "Guideline (40 µg/m³)"), hjust = 0, size = 4) +
  annotate("text", x = 6.3, y = 8, label = expression("WHO" ~ PM[2.5] ~ "Guideline (5 µg/m³)"), hjust = 0, size = 4) +
  scale_color_manual(values = c("1998" = "#FFE6B3", "2009" = "#FFD25D", 
                                "2017" = "#FFBA00", "2019" = "#FF6908", "2020" = "#FF9600", 
                                "2021" = "#E63D23")) +
  scale_y_continuous(breaks = seq(0, 130, 20)) +
  guides(colour = guide_legend(nrow = 1, 
                               override.aes = list(size = 5)), 
         size = guide_legend(title = "Population (in Lakhs)", 
                             nrow = 1, override.aes = list(shape = 21))) 
  

beeswarm_plot_data <- color_2021 %>%
    select(country, name_1, name_2, population, starts_with("pm")) %>%
  pivot_longer(cols = pm1998:pm2021, names_to = "years", 
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.factor(as.integer(unlist(str_extract(years, "\\d+")))), 
         region = "City Average") 


plt <- beeswarm_plot_data %>%
  filter(country == "India", years %in% c(1998, 2003, 2017, 2021)) %>%
  ggplot(mapping = aes(x = years, y = pop_weighted_avg_pm2.5, color = years)) +
  geom_beeswarm(cex = 1.5, alpha = 0.7) +
  labs(x = expression("Year"), y = expression("Annual Average" ~ PM[2.5] ~ "(in µg/m³)")) +
  ggthemes::theme_tufte() + 
  theme(axis.line = element_line()) +
  viridis::scale_color_viridis(discrete = TRUE)
  
plot2_data <- final_analysis_dataset %>%
    slice_max(population, n = 10) %>%
  mutate(pm2017_40_perc = pm2017*((red_perc)/100), 
         le_gain_from_40_perc_red = pm2017_40_perc*0.098) %>%
  select(country, name_1, name_2, city, population, pm2017, pm2017_40_perc, le_gain_from_40_perc_red) %>%
  slice_max(population, n = 10) 



# plot 1.2 (lollipop plot)

plt1.2 <- plot1_data_with_empty_rows %>%
  ggplot(mapping = aes(x = city, y = value, color = factor(pol_type))) + 
  geom_segment(mapping = aes(x = forcats::fct_reorder(city, population, .desc = TRUE), y = 0, xend = city, yend = value), position = "dodge") +
  geom_hline(mapping = aes(yintercept = who_guideline), color = "black", linetype = "dashed", size = 0.5) +
   geom_hline(mapping = aes(yintercept = nat_pm2.5_stan_india), color = "black", linetype = "dashed", size = 0.5) +
  labs(x = "City", y = expression("Annual average" ~ PM[2.5] ~ "(in µg/m³)"), fill = "", 
       title = expression("2017" ~ PM[2.5] ~ "Concentrations in top 10 most populated Non-Attainment cities in India"), caption = str_wrap("*Under NCAP's recently updated goals, a 40% reduction (in PM2.5) is targeted by 2026 (relative to 2017 levels). The cities in this graph are the 10 largest by population (2011 Census) of the 131 non-attainment cities singled out by NCAP. The cities are ordered from most populated to least populated. Since AQLI produces results at the district-level, the statistics shown are for districts containing these cities. The dotted black lines represent the Annual Average PM2.5 guideline both as per WHO and as per India's National Ambient Air Quality Standard (NAAQS).", width = 100)) +
  scale_fill_manual(values = c("pm2017" = "#1C2B39", "pm2017_40_perc_red" = "#576572"), labels = c("2017", "After 40% reduction under NCAP")) +
  guides(colour = guide_legend(override.aes = list(shape = 12))) +
  scale_y_continuous(breaks = seq(0, 130, 10)) +
   ggthemes::theme_tufte() +
   theme(axis.text.x = element_text(size = 10),
         axis.text.y = element_text(size = 10),
         axis.title = element_text(size = 12),
        legend.position = "bottom", 
        legend.text = element_text(size = 7), 
        panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), 
plot.title = element_text(hjust = 0.5, size = 14), 
legend.background = element_rect(fill = "white", colour = "black"), 
axis.ticks = element_blank(), 
plot.caption = element_text(hjust = 0, margin = margin(0, 10, 0, 0), face = "italic")) +
  annotate("text", x = 10.1, y = 43, label = expression("National" ~ PM[2.5] ~ "Guideline (40 µg/m³)"), hjust = 0, size = 3) +
  annotate("text", x = 10.37, y = 8, label = expression("WHO" ~ PM[2.5] ~ "Guideline (5 µg/m³)"), hjust = 0, size = 2.7)
  



# plot 2.2 (lollipop plot)
plt2.2 <- plot2_data %>%
  ggplot(mapping = aes(x = city, y = le_gain_from_40_perc_red)) + 
  geom_segment(aes(x = forcats::fct_reorder(city, population ,.desc = TRUE), y = 0, xend = city, yend = le_gain_from_40_perc_red), color = "darkred", size = 1) +
  geom_point(size=5, color="red", fill=alpha("orange", 0.3), alpha=0.7, shape=21, stroke=2) +
  labs(x = "City", y = "Life Expectancy Gains (in years)", title = expression("Life Expectancy Gains by reducing" ~ PM[2.5] ~ "by 40% relative to 2017"), 
       subtitle = "(Top 10 most populated non-attainment cities in India)", 
       caption = str_wrap("*Under NCAP's recently updated goals, a 40% reduction (in PM2.5) is targeted by 2026 (relative to 2017 levels). The cities in this graph are the 10 largest by population (2011 Census) of the 131 non-attainment cities singled out by NCAP. The cities are ordered from most populated to least populated. Since AQLI produces results at the district-level, the statistics shown are for districts containing these cities.", width = 100)) +
  ggthemes::theme_clean() +
  theme(axis.text.x = element_text(size = 10),
         axis.text.y = element_text(size = 10),
         axis.title = element_text(size = 12),
        legend.position = "bottom", 
        legend.text = element_text(size = 7), 
        panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), 
plot.title = element_text(hjust = 0.5, size = 14), 
plot.subtitle = element_text(hjust = 0.5, size = 9), 
legend.background = element_rect(fill = "white", colour = "black"), 
axis.ticks = element_blank(), 
plot.caption = element_text(hjust = 0, margin = margin(0, 10, 0, 0), face = "italic"))


# ridgeline plot (same dataset as used in the above snapshot map, run that before and then run this)

# cities to plot in the snapshot heatmap
city_to_plot <- final_analysis_dataset %>%
  slice_max(pm2020, n = 10) %>%
  pull(city) 

# ridgeline plot
snapshot_map_data %>% filter(city %in% city_to_plot, years <= 2017)  %>% ggplot(mapping = aes(x = pop_weighted_avg_pm2.5, y = city, fill = city)) + geom_density_ridges() + theme_ridges() + theme(legend.position = "none") + labs(x = expression("Annual Average" ~ PM[2.5] ~ ("in µg/m³")), y = "City", subtitle = "Top 10 most polluted NCAP cities in 2020") + ggtitle(expression(PM[2.5] ~ "Distribution (1998 to 2021)")) + theme(plot.title = element_text(hjust = 0.5, size = 10),
                                        plot.subtitle = element_text(hjust = 0.5, size = 7)                                            )

```

```{r}
foo <- color_2021 %>%
  group_by(country) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2021_pop_weighted = pm2021*pop_weights) %>%
  summarise(avg_pm2.5_2021 = sum(pm2021_pop_weighted, na.rm = TRUE))

color_2021 %>%
  filter(country == "India", pm2021 > 40) %>%
  pull(population) %>%
  sum()

foo_risks <- read_csv("./september.2023/gbd.calculation/GBDComparisons/GBD/gbdrates_Global_risks.csv")
foo_causes <- read_csv("./september.2023/gbd.calculation/GBDComparisons/GBD/gbdrates_Global_causes.csv")

foo_causes %>%
  mutate(age = str_remove(age, " years"), 
         age = str_replace(age, "\\+", " plus"), 
         age = str_replace(age, "-", " to "))  %>%
  write_csv("./september.2023/gbd.calculation/GBDComparisons/GBD/gbdrates_Global_causes.csv")

foo_risks %>%
  filter(rei %in%  c("Drug use", "Drug use disorders")) %>%
  mutate(age = str_remove(age, "years"), 
         age = str_replace(age, "\\+", " plus"), 
         age = str_replace(age, "-", " to ")) %>%
  write_csv("./september.2023/gbd.calculation/GBDComparisons/GBD/gbdrates_Global_risks.csv")


color_2021 %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2021_pop_weighted = pm2021*pop_weights) %>%
  summarise(avg_pm2.5 = sum(pm2021_pop_weighted, na.rm = TRUE))

```

