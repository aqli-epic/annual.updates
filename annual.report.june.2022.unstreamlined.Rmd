---
title: "annual.report.june.2022"
author: "Aarsh"
date: '2022-07-12'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load-lib-helper-files-data-global-var}

# libraries
library(readr)
library(dplyr)
library(stringr)
library(magrittr)
library(ggplot2)
library(readr)
library(tidytext)
library(tidyr)
library(tidyverse)
library(sf)
library(usethis)
library(devtools)

# load and document to keep things updated
devtools::load_all()
devtools::document()

# read in latest color file
color_2020 <- read_csv("./june.2022/master.dataset/color.csv")

# GBD final results file (resulting file that we get after applying the steps in the GBD technical appendix)
gbd_results <- read_csv("./june.2022/other.important.calculations.data/estimated_life_expectancy_differences_master_table_final.csv")

# global variables
who_guideline <- 5
le_constant <- 0.098

```



# Annual Report Figures

# Figure 1

```{r figure-1}

```

# Figure 2: Global Trends in PM2.5 Concentrations, 2000-2020

```{r ar-fig2}

# calculating population weights and replacing the "pm" columns with their population weighted counterparts
color_2020_pop_weighted <- color_2020 %>%
  dplyr::mutate(global_pop_weights = population/sum(population)) %>%
  dplyr::mutate(across(starts_with("pm"), ~.x*global_pop_weights, .names = "{col}_weighted"))

# get year wise population weighted average in wide format
color_2020_summary <- color_2020_pop_weighted %>%
  dplyr::summarise(across(ends_with("weighted"), sum))

# convert the above data to long format
global_trends_figure_2020_dataset <- tibble(years = 1998:2020, global_avg_pm2.5_2020_dataset = as.numeric(unlist(color_2020_summary)))

# add le gains column
global_trends_figure_2020_dataset <- global_trends_figure_2020_dataset %>%
  dplyr::mutate(le_gains_red_pm2.5_to_who = round((global_avg_pm2.5_2020_dataset -  who_guideline)*le_constant, 1), 
         le_gains_red_pm2.5_to_who = ifelse(le_gains_red_pm2.5_to_who < 0, 0, le_gains_red_pm2.5_to_who))

# filter data and only keep the following year range: 2000 to 2020
global_trends_figure_2020_dataset_filtered <- global_trends_figure_2020_dataset %>%
  dplyr::filter(years > 1999)

# plot the figure
ar_fig2 <- ggplot() +
  geom_line(global_trends_figure_2020_dataset_filtered, mapping = aes(x = years, y = global_avg_pm2.5_2020_dataset), color = "darkblue", lwd = 1.3) +
  theme_classic() +
  labs(x = "Years", y = expression(paste("Average PM2.5 concentration ( ", mu, "gm", "/", m^3, " )"))) + 
  scale_x_continuous(breaks = seq(2000, 2020, 2)) +
  scale_y_continuous(breaks = seq(0, 35, 5), limits = c(0, 35)) +
  theme(legend.position = "none", legend.title = element_blank(), axis.title.x =  element_text(size = 8), axis.title.y = element_text(size = 10))

# save figure
ggsave("./june.2022/annual.report/figure2.data.graph/ar_fig2.png", ar_fig2)

# save figure data
write_csv(global_trends_figure_2020_dataset_filtered, "./june.2022/annual.report/figure2.data.graph/ar_fig2_data.csv")

```

# Figure 3: Potential Gain in Life Expectancy from Permanently Reducing PM2.5 from 2020 Concentrations to the WHO Guideline in the 10 Most Populated Countries in the World

```{r ar-fig3}

# Creating the master dataset with all relevant columns to plot the 3 figures in the panel (will be arranged in a single row)
ar_fig3_dataset <- color_2020 %>%
  group_by(country) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2020_pop_weighted = pm2020*pop_weights, 
         pm2019_pop_weighted = pm2019*pop_weights,
         le_gain_pre = ((pm2020 - who_guideline)*le_constant), 
         le_gain_pre = ifelse(le_gain_pre < 0, 0, le_gain_pre), 
         lifeyears_gained = le_gain_pre * population) %>%
  summarise(tot_population = sum(population, na.rm = TRUE),
            tot_population_millions = round((tot_population/1000000), 2),
            avg_pm2.5_2019 = sum(pm2019_pop_weighted, na.rm = TRUE),
            avg_pm2.5_2020 = sum(pm2020_pop_weighted, na.rm = TRUE), 
            avg_life_exp_gain = round((avg_pm2.5_2020 - who_guideline)*le_constant, 2),
            avg_life_exp_gain = ifelse(avg_life_exp_gain < 0, 0, avg_life_exp_gain),
            total_person_years_gained = sum(lifeyears_gained, na.rm = TRUE), 
            total_person_years_gained_billions = round(total_person_years_gained/1000000000, 2)) %>%
  ungroup() %>%
  slice_max(tot_population, n = 10) 

# population plot of the top 10 most populous
plt_top10_most_populous_population <- ar_fig3_dataset %>%
  ggplot() +
  geom_col(mapping = aes(x = forcats::fct_reorder(country, tot_population_millions), y = tot_population_millions), fill = "darkred", width = 0.7) +
  labs(x = "Country", y = "Population (in millions)") +
  scale_y_continuous(breaks = seq(0, 1500, 200)) +
  coord_flip() +
  ggthemes::theme_tufte()

# Average Life Expectancy Gains experienced by a person in top 10 most populous countries if PM2.5 is reduced to the WHO guideline
plt_top10_most_populous_le_gains_per_person <- ar_fig3_dataset %>%
  ggplot() +
  geom_col(mapping = aes(x = forcats::fct_reorder(country, tot_population_millions), y = avg_life_exp_gain), fill = "darkred", width = 0.7) +
  labs(x = "", y = "Average Life Expectancy Gains (Years)") +
  scale_y_continuous(breaks = seq(0, 8, 1)) +
   ggthemes::theme_tufte() +
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank()) +
  coord_flip() 

# Total person years gained on the country level for the top 10 most populous regions in the world (if PM2.5 is reduced to the WHO guideline)

plt_top10_most_populous_tot_person_years_gained <- ar_fig3_dataset %>%
  ggplot() +
  geom_col(mapping = aes(x = forcats::fct_reorder(country, tot_population_millions), y = total_person_years_gained_billions), fill = "darkred", width = 0.7) +
  labs(x = "", y = "Total Person Years Gained (Billion Years)") +
  scale_y_continuous(breaks = seq(0, 8, 1)) +
   ggthemes::theme_tufte() +
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank()) +
  coord_flip() 

# Combine all 3 graphs in a panel
ar_fig3 <- gridExtra::grid.arrange(plt_top10_most_populous_population , plt_top10_most_populous_le_gains_per_person, plt_top10_most_populous_tot_person_years_gained, nrow = 1)

# save the plot in the appropriate folder
ggsave("./june.2022/annual.report/figure3.data.graph/ar_fig3.png", ar_fig3)

# save the dataset that was reduced to generate the figure
write_csv(ar_fig3_dataset , "./june.2022/annual.report/figure3.data.graph/ar_fig3_data.csv")
```


# Figure 4: Life Expectancy Impact of PM2.5 and Unassociated Causes/Risks of Death, Global

```{r ar-fig4}

# prepare the gbd figure dataset keeping relevant causes of death and filtering out others
ar_fig4_dataset <- gbd_results %>%
  filter(location == "global", 
         cause_of_death %in% c("PM2.5 relative to WHO", "Smoking", 
                               "Alcohol use", "Unsafe water, sanitation, and handwashing",
                               "Road injuries", "HIV/AIDS", 
                               "Malaria", "Conflict and terrorism")) %>%
  select(cause_of_death, est_le_diff_vs_actual_aggregate) 

# plot the gbd figure
ar_fig4 <- ggplot(gbd_fig_4_dataset, mapping = aes(x = fct_reorder(cause_of_death, est_le_diff_vs_actual_aggregate, .desc = TRUE), y = est_le_diff_vs_actual_aggregate)) + 
  geom_col(mapping = aes(fill = est_le_diff_vs_actual_aggregate), width = 0.5) +
  theme_classic() + 
  labs(x = "", y = "Life Years Lost") +
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust=0.90), 
        legend.position = "none") +
  ggtitle(str_c("Life Expectany Impact of Mortality Causes & Risks:", "Global", sep = " ")) +
   scale_fill_gradient(low = "darkgoldenrod1", high = "darkorange")
 
# save the plot in the appropriate folder
ggsave("./june.2022/annual.report/figure4.data.graph/ar_fig4.png", ar_fig4)

# save the dataset that was reduced to generate the figure
write_csv(ar_fig4_dataset , "./june.2022/annual.report/figure4.data.graph/ar_fig4_data.csv")

 
```


# Figure 5: Global Trends in PM2.5 Concentrations, 2000-2020

```{r ar-fig5}
# AR Figure 5
 
# South Asia definition
south_asia_def <- c("Afghanistan", "Bangladesh", 
                    "Bhutan", "India", 
                    "Maldives", "Nepal", 
                    "Pakistan", "Sri Lanka")

# create an identifer for South Asia  
color_2020 <- color_2020 %>%
  mutate(region = ifelse(country %in% south_asia_def, "South Asia", country), 
         region = ifelse(region %in% "China", "China", region), 
         region = ifelse(region %in% c("China", "South Asia"), region, "Rest of the World"))


# convert data from wode to long
color_2020_long <- color_2020 %>%
    group_by(region) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2020_weighted, names_to = "years", 
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+")))) 

# keep only years post 1999
color_2020_long_2000_2020 <- color_2020_long %>%
  filter(years > 1999) 

# Save AR figure 5 dataset
color_2020_long_2000_2020 %>%
  write_csv("./june.2022/annual.report/figure5.data.graph/ar_fig5_data.csv")
  

# AR figure 5 plot
ar_fig5 <- ggplot(color_2020_long_2000_2020) +  geom_line(mapping = ggplot2::aes(x = years, y = pop_weighted_avg_pm2.5, color = region, lwd = 1.5), lwd = 2) +
  labs(x = "Years", y = "Average PM2.5 concentrations (in µg/m³)") +
  ggthemes::theme_fivethirtyeight() +
  scale_color_manual(values = c("chartreuse4", "blue4", "darkorange2")) +
   theme(legend.position = "bottom", legend.title = element_blank(), 
        legend.text = element_text(size = 7), 
        axis.title.y = element_text(size = 9), 
        axis.title.x = element_text(size = 9)) +
  scale_y_continuous(breaks = seq(0, 60, 10)) +
  scale_x_continuous(breaks = seq(2000, 2020, 1))

# save the plot in the appropriate folder
ggsave("./june.2022/annual.report/figure5.data.graph/ar_fig5.png", ar_fig5)


```


# Figure 6:

```{r}

```


# Figure 7: Year-Over-Year Change in PM2.5 Levels in 2020, the First Year of the Pandemic

```{r}

# Prepare AR Figure 7 data set
ar_fig7_dataset <- color_2020 %>%
  group_by(country) %>%
  mutate(pop_weights = population/sum(population, na.rm =TRUE), 
         pm2019_pop_weighted = pop_weights*pm2019,
         pm2020_pop_weighted = pop_weights*pm2020) %>%
  summarise(avg_pm2.5_pop_weighted_2019 = sum(pm2019_pop_weighted, na.rm = TRUE), 
            avg_pm2.5_pop_weighted_2020 = sum(pm2020_pop_weighted, na.rm = TRUE),
            change_pm2.5_2019_to_2020 = avg_pm2.5_pop_weighted_2020 - avg_pm2.5_pop_weighted_2019,
            percent_change_pm2.5_2019_to_2020 = (change_pm2.5_2019_to_2020/avg_pm2.5_pop_weighted_2019)*100,
            total_population = sum(population, na.rm = TRUE)) %>%
  mutate(direction_label = ifelse(change_pm2.5_2019_to_2020 < 0, "Negative", "Positive")) %>%
  slice_max(total_population, n = 20) 
  
# Save AR figure 7 dataset as a csv
ar_fig7_dataset %>% 
  write_csv("./june.2022/annual.report/figure7.data.graph/ar_fig7_dataset.csv")

# AR figure 7 plot
ar_fig7 <- ar_fig7_dataset %>%  
  ggplot(mapping = aes(x = fct_reorder(country, percent_change_pm2.5_2019_to_2020), y = percent_change_pm2.5_2019_to_2020, fill = direction_label)) + geom_bar(stat = "identity") +
  geom_hline(mapping = aes(yintercept = 0)) +
  scale_y_continuous(limits = c(-25, 25), breaks = seq(-25, 25, 5)) +
  labs(x = "country", y = "Year over Year change in PM2.5 (%)")+
  ggthemes::theme_clean() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5), legend.position = "none") 


# Save AR figure 7
ggsave("./june.2022/annual.report/figure7.data.graph/ar_fig7.png", ar_fig7)
```
# Figure 8:

```{r}

```

# Figure 9: Potential Gain in Years of Life Expectancy Through Permanently Reducing PM2.5 from 2020 Concentrations to the WHO Guideline, in 10 Most Populated Regions in Southeast Asia

```{r}

# South East Asia Definition
se_asia_vec <- c("Brunei", "Myanmar", "Cambodia", "Timor-Leste", "Indonesia", "Laos", "Malaysia", "Philippines", "Singapore", "Thailand", "Vietnam")

# filter dataset for South East Asia and add a new column that combines gadm_1 and gadm_0 columns
ar_fig9_dataset <- color_2020 %>%
  filter(country %in% se_asia_vec) %>%
  mutate(name_1_country = str_c(name_1, "(", country, ")", sep = "")) %>%
  group_by(name_1_country) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2020_pop_weighted = pop_weights*pm2020) %>%
  summarise(tot_pop = sum(population, na.rm = TRUE), avg_pm2.5_pop_weighted = sum(pm2020_pop_weighted, na.rm = TRUE), 
            gain_in_le = (avg_pm2.5_pop_weighted - who_guideline) * le_constant, 
            gain_in_le = ifelse(gain_in_le < 0, 0, gain_in_le)) %>%
  ungroup() %>%
  mutate(name_1_country = str_replace(name_1_country, "Jawa Barat", "West Java"),
         name_1_country = str_replace(name_1_country, "Jawa Timur", "East Java"), 
         name_1_country = str_replace(name_1_country, "Jawa Tengah", "Central Java")
         ) %>%
  slice_max(tot_pop, n = 10) 

# Save AR figure 9 dataset as a csv
ar_fig9_dataset %>% 
  write_csv("./june.2022/annual.report/figure9.data.graph/ar_fig9_dataset.csv")

# AR figure 9
ar_fig9 <- ar_fig9_dataset %>%
  ggplot(mapping = aes(x = forcats::fct_reorder(name_1_country, gain_in_le), y = gain_in_le, fill = gain_in_le)) +
  geom_col() + 
  labs(y = "Gain In Life Expectancy (Years)", x = "Region") +
  coord_flip() + 
  scale_fill_gradient(low = "darkgoldenrod1", high = "darkorange2") +
  ggthemes::theme_tufte() +
  theme(legend.position = "none")

# save AR figure 9
ggsave("./june.2022/annual.report/figure9.data.graph/ar_fig9.png", ar_fig9)

```



