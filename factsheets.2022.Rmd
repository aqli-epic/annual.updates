---
title: "Factsheets 2022"
author: "Aarsh"
date: '2022-07-26'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load-lib-helper-files-data-global-var}

# libraries
library(readr)
library(dplyr)
library(stringr)
library(magrittr)
library(ggplot2)
library(readr)
library(tidytext)
library(tidyr)
library(tidyverse)
library(sf)
library(usethis)
library(devtools)
library(data.table)

# load and document to keep things updated
devtools::load_all()
devtools::document()

# read in latest color file
color_2020 <- read_csv("./june.2022/master.dataset/color_2020.csv")

# read in old available color datasets
color_2019 <- read_csv("./june.2022/master.dataset/color_2019.csv")
color_2016 <- read_csv("./june.2022/master.dataset/color_2016.csv")

# GBD final results file (resulting file that we get after applying the steps in the GBD technical appendix)
gbd_results <- read_csv("./june.2022/other.important.calculations.data/estimated_life_expectancy_differences_master_table_final.csv")

# global variables
who_guideline <- 5
le_constant <- 0.098
ncap_midpoint <- 25
nat_stan_india <- 40

# global operations
`%notin%` <- Negate(`%in%`)


```

# Nigeria Factsheet

```{r}

# No National Standard for Nigeria
nat_stan_nigeria <- "No National Standard"

# filtering the color file for Nigeria
color_2020_nigeria <- color_2020 %>%
  filter(country == "Nigeria") %>%
  mutate(region = ifelse(name_1 %in% c("Ekiti", "Lagos", "Ogun", "Ondo", 
                                       "Osun", "Oyo"), "South-West Nigeria", 
                         "All other regions (excluding South-West Nigeria)"))

# nigeria factsheet figure 2 dataset
nigeria_fs_fig2_dataset <-  color_2020_nigeria %>%
  group_by(name_1) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2020_pop_weighted = pop_weights*pm2020) %>%
  summarise(avg_pm2.5_2020 = sum(pm2020_pop_weighted, na.rm = TRUE), gain_in_life_expectancy = (avg_pm2.5_2020 - who_guideline)*le_constant,
            gain_in_life_expectancy = ifelse(gain_in_life_expectancy < 0,  0, gain_in_life_expectancy),
            tot_pop = sum(population, na.rm = TRUE)) %>%
  slice_max(tot_pop, n = 10)  

# save nigeria fs fig2 dataset
nigeria_fs_fig2_dataset %>%
  write_csv("./june.2022/factsheets/nigeria/graph.wise.datasets/nigeria_fs_fig2_dataset.csv")

# nigeria fs figure 2
 nigeria_fs_fig2 <- nigeria_fs_fig2_dataset %>% ggplot() +
  geom_col(mapping = aes(x = forcats::fct_reorder(name_1, gain_in_life_expectancy), y = gain_in_life_expectancy, fill = gain_in_life_expectancy)) +
  labs(x = "Region", y = "Average Life Expectancy Gains (Years)") +
  scale_y_continuous(breaks = seq(0, 3, 0.5)) +
   scale_fill_gradient(low = "burlywood1", high = "darkgoldenrod1") +
  coord_flip() +
  ggthemes::theme_clean() +
  theme(legend.position = "none")
 
# save nigeria factsheet figure 2
ggsave("./june.2022/factsheets/nigeria/graphs/nigeria_fs_fig2.png", nigeria_fs_fig2)


# getting gbd result for Nigeria from the master file
gbd_nigeria <- gbd_results %>%
  filter(location == "nigeria")

# filter out some of the diseases that are already in some* (need to discuss this) way covered in the PM2.5 category
gbd_nigeria_filter <- gbd_nigeria %>%
  filter(cause_of_death %notin% c("Cardiovascular diseases", "Neoplasms", "Tobacco", 
                                  "Lower respiratory infections"))

# choosing the top 6 causes of death, based on "est_le_diff_vs_actual_aggregate" variable
nigeria_fs_fig3_dataset <- gbd_nigeria_filter %>%
  slice_max(est_le_diff_vs_actual_aggregate, n = 6)

# save nigeria fs figure 3 dataset
nigeria_fs_fig3_dataset %>%
  write_csv("./june.2022/factsheets/nigeria/graph.wise.datasets/nigeria_fs_fig3_dataset.csv")

# nigeria fs figure 3
nigeria_fs_fig3 <- nigeria_fs_fig3_dataset %>%
  ggplot() + 
  geom_col(mapping = aes(x = forcats::fct_reorder(cause_of_death, est_le_diff_vs_actual_aggregate), y = est_le_diff_vs_actual_aggregate, fill = cause_of_death), width = 0.5) +
  labs(x = "Cause of Death", y = "Years Lost") + 
  coord_flip() +
   scale_fill_manual(values = c("royalblue", "royalblue",  
                                "royalblue", "royalblue", "darkred", "royalblue")) +
  ggthemes::theme_clean() +
  theme(legend.position = "none") +
  coord_flip()

# save nigeria factsheet figure 3
ggsave("./june.2022/factsheets/nigeria/graphs/nigeria_fs_fig3.png", nigeria_fs_fig3)

# nigeria factsheet figure 4 dataset 
nigeria_fs_fig4_dataset <- color_2020_nigeria %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2020_weighted, names_to = "years", 
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+"))), 
         region = "National Average") %>% 
  select(years, region, pop_weighted_avg_pm2.5)

# save nigeria fs figure 4 dataset
nigeria_fs_fig4_dataset %>%
  write_csv("./june.2022/factsheets/nigeria/graph.wise.datasets/nigeria_fs_fig4_dataset.csv")
  

# nigeria factsheet figure 4 
  nigeria_fs_fig4 <- ggplot(nigeria_fs_fig4_dataset) +
  geom_line(mapping = ggplot2::aes(x = years, y = pop_weighted_avg_pm2.5), lwd = 1.1, 
            color = "darkred") +
    geom_hline(mapping = aes(yintercept = 5), lwd = 0.8) +
  scale_y_continuous(breaks = seq(0, 30, 5), limits = c(0, 30)) +
  scale_x_continuous(breaks = seq(1998, 2020, 2)) +
    scale_color_manual(values = c("National Average" = "darkgrey")) +
  ggthemes::theme_clean() +
  labs(x = "Years", 
       y = expression(paste("Average PM2.5 concentration ( ", mu, "g", "/", m^3, " )"))) +
  theme(legend.position = "bottom", legend.title = element_blank(), 
        legend.text = element_text(size = 7), 
        axis.title.y = element_text(size = 9), 
        axis.title.x = element_text(size = 9)) + 
     geom_text(x = 2003.5, y = 6.5, label = expression(paste("WHO PM2.5 Guideline (last updated: 2021): 5 ", mu, "g","/", m^3, "")))

  
# save nigeria factsheet figure 4
ggsave("./june.2022/factsheets/nigeria/graphs/nigeria_fs_fig4.png", nigeria_fs_fig4)  

# appendix table nigeria factsheet 

nigeria_appendix_table <- color_2020_nigeria %>%
  group_by(name_1) %>%
   mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2020_pop_weighted = pop_weights*pm2020) %>%
  summarise(total_population_millions = round((sum(population, na.rm = TRUE))/1000000, 1), avg_pm2.5_2020 = round(sum(pm2020_pop_weighted, na.rm = TRUE), 2),
            life_exp_gain_2020_who  = round((avg_pm2.5_2020 - who_guideline)*le_constant, 2), 
            life_exp_gain_2020_30perc_reduce = round(((avg_pm2.5_2020*0.30)*le_constant), 2)) %>%
  ungroup() %>%
  mutate(life_exp_gain_2020_who = ifelse(life_exp_gain_2020_who < 0, 0, life_exp_gain_2020_who)) %>%
  rename(`State` = name_1, `Population (Millions)` = total_population_millions, 
         `PM 2.5 concentration 2020 (µg/m³)` = avg_pm2.5_2020, 
         `From 2020 Concentration to WHO Guideline of 5 µg/m³` = life_exp_gain_2020_who, 
         `From 2020 Concentration reduction by 30 percent` = life_exp_gain_2020_30perc_reduce)

# save nigeria factsheet appendix table
nigeria_appendix_table %>%
   write_csv("./june.2022/factsheets/nigeria/nigeria_fs_appendix_table.csv")
  

```

