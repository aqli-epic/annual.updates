---
title: "Factsheets 2024"
author: "Nishka Sharma, Hrishikesh Chandra Gautam"
output: html_document
date: "2024-03-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# get packages, global variables and datasets
```{r load-lib-helper-files-data-global-var}

# read in the helper file
source("R/july_2024_helper_script.R")

```

## India Factsheet 

```{r india_fs_2024}
#> Since [year], [x%] of the world's increase in pollution came from [country]-----------------

country_select <- "India"

# Since 2013 all gadm2 places where pollution has increased - > average pm2.5 in 2013, 2022
avg_pm2.5_global <- gadm2_aqli_2022 %>% 
  mutate(diff_pm2022_pm2013 = pm2022 - pm2013) %>%
  filter(diff_pm2022_pm2013 > 0) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2013_pop_weighted = pm2013*pop_weights, 
         pm2022_pop_weighted = pm2022*pop_weights) %>%
  summarise(avg_pm2.5_2013 = sum(pm2013_pop_weighted, na.rm = TRUE), 
            avg_pm2.5_2022 = sum(pm2022_pop_weighted, na.rm = TRUE))

actual_diff_global <- avg_pm2.5_global$avg_pm2.5_2022 - avg_pm2.5_global$avg_pm2.5_2013
 
# Assuming that of the places (gadm2 regions) where pollution increased, if  
# amongst those places, all Indian gadm2 regions had the same pollution in 2022 
# as it had in 2013, how would the global average PM2.5 look in 2022.
 
avg_pm2.5_global_adjusted <- gadm2_aqli_2022 %>% 
  mutate(diff_pm2022_pm2013 = pm2022 - pm2013) %>%
  filter(diff_pm2022_pm2013 > 0) %>%
  mutate(pm2022 = ifelse(country == country_select, pm2013, pm2022)) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2013_pop_weighted = pm2013*pop_weights, 
         pm2022_pop_weighted = pm2022*pop_weights) %>%
  summarise(avg_pm2.5_2013 = sum(pm2013_pop_weighted, na.rm = TRUE), 
            avg_pm2.5_2022 = sum(pm2022_pop_weighted, na.rm = TRUE))

# difference between adjusted and actual global average, i.e. India's contribution
adjusted_diff_global <- avg_pm2.5_global_adjusted$avg_pm2.5_2022 - avg_pm2.5_global_adjusted$avg_pm2.5_2013
 
# final answer
final_answer <- round(((actual_diff_global - adjusted_diff_global)/actual_diff_global)*100, 1)

#> Indo Gangetic Plain, population and average PM2.5----------------------------------

# average pm2.5 and total population in Indo-Gangetic plains in 2022
summary_indo_gangetic_plain <- gadm2_aqli_2022 %>%
  filter(country == "India", name_1 %in% indo_gangetic_plains_states) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         pm2022_pop_weighted = pm2022*pop_weights) %>%
  summarise(avg_pm2.5_2022 = sum(pm2022_pop_weighted, na.rm = TRUE), 
            total_population = sum(population, na.rm = TRUE))

# Fig 1: Potential gain in Life Expectancy from permanently reducing PM2.5 from -------- 
# 2022 levels to the WHO PM2.5 guideline.
# separately getting Gilgit Baltistan and Azad Kashmir
azad_kashmir_gilgit_baltistan <- gadm2_aqli_2022 %>%
  filter(country == "Pakistan", name_1 %in% c("Azad Kashmir", "Gilgit Baltistan"))

# plot 1 data
india_fs_fig1_data <- gadm2_aqli_2022 %>%
  filter(country == "India") %>%
  bind_rows(azad_kashmir_gilgit_baltistan) %>%
  left_join(gadm2_aqli_2022_shp, by = c("objectid_gadm2" = "obidgadm2")) %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2022") %>%
  select(-geometry, geometry) %>%
  st_as_sf()

# india factsheet figure 1
india_fs_fig1 <- india_fs_fig1_data %>%
  ggplot() +
  geom_sf(mapping = aes(fill = forcats::fct_reorder(lyl_bucket, order_lyl_bucket)), color = "lightgrey", lwd = 0.05) +
  geom_sf(data = india_state, color = "black", fill = "transparent", lwd = 0.5) +
  ggthemes::theme_map() + 
  scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  ggthemes::theme_map() +
  labs(fill = "Potential gain in life expectancy (Years) ", title = "") + 
  theme(legend.position = "bottom", 
        legend.justification = c(0.5, 3), 
        legend.background = element_rect(color = "black"), 
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 15), 
        plot.title = element_text(hjust = 0.5, size = 15), 
        # legend.key = element_rect(color = "black"),
        legend.box.margin = margin(b = 1, unit = "cm"),
        plot.subtitle = element_text(hjust = 0.5, size = 7), 
        plot.caption = element_text(hjust = 0.7, size = 9, face = "italic"), 
        legend.key = element_rect(color = "black"), 
        legend.box.spacing = unit(0, "cm"), 
        legend.direction = "horizontal", 
       plot.background = element_rect(fill = "white", color = "white")) +
  guides(fill = guide_legend(nrow = 1))


# Fig 2: Potential gain in life expectancy in top 10 most populous states in India ----------
india_fs_fig2_data <- gadm_level_summary(gadm2_aqli_2022, c("country", "name_1"), c(2022),  10) %>%
  filter(country == "India") %>% 
  slice_max(population, n = 10) %>%
  add_aqli_color_scale_buckets("lyl", "llpp_who_2022")


india_fs_fig2_data$lyl_bucket <- as.factor(india_fs_fig2_data$lyl_bucket)

india_fs_fig2 <- india_fs_fig2_data %>%
  ggplot() +
  geom_col(mapping = aes(x = forcats::fct_reorder(name_1, llpp_who_2022), y = llpp_who_2022, fill = lyl_bucket), width = 0.5) +
  labs(x = "State", y = "Potential Gain in Life Expectancy (Years)",
       title = "",
       subtitle = "", 
       caption = "", 
       fill = "Potential gain in life expectancy (Years)") +
  scale_y_continuous(breaks = seq(0, 7, 1), limits = c(0, 7)) +
  scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) +
  coord_flip() +
  ggthemes::theme_tufte() +
  themes_aqli_base +
  theme(legend.position = "bottom", 
        plot.title = element_text(hjust = 0.5, size = 16), 
        plot.subtitle = element_text(hjust =  0.5, size = 10, face = "italic", margin = margin(b = 0.8, unit = "cm")), 
        plot.caption = element_text(size = 8, hjust = 0, face = "italic"),
        axis.line = element_line(), 
        axis.text = element_text(size = 11), 
        axis.title = element_text(size = 13), 
        axis.title.y = element_text(margin = margin(r = 0.7, unit = "cm")), 
        axis.title.x = element_text(margin = margin(t = 0.6, b = 0.6, unit = "cm")), 
        axis.ticks = element_blank(),
        plot.background = element_rect(fill = "white", color = "white")) 


# Fig 3:  GBD India graph --------------------------------------------
# top 5 most deadly diseases
india_fs_fig3_dataset <- gbd_results_master_2022 %>%
  filter(country == "India") %>%
  slice_max(lyl, n = 5)

colnames(india_fs_fig3_dataset)[3] <- c("llpp_who_2022")

india_fs_fig3_dataset <- india_fs_fig3_dataset %>%
add_aqli_color_scale_buckets("lyl", "llpp_who_2022")

# figure 3 caption removed: 
# Source: Global Burden of Disease (https://vizhub.healthdata.org/gbd-results/) 
# causes and risks data and WHO Life Tables (https://apps.who.int/gho/data/node.main.LIFECOUNTRY?lang=en) 
# were used combined with the Life table method to arrive at these results. 
# 'PM2.5 relative to WHO Guideline' bar displays life years lost relative to the 
# WHO guideline as calculated by latest AQLI (2022) data, which will be published 
# in 2024.

india_fs_fig3 <- india_fs_fig3_dataset %>%
  ggplot() + 
  geom_col(mapping = aes(x = forcats::fct_reorder(cause_of_death, llpp_who_2022), 
                         y = llpp_who_2022, 
                         fill = forcats::fct_reorder(lyl_bucket, order_lyl_bucket)), 
           width = 0.4, color = "black") +
  labs(x = "Threats to Life Expectancy", y = "Life Years Lost", fill = "Life years lost", 
       title = expression("")) +
  coord_flip() + 
  ggthemes::theme_tufte() +
  themes_aqli_base +
  theme(legend.position = "bottom",
        axis.text = element_text(size = 14),
        axis.title.y = element_text(size = 16, margin = margin(r = 0.6, unit = "cm")),
        axis.title.x = element_text(size = 16, margin = margin(t = 0.6, b = 0.6, unit = "cm")),
        plot.caption = element_text(hjust = 0, size = 8, margin = margin(t = 0.8, unit = "cm")),
        plot.title = element_text(hjust = 0.5, size = 20, margin = margin(b = 0.8, unit = "cm")),
        plot.subtitle = element_text(hjust = 0.5, size = 10, margin = margin(b = 0.8, unit = "cm")),
        legend.box.background = element_rect(color = "black"),
        axis.line = element_line(), 
        legend.text = element_text(size = 11), 
        legend.title = element_text(size = 14),
        panel.grid.major.y = element_blank(), 
        plot.background = element_rect(fill = "white", color = "white")) +
  scale_y_continuous(breaks = seq(0, 6, 0.5)) +
  scale_fill_manual(values = c("0 to < 0.1" = "#ffffff", 
                               "0.1 to < 0.5" = "#ffeda0", 
                               "0.5 to < 1" = "#fed976", 
                               "1 to < 2" = "#feb24c", 
                               "2 to < 3" = "#fd8d3c", 
                               "3 to < 4" = "#fc4e2a", 
                               "4 to < 5" = "#e31a1c", 
                               "5 to < 6" = "#bd0026", 
                               ">= 6" = "#800026")) + 
  guides(fill = guide_legend(nrow = 1)) 


# Figure 4: Average PM2.5 concentration in India from 1998 to 2022 --------------

# adding a north India/rest of india region column (specifically Indo gangetic plain)
north_india <- c("West Bengal", "Uttar Pradesh", "Punjab", "Haryana", 
                 "Chandigarh", "Bihar", "NCT of Delhi")

india_fs_fig4_data_part1 <- gadm2_aqli_2022 %>%
  filter(country == "India", !is.na(population)) %>%
  mutate(region = ifelse(name_1 %in% north_india, "Northern Plains of India", "All other regions (excluding Northern Plains of India)"))


# creating India's region wise average PM2.5 data from 1998 to 2022 
india_fs_fig4_data_part1 <- india_fs_fig4_data_part1 %>%
  group_by(region) %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2022_weighted, names_to = "years", 
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+")))) %>%
  select(years, region, pop_weighted_avg_pm2.5)

# creating a national average PM2.5 trendlines data from 1998 to 2022
india_fs_fig4_data_part2 <- gadm2_aqli_2022 %>%
  filter(country == "India") %>%
  mutate(pop_weights = population/sum(population, na.rm = TRUE), 
         mutate(across(starts_with("pm"), ~.x*pop_weights, .names = "{col}_weighted"))) %>%
  summarise(across(ends_with("weighted"), sum)) %>%
  pivot_longer(cols = pm1998_weighted:pm2022_weighted, names_to = "years", 
               values_to = "pop_weighted_avg_pm2.5") %>%
  mutate(years = as.integer(unlist(str_extract(years, "\\d+"))), 
         region = "National Average") %>% 
  select(years, region, pop_weighted_avg_pm2.5)

# India factsheet figure 4 dataset
india_fs_fig4_data <- rbind(india_fs_fig4_data_part1, india_fs_fig4_data_part2)

# India factsheet figure 4
# fig4 caption removed: "We define the Indo-Gangetic plain region as containing 
# the following seven states and union territories: Bihar, Chandigarh, NCT of Delhi, 
# Haryana, Punjab, Uttar Pradesh, and West Bengal."

india_fs_fig4_data$region <- factor(india_fs_fig4_data$region, 
                                    levels = c("Northern Plains of India", 
                                               "National Average", 
                                               "All other regions (excluding Northern Plains of India)"))

india_fs_fig4 <- ggplot(india_fs_fig4_data) +
  geom_line(mapping = aes(x = years, y = pop_weighted_avg_pm2.5, 
                          color = interaction(region), 
                          linetype = interaction(region)), lwd = 1.3) +
  geom_hline(mapping = aes(yintercept = 5), lwd = 0.8, linetype = "dotted", color = "lightgrey") +
  scale_y_continuous(breaks = seq(0, 100, 10), limits = c(0, 100)) +
  scale_x_continuous(breaks = c(seq(1998, 2019, 3), 2022)) +
  scale_color_manual(values = c("Northern Plains of India" = "#1a1638", 
                                "National Average" =  "#3c456f", 
                                "All other regions (excluding Northern Plains of India)" = "#4e5e8b"), 
                     name = "legend") +
  scale_linetype_manual(values = c("Northern Plains of India" = "dashed", 
                                   "National Average" = "solid", 
                                   "All other regions (excluding Northern Plains of India)" = "dotted"), 
                        name = "legend")  +
  ggthemes::theme_tufte() +
  labs(x = "Year", 
       y = expression("Annual Average   " ~ PM[2.5] ~ " Concentration (in µg/m³)"), 
       title = "") +
  theme(legend.position = "bottom",
        legend.text = element_text(size = 11),
        legend.title = element_blank(),
        axis.title.y = element_text(size = 13, margin = margin(r = 0.6, unit = "cm")), 
        axis.title.x = element_text(size = 13, margin = margin(t = 0.6, b = 0.6, unit = "cm")), 
        axis.line = element_line(), 
        legend.box.background = element_rect(color = "black"),
        plot.title = element_text(hjust = 0.5, size = 16, margin = margin(b = 0.7, unit = "cm")), 
        plot.subtitle = element_text(hjust = 0.5, size = 8, face = "italic"), 
        plot.caption = element_text(size = 7, margin = margin(t = 0.8, unit = "cm"), hjust = 0, face = "italic"),
        axis.text = element_text(size = 12), 
        plot.background = element_rect(color = "white"), 
        axis.ticks = element_blank(), 
        legend.key.width = unit(2, "cm")) +
     geom_text(x = 2003.5, y = 7.6, label = expression("WHO" ~ PM[2.5] ~ "Guideline (last updated: 2022): 5 µg/m³"), size = 4.5) 


# Appendix table
appendix_table_raw_india <- gadm_level_summary(gadm2_aqli_2022, c("country", "name_1"), c(2022), 10) %>%
  filter(country == "India") %>%
  mutate(population_lakhs = round(population/100000, 1)) %>%
  select(name_1, population_lakhs, pm2022, llpp_who_2022, llpp_nat_2022) %>%
  rename("State/UT" = name_1, 
         "Population (Lakhs)" = population_lakhs, 
         "Annual Average 2022 PM2.5 Concentration (µg/m³)" = pm2022, 
         "Life Expectancy Gains from reducing PM2.5 from 2022 concentration to WHO PM2.5 guideline of 5 µg/m³" = llpp_who_2022, 
         "Life Expectancy Gains from reducing PM2.5 from 2022 concentration to National PM2.5 guideline of 40 µg/m³" = llpp_nat_2022)
```


